{"config":{"lang":["en"],"separator":"[\\s\\u200b\\u3000\\-\u3001\u3002\uff0c\uff0e\uff1f\uff01\uff1b]+","pipeline":["stemmer"]},"docs":[{"location":"","title":"\u9996\u9875","text":"\u300ak8s\u5165\u95e8\u4e0e\u8fdb\u9636\u5b9e\u6218\u300b <p>\u5feb\u901f\u4e0a\u624bkubernetes\uff0c\u638c\u63e1kubernetes\u6838\u5fc3\u77e5\u8bc6\uff01</p> <p>\u4f5c\u8005: https://phy.xyz</p> <p></p> <p>        \u5f00\u59cb\u9605\u8bfb           \u4e0b\u8f7d\u4ee3\u7801    </p>"},{"location":"01.basic/00-start/","title":"kubernetes\u7b80\u4ecb","text":""},{"location":"01.basic/00-start/#k8s","title":"\u4e00\u3001\u4ec0\u4e48\u662fk8s\uff1f","text":"<p><code>k8s</code>\u662f<code>Kubernetes</code>\u7684\u7b80\u79f0\uff0c\u6765\u81ea<code>Google</code>\uff0c\u662f\u7528\u4e8e\u81ea\u52a8\u90e8\u7f72\u3001\u6269\u5c55\u548c\u7ba1\u7406\u201c\u5bb9\u5668\u5316\u5e94\u7528\u7a0b\u5e8f\u201d\u7684\u5f00\u6e90\u7cfb\u7edf\u3002\u7b80\u5355\u5730\u8bf4\u5c31\u662f\uff1ak8s\u662f\u4e00\u5957\u670d\u52a1\u5668\u96c6\u7fa4\u7ba1\u7406\u7ec4\u4ef6\uff0ck8s\u73b0\u5728\u666e\u904d\u7528\u4e8e\u7ba1\u7406\u96c6\u7fa4\u8282\u70b9\u4e0a\u7684\u5bb9\u5668\u3002\u5728\u5b66\u4e60k8s\u4e4b\u524d\uff0c\u6211\u4eec\u5e94\u8be5\u5177\u5907\u4e00\u5b9a\u7684\u5bb9\u5668\u77e5\u8bc6\u57fa\u7840\u3002</p> <p>\u4e0b\u9762\u8fd9\u5f20\u56fe\u5c55\u793a\u4e86\u4e00\u4e2a<code>k8s</code>\u7684\u4e00\u4e2a\u5178\u578b\u7684\u67b6\u6784\uff0c\u4f60\u53ef\u80fd\u770b\u4e0d\u61c2\uff0c\u4f46\u5b8c\u5168\u6ca1\u5173\u7cfb\uff0c\u6211\u4eec\u8fd9\u91cc\u53ea\u662f\u4e2a\u4e86\u89e3\uff0c\u540e\u9762\u518d\u4ecb\u7ecd\u5176\u4e2d\u5305\u542b\u7684\u6280\u672f\u70b9\u3002</p> <p></p>"},{"location":"01.basic/00-start/#k8s_1","title":"\u4e8c\u3001\u4f7f\u7528k8s\u6709\u4ec0\u4e48\u597d\u5904\uff1f","text":"<p>\u4f7f\u7528Kubernetes\u53ef\u4ee5\u63d0\u9ad8\u5f00\u53d1\u548c\u8fd0\u7ef4\u7684\u6548\u7387\uff0c\u7b80\u5316\u5e94\u7528\u7a0b\u5e8f\u7684\u90e8\u7f72\u548c\u7ba1\u7406\uff0c\u63d0\u9ad8\u5e94\u7528\u7a0b\u5e8f\u7684\u53ef\u7528\u6027\u548c\u53ef\u4f38\u7f29\u6027\uff0c\u540c\u65f6\u8fd8\u80fd\u591f\u63d0\u4f9b\u7075\u6d3b\u6027\u548c\u53ef\u79fb\u690d\u6027\u3002\u8fd9\u4e9b\u597d\u5904\u4f7f\u5f97Kubernetes\u6210\u4e3a\u73b0\u4ee3\u5316\u5e94\u7528\u7a0b\u5e8f\u90e8\u7f72\u548c\u7ba1\u7406\u7684\u9996\u9009\u5e73\u53f0\u3002\u4ee5\u4e0b\u662fKubernetes\u7684\u4e00\u4e9b\u4e3b\u8981\u4f18\u52bf\uff1a</p> <ul> <li> <p><code>\u7b80\u5316\u90e8\u7f72\u548c\u7ba1\u7406</code>\uff1aKubernetes\u63d0\u4f9b\u4e86\u4e00\u4e2a\u7edf\u4e00\u7684\u5e73\u53f0\u6765\u7ba1\u7406\u5bb9\u5668\u5316\u5e94\u7528\u7a0b\u5e8f\u3002\u5b83\u53ef\u4ee5\u81ea\u52a8\u5316\u5e94\u7528\u7a0b\u5e8f\u7684\u90e8\u7f72\u3001\u5347\u7ea7\u548c\u6269\u5c55\uff0c\u5927\u5927\u7b80\u5316\u4e86\u5e94\u7528\u7a0b\u5e8f\u7684\u7ba1\u7406\u5de5\u4f5c\u3002</p> </li> <li> <p><code>\u5f39\u6027\u4f38\u7f29</code>\uff1aKubernetes\u53ef\u4ee5\u6839\u636e\u5e94\u7528\u7a0b\u5e8f\u7684\u8d1f\u8f7d\u81ea\u52a8\u8fdb\u884c\u6c34\u5e73\u6269\u5c55\u548c\u6536\u7f29\u3002\u5b83\u53ef\u4ee5\u6839\u636e\u914d\u7f6e\u7684\u89c4\u5219\u81ea\u52a8\u6dfb\u52a0\u6216\u5220\u9664\u5bb9\u5668\u5b9e\u4f8b\uff0c\u4ee5\u6ee1\u8db3\u5e94\u7528\u7a0b\u5e8f\u7684\u9700\u6c42\u3002</p> </li> <li> <p><code>\u9ad8\u53ef\u7528\u6027</code>\uff1aKubernetes\u63d0\u4f9b\u4e86\u6545\u969c\u6062\u590d\u548c\u81ea\u52a8\u91cd\u542f\u7684\u673a\u5236\u3002\u5f53\u5bb9\u5668\u5b9e\u4f8b\u5931\u8d25\u65f6\uff0cKubernetes\u4f1a\u81ea\u52a8\u91cd\u65b0\u542f\u52a8\u5bb9\u5668\uff0c\u5e76\u786e\u4fdd\u5e94\u7528\u7a0b\u5e8f\u4fdd\u6301\u53ef\u7528\u72b6\u6001\u3002</p> </li> <li> <p><code>\u8d44\u6e90\u7ba1\u7406</code>\uff1aKubernetes\u53ef\u4ee5\u5bf9\u96c6\u7fa4\u4e2d\u7684\u8d44\u6e90\u8fdb\u884c\u7ba1\u7406\u548c\u8c03\u5ea6\uff0c\u786e\u4fdd\u6bcf\u4e2a\u5e94\u7528\u7a0b\u5e8f\u90fd\u80fd\u591f\u83b7\u5f97\u6240\u9700\u7684\u8d44\u6e90\u3002\u5b83\u53ef\u4ee5\u6839\u636e\u5e94\u7528\u7a0b\u5e8f\u7684\u9700\u6c42\u81ea\u52a8\u5206\u914d\u548c\u8c03\u6574\u8d44\u6e90\uff0c\u63d0\u9ad8\u8d44\u6e90\u5229\u7528\u7387\u3002</p> </li> <li> <p><code>\u7075\u6d3b\u6027\u548c\u53ef\u79fb\u690d\u6027</code>\uff1aKubernetes\u63d0\u4f9b\u4e86\u4e00\u79cd\u6807\u51c6\u5316\u7684\u5bb9\u5668\u7f16\u6392\u548c\u7ba1\u7406\u65b9\u5f0f\uff0c\u4f7f\u5f97\u5e94\u7528\u7a0b\u5e8f\u53ef\u4ee5\u5728\u4e0d\u540c\u7684\u73af\u5883\u4e2d\u8fdb\u884c\u90e8\u7f72\u548c\u8fc1\u79fb\u3002\u5b83\u652f\u6301\u591a\u4e2a\u4e91\u5e73\u53f0\u548c\u57fa\u7840\u8bbe\u65bd\uff0c\u4f7f\u5f97\u5e94\u7528\u7a0b\u5e8f\u5177\u6709\u66f4\u9ad8\u7684\u7075\u6d3b\u6027\u548c\u53ef\u79fb\u690d\u6027\u3002</p> </li> </ul>"},{"location":"01.basic/01-build_in_virtual/","title":"\u4f7f\u7528kubeadm\u5feb\u901f\u642d\u5efak8s\u96c6\u7fa4","text":""},{"location":"01.basic/01-build_in_virtual/#_1","title":"\u4e00\u3001\u6982\u8ff0","text":""},{"location":"01.basic/01-build_in_virtual/#11-multipass","title":"1.1 \u4f7f\u7528multipass\u642d\u5efa\u865a\u62df\u73af\u5883","text":"<p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528<code>multipass</code>\u6765\u521b\u5efa\u591a\u53f0<code>Ubuntu Server</code>\u865a\u62df\u73af\u5883\uff0c\u4f5c\u4e3aLinux\u96c6\u7fa4\u7684\u73af\u5883\u3002\u5982\u679c\u4f60\u4e0d\u77e5\u9053<code>multipass</code>\u8fd9\u4e2a\u865a\u62df\u5316\u5de5\u5177\u7684\u4f7f\u7528\u65b9\u6cd5\uff0c\u53ef\u4ee5\u53c2\u8003\u53e6\u4e00\u7bc7\u6587\u7ae0\uff1ahttps://webcoding.tech/posts/tools_run-ubuntu-on-multipass.html\u3002</p>"},{"location":"01.basic/01-build_in_virtual/#12-vagtrant","title":"1.2 \u4f7f\u7528vagtrant\u642d\u5efa\u865a\u62df\u73af\u5883","text":"<p>\u9664\u4e86multipass\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528<code>vagtrant</code>\u6765\u521b\u5efaLinux\u865a\u62df\u73af\u5883\uff0c<code>vagrant</code>\u7684\u57fa\u672c\u64cd\u4f5c\u53ef\u4ee5\u53c2\u8003\u8fd9\u7bc7\u6587\u7ae0\uff1ahttps://webcoding.tech/posts/tools_run-linux-on-vagrant.html\u3002</p>"},{"location":"01.basic/01-build_in_virtual/#13-virtualbox","title":"1.3 \u4f7f\u7528VirtualBox\u642d\u5efa\u865a\u62df\u73af\u5883","text":"<p>\u5982\u679c\u4f60\u4e0d\u60f3\u7528\u4ee5\u4e0a\u7684\u4e24\u6b3e\u5de5\u5177\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528VirtualBox\u6765\u521b\u5efa\u4f60\u7684\u865a\u62df\u73af\u5883\uff0c\u4f46\u76f4\u63a5\u4f7f\u7528VirtualBox\u64cd\u4f5c\u4f1a\u66f4\u52a0\u7e41\u6742\uff0c\u6240\u4ee5\u66f4\u63a8\u8350\u4f7f\u7528multipass\u6216\u8005vagrant\u3002</p>"},{"location":"01.basic/01-build_in_virtual/#14","title":"1.4 \u76ee\u6807","text":"<p>\u672c\u6b21\u6211\u4eec\u5c06\u90e8\u7f72\u4e00\u4e2a\u4e3b\uff08master\u3001\u7ba1\u7406\u3001\u63a7\u5236\uff09\u8282\u70b9master1\u548c\u4e24\u4e2a\u5de5\u4f5c\uff08worker\uff09\u8282\u70b9worker1\u3001worker2\u7684\u96c6\u7fa4\u3002master1\u3001worker1\u3001worker2\u6bcf\u4e2a\u8282\u70b9\u5206\u914d2\u4e2acpu\u30012G\u5185\u5b58\u300110G\u786c\u76d8\u3002\u8fd9\u662fk8s\u8981\u6c42\u7684\u6700\u4f4e\u914d\u7f6e\uff0c\u4f46\u8fd9\u4e9b\u914d\u7f6e\u5b8c\u5168\u8db3\u591f\u6211\u4eec\u7528\u4ee5\u5b66\u4e60\u3002</p> <p>\u6211\u4eec\u5c06\u4f7f\u7528multipass\u6765\u642d\u5efa\u96c6\u7fa4\u73af\u5883\uff0c\u4e0b\u6587\u662f\u5728\u865a\u62df\u73af\u5883\u4e2d\u4f7f\u7528kubeadm\u642d\u5efak8s\u96c6\u7fa4\u642d\u5efa\u8fc7\u7a0b\uff0c\u5728\u540e\u7eed\u7684\u6587\u7ae0\u4e2d\u4e5f\u4f1a\u5faa\u5e8f\u6e10\u8fdb\u5730\u4ecb\u7ecdk8s\u3002</p>"},{"location":"01.basic/01-build_in_virtual/#_2","title":"\u4e8c\u3001\u51c6\u5907\u73af\u5883","text":""},{"location":"01.basic/01-build_in_virtual/#21-ubuntu1804","title":"2.1 \u521b\u5efaUbuntu18.04\u865a\u62df\u673a","text":"<p>\u5728\u64b0\u5199\u6b64\u6587\u7684\u65f6\u5019\uff0c<code>ubuntu18.04</code>\u6b63\u5904\u4e8e\u5176\u7a33\u5b9a\u7684\u751f\u547d\u5468\u671f\u5185\uff0c\u672c\u6b21\u6211\u4eec\u9009\u62e9<code>ubuntu18.04</code>\u4f5c\u4e3a\u793a\u4f8b\u3002\u5206\u522b\u521b\u5efa2\u6838cpu\u300110G\u786c\u76d8\u30012G\u5185\u5b58\uff0c\u540d\u4e3amaster1\u3001worker1\u3001worker2\u4e09\u53f0\u865a\u62df\u673a\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>multipass launch -c 2 -d 10G -m 2G -n master1 18.04\nmultipass launch -c 2 -d 10G -m 2G -n worker1 18.04\nmultipass launch -c 2 -d 10G -m 2G -n worker2 18.04\n</code></pre> <p>\u4f7f\u7528<code>multipass list</code>\u5217\u51fa\u5df2\u521b\u5efa\u7684\u865a\u62df\u673a\u5217\u8868\uff0c\u5982\u4e0b</p> <pre><code>pan@pandeMacBook-Pro ~ % multipass list\nName                    State             IPv4             Image\nmaster1                 Running           192.168.64.4     Ubuntu 18.04 LTS\nworker1                 Running           192.168.64.5     Ubuntu 18.04 LTS\nworker2                 Running           192.168.64.6     Ubuntu 18.04 LTS\n</code></pre> <p>\u521b\u5efa\u865a\u62df\u673a\u4e4b\u540e\uff0c\u6211\u4eec\u9700\u8981\u8bb0\u4f4fIP\u4e0e\u865a\u62df\u673a\u7684\u5bf9\u5e94\u5173\u7cfb\uff0c\u518d\u5bf9\u865a\u62df\u673a\u8fdb\u884c\u521d\u59cb\u5316\u64cd\u4f5c\uff0c\u4ee5\u4e0b2.2\u30012.3\u7684\u64cd\u4f5c\u8fc7\u7a0b\u9700\u8981\u5728\u6240\u6709\u4e3b\u673a\u4e0a\u8fdb\u884c\u3002</p>"},{"location":"01.basic/01-build_in_virtual/#22-root","title":"2.2 \u4fee\u6539root\u7528\u6237\u5bc6\u7801","text":"<p>\u56e0\u4e3a\u540e\u9762\u7684\u64cd\u4f5c\u90fd\u662f\u4f7f\u7528<code>root</code>\u7528\u6237\u8fdb\u884c\uff0c\u4e0b\u9762\u6211\u4eec\u5148\u4fee\u6539\u6bcf\u4e00\u53f0\u4e3b\u673a\u7684<code>root</code>\u7528\u6237\u5bc6\u7801\uff0c\u4ee5master1\u4e3a\u4f8b\uff0c\u5982\u4e0b\u64cd\u4f5c\u547d\u4ee4</p> <pre><code># \u8fdb\u5165\u865a\u62df\u673a\nmultipass bash master1\n# \u4fee\u6539root\u5bc6\u7801\nsudo passwd root\n# \u4fee\u6539\u5bc6\u7801\u4e4b\u540e\uff0c\u4f7f\u7528su\u547d\u4ee4\u5207\u6362root\u7528\u6237\nsu\n</code></pre>"},{"location":"01.basic/01-build_in_virtual/#23-iptables","title":"2.3 \u5173\u95ed\u9632\u706b\u5899\u548ciptables","text":"<p>\u6839\u636e\u5b98\u65b9\u6587\u6863\uff0c\u9632\u706b\u5899\u548ciptables\u53ef\u80fd\u4f1a\u5f71\u54cd\u5230k8s\u96c6\u7fa4\uff0c\u6240\u4ee5\u6211\u4eec\u90fd\u8981\u5173\u95ed\u6389\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code># \u5173\u95ed\u9632\u706b\u5899\nufw disable\n# \u5173\u95ediptables\niptables -P INPUT ACCEPT\niptables -P FORWARD ACCEPT\niptables -P OUTPUT ACCEPT\niptables -F\n</code></pre>"},{"location":"01.basic/01-build_in_virtual/#dockerkubeadm","title":"\u4e8c\u3001\u5b89\u88c5docker\u4e0ekubeadm","text":"<p>\u4ee5\u4e0b3.1\u30013.2\u30013.3\u7684\u64cd\u4f5c\u8fc7\u7a0b\u9700\u8981\u5728\u6240\u6709\u4e3b\u673a\u4e0a\u8fdb\u884c\u3002</p>"},{"location":"01.basic/01-build_in_virtual/#31-docker","title":"3.1 \u5b89\u88c5\u4e0e\u914d\u7f6edocker","text":"<p>\u5b89\u88c5docker</p> <pre><code># \u5b89\u88c5\u963f\u91cc\u4e91docker\u955c\u50cf\u670d\u52a1\u7684GPG\u8bc1\u4e66\ncurl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -\n# \u5199\u5165\u963f\u91cc\u4e91docker\u955c\u50cf\u670d\u52a1\u8f6f\u4ef6\u6e90\nadd-apt-repository \"deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable\"\n# \u66f4\u65b0\u8f6f\u4ef6\u5e93\napt-get update\n# \u67e5\u770b\u53ef\u4ee5\u5b89\u88c5\u7684docke-ce\u7248\u672c\napt-cache madison docker-ce\n# \u5b89\u88c5docker\napt-get -y install docker-ce=5:20.10.17~3-0~debian-bullseye\n# \u56fa\u5b9adocker-ce\u7248\u672c\napt-mark hold docker-ce\n</code></pre> <p>\u6bcf\u4e2a\u4eba\u90fd\u53ef\u4ee5\u4f7f\u7528\u963f\u91cc\u4e91\u521b\u5efa\u81ea\u5df1\u7684\u955c\u50cf\u52a0\u901f\u4ed3\u5e93\uff0c\u6bd4\u5982<code>https://g6ogy192.mirror.aliyuncs.com</code>\u5c31\u662f\u6211\u7684\u4e2a\u4eba\u955c\u50cf\u52a0\u901f\u5730\u5740\uff0c\u4f46\u662f\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528\uff0c\u8bbe\u7f6e\u955c\u50cf\u4ed3\u5e93\u5730\u5740\u5982\u4e0b\u547d\u4ee4</p> <pre><code># \u521b\u5efa\u914d\u7f6e\u76ee\u5f55\nmkdir -p /etc/docker\n# \u5199\u5165\u914d\u7f6e\u6587\u4ef6\ntee /etc/docker/daemon.json &lt;&lt;-'EOF'\n{\n  \"registry-mirrors\": [\"https://g6ogy192.mirror.aliyuncs.com\"],\n  \"exec-opts\": [\"native.cgroupdriver=systemd\"] \n}\nEOF\n# \u91cd\u65b0\u52a0\u8f7d\u670d\u52a1\u7684\u914d\u7f6e\u6587\u4ef6\nsystemctl daemon-reload\n# \u91cd\u542fdocker\u670d\u52a1\nsystemctl restart docker\n</code></pre>"},{"location":"01.basic/01-build_in_virtual/#32-kubeadmkubeletkubectl","title":"3.2 \u5b89\u88c5kubeadm\u3001kubelet\u3001kubectl","text":"<pre><code># \u5b89\u88c5\u963f\u91cc\u4e91k8s\u955c\u50cf\u670d\u52a1\u7684GPG\u8bc1\u4e66\ncurl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add -\n# \u6dfb\u52a0\u963f\u91cc\u4e91k8s\u955c\u50cf\u6e90\ncat &lt;&lt;EOF &gt; /etc/apt/sources.list.d/kubernetes.list\ndeb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main\nEOF\n# \u66f4\u65b0\u8f6f\u4ef6\u5e93\napt-get update\n# \u5b89\u88c5\u7a0b\u5e8f\napt-get install -y kubelet=1.18.0-00 kubeadm=1.18.0-00 kubectl=1.18.0-00\n# \u56fa\u5b9a\u7248\u672c\napt-mark hold kubelet kubeadm kubectl\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff1a\u5b89\u88c5\u7684<code>docker</code>\u7248\u672c\u8981\u548c<code>k8s</code>\u7248\u672c\u5339\u914d\uff0c\u5426\u5219<code>k8s</code>\u53ef\u80fd\u51fa\u73b0\u65e0\u6cd5\u9a71\u52a8<code>docker</code>\u7684\u60c5\u51b5\uff0c\u4ee5\u4e0a\u5b89\u88c5\u7684<code>docker19.03</code>\u548c<code>k8s1.18.0</code>\u662f\u5b58\u5728\u5bf9\u5e94\u5173\u7cfb\u7684\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u67e5\u9605k8s\u5b98\u65b9\u6587\u6863\u7684\u65b9\u5f0f\u67e5\u770b\u66f4\u591a\u7684\u5bf9\u5e94\u5173\u7cfb\u3002</p>"},{"location":"01.basic/01-build_in_virtual/#33","title":"3.3 \u96c6\u7fa4\u955c\u50cf\u51c6\u5907","text":"<p>\u4f7f\u7528<code>kubeadm config images list</code>\u547d\u4ee4\u67e5\u770b\u5f53\u524d\u96c6\u7fa4\u57fa\u7840\u670d\u52a1\u6240\u9700\u8981\u7684\u955c\u50cf\uff0c\u955c\u50cf\u7248\u672c\u4f1a\u6839\u636e\u5f53\u524d\u7684\u7cfb\u7edf\u73af\u5883\uff08\u5f53\u524d\u5b89\u88c5kubeadm\u7684\u7248\u672c\uff09\u800c\u5b9a\uff0c\u8fd4\u56de\u5982\u4e0b\u5185\u5bb9</p> <pre><code>k8s.gcr.io/kube-apiserver:v1.18.20\nk8s.gcr.io/kube-controller-manager:v1.18.20\nk8s.gcr.io/kube-scheduler:v1.18.20\nk8s.gcr.io/kube-proxy:v1.18.20\nk8s.gcr.io/pause:3.2\nk8s.gcr.io/etcd:3.4.3-0\nk8s.gcr.io/coredns:1.6.7\n</code></pre> <p>\u4f46\u662f\u7531\u4e8e\u56fd\u5185\u6b63\u5e38\u8bbf\u95ee\u4e0d\u5230<code>k8s.cgr.io</code>\uff0c\u53ef\u4ee5\u66ff\u6362\u963f\u91cc\u4e91\u955c\u50cf\u5730\u5740\uff1a<code>registry.aliyuncs.com/google_containers</code>\uff0c\u6267\u884c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>docker pull registry.aliyuncs.com/google_containers/kube-apiserver:v1.18.20\ndocker pull registry.aliyuncs.com/google_containers/kube-controller-manager:v1.18.20\ndocker pull registry.aliyuncs.com/google_containers/kube-scheduler:v1.18.20\ndocker pull registry.aliyuncs.com/google_containers/kube-proxy:v1.18.20\ndocker pull registry.aliyuncs.com/google_containers/pause:3.2\ndocker pull registry.aliyuncs.com/google_containers/etcd:3.4.3-0\ndocker pull registry.aliyuncs.com/google_containers/coredns:1.6.7\n</code></pre> <p>\u63a5\u4e0b\u6765\u7ed9\u955c\u50cf\u6253\u6807\u7b7e\uff0c\u5f97\u5230kubeadm\u9700\u8981\u7684\u955c\u50cf</p> <pre><code>docker tag registry.aliyuncs.com/google_containers/kube-apiserver:v1.18.20 k8s.gcr.io/kube-apiserver:v1.18.20\ndocker tag registry.aliyuncs.com/google_containers/kube-controller-manager:v1.18.20 k8s.gcr.io/kube-controller-manager:v1.18.20\ndocker tag registry.aliyuncs.com/google_containers/kube-scheduler:v1.18.20 k8s.gcr.io/kube-scheduler:v1.18.20\ndocker tag registry.aliyuncs.com/google_containers/kube-proxy:v1.18.20 k8s.gcr.io/kube-proxy:v1.18.20\ndocker tag registry.aliyuncs.com/google_containers/pause:3.2 k8s.gcr.io/pause:3.2\ndocker tag registry.aliyuncs.com/google_containers/etcd:3.4.3-0 k8s.gcr.io/etcd:3.4.3-0\ndocker tag registry.aliyuncs.com/google_containers/coredns:1.6.7 k8s.gcr.io/coredns:1.6.7\n</code></pre> <p>\u518d\u5220\u9664\u6389\u4ece\u963f\u91cc\u4e91\u4e0b\u8f7d\u7684\u955c\u50cf</p> <pre><code>docker rmi registry.aliyuncs.com/google_containers/kube-apiserver:v1.18.20\ndocker rmi registry.aliyuncs.com/google_containers/kube-controller-manager:v1.18.20\ndocker rmi registry.aliyuncs.com/google_containers/kube-scheduler:v1.18.20\ndocker rmi registry.aliyuncs.com/google_containers/kube-proxy:v1.18.20\ndocker rmi registry.aliyuncs.com/google_containers/pause:3.2\ndocker rmi registry.aliyuncs.com/google_containers/etcd:3.4.3-0\ndocker rmi registry.aliyuncs.com/google_containers/coredns:1.6.7\n</code></pre>"},{"location":"01.basic/01-build_in_virtual/#k8s","title":"\u4e09\u3001k8s\u96c6\u7fa4\u521d\u59cb\u5316","text":""},{"location":"01.basic/01-build_in_virtual/#31-master","title":"3.1 \u521d\u59cb\u5316master\u8282\u70b9","text":"<p>\u5728master1\u8282\u70b9\u4e0a\u6267\u884c\u521d\u59cb\u5316\u547d\u4ee4</p> <pre><code>kubeadm init --apiserver-advertise-address=192.168.64.4 --service-cidr=10.96.0.0/12 --pod-network-cidr=10.244.0.0/16  --ignore-preflight-errors=Swap\n</code></pre> <p>\u53c2\u6570\u8bf4\u660e</p> <ul> <li><code>--apiserver-advertise-address</code>\uff1a\u6307\u5b9aapiserver\u7684\u670d\u52a1IP\uff0c\u6b64\u5904\u586b\u5199master1\u7684IP\u5730\u5740\uff0c\u5982\u679c\u7cfb\u7edf\u5305\u542b\u591a\u4e2aIP\uff0c\u5fc5\u987b\u9009\u62e9\u5916\u7f51IP\uff08\u80fd\u4e0e\u5176\u4ed6\u8282\u70b9\u8fdb\u884c\u7f51\u7edc\u901a\u4fe1\u7684IP\uff09</li> <li><code>--service-cidr</code>\uff1ak8s\u4e2dservice\u7f51\u7edc\u4f7f\u7528\u7684\u7f51\u6bb5</li> <li><code>--pod-network-cidr</code>\uff1ak8s\u4e2dpod\u7f51\u7edc\u4f7f\u7528\u7684\u7f51\u6bb5</li> <li><code>--ignore-preflight-errors</code>\uff1a\u5ffd\u7565swap\u62a5\u9519</li> </ul> <p>\u521d\u59cb\u5316\u7ed3\u679c\u5982\u4e0b</p> <pre><code>Your Kubernetes control-plane has initialized successfully!\n\nTo start using your cluster, you need to run the following as a regular user:\n\nmkdir -p $HOME/.kube\n  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n  sudo chown $(id -u):$(id -g) $HOME/.kube/config\n\nYou should now deploy a pod network to the cluster.\nRun \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at:\n  https://kubernetes.io/docs/concepts/cluster-administration/addons/\n\nThen you can join any number of worker nodes by running the following on each as root:\n\nkubeadm join 192.168.64.4:6443 --token wkgukj.up6d3a8rng4ytyl0 \\\n--discovery-token-ca-cert-hash sha256:d36346a3820781efd88ae3796a58e2fa139f411f9ddc9c1dc7c9c2add8da5cfb\n</code></pre> <p>\u5982\u679c\u51fa\u73b0\u7c7b\u4f3c\u4ee5\u4e0a\u7684\u63d0\u793a\u4fe1\u606f\uff0c\u4ee3\u8868master\u8282\u70b9\u521d\u59cb\u5316\u6210\u529f\u3002\u4ee5\u4e0a\u4fe1\u606f\u63d0\u793a\u6211\u4eec\u8981\u5b8c\u6210\u4e09\u4e2a\u64cd\u4f5c\uff0c\u5e76\u7ed9\u51fa\u4e86\u76f8\u5173\u63d0\u793a\uff1a\u4e00\u662f\u62f7\u8d1d\u914d\u7f6e\u6587\u4ef6\u3001\u4e8c\u662f\u90e8\u7f72pod\u7684\u7f51\u7edc\u63d2\u4ef6\u3001\u4e09\u662f\u5c06\u5de5\u4f5c\u8282\u70b9\u52a0\u5165\u5230\u96c6\u7fa4\u4e2d\u3002</p>"},{"location":"01.basic/01-build_in_virtual/#32","title":"3.2 \u62f7\u8d1d\u914d\u7f6e\u6587\u4ef6","text":"<p>\u6839\u636e\u521d\u59cb\u5316\u7ed3\u679c\u63d0\u793a\uff0c\u6211\u4eec\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u62f7\u8d1dk8s\u7684\u76f8\u5173\u914d\u7f6e\u6587\u4ef6\u5230\u7528\u6237\u7684\u5bb6\u76ee\u5f55\uff0c\u624d\u80fd\u4f7fmaster1\u4e0a\u5f53\u524d\u767b\u5f55\u7684\u7528\u6237\u6b63\u5e38\u64cd\u4f5c\u96c6\u7fa4</p> <pre><code># \u521b\u5efa\u914d\u7f6e\u7528\u6237\u7684k8s\u6587\u4ef6\u76ee\u5f55\nmkdir -p $HOME/.kube\n# \u62f7\u8d1d\u914d\u7f6e\u548c\u4fee\u6539\u6240\u6709\u8005\uff0c\u6211\u4eec\u672c\u8eab\u4f7f\u7528root\u7528\u6237\u64cd\u4f5c\uff0c\u4e0d\u9700\u8981\u52a0sudo\u524d\u7f00\ncp -i /etc/kubernetes/admin.conf $HOME/.kube/config\nchown $(id -u):$(id -g) $HOME/.kube/config\n</code></pre>"},{"location":"01.basic/01-build_in_virtual/#33_1","title":"3.3 \u914d\u7f6e\u96c6\u7fa4\u7f51\u7edc","text":"<p>\u5728\u62f7\u8d1d\u597dk8s\u7684\u914d\u7f6e\u6587\u4ef6\u5230\u7528\u6237\u5bb6\u76ee\u5f55\u4e4b\u540e\uff0c\u6211\u4eec\u9700\u8981\u5b89\u88c5\u7f51\u7edc\u63d2\u4ef6\u3002\u672c\u6b21\u6211\u4eec\u4f7f\u7528<code>flannel</code>\u4f5c\u4e3a\u96c6\u7fa4\u7684\u7f51\u7edc\u63d2\u4ef6\uff0c\u5c06<code>flannel</code>\u914d\u7f6e\u6587\u4ef6\u4ecegithub\u4e0b\u8f7d\u4fdd\u5b58\u5230master1\uff0c\u6587\u4ef6\u5730\u5740\u4e3a\uff1a https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml\uff0c\u5728master1\u4e0a\u5c06\u6587\u4ef6\u547d\u540d\u4e3a<code>kube-flannel.yml</code>\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5982\u679c\u6211\u4eec\u7684\uff08\u865a\u62df\uff09\u4e3b\u673a\u91cc\u5b58\u5728\u591a\u4e2aIP\uff0c\u6211\u4eec\u9700\u8981\u6307\u5b9a\u6709\u6548IP\u7684\u7f51\u5361\uff08\u5982\u6211\u4eec\u5728vagrant\u91cc\u521b\u5efa\u7684\u865a\u62df\u673a\uff0c\u7b2c\u4e8c\u4e2a\u7f51\u5361\u624d\u662f\u6709\u6548IP\uff0c\u9700\u8981\u6307\u5b9a\u6709\u6548IP\u7684\u7f51\u5361\uff09\u3002\u4fee\u6539flannel\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u5728<code>- --kube-subnet-mgr</code>\u540e\u9762\u52a0\u4e00\u6761\u53c2\u6570\u914d\u7f6e\uff1a<code>- --iface=\u7f51\u5361\u540d</code>\uff0c\u5982\u4e0b</p> <pre><code># ...\ncontainers:\n      - name: kube-flannel\n       #image: flannelcni/flannel:v0.16.3 for ppc64le and mips64le (dockerhub limitations may apply)\n        image: rancher/mirrored-flannelcni-flannel:v0.16.3\n        command:\n        - /opt/bin/flanneld\n        args:\n        - --ip-masq\n        - --kube-subnet-mgr\n        - --iface=enp0s8\n# ...\n</code></pre> <p>\u540e\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u521b\u5efak8s\u7f51\u7edc\u63d2\u4ef6</p> <pre><code>kubectl apply -f kube-flannel.yml\n</code></pre> <p>\u5982\u770b\u5230\u5305\u542b<code>created</code>\u7684\u5982\u4e0b\u7c7b\u4f3c\u4fe1\u606f\uff0c\u8bc1\u660e\u7f51\u7edc\u63d2\u4ef6\u5b89\u88c5\u6210\u529f</p> <pre><code>namespace/kube-flannel created\nclusterrole.rbac.authorization.k8s.io/flannel created\nclusterrolebinding.rbac.authorization.k8s.io/flannel created\nserviceaccount/flannel created\nconfigmap/kube-flannel-cfg created\ndaemonset.apps/kube-flannel-ds created\n</code></pre>"},{"location":"01.basic/01-build_in_virtual/#34","title":"3.4 \u521d\u59cb\u5316\u96c6\u7fa4\u5de5\u4f5c\u8282\u70b9","text":"<p>\u521d\u59cb\u5316\u96c6\u7fa4\u7ba1\u7406\u8282\u70b9master1\u4e4b\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u5de5\u4f5c\u8282\u70b9worker1\u548cwroker2\u52a0\u5165\u5230\u96c6\u7fa4\u4e2d\u3002\u5c06\u5de5\u4f5c\u8282\u70b9\u7684\u521d\u59cb\u5316\u547d\u4ee4\u62f7\u8d1d\u5230worker1\u548cworker2\u53bb\u6267\u884c\uff0c\u4f7f\u96c6\u7fa4\u7684\u5de5\u4f5c\u8282\u70b9\uff08worker1\u3001worker2\uff09\u548c\u7ba1\u7406\u8282\u70b9\uff08master1\uff09\u5173\u8054\u8d77\u6765\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>kubeadm join 192.168.64.4:6443 --token wkgukj.up6d3a8rng4ytyl0 \\\n--discovery-token-ca-cert-hash sha256:d36346a3820781efd88ae3796a58e2fa139f411f9ddc9c1dc7c9c2add8da5cfb\n</code></pre> <p>\u5728\u5de5\u4f5c\u8282\u70b9\u6267\u884c\u521d\u59cb\u5316\u547d\u4ee4\u4e4b\u540e\uff0c\u6211\u4eec\u5728\u7ba1\u7406\u8282\u70b9master1\u4f7f\u7528<code>kubectl get pods --all-namespaces</code>\u67e5\u770b\u7ed3\u679c\uff0c\u53ef\u4ee5\u770b\u5230\u7c7b\u4f3c\u5982\u4e0b\u4fe1\u606f</p> <pre><code>root@master1:/home/ubuntu# kubectl get pods --all-namespaces\nNAMESPACE     NAME                              READY   STATUS    RESTARTS   AGE\nkube-system   coredns-66bff467f8-pw9br          1/1     Running   0          13m\nkube-system   coredns-66bff467f8-wsj45          1/1     Running   0          13m\nkube-system   etcd-master1                      1/1     Running   0          14m\nkube-system   kube-apiserver-master1            1/1     Running   0          14m\nkube-system   kube-controller-manager-master1   1/1     Running   0          14m\nkube-system   kube-flannel-ds-c4jnh             1/1     Running   0          3m39s\nkube-system   kube-flannel-ds-rg58c             1/1     Running   0          3m14s\nkube-system   kube-flannel-ds-sw85v             1/1     Running   0          3m15s\nkube-system   kube-proxy-ddk88                  1/1     Running   0          3m15s\nkube-system   kube-proxy-dt825                  1/1     Running   0          13m\nkube-system   kube-proxy-jgm4h                  1/1     Running   0          3m14s\nkube-system   kube-scheduler-master1            1/1     Running   0          14m\n</code></pre> <p>\u5982\u679c\u9700\u8981\u67e5\u770b\u66f4\u591a\u7684\u4fe1\u606f\uff08\u5982\u6240\u8fd0\u884c\u7684\u5bbf\u4e3b\u673a\uff09\uff0c\u53ea\u9700\u5728\u539f\u547d\u4ee4\u4e2d\u8ffd\u52a0<code>-o wide</code>\u53c2\u6570\u5373\u53ef\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5982\u679c\u4f60\u7684\u5217\u8868\u4e2d\u663e\u793a\u7684\u6240\u6709pod\u5e76\u4e0d\u662f\u5904\u4e8eRunning\u72b6\u6001\uff0c\u4e00\u822c\u662f\u6b63\u5728\u4ece\u7f51\u7edc\u4e0a\u4e0b\u8f7d\u8d44\u6e90\uff0c\u8fd8\u6ca1\u6709\u5b8c\u5168\u542f\u52a8\u670d\u52a1\uff0c\u4f60\u9700\u8981\u7b49\u5f85\u4e00\u6bb5\u65f6\u95f4\u3002\u4f60\u5728\u5b89\u88c5\u96c6\u7fa4\u7684\u8fc7\u7a0b\u4e2d\uff0c\u6700\u597d\u5904\u4e8e\u4e00\u4e2a\u4f18\u8d28\u7684\u7f51\u7edc\u73af\u5883\u3002\u5982\u679c\u4f60\u7535\u8111\u914d\u7f6e\u5141\u8bb8\uff0c\u4f60\u8fd8\u53ef\u4ee5\u4f7f\u7528\u4e0a\u6587\u8bf4\u660e\u7684\u64cd\u4f5c\u6b65\u9aa4\uff0c\u6dfb\u52a0\u66f4\u591a\u7684\u5de5\u4f5c\u8282\u70b9\u3002</p>"},{"location":"01.basic/01-build_in_virtual/#35-k8s","title":"3.5 \u91cd\u7f6ek8s\u96c6\u7fa4","text":"<p>\u5982\u679c\u4f60\u5728\u642d\u5efa\u8fc7\u7a0b\u4e2d\u51fa\u73b0\u95ee\u9898\uff0c\u5982\u56e0\u4e3a\u7f51\u7edc\u539f\u56e0\u5b89\u88c5\u5931\u8d25\u7b49\uff0c\u6216\u8005\u56e0\u4e3a\u5176\u4ed6\u539f\u56e0\u60f3\u91cd\u7f6ek8s\u96c6\u7fa4\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u7684\u64cd\u4f5c\u6b65\u9aa4</p> <pre><code># \u9a71\u79bb\u5de5\u4f5c\u8282\u70b9\u7684pod\nkubectl drain worker1 --delete-local-data --force --ignore-daemonsets\nkubectl drain worker2 --delete-local-data --force --ignore-daemonsets\n# \u5220\u9664\u5de5\u4f5c\u8282\u70b9\nkubectl delete node worker1\nkubectl delete node worker2\n# \u91cd\u7f6e\u96c6\u7fa4\nkubeadm reset\n</code></pre>"},{"location":"01.basic/01-build_in_virtual/#_3","title":"\u56db\u3001\u603b\u7ed3","text":"<p>\u4ee5\u4e0a\u662f\u4f7f\u7528kubeadm\u5feb\u901f\u642d\u5efak8s\u96c6\u7fa4\u7684\u5b8c\u6574\u8bf4\u660e\uff0c\u6216\u8bb8\u4f60\u7684\u5b89\u88c5\u4f1a\u5931\u8d25\u3002\u539f\u56e0\u53ef\u80fd\u662f\u4f60\u7684\u865a\u62df\u73af\u5883\u95ee\u9898\u3001\u4e5f\u53ef\u80fd\u56e0\u4e3a\u7f51\u7edc\u539f\u56e0\uff0c\u6216\u8005\u662f\u4f60\u64cd\u4f5c\u9519\u8bef\u3002\u5982\u679c\u51fa\u73b0\u5931\u8d25\uff0c\u4f60\u9700\u8981\u6839\u636e\u4f60\u7684\u64cd\u4f5c\u6b65\u9aa4\u8ba4\u771f\u5206\u6790\u5e76\u91cd\u8bd5\u3002</p> <p>\u4f5c\u8005wx\u8ba2\u9605\u53f7\uff1a\u6781\u5ba2\u5f00\u53d1\u8005\uff0c\u7981\u6b62\u8f6c\u8f7d</p>"},{"location":"01.basic/02-conception/","title":"k8s\u4e2d\u7684\u6838\u5fc3\u6982\u5ff5","text":"<p>\u672c\u6587\u5c06\u4ecb\u7ecdk8s\u77e5\u8bc6\u4f53\u7cfb\u4e2d\uff0c\u6700\u5e38\u89c1\u7684\u4e13\u4e1a\u540d\u8bcd\u4ee5\u53ca\u76f8\u5173\u6982\u5ff5</p>"},{"location":"01.basic/02-conception/#pod","title":"\u4e00\u3001Pod","text":"<p>Pod\u662fk8s\u4e2d\u6700\u5c0f\u7684\u903b\u8f91\u5355\u5143\uff0c\u4e5f\u53eb\u505ak8s\u7684\u539f\u5b50\u5355\u5143\u3002\u4e00\u4e2aPod\u91cc\u53ef\u4ee5\u8fd0\u884c\u591a\u4e2a\u5bb9\u5668\uff0c\u4ed6\u4eec\u5171\u4eabUTS\u547d\u540d\u7a7a\u95f4\uff08\u9694\u79bbHostname\u548cNIS\u57df\u540d\uff09\u3001\u5171\u4eabNET\u547d\u540d\u7a7a\u95f4\uff08\u9694\u79bb\u7f51\u7edc\u8bbe\u5907\u3001\u534f\u8bae\u6808\u3001\u7aef\u53e3\u7b49\uff09\u3001\u5171\u4eabIPC\u547d\u540d\u7a7a\u95f4\uff08\u9694\u79bb\u8fdb\u7a0b\u95f4\u901a\u4fe1\uff09\u3002\u6211\u4eec\u53ef\u4ee5\u628aPod\u7406\u89e3\u6210\u8c4c\u8c46\u835a\uff0c\u800c\u540c\u4e00\u4e2aPod\u5185\u7684\u6bcf\u4e2a\u5bb9\u5668\u662f\u4e00\u9897\u9897\u8c4c\u8c46\u3002\u4e00\u4e2aPod\u5185\u8fd0\u884c\u591a\u4e2a\u5bb9\u5668\uff0c\u53c8\u53eb\u8fb9\u8f66\uff08SideCar\uff09\u6a21\u5f0f\u3002</p>"},{"location":"01.basic/02-conception/#pod_1","title":"\u4e8c\u3001Pod\u63a7\u5236\u5668","text":"<p>Pod\u63a7\u5236\u5668\u662fPod\u542f\u52a8\u7684\u4e00\u79cd\u6a21\u677f\uff0c\u7528\u6765\u4fdd\u8bc1\u5728k8s\u91cc\u542f\u52a8\u7684Pod\u59cb\u7ec8\u6309\u7167\u4eba\u4eec\u7684\u9884\u671f\u8fd0\u884c\uff08\u5982\u526f\u672c\u6570\u3001\u751f\u547d\u5468\u671f\u3001\u5065\u5eb7\u72b6\u6001\u68c0\u67e5\u7b49\uff09\u3002k8s\u63d0\u4f9b\u4e86\u4f17\u591a\u7684Pod\u63a7\u5236\u5668\uff0c\u5e38\u7528\u7684\u63a7\u5236\u5668\u6709\u4ee5\u4e0b\u51e0\u79cd\uff1a</p> <ul> <li>Deployment</li> <li>DaemonSet</li> <li>ReplicaSet</li> <li>StatefulSet</li> <li>Job</li> <li>Cronjob</li> </ul>"},{"location":"01.basic/02-conception/#name-","title":"\u4e09\u3001Name--\u540d\u79f0","text":"<p>\u7531\u4e8ek8s\u5185\u90e8\u4f7f\u7528\u201c\u8d44\u6e90\u201d\u6765\u5b9a\u4e49\u6bcf\u4e00\u79cd\u903b\u8f91\u6982\u5ff5\uff08\u6216\u8005\u529f\u80fd\uff09\uff0c\u6545\u6bcf\u4e00\u79cd\u201c\u8d44\u6e90\u201d\u90fd\u5e94\u8be5\u6709\u81ea\u5df1\u7684\u540d\u79f0\uff0c\u201c\u8d44\u6e90\u201d\u6709api\u7248\u672c\uff08apiVersion\uff09\u3001\u7c7b\u522b\uff08kind\uff09\u3001\u5143\u6570\u636e\uff08metadata\uff09\u3001\u5b9a\u4e49\u6e05\u5355\uff08spec\uff09\u3001\u72b6\u6001\uff08status\uff09\u7b49\u914d\u7f6e\u4fe1\u606f\uff0c\u800c\u201c\u8d44\u6e90\u201d\u7684\u540d\u79f0\u901a\u5e38\u5b9a\u4e49\u5728\u201c\u8d44\u6e90\u201d\u7684\u5143\u4fe1\u606f\u91cc\u3002</p>"},{"location":"01.basic/02-conception/#namespace-","title":"\u56db\u3001Namespace--\u540d\u79f0\u7a7a\u95f4","text":"<p>\u968f\u7740\u9879\u76ee\u589e\u591a\u3001\u4eba\u5458\u589e\u52a0\u3001\u96c6\u7fa4\u89c4\u6a21\u6269\u5927\u7b49\uff0c\u9700\u8981\u4e00\u79cd\u80fd\u9694\u79bb\u5f00k8s\u5185\u90e8\u5404\u79cd\u201c\u8d44\u6e90\u201d\u7684\u65b9\u6cd5\uff0c\u8fd9\u5c31\u662f\u540d\u79f0\u7a7a\u95f4\u3002\u540d\u79f0\u7a7a\u95f4\u53ef\u4ee5\u7406\u89e3\u4e3ak8s\u5185\u90e8\u7684\u865a\u62df\u96c6\u7fa4\u7ec4\u3002\u4e0d\u540c\u7684\u540d\u79f0\u7a7a\u95f4\u5185\u7684\u201c\u8d44\u6e90\u201d\uff0c\u540d\u79f0\u53ef\u4ee5\u76f8\u540c\uff0c\u76f8\u540c\u540d\u79f0\u7a7a\u95f4\u5185\u7684\u540c\u79cd\u201c\u8d44\u6e90\u201d\uff0c\u540d\u79f0\u4e0d\u80fd\u76f8\u540c\u3002</p> <p>\u5408\u7406\u7684\u4f7f\u7528k8s\u7684\u540d\u79f0\u7a7a\u95f4\uff0c\u4f7f\u5f97\u96c6\u7fa4\u7ba1\u7406\u5458\u80fd\u591f\u66f4\u597d\u5730\u5bf9\u4ea4\u4ed8\u5230k8s\u91cc\u7684\u670d\u52a1\u8fdb\u884c\u5206\u7c7b\u7ba1\u7406\u548c\u6d4f\u89c8\u3002\u67e5\u8be2k8s\u91cc\u7279\u5b9a\u201c\u8d44\u6e90\u201d\u8981\u5e26\u4e0a\u76f8\u5e94\u7684\u540d\u79f0\u7a7a\u95f4\uff0ck8s\u91cc\u9ed8\u8ba4\u5b58\u5728\u7684\u540d\u79f0\u7a7a\u95f4\u6709\uff1a<code>default</code>\u3001<code>kube-system</code>\u3001<code>kube-public</code>\u3001<code>kube-node-lease</code>\uff081.13\u7248\u672c\u52a0\u5165\uff09\u3002</p>"},{"location":"01.basic/02-conception/#service-","title":"\u4e94\u3001Service--\u670d\u52a1","text":"<p>\u5728k8s\u91cc\uff0c\u867d\u7136\u6bcf\u4e2aPod\u90fd\u4f1a\u88ab\u5206\u914d\u4e00\u4e2a\u5355\u72ec\u7684IP\u5730\u5740\uff0c\u4f46\u8fd9\u4e2aIP\u5730\u5740\u4f1a\u968f\u7740Pod\u7684\u9500\u6bc1\u800c\u6d88\u5931\uff0cService\u5c31\u662f\u7528\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u7684\u6838\u5fc3\u6982\u5ff5\u3002\u4e00\u4e2aService\u53ef\u4ee5\u770b\u4f5c\u4e00\u7ec4\u63d0\u4f9b\u76f8\u540c\u670d\u52a1\u7684Pod\u7684\u5bf9\u5916\u8bbf\u95ee\u63a5\u53e3\uff0cService\u4f5c\u7528\u4e8e\u54ea\u4e9bPod\u662f\u53ef\u4ee5\u901a\u8fc7\u6807\u7b7e\u9009\u62e9\u5668\u6765\u5b9a\u4e49\u3002</p>"},{"location":"01.basic/02-conception/#ingress","title":"\u516d\u3001Ingress","text":"<p>Ingress\u662fk8s\u96c6\u7fa4\u91cc\u5de5\u4f5c\u5728OSI\u7f51\u7edc\u53c2\u8003\u6a21\u578b\u4e0b\uff0c\u7b2c7\u5c42\u7684\u5e94\u7528\u5bf9\u5916\u66b4\u9732\u7684\u63a5\u53e3\u3002Service\u53ea\u80fd\u8fdb\u884cL4\u6d41\u91cf\u8c03\u5ea6\uff0c\u8868\u73b0\u5f62\u5f0f\u662fip+Port\u3002Ingress\u5219\u53ef\u4ee5\u8c03\u5ea6\u4e0d\u540c\u7684\u4e1a\u52a1\u57df\u3001\u4e0d\u540cURL\u8bbf\u95ee\u8def\u5f84\u7684\u4e1a\u52a1\u6d41\u91cf\u3002</p>"},{"location":"01.basic/03-compoents/","title":"k8s\u4e2d\u7684\u6838\u5fc3\u7ec4\u4ef6","text":""},{"location":"01.basic/03-compoents/#master-node","title":"\u4e00\u3001\u4e3b\u63a7\u5236\u8282\u70b9(master node)","text":""},{"location":"01.basic/03-compoents/#11-apiserver","title":"1.1 apiserver","text":"<p>\u7528\u4e8e\u63a5\u6536\u5ba2\u6237\u7aef\u64cd\u4f5ck8s\u7684\u6307\u4ee4\u3002\u63d0\u4f9b\u4e86REST API\u63a5\u53e3\uff0c\u5305\u62ec\u9274\u6743\u3001\u6570\u636e\u6821\u9a8c\u3001\u96c6\u7fa4\u72b6\u6001\u53d8\u66f4\u7b49\u3002\u8d1f\u8d23\u5404\u4e2a\u6a21\u5757\u4e4b\u95f4\u7684\u6570\u636e\u4ea4\u4e92\uff0c\u627f\u62c5\u901a\u4fe1\u67a2\u7ebd\u529f\u80fd\u3002\u4f5c\u4e3a\u8d44\u6e90\u914d\u989d\u63a7\u5236\u7684\u5165\u53e3\uff0c\u540c\u65f6\u63d0\u4f9b\u4e86\u5b8c\u6574\u7684\u96c6\u7fa4\u5b89\u5168\u673a\u5236\u3002</p>"},{"location":"01.basic/03-compoents/#12-schduler","title":"1.2 schduler","text":"<p>\u4e3b\u8981\u662f\u8c03\u5ea6pod\u5230\u9002\u5408\u7684\u8fd0\u7b97\u8282\u70b9\u4e0a\uff0c\u901a\u8fc7\u9884\u7b97\u7b56\u7565\uff08predict\uff09\u548c\u4f18\u9009\u7b56\u7565\uff08priorities\uff09\u7b49\u8c03\u5ea6\u6700\u5408\u9002\u7684\u8282\u70b9\u53bb\u8fd0\u884cpod\u3002</p>"},{"location":"01.basic/03-compoents/#13-controller-manger","title":"1.3 controller manger","text":"<p>\u5411worker\u8282\u70b9\u7684kubelet\u7ec4\u4ef6\u53d1\u9001\u6307\u4ee4\u3002\u7531\u4e00\u7ec4\u63a7\u5236\u5668\u7ec4\u6210\uff0c\u901a\u8fc7apiserver\u76d1\u63a7\u6574\u4e2a\u96c6\u7fa4\u7684\u72b6\u6001\uff0c\u5e76\u786e\u4fdd\u96c6\u7fa4\u5904\u4e8e\u9884\u671f\u7684\u5de5\u4f5c\u72b6\u6001\uff0c\u5e38\u89c1\u7684\u63a7\u5236\u5668\u5982\u4e0b</p> <ul> <li><code>Node Controller</code></li> <li><code>Deployment Controller</code></li> <li><code>Service Controller</code></li> <li><code>Volume Controller</code></li> <li><code>Endpoint Controller</code></li> <li><code>Barbage Controller</code></li> <li><code>Namespace Controller</code></li> <li><code>Job Controller</code></li> <li><code>Resurce quta Controller</code></li> </ul>"},{"location":"01.basic/03-compoents/#worker-node","title":"\u4e8c\u3001\u5de5\u4f5c\u8282\u70b9(worker node)","text":""},{"location":"01.basic/03-compoents/#21-kubenet","title":"2.1 kubenet","text":"<ul> <li> <p>\u8d1f\u8d23\u5411\u5bb9\u5668\u5f15\u64ce\uff08\u672c\u7cfb\u5217\u6587\u7ae0\u7279\u6307docker\uff09\u53d1\u9001\u6307\u4ee4\u8fdb\u884c\u5bb9\u5668\u8c03\u5ea6\uff1akubelet\u7684\u4e3b\u8981\u529f\u80fd\u5c31\u662f\u5b9a\u65f6\u4ece\u67d0\u4e2a\u5730\u65b9\u83b7\u53d6\u8282\u70b9\u4e0aPod\u7684\u671f\u671b\u72b6\u6001\uff08\u8fd0\u884c\u7684\u5bb9\u5668\u3001\u8fd0\u884c\u7684\u526f\u672c\u6570\u3001\u7f51\u7edc\u914d\u7f6e\u3001\u5b58\u50a8\u914d\u7f6e\u7b49\uff09\uff0c\u5e76\u8c03\u7528\u5bf9\u5e94\u7684\u5bb9\u5668\u5f15\u64ce\u63a5\u53e3\u8fbe\u5230\u8fd9\u4e2a\u72b6\u6001\u3002</p> </li> <li> <p>\u8d1f\u8d23\u5b9a\u65f6\u6c47\u62a5\u5f53\u524d\u8282\u70b9\u7684\u72b6\u6001\u7ed9 <code>apiserver</code> \uff0c\u4ee5\u4f9b\u8c03\u5ea6\u7684\u65f6\u5019\u4f7f\u7528\u3002</p> </li> <li> <p>\u8d1f\u8d23\u955c\u50cf\u548c\u5bb9\u5668\u7684\u6e05\u7406\u5de5\u4f5c\uff0c\u4fdd\u8bc1\u8282\u70b9\u4e0a\u7684\u955c\u50cf\u4e0d\u4f1a\u5360\u6ee1\u78c1\u76d8\u7a7a\u95f4\uff0c\u9000\u51fa\u7684\u5bb9\u5668\u4e0d\u4f1a\u5360\u7528\u592a\u591a\u8d44\u6e90\u3002</p> </li> </ul>"},{"location":"01.basic/03-compoents/#22-kube-proxy","title":"2.2 kube-proxy","text":"<p>\u4f5c\u4e3aservice\u8d44\u6e90\u7684\u8f7d\u4f53\uff0c\u8c03\u5ea6\u5bb9\u5668\u7684\u7f51\u7edc\uff0c\u5efa\u7acb\u4e86Pod\u7f51\u7edc\u548c\u96c6\u7fa4\u7f51\u7edc\u7684\u5173\u7cfb\uff08clusterip -&gt; podip\uff09\u3002\u5e38\u7528\u7684\u4e09\u79cd\u6d41\u91cf\u8c03\u5ea6\u6a21\u5f0f\uff1aUserspace\uff08\u5df2\u5e9f\u5f03\uff09\u3001Iptables\uff08\u6fd2\u4e34\u5e9f\u5f03\uff09\u3001Ipvs\uff08\u63a8\u8350\uff09\u3002</p> <p>\u8d1f\u8d23\u5efa\u7acb\u3001\u5220\u9664\u3001\u66f4\u65b0\u8c03\u5ea6\u89c4\u5219\uff0c\u901a\u77e5apiserver\u81ea\u5df1\u7684\u66f4\u65b0\uff0c\u6216\u8005\u4eceapiserver\u83b7\u53d6\u5176\u4ed6kube-proxy\u7684\u8c03\u5ea6\u89c4\u5219\u53d8\u5316\u6765\u66f4\u65b0\u81ea\u5df1\u7684\u89c4\u5219\u3002</p>"},{"location":"01.basic/03-compoents/#cli","title":"\u4e09\u3001CLI\u5ba2\u6237\u7aef","text":""},{"location":"01.basic/03-compoents/#31-kubectl","title":"3.1 kubectl","text":"<p>kubectl\u662f\u4e00\u4e2a\u7528\u4e8e\u64cd\u4f5ckubernetes\u96c6\u7fa4\u7684\u547d\u4ee4\u884c\u63a5\u53e3\uff0c\u901a\u8fc7\u5229\u7528kubectl\u7684\u5404\u79cd\u547d\u4ee4\u53ef\u4ee5\u5b9e\u73b0\u5404\u79cd\u529f\u80fd\u3002</p>"},{"location":"01.basic/03-compoents/#_1","title":"\u56db\u3001\u6838\u5fc3\u9644\u4ef6","text":"<ul> <li><code>CNI\u7f51\u7edc\u63d2\u4ef6</code>: flannel/calico</li> <li><code>\u670d\u52a1\u53d1\u73b0\u63d2\u4ef6</code>: coredns</li> <li><code>\u670d\u52a1\u66b4\u9732\u63d2\u4ef6</code>: traefik</li> <li><code>GUI\u7ba1\u7406\u63d2\u4ef6</code>: Dashboard</li> </ul>"},{"location":"01.basic/04-yaml/","title":"k8s\u8d44\u6e90\u6e05\u5355\u6587\u4ef6","text":""},{"location":"01.basic/04-yaml/#_1","title":"\u4e00\u3001\u6982\u8ff0","text":"<p>\u5728k8s\u4e2d\uff0c\u4e00\u822c\u4f7f\u7528yaml\u683c\u5f0f\u7684\u6587\u4ef6\u6765\u5b9a\u4e49\u7b26\u5408\u6211\u4eec\u9884\u671f\u7684Pod\uff0c\u8fd9\u6837\u7684yaml\u6587\u4ef6\u88ab\u79f0\u4e3a\u8d44\u6e90\u6e05\u5355\u6587\u4ef6</p>"},{"location":"01.basic/04-yaml/#_2","title":"\u4e8c\u3001\u5e38\u7528\u5b57\u6bb5","text":"\u5b57\u6bb5\u540d \u7c7b\u578b \u8bf4\u660e version String k8s\u7684api\u7684\u7248\u672c\uff0c\u76ee\u524d\u57fa\u672c\u4e0a\u662fv1\uff0c\u53ef\u4ee5\u4f7f\u7528<code>kubectl api-versions</code>\u547d\u4ee4\u67e5\u770b kind String \u6307\u5b9a\u6587\u4ef6\u5b9a\u4e49\u7684\u8d44\u6e90\u7c7b\u578b\u548c\u89d2\u8272\uff0c\u6bd4\u5982\uff1apod metadata Object \u5143\u6570\u636e\u5bf9\u8c61 metadata.name String \u5143\u6570\u636e\u5bf9\u8c61\u540d\u79f0\uff0c\u7531\u6211\u4eec\u81ea\u5b9a\u4e49\u3002\u6bd4\u5982\u662f\u8d44\u6e90\u7c7b\u578b\u662fpod\uff0c\u6211\u4eec\u5728\u8fd9\u91cc\u53ef\u4ee5\u5b9a\u4e49pod\u7684\u540d\u79f0 metadata.namespace String \u5143\u6570\u636e\u5bf9\u8c61\u547d\u540d\u7a7a\u95f4\uff0c\u7531\u6211\u4eec\u81ea\u5b9a\u4e49 Spec Object \u8be6\u7ec6\u5b9a\u4e49\u5bf9\u8c61 spec.containers[] List Spec\u5bf9\u8c61\u7684\u5bb9\u5668\u5217\u8868 spec.containers[$index].name String \u5b9a\u4e49\u5bb9\u5668\u7684\u540d\u79f0 spec.containers[$index].image String \u5b9a\u4e49\u5bb9\u5668\u7684\u955c\u50cf\u540d\u79f0 spec.containers[$index].imagePullPolicy String \u5b9a\u4e49\u955c\u50cf\u62c9\u53d6\u7b56\u7565\uff0c\u6709Always\uff08\u6bcf\u6b21\u90fd\u5c1d\u8bd5\u62c9\u53d6\u65b0\u955c\u50cf\uff09\u3001Never\uff08\u4ec5\u4f7f\u7528\u672c\u5730\u955c\u50cf\uff09\u3001Ifnotpresent\uff08\u672c\u5730\u6709\u955c\u50cf\u5219\u4e0d\u62c9\u53d6\u65b0\u955c\u50cf\uff09\u4e09\u4e2a\u503c\u53ef\u9009 spec.containers[$index].command[] List \u6307\u5b9a\u5bb9\u5668\u542f\u52a8\u547d\u4ee4\uff0c\u56e0\u4e3a\u662f\u6570\u7ec4\u53ef\u4ee5\u6307\u5b9a\u591a\u4e2a\uff0c\u4e0d\u6307\u5b9a\u5219\u4f7f\u7528\u955c\u50cf\u6253\u5305\u65f6\u7684\u542f\u52a8\u547d\u4ee4 spec.containers[$index].args List \u6307\u5b9a\u5bb9\u5668\u542f\u52a8\u547d\u4ee4\u53c2\u6570\uff0c\u56e0\u4e3a\u662f\u6570\u7ec4\u53ef\u4ee5\u6307\u5b9a\u591a\u4e2a spec.containers[$index].workDir String \u6307\u5b9a\u5bb9\u5668\u7684\u5de5\u4f5c\u76ee\u5f55 spec.containers[$index].volumeMounts[] List \u6307\u5b9a\u5bb9\u5668\u5185\u90e8\u7684\u5b58\u50a8\u5377\u914d\u7f6e spec.containers[\\(index].volumeMounts[\\)subIndex].name String \u6307\u5b9a\u5bb9\u5668\u52a0\u8f7d\u7684\u5b58\u50a8\u5377\u7684\u540d\u79f0 spec.containers[\\(index].volumeMounts[\\)subIndex].mountPath String \u6307\u5b9a\u5bb9\u5668\u52a0\u8f7d\u7684\u5b58\u50a8\u5377\u7684\u8def\u5f84 spec.containers[\\(index].volumeMounts[\\)subIndex].readOnly String \u8bbe\u7f6e\u5b58\u50a8\u5377\u7684\u8bfb\u5199\u6a21\u5f0f\uff0ctrue\u6216\u8005false\uff0c\u9ed8\u8ba4\u4e3a\u8bfb\u5199\u6a21\u5f0f\uff0c\u53ef\u4ee5\u4f7f\u7528true\u4ee3\u8868\u53ea\u8bfb\u6a21\u5f0f spec.containers[$index].ports[] String \u6307\u5b9a\u5bb9\u5668\u9700\u8981\u7528\u5230\u7684\u7aef\u53e3\u5217\u8868 spec.containers[\\(index].ports[\\)subIndex].name String \u6307\u5b9a\u7684\u7aef\u53e3\u540d\u79f0 spec.containers[\\(index].ports[\\)subIndex].containerPort String \u6307\u5b9a\u5bb9\u5668\u9700\u8981\u76d1\u542c\u7684\u7aef\u53e3\u53f7 spec.containers[\\(index].ports[\\)subIndex].hostPort String \u6307\u5b9a\u5bb9\u5668\u6240\u5728\u4e3b\u673a\u9700\u8981\u76d1\u542c\u7684\u7aef\u53e3\u53f7\uff0c\u9ed8\u8ba4\u8ddfcontainerPort\u76f8\u540c\uff0c\u6ce8\u610f\uff1a\u8bbe\u7f6e\u4e86hostPort\u540c\u4e00\u53f0\u4e3b\u673a\u65e0\u6cd5\u542f\u52a8\u8be5\u5bb9\u5668\u7684\u76f8\u540c\u526f\u672c\uff0c\u56e0\u4e3a\u4e3b\u673a\u7684\u7aef\u53e3\u4e0d\u80fd\u76f8\u540c\uff0c\u8fd9\u6837\u4f1a\u51b2\u7a81 spec.containers[\\(index].ports[\\)subIndex].protocol String \u6307\u5b9a\u7aef\u53e3\u534f\u8bae\uff0c\u652f\u6301TCP\u548cUDP\uff0c\u9ed8\u8ba4\u503c\u4e3aTCP spec.containers[\\(index].ports[\\)subIndex].env[] List \u6307\u5b9a\u5bb9\u5668\u8fd0\u884c\u524d\u9700\u8bbe\u7684\u73af\u5883\u53d8\u91cf\u5217\u8868 spec.containers[\\(index].ports[\\)subIndex].env[$secSubIndex].name List \u6307\u5b9a\u73af\u5883\u53d8\u91cf\u540d\u79f0 spec.containers[\\(index].ports[\\)subIndex].env[$secSubIndex].value List \u6307\u5b9a\u73af\u5883\u53d8\u91cf\u503c spec.containers[\\(index].ports[\\)subIndex].resources Object \u6307\u5b9a\u8d44\u6e90\u9650\u5236\u548c\u8d44\u6e90\u8bf7\u6c42\u7684\u503c\uff08\u8fd9\u91cc\u5f00\u59cb\u5c31\u662f\u8bbe\u7f6e\u8d44\u6e90\u7684\u4e0a\u9650\uff09 spec.containers[\\(index].ports[\\)subIndex].resources.limits Object \u6307\u5b9a\u5bb9\u5668\u8fd0\u884c\u65f6\u8d44\u6e90\u7684\u8fd0\u884c\u4e0a\u9650 spec.containers[\\(index].ports[\\)subIndex].resources.limits.cpu String \u6307\u5b9aCPU\u9650\u5236\uff0c\u5355\u4f4d\u4e3acore\u6570\uff0c\u5c06\u7528\u4e8e<code>docker run --cpu-shares</code>\u53c2\u6570 spec.containers[\\(index].ports[\\)subIndex].resources.limits.memory String \u6307\u5b9aMEM\u5185\u5b58\u9650\u5236\uff0c\u5355\u4f4d\u4e3aMiB\u3001GiB spec.containers[\\(index].ports[\\)subIndex].resources.requests Objects \u6307\u5b9a\u5bb9\u5668\u542f\u52a8\u548c\u8c03\u5ea6\u65f6\u8d44\u6e90\u9700\u6c42\u8bbe\u7f6e spec.containers[\\(index].ports[\\)subIndex].resources.requests.cpu String CPU\u9700\u6c42\u4e2a\u6570\uff0c\u5355\u4f4d\u4e3acore \u6570\uff0c\u5bb9\u5668\u542f\u52a8\u65f6\u521d\u59cb\u5316\u6570\u91cf spec.containers[\\(index].ports[\\)subIndex].resources.requests.memory String \u5185\u5b58\u9700\u6c42\uff0c\u5355\u4f4d\u4e3aMiB\u3001GiB\uff0c\u5bb9\u5668\u542f\u52a8\u65f6\u521d\u59cb\u5316\u91cf spec.restartPolicy String \u5b9a\u4e49Pod\u7684\u91cd\u542f\u7b56\u7565\uff0cAlways\uff08\u9ed8\u8ba4\uff0c\u4e00\u65e6\u7ec8\u6b62\u8fd0\u884c\uff0c\u5219\u65e0\u8bba\u5bb9\u5668\u4f55\u65f6\u7ec8\u6b62\u7684\uff0ckubelet\u670d\u52a1\u5c06\u91cd\u542f\u5b83\uff09\u3001OnFailure\uff08\u53ea\u6709Pod\u4ee5\u975e\u96f6\u9000\u51fa\u7801\u7ec8\u6b62\u65f6\uff0ckubelet\u624d\u4f1a\u91cd\u542f\u8be5\u5bb9\u5668\uff0c\u5982\u679c\u5bb9\u5668\u6b63\u5e38\u7ed3\u675f\u9000\u51fa\u7801\u4e3a0\uff09\u3001Never\uff1aPod\u7ec8\u6b62\u540e\uff0ckubelet\u5c06\u9000\u51fa\u7801\u62a5\u544a\u7ed9Master\uff0c\u4e0d\u4f1a\u91cd\u542f\u670d\u52a1\u8be5Pod spec.imagePullSecrets Object \u5b9a\u4e49Pull\u955c\u50cf\u65f6\u4f7f\u7528secret\u540d\u79f0\uff0c\u4ee5name: secretKey\u683c\u5f0f\u6307\u5b9a spec.hostNetwork Boolean \u5b9a\u4e49\u662f\u5426\u4f7f\u7528\u4e3b\u673a\u7f51\u7edc\u6a21\u5f0f\uff0c\u9ed8\u8ba4\u4e3a false\u3002\u8bbe\u7f6etrue\u8868\u793a\u4f7f\u7528\u5bbf\u4e3b\u673a\u7f51\u7edc\uff0c\u4e0d\u662f\u7528docker\u7f51\u6865\uff0c\u540c\u65f6\u8bbe\u7f6e\u4e86true\u5c06\u65e0\u6cd5\u5728\u540c\u4e00\u53f0\u5bbf\u4e3b\u673a\u4e0a\u542f\u52a8\u7b2c\u4e8c\u4e2a\u526f\u672c"},{"location":"01.basic/04-yaml/#_3","title":"\u4e09\u3001\u793a\u4f8b","text":""},{"location":"01.basic/04-yaml/#31-namespace","title":"3.1 \u5b9a\u4e49\u4e00\u4e2anamespace","text":"<pre><code>apiVersion: v1\nkind: Namespace\nmetadata:\nname: test\n</code></pre>"},{"location":"01.basic/04-yaml/#32-pod","title":"3.2 \u5b9a\u4e49\u4e00\u4e2apod","text":"<pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: pod1\nspec:\ncontainers:\n- name: nginx-containers\nimage: nginx:latest\n</code></pre>"},{"location":"01.basic/05-namespace/","title":"k8s\u540d\u79f0\u7a7a\u95f4","text":""},{"location":"01.basic/05-namespace/#_1","title":"\u4e00\u3001\u6982\u8ff0","text":"<p>\u672c\u6587\u76ee\u6807\u5982\u4e0b</p> <ul> <li>\u4e86\u89e3namespace\u7684\u4f5c\u7528</li> <li>\u638c\u63e1namespace\u67e5\u770b\u65b9\u6cd5</li> <li>\u638c\u63e1namespace\u521b\u5efa\u65b9\u6cd5</li> <li>\u638c\u63e1namespace\u5220\u9664\u65b9\u6cd5</li> </ul> <p>\u5047\u8bbe\u9700\u8981\u51c6\u5907\u4e24\u5957k8s\u96c6\u7fa4\u7528\u4e8e\u5f00\u53d1\u6d4b\u8bd5\u548c\u9884\u53d1\u5e03\u73af\u5883\uff0c\u4f46\u662f\u7531\u4e8e\u9879\u76ee\u7ec4\u53ef\u7528\u4e3b\u673a\u8d44\u6e90\u6709\u9650\uff0c\u6ca1\u6709\u90a3\u4e48\u591a\u4e3b\u673a\u53ef\u7528\uff0c\u4e0d\u80fd\u6ee1\u8db3k8s\u96c6\u7fa4\u7684\u8981\u6c42\u3002\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528k8s\u96c6\u7fa4\u4e2d\u7684namespace\uff08\u540d\u79f0\u7a7a\u95f4\uff09\u5373\u53ef\u5b9e\u73b0\u5f00\u53d1\u6d4b\u8bd5\u548c\u9884\u53d1\u5e03\u73af\u5883\u7684\u9694\u79bb\u3002</p>"},{"location":"01.basic/05-namespace/#_2","title":"\u4e8c\u3001\u67e5\u770b\u540d\u79f0\u7a7a\u95f4","text":"<pre><code>kubectl get namespace\n# \u6216\u8005\nkubectl get ns\n</code></pre> <p>\u8fd4\u56de\u5185\u5bb9\u5982\u4e0b</p> <pre><code>NAME              STATUS   AGE\ndefault           Active   14h\nkube-node-lease   Active   14h\nkube-public       Active   14h\nkube-system       Active   14h\n</code></pre> <p>\u7cfb\u7edf\u9ed8\u8ba4\u540d\u79f0\u7a7a\u95f4\u5982\u4e0b</p> <ul> <li><code>default</code>: \u7528\u6237\u521b\u5efa\u7684pod\u9ed8\u8ba4\u5728\u6b64\u540d\u79f0\u7a7a\u95f4</li> <li><code>kube-public</code>: \u6240\u6709\u7528\u6237\u5747\u53ef\u8bbf\u95ee\uff0c\u5305\u62ec\u672a\u8ba4\u8bc1\u7528\u6237</li> <li><code>kube-node-lease</code>: kubernetes\u96c6\u7fa4\u8282\u70b9\u79df\u7ea6\u72b6\u6001\u5728\u6b64\u4f7f\u7528\uff0cv1.13\u52a0\u5165</li> <li><code>kube-system</code>: kubernetes\u96c6\u7fa4\u6240\u6709\u7ec4\u4ef6\u5728\u6b64\u8fd0\u884c</li> </ul> <p>\u6839\u636e\u540d\u79f0\u7a7a\u95f4\u67e5\u770bpod</p> <pre><code>kubectl get pods --namespace kube-system\n</code></pre>"},{"location":"01.basic/05-namespace/#_3","title":"\u4e09\u3001\u521b\u5efa\u540d\u79f0\u7a7a\u95f4","text":"<p>\u901a\u8fc7\u547d\u4ee4\u521b\u5efa\u540d\u79f0\u7a7a\u95f4</p> <pre><code>kubectl create namespace test\n</code></pre> <p>\u901a\u8fc7\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u521b\u5efa\u540d\u79f0\u7a7a\u95f4</p> <pre><code>touch 01-create-ns.yaml\n</code></pre> <p>\u5728\u6587\u4ef6\u4e2d\u5b9a\u4e49\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>apiVersion: v1\nkind: Namespace\nmetadata:\nname: test2\n</code></pre> <p>\u5e94\u7528\u8d44\u6e90</p> <pre><code>kubectl apply -f 01-create-ns.yaml\n</code></pre>"},{"location":"01.basic/05-namespace/#_4","title":"\u56db\u3001\u5220\u9664\u540d\u79f0\u7a7a\u95f4","text":"<p>\u901a\u8fc7\u540d\u79f0\u5220\u9664\u540d\u79f0\u7a7a\u95f4</p> <pre><code># \u5220\u9664test1\u540d\u79f0\u7a7a\u95f4\nkubectl delete namespace test1\n</code></pre> <p>\u901a\u8fc7\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5220\u9664\uff0c\u5b9a\u4e49\u5185\u5bb9\u548c\u521b\u5efa\u5185\u5bb9\u4e00\u81f4\uff0c\u5982\u201c\u4e09\u201d\u4e2d\u5b9a\u4e49\u4e86\u540d\u4e3a<code>test2</code>\u7684namespace\uff0c\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u8fdb\u884c\u5220\u9664</p> <pre><code>kubectl delete -f 01-create-ns.yaml\n</code></pre>"},{"location":"01.basic/06-pod/","title":"pod\u7684\u76f8\u5173\u64cd\u4f5c","text":""},{"location":"01.basic/06-pod/#_1","title":"\u4e00\u3001\u6982\u8ff0","text":"<p>k8s\u662f\u4e0d\u80fd\u76f4\u63a5\u8fd0\u884c\u7a0b\u5e8f\u7684\uff0ck8s\u96c6\u7fa4\u4e2d\u6700\u5c0f\u7684\u8c03\u5ea6\u5355\u5143\u4e3apod\uff0cPod\u662f\u5bb9\u5668\u7684\u5c01\u88c5\u3002\u56e0\u6b64\u6211\u4eec\u9700\u8981\u4f7f\u7528Pod\u6765\u8fd0\u884c\u5e94\u7528\u7a0b\u5e8f</p> <p>\u672c\u671f\u76ee\u6807</p> <ul> <li>\u67e5\u770bPod</li> <li>\u521b\u5efaPod</li> <li>Pod\u8bbf\u95ee</li> <li>\u5220\u9664Pod</li> </ul>"},{"location":"01.basic/06-pod/#pod_1","title":"\u4e8c\u3001\u67e5\u770bPod","text":"<p>\u9ed8\u8ba4\u67e5\u8be2default\u547d\u540d\u7a7a\u95f4\u4e2d\u7684Pod</p> <pre><code>kubectl get pod\n# \u6216\nkubectl get pods\n</code></pre> <p>\u67e5\u770b\u6307\u5b9a\u547d\u540d\u7a7a\u95f4\u7684Pod</p> <pre><code>kubectl get pods --namespace default\n# \u6216\nkubectl get pods -n default\n</code></pre> <p>\u67e5\u770b\u6240\u6709\u547d\u540d\u7a7a\u95f4\u7684Pod</p> <pre><code>kubectl get pods --all-namespaces\n</code></pre>"},{"location":"01.basic/06-pod/#pod_2","title":"\u4e09\u3001\u521b\u5efaPod","text":"<p>\u7f16\u5199\u7528\u4e8e\u521b\u5efaPod\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6<code>create-pod.yaml</code>\uff0c\u5b9a\u4e49\u5982\u4e0b\u5185\u5bb9</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: pod1\nspec:\ncontainers:\n- name: nginx-pod\nimage: nginx:latest\nimagePullPolicy: IfNotPresent\nports:\n- name: nginxport\ncontainerPort: 80\n</code></pre> <p>\u6267\u884c<code>apply</code>\u6307\u4ee4\uff0c\u5c06\u4f1a\u5728\u9ed8\u8ba4\u547d\u540d\u7a7a\u95f4\u521b\u5efaPod</p> <pre><code>kubectl apply -f create-pod.yaml\n</code></pre> <p>\u8981\u67e5\u770bPod\u5728\u54ea\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4</p> <pre><code>kubectl get pods -o wide\n</code></pre> <p>\u672c\u6b21\u521b\u5efa\u4e86nginx\uff0c\u6240\u4ee5\u53ef\u4ee5\u4f7f\u7528\u8bbf\u95eePod\u7684IP\u8fdb\u884c\u9a8c\u8bc1\u3002</p> <pre><code>curl http://10.244.1.2\n</code></pre>"},{"location":"01.basic/06-pod/#pod_3","title":"\u56db\u3001\u8bbf\u95eePod","text":"<p>\u6839\u636ePod\u540d\u79f0\u8fdb\u5165\u5230\u5bf9\u5e94Pod\u4e2d\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code># \u8fdb\u5165bash\nkubectl exec -it pod1 -- bash\n# \u9000\u51fa bash\nexit\n</code></pre>"},{"location":"01.basic/06-pod/#pod_4","title":"\u4e94\u3001\u5220\u9664Pod","text":"<p>\u4f7f\u7528\u547d\u4ee4\u5220\u9664Pod</p> <pre><code># \u9ed8\u8ba4\u5220\u9664default\u547d\u540d\u7a7a\u95f4\u4e0b\u7684pod1\nkubectl delete pods pod1\n# \u6216\u6307\u5b9a\u547d\u540d\u7a7a\u95f4\u5220\u9664\nkubectl delete pods pod1 -n default\n</code></pre> <p>\u4f7f\u7528\u8d44\u6e90\u6e05\u5355\u6267\u884c\u5220\u9664</p> <pre><code>kubectl delete -f create-pod.yaml\n</code></pre>"},{"location":"01.basic/07-controller/","title":"Controller","text":""},{"location":"01.basic/07-controller/#_1","title":"\u4e00\u3001\u6982\u8ff0","text":"<p>Pod\u662f\u53ef\u4ee5\u76f4\u63a5\u5220\u9664\u7684\uff0c\u5982\u679c\u751f\u4ea7\u8fc7\u7a0b\u4e2d\u8bef\u64cd\u4f5c\uff0cPod\u540c\u6837\u4e5f\u4f1a\u88ab\u8f7b\u6613\u5220\u9664\uff0c\u56e0\u6b64\u6211\u4eec\u9700\u8981\u5728k8s\u96c6\u7fa4\u4e2d\u5f15\u5165\u53e6\u4e00\u79cd\u6982\u5ff5\uff1a\u63a7\u5236\u5668\uff0c\u7528\u4e8e\u5728k8s\u96c6\u7fa4\u4e2d\u4ee5loop\u65b9\u5f0f\u76d1\u89c6Pod\u72b6\u6001\uff0c\u5982\u679c\u53d1\u73b0Pod\u88ab\u5220\u9664\uff0c\u5c06\u91cd\u65b0\u62c9\u8d77\u4e00\u4e2aPod\uff0c\u4ee5\u8ba9Pod\u4e00\u76f4\u4fdd\u6301\u5728\u7528\u6237\u671f\u671b\u72b6\u6001\u3002</p> <p>\u672c\u6587\u76ee\u6807</p> <ul> <li>\u4e86\u89e3Controller</li> <li>\u4e86\u89e3Controller\u5206\u7c7b</li> <li>\u4e86\u89e3Deployment\u63a7\u5236\u5668\u4f5c\u7528</li> <li>\u638c\u63e1\u521b\u5efaDeloypment\u63a7\u5236\u5668\u578b\u5e94\u7528\u65b9\u6cd5</li> <li>\u638c\u63e1\u5220\u9664Deployment\u63a7\u5236\u5668\u578b\u5e94\u7528\u65b9\u6cd5</li> </ul>"},{"location":"01.basic/07-controller/#_2","title":"\u4e8c\u3001\u76f8\u5173\u6982\u5ff5","text":""},{"location":"01.basic/07-controller/#21","title":"2.1 \u4ecb\u7ecd","text":"<ul> <li>Controller\u662fk8s\u96c6\u7fa4\u4e2d\u7684\u63a7\u5236\u5668\u7ec4\u4ef6</li> <li>\u7528\u4e8e\u5bf9\u5e94\u7528\u8fd0\u884c\u7684\u8d44\u6e90\u5bf9\u8c61\u8fdb\u884c\u76d1\u63a7</li> <li>\u5f53Pod\u51fa\u73b0\u95ee\u9898\u65f6\uff0c\u4f1a\u628aPod\u91cd\u65b0\u62c9\u8d77\uff0c\u4ee5\u8fbe\u5230\u7528\u6237\u671f\u671b\u7684\u72b6\u6001</li> </ul>"},{"location":"01.basic/07-controller/#22","title":"2.2 \u5206\u7c7b","text":"<p>\u5e38\u89c1\u7684Pod\u63a7\u5236\u5668\u5206\u7c7b</p> <ul> <li> <p><code>Deployment</code>\uff1a\u58f0\u660e\u5f0f\u66f4\u65b0\u63a7\u5236\u5668\uff0c\u7528\u4e8e\u53d1\u5e03\u65e0\u72b6\u6001\u5e94\u7528</p> </li> <li> <p><code>ReplicaSet</code>\uff1a\u526f\u672c\u96c6\u63a7\u5236\u5668\uff0c\u7528\u4e8e\u5bf9Pod\u8fdb\u884c\u526f\u672c\u89c4\u6a21\u6269\u5927\u6216\u526a\u88c1</p> </li> <li> <p><code>StatefulSet</code>\uff1a\u6709\u72b6\u6001\u526f\u672c\u96c6\uff0c\u7528\u4e8e\u53d1\u5e03\u6709\u72b6\u6001\u5e94\u7528</p> </li> <li> <p><code>DaemonSet</code>\uff1a\u5728k8s\u96c6\u7fa4\u6bcf\u4e00\u4e2aNode\u4e0a\u8fd0\u884c\u4e00\u4e2a\u526f\u672c\uff0c\u7528\u4e8e\u53d1\u5e03\u76d1\u63a7\u6216\u65e5\u5fd7\u6536\u96c6\u7c7b\u7b49\u5e94\u7528</p> </li> <li> <p><code>Job</code>\uff1a\u8fd0\u884c\u4e00\u6b21\u6027\u4f5c\u4e1a\u4efb\u52a1</p> </li> <li> <p><code>CronJob</code>\uff1a\u8fd0\u884c\u5468\u671f\u6027\u4f5c\u4e1a\u4efb\u52a1</p> </li> </ul>"},{"location":"01.basic/07-controller/#_3","title":"\u4e09\u3001\u76f8\u5173\u64cd\u4f5c","text":""},{"location":"01.basic/07-controller/#31","title":"3.1 \u521b\u5efa","text":"<p>\u65b0\u7248\u672ck8s\u5df2\u7ecf\u542f\u7528\u547d\u4ee4\u521b\u5efa\uff0c\u6211\u4eec\u4f7f\u7528\u8d44\u6e90\u6587\u4ef6\u521b\u5efa\uff0c\u65b0\u5efa<code>create-deployment-nginx-app2.yaml</code>\u6587\u4ef6\uff0c\u5199\u5165\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\nname: nginx-app2\nlabels:\napp: nginx\nspec:\nreplicas: 1\nselector:\nmatchLabels:\napp: nginx\ntemplate:\nmetadata:\nlabels:\napp: nginx\nspec:\ncontainers:\n- name: nginxapp\nimage: nginx:latest\nimagePullPolicy: IfNotPresent\nports: - containerPort: 80\n</code></pre> <p>\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u8fdb\u884c\u521b\u5efa</p> <pre><code>kubectl apply -f create-deployment-nginx-app2.yaml\n</code></pre>"},{"location":"01.basic/07-controller/#32","title":"3.2 \u67e5\u770b","text":"<p>\u67e5\u770b\u521b\u5efa\u7684deployment</p> <pre><code>kubectl get deployment.apps\n</code></pre> <p>\u6216\u8005\u67e5\u770breplicas</p> <pre><code>kubectl get rs\n</code></pre> <p>\u6216\u901a\u8fc7\u67e5\u770bpod\u8be6\u60c5</p> <pre><code>kubectl get pods -o wide\n</code></pre>"},{"location":"01.basic/07-controller/#33","title":"3.3 \u5220\u9664","text":"<p>\u901a\u8fc7\u547d\u4ee4\u5220\u9664deployment\u63a7\u5236\u5668\u7c7b\u578b\u7684\u5e94\u7528</p> <pre><code>kubectl delete deployment.apps nginx-app2\n</code></pre> <p>\u901a\u8fc7\u8d44\u6e90\u6e05\u5355\u5220\u9664\uff0c\u5728\u201c3.1\u201d\u4e2d\u521b\u5efa\u7684\u5e94\u7528\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5220\u9664</p> <pre><code>kubectl delete -f create-deployment-nginx-app2.yaml\n</code></pre>"},{"location":"01.basic/08-service/","title":"Service","text":""},{"location":"01.basic/08-service/#_1","title":"\u4e00\u3001 \u6982\u8ff0","text":"<p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7Controller\u521b\u5efa\u5e94\u7528\uff0c\u53ef\u662f\u5f53\u6211\u4eec\u8bbf\u95ee\u5e94\u7528\u65f6\uff0c\u53d1\u73b0\u4e00\u4e2a\u95ee\u9898\uff0cPod\u7684\u72b6\u6001\u4e0d\u662f\u8ba4\u4e3a\u63a7\u5236\u7684\uff0cPod IP\u662f\u5728\u521b\u5efa\u7684\u65f6\u5019\u5206\u914d\u7684\u3002\u5047\u8bbePod\u88ab\u8bef\u5220\u9664\uff0c\u88abController\u91cd\u65b0\u62c9\u8d77\u4e00\u4e2a\u65b0\u7684Pod\u65f6\uff0c\u6211\u4eec\u53d1\u73b0Pod IP\u662f\u53d8\u5316\u7684\u3002\u5982\u679c\u8bbf\u95ee\u5fc5\u987b\u66f4\u6362IP\u5730\u5740\uff0c\u8fd9\u6837\u5bf9\u4e8e\u5927\u91cfPod\u8fd0\u884c\u5e94\u7528\u6765\u8bf4\uff0c\u6211\u4eec\u5bf9Pod\u5b8c\u5168\u65e0\u6cd5\u63a7\u5236\uff0c\u56e0\u6b64\u5728k8s\u96c6\u7fa4\u4e2d\u6211\u4eec\u5f15\u5165\u53e6\u4e00\u4e2a\u65b0\u7684\u6982\u5ff5\uff1aService</p> <p>\u672c\u671f\u76ee\u6807</p> <ul> <li>\u4e86\u89e3Service\u7684\u4f5c\u7528</li> <li>\u4e86\u89e3Serivce\u7684\u7c7b\u578b</li> <li>Serivce\u53c2\u6570</li> <li>Service\u521b\u5efa\u65b9\u6cd5</li> <li>Service\u5220\u9664\u65b9\u6cd5</li> </ul>"},{"location":"01.basic/08-service/#_2","title":"\u4e8c\u3001\u76f8\u5173\u6982\u5ff5","text":""},{"location":"01.basic/08-service/#21-service","title":"2.1 Service\u6982\u5ff5","text":"<ul> <li>Serivice\u4e0d\u662f\u4e00\u4e2a\u5b9e\u4f53\u670d\u52a1\uff0cService\u662f\u4e00\u6761iptables\u6216ipvs\u7684\u8f6c\u53d1\u89c4\u5219</li> <li>\u901a\u8fc7Service\u4e3aPod\u5ba2\u6237\u7aef\u63d0\u4f9b\u8bbf\u95eePod\u65b9\u6cd5\uff08\u5373\u5ba2\u6237\u7aef\u8bbf\u95eePod\u5165\u53e3\uff09\uff0cService\u901a\u8fc7Pod\u6807\u7b7e\u4e0ePod\u8fdb\u884c\u5173\u8054</li> </ul>"},{"location":"01.basic/08-service/#22-service","title":"2.2 Service\u7c7b\u578b","text":"<p><code>ClusterIP</code>: \u9ed8\u8ba4\uff0c\u5206\u914d\u4e00\u4e2a\u96c6\u7fa4\u5185\u90e8\u53ef\u4ee5\u8bbf\u95ee\u7684\u865a\u62dfIP</p> <p><code>NodePort</code>: \u5728\u6bcf\u4e2aNode\u4e0a\u5206\u914d\u4e00\u4e2a\u7aef\u53e3\u4f5c\u4e3a\u5916\u90e8\u8bbf\u95ee\u5165\u53e3</p> <p><code>LoadBalancer</code>: \u5de5\u4f5c\u5728\u5f85\u5b9a\u7684Cloud Provider\u4e0a\uff0c\u4f8b\u5982 Google Cloud\uff0cAWS\uff0cOpenStack</p> <p><code>ExternalName</code>: \u8868\u793a\u628a\u96c6\u7fa4\u5916\u90e8\u7684\u670d\u52a1\u5f15\u5165\u5230\u96c6\u7fa4\u5185\u90e8\u4e2d\u6765\uff0c\u5373\u5b9e\u73b0\u96c6\u7fa4\u5185\u90e8Pod\u548c\u96c6\u7fa4\u5916\u90e8\u7684\u670d\u52a1\u8fdb\u884c\u901a\u4fe1</p>"},{"location":"01.basic/08-service/#23-service","title":"2.3 Service\u53c2\u6570","text":"<p>\u5e38\u7528\u7aef\u53e3\u53c2\u6570</p> <ul> <li>port: \u8bbf\u95eeService\u4f7f\u7528\u7684\u7aef\u53e3</li> <li>targetPort: Pod\u4e2d\u5bb9\u5668\u7aef\u53e3</li> <li>NodePort: \u901a\u8fc7Node\u5b9e\u73b0\u5916\u7f51\u7528\u6237\u8bbf\u95eek8s\u96c6\u7fa4\u5185\u90e8Service\uff0830000-32767\uff09</li> </ul>"},{"location":"01.basic/08-service/#service_1","title":"\u4e09\u3001Service\u7684\u521b\u5efa","text":""},{"location":"01.basic/08-service/#31-service","title":"3.1 \u901a\u8fc7\u547d\u4ee4\u521b\u5efaService","text":"<p>\u5148\u521b\u5efadeployment\u5e94\u7528\uff0c\u7136\u540e\u521b\u5efaService\u4e0eDeployment\u5e94\u7528\u5173\u8054\uff0c\u67e5\u770bdeployment\u5e94\u7528\uff1a<code>kubectl get deployment.apps</code>\uff0c\u8fd4\u56de\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>NAME         READY   UP-TO-DATE   AVAILABLE   AGE\nnginx-app2   1/1     1            1           7m43s\n</code></pre> <p>\u521b\u5efaService</p> <pre><code>kubectl expose deployment.apps nginx-app2 --type=ClusterIP --target-port=80 --port=80\n</code></pre> <p>\u67e5\u770b\u521b\u5efa\u7684Service</p> <pre><code>kubectl get service\n# \u6216\nkubectl get svc\n</code></pre> <p>\u8fd4\u56de\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE\nkubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP   24h\nnginx-app2   ClusterIP   10.104.130.50   &lt;none&gt;        80/TCP    6m58s\n</code></pre> <p>\u67e5\u770bService\u4e0ePod\u7684\u7aef\u70b9\u5173\u7cfb\uff0c\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4</p> <pre><code>kubectl get endpoints\n</code></pre> <p>\u8fd4\u56de\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>NAME         ENDPOINTS           AGE\nkubernetes   192.168.64.4:6443   24h\nnginx-app2   10.244.1.5:80       7m10s\n</code></pre>"},{"location":"01.basic/08-service/#32-service","title":"3.2 \u901a\u8fc7\u8d44\u6e90\u6e05\u5355\u521b\u5efaService","text":"<p>\u6211\u4eec\u5148\u5728\u8d44\u6e90\u6e05\u5355\u91cc\u5b9a\u4e49Deployment\u5e94\u7528\uff0c\u518d\u5b9a\u4e49Service\uff0c\u521b\u5efa<code>create-deployment-nginx-app-service.yaml</code>\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u5185\u5bb9\u5982\u4e0b</p> <pre><code>---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\nname: nginx-app\nspec:\nreplicas: 2\nselector:\nmatchLabels:\napps: nginx\ntemplate:\nmetadata:\nlabels:\napps: nginx\nspec:\ncontainers:\n- name: nginxapp\nimage: nginx:latest\nimagePullPolicy: IfNotPresent\nports:\n- containerPort: 80\n---\napiVersion: v1\nkind: Service\nmetadata:\nname: nginx-app2-svc\nspec:\ntype: ClusterIP\nports:\n- protocol: TCP\nport: 80\nselector:\napps: nginx\n</code></pre> <p>\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u6765\u521b\u5efa</p> <pre><code>kubectl apply -f create-deployment-nginx-app-service.yaml\n</code></pre>"},{"location":"01.basic/08-service/#33-nodeportservice","title":"3.3 \u901a\u8fc7\u8d44\u6e90\u6e05\u5355\u521b\u5efaNodePort\u7c7b\u578b\u7684Service","text":"<p>\u521b\u5efa<code>create-deployment-nginx-app3-service.yaml</code>\uff0c\u5b9a\u4e49\u5185\u5bb9\u5982\u4e0b</p> <pre><code>---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\nname: nginx-app3\nspec:\nreplicas: 2\nselector:\nmatchLabels:\napps: nginx-app3\ntemplate:\nmetadata:\nlabels:\napps: nginx-app3\nspec:\ncontainers:\n- name: nginxapp3\nimage: nginx:latest\nimagePullPolicy: IfNotPresent\nports:\n- containerPort: 80\n---\napiVersion: v1\nkind: Service\nmetadata:\nname: nginx-app3-svc\nspec:\ntype: NodePort\nports:\n- protocol: TCP\nport: 80\ntargetPort: 80\nnodePort: 30001\nselector:\napps: nginx-app3\n</code></pre> <p>\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u6765\u521b\u5efa</p> <pre><code>kubectl apply -f create-deployment-nginx-app3-service.yaml\n</code></pre>"},{"location":"01.basic/08-service/#34-service","title":"3.4 \u5220\u9664Service","text":"<p>\u901a\u8fc7\u547d\u4ee4\u884c\u5220\u9664</p> <pre><code>kubectl delete service nginx-app2\n</code></pre> <p>\u901a\u8fc7\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u521b\u5efa\u7684\u53ef\u4ee5\u901a\u8fc7\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5220\u9664\uff0c\u5982\u4e0b</p> <pre><code>kubectl delete -f create-deployment-nginx-app-service.yaml\n</code></pre>"},{"location":"01.basic/09-ingress/","title":"Ingress","text":""},{"location":"01.basic/09-ingress/#_1","title":"\u4e00\u3001\u76f8\u5173\u6982\u5ff5","text":"<p>Service\u5bf9\u96c6\u7fa4\u4e4b\u5916\u66b4\u9732\u7aef\u53e3\u4e3b\u8981\u65b9\u5f0f\u6709\u4e24\u79cd\uff1a<code>NodePort</code>\u548c<code>LoadBalancer</code>\uff0c\u4f46\u662f\u8fd9\u4e24\u79cd\u65b9\u5f0f\uff0c\u90fd\u6709\u4e00\u4e2a\u7f3a\u70b9</p> <ul> <li><code>NodePort</code>\u65b9\u5f0f\u7684\u7f3a\u70b9\u662f\u4f1a\u5360\u7528\u5f88\u591a\u96c6\u7fa4\u7684\u7aef\u53e3\uff0c\u96c6\u7fa4\u670d\u52a1\u5668\u53d8\u591a\u7684\u65f6\u5019\uff0c\u8fd9\u4e2a\u7f3a\u70b9\u6108\u53d1\u660e\u663e</li> <li><code>LoadBalancer</code>\u7684\u7f3a\u70b9\u662f\u6bcf\u4e2aService\u9700\u8981\u4e00\u4e2a<code>LoadBalancer</code>\uff0c\u6d6a\u8d39\u3001\u9ebb\u70e6\uff0c\u5e76\u4e14\u9700\u8981k8s\u4e4b\u5916\u7684\u8bbe\u5907\u652f\u6301</li> </ul> <p>\u57fa\u4e8e\u8fd9\u4e24\u79cd\u73b0\u72b6\uff0ck8s\u63d0\u4f9b\u4e86Ingress\u8d44\u6e90\u5bf9\u8c61\uff0cIngress\u503c\u9700\u8981\u4e00\u4e2aNodePort\u6216\u8005\u4e00\u4e2aLoadBalancer\u5c31\u53ef\u4ee5\u6ee1\u8db3\u66b4\u9732\u591a\u4e2aService\u7684\u9700\u6c42\u3002\u5de5\u4f5c\u673a\u5236\u5927\u81f4\u5982\u4e0b\u56fe\u6240\u793a</p> <p></p> <p>\u5b9e\u9645\u4e0a\uff0cIngress\u76f8\u5f53\u4e8e\u662f\u4e00\u4e2a7\u5c42\u7684\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u662fk8s\u5bf9\u53cd\u5411\u4ee3\u7406\u7684\u4e00\u4e2a\u62bd\u8c61\u6982\u5ff5\uff0c\u5b83\u7684\u5de5\u4f5c\u539f\u7406\u7c7b\u4f3c\u4e8eNginx\uff0c\u53ef\u4ee5\u7406\u89e3\u6210\u5728Ingress\u91cc\u5efa\u7acb\u8bf8\u591a\u53cd\u5c04\u89c4\u5219\uff0cIngress Controller\u901a\u8fc7\u76d1\u542c\u8fd9\u4e9b\u914d\u7f6e\u89c4\u5219\u8f6c\u5316\u6210Nginx\u7684\u53cd\u5411\u4ee3\u7406\u914d\u7f6e\uff0c\u7136\u540e\u5bf9\u5916\u90e8\u63d0\u4f9b\u670d\u52a1\u3002\u5728\u8fd9\u91cc\u6709\u4e24\u4e2a\u6838\u5fc3\u6982\u5ff5</p> <ul> <li><code>Ingress</code>: k8s\u4e2d\u7684\u4e00\u4e2a\u62bd\u8c61\u6982\u5ff5\uff0c\u4f5c\u7528\u662f\u5b9a\u4e49\u8bf7\u6c42\u8f6c\u53d1\u5230Service\u7684\u89c4\u5219</li> <li><code>Ingress controller</code>: \u5177\u4f53\u5b9e\u73b0\u53cd\u5411\u4ee3\u7406\u53ca\u8d1f\u8f7d\u5747\u8861\u7684\u7a0b\u5e8f\uff0c\u5bf9Ingress\u5b9a\u4e49\u7684\u89c4\u5219\u8fdb\u884c\u89e3\u6790\uff0c\u6839\u636e\u914d\u7f6e\u89c4\u5219\u6765\u5b9e\u73b0\u8f6c\u53d1\uff0c\u5b9e\u73b0\u65b9\u5f0f\u6709\u5f88\u591a\u79cd\uff0c\u6bd4\u5982Nginx\u3001Controller\u3001Haproxy\u7b49\u7b49\u3002</li> </ul> <p>Ingress\uff08\u4ee5Nginx\u4e3a\u4f8b\uff09\u7684\u5de5\u4f5c\u539f\u7406\u5982\u4e0b</p> <ul> <li> <ol> <li>\u7528\u6237\u7f16\u5199Ingress\u89c4\u5219\uff0c\u8bf4\u660e\u54ea\u4e2a\u57df\u540d\u5bf9\u5e94k8s\u96c6\u7fa4\u7684\u54ea\u4e2aSeivice</li> </ol> </li> <li> <ol> <li>Ingress\u63a7\u5236\u5668\u52a8\u6001\u611f\u77e5Ingress\u670d\u52a1\u89c4\u5219\u7684\u53d8\u5316\uff0c\u7136\u540e\u751f\u6210\u4e00\u6bb5\u5bf9\u5e94\u7684Nginx\u53cd\u5411\u4ee3\u7406\u914d\u7f6e</li> </ol> </li> <li> <ol> <li>Ingress\u63a7\u5236\u5668\u5c06\u4f1a\u751f\u6210\u7684Nginx\u914d\u7f6e\u5199\u5165\u5230\u4e00\u4e2a\u8fd0\u884c\u7740\u7684Nginx\u670d\u52a1\u4e2d\uff0c\u5e76\u4e14\u52a8\u6001\u66f4\u65b0</li> </ol> </li> <li> <ol> <li>\u5176\u5b9e\u771f\u6b63\u5728\u5de5\u4f5c\u7684\u5c31\u662f\u4e00\u4e2aNginx\u4e86\uff0c\u5185\u90e8\u914d\u7f6e\u4e86\u7528\u6237\u7684\u8bf7\u6c42\u8f6c\u53d1\u89c4\u5219</li> </ol> </li> </ul>"},{"location":"01.basic/09-ingress/#ingress_1","title":"\u4e8c\u3001\u521b\u5efaIngress","text":""},{"location":"01.basic/09-ingress/#21-ingress-controller","title":"2.1 \u521b\u5efaIngress Controller","text":"<p>\u5c06\u4ee5\u4e0b\u4e24\u4e2a\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u4fdd\u5b58\u5230\u670d\u52a1\u5668</p> <pre><code># \u521b\u5efa\u76ee\u5f55\nmkdir ingress-controller\n# \u8fdb\u5165\u8d44\u6e90\u76ee\u5f55\ncd ingress-controller\n# mandatory\nwget https://github.com/kubernetes/ingress-nginx/blob/nginx-0.30.0/deploy/static/mandatory.yaml\n# service-nodeport\u6587\u4ef6\nwget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/provider/baremetal/service-nodeport.yaml\n</code></pre> <p>\u6267\u884ckubectl\u521b\u5efa\u8d44\u6e90\u547d\u4ee4</p> <pre><code>kubectl apply -f ./\n</code></pre>"},{"location":"01.basic/09-ingress/#22-ingress-controller","title":"2.2 \u67e5\u770bIngress Controller","text":"<p>\u67e5\u770bPod\uff1a<code>kubectl get pods -n ingress-nginx</code>\uff0c\u8fd4\u56de\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>NAME                                        READY   STATUS    RESTARTS   AGE\nnginx-ingress-controller-5bb8fb4bb6-qnbdv   1/1     Running   0          3m23s\n</code></pre> <p>\u67e5\u770bService\uff1a<code>kubectl get svc -n ingress-nginx</code>\uff0c\u8fd4\u56de\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>NAME            TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE\ningress-nginx   NodePort   10.99.166.208   &lt;none&gt;        80:30796/TCP,443:31737/TCP   5m22s\n</code></pre>"},{"location":"01.basic/09-ingress/#23-deploymentservice","title":"2.3 \u521b\u5efaDeployment\u548cService","text":"<p>\u521b\u5efa3\u4e2aNginx\u548c3\u4e2atomcat\u5e94\u7528\u548c\u5bf9\u5e94\u7684\u4e24\u4e2aService\uff0c\u521b\u5efa<code>tomcat-nginx.yaml</code>\u6587\u4ef6\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\nname: nginx-deployment\nnamespace: dev\nspec:\nreplicas: 3\nselector:\nmatchLabels:\napp: nginx-pod\ntemplate:\nmetadata:\nlabels:\napp: nginx-pod\nspec:\ncontainers:\n- name: nginx\nimage: nginx:1.17.1\nports:\n- containerPort: 80\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\nname: tomcat-deployment\nnamespace: dev\nspec:\nreplicas: 3\nselector:\nmatchLabels:\napp: tomcat-pod\ntemplate:\nmetadata:\nlabels:\napp: tomcat-pod\nspec:\ncontainers:\n- name: tomcat\nimage: tomcat:8.5-jre10-slim\nports:\n- containerPort: 8080\n---\napiVersion: v1\nkind: Service\nmetadata:\nname: nginx-service\nnamespace: dev\nspec:\nselector:\napp: nginx-pod\nclusterIP: None\ntype: ClusterIP\nports:\n- port: 80\ntargetPort: 80\n---\napiVersion: v1\nkind: Service\nmetadata:\nname: tomcat-service\nnamespace: dev\nspec:\nselector:\napp: tomcat-pod\nclusterIP: None\ntype: ClusterIP\nports:\n- port: 8080\ntargetPort: 8080\n</code></pre>"},{"location":"01.basic/09-ingress/#34-ingress-http","title":"3.4 \u521b\u5efaingress-http","text":"<p>\u521b\u5efa<code>ingress-http.yaml</code>\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>apiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\nname: ingress-http\nnamespace: dev\nspec:\nrules:\n- host: nginx.jkdev.cn\nhttp:\npaths:\n- path: /\nbackend:\nserviceName: nginx-service\nservicePort: 80\n- host: tomcat.jkdev.cn\nhttp:\npaths:\n- path: /\nbackend:\nserviceName: tomcat-service\nservicePort: 8080\n</code></pre> <p>\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u8fdb\u884c\u521b\u5efa</p> <pre><code>kubectl create -f ingress-http.yaml\n</code></pre> <p>\u521b\u5efa\u4e4b\u540e\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u67e5\u770b</p> <pre><code>kubectl get ingress -n dev\n# \u6216\nkubectl get ing -n dev\n</code></pre> <p>\u6216\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u6307\u5b9aingress\u540d\u79f0\u67e5\u770b</p> <pre><code>kubectl get ingress ingress-http -n dev\n# \u6216\nkubectl get ing ingress-http -n dev\n</code></pre> <p>\u6216\u4f7f\u7528<code>kubectl describe ingress -n dev</code>\u6307\u4ee4\u67e5\u770b\u8be6\u7ec6\u4fe1\u606f\uff0c\u8fd4\u56de\u4ee5\u4e0b\u8be6\u7ec6\u5185\u5bb9</p> <pre><code>Name:             ingress-http\nNamespace:        dev\nAddress:          10.99.166.208\nDefault backend:  default-http-backend:80 (&lt;error: endpoints \"default-http-backend\" not found&gt;)\nRules:\n  Host             Path  Backends\n  ----             ----  --------\n  nginx.jkdev.cn   /   nginx-service:80 (10.244.1.20:80,10.244.1.21:80,10.244.1.24:80)\ntomcat.jkdev.cn  /   tomcat-service:8080 (10.244.1.22:8080,10.244.1.23:8080,10.244.1.25:8080)\nAnnotations:       &lt;none&gt;\nEvents:\n  Type    Reason  Age   From                      Message\n  ----    ------  ----  ----                      -------\n  Normal  CREATE  21m   nginx-ingress-controller  Ingress dev/ingress-http\n  Normal  UPDATE  21m   nginx-ingress-controller  Ingress dev/ingress-http\n</code></pre>"},{"location":"01.basic/09-ingress/#35-ingress-https","title":"3.5 \u521b\u5efaingress-https","text":"<p>\u751f\u6210ssl\u8bc1\u4e66\u4ee5\u53ca\u5bc6\u94a5</p> <pre><code># \u751f\u6210\u8bc1\u4e66\u8bf7\u6c42\u6587\u4ef6tls.crt\u548c\u79c1\u94a5tls.key\nopenssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj \"/C=CN/ST=GZ/O=nginx/CN=jkdev.cn\"\n# \u901a\u8fc7\u8bc1\u4e66\u8bf7\u6c42\u6587\u4ef6tls.crt\u548c\u79c1\u94a5tls.key\u751f\u6210k8s\u8bc1\u4e66tls-secret\nkubectl create secret tls tls-secret --key tls.key --cert tls.crt\n</code></pre> <p>\u6dfb\u52a0<code>ingress-https.yaml</code>\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>apiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\nname: ingress-https\nnamespace: dev\nspec:\ntls:\n- hosts:\n- nginx.jkdev.cn\n- tomcat.jkdev.cn\nsecretName: tls-secret # \u6307\u5b9a\u5bc6\u94a5\uff0c\u5fc5\u987b\u548c\u521b\u5efa\u7684\u5bc6\u94a5\u540d\u79f0\u4e00\u81f4\nrules:\n- host: nginx.jkdev.cn\nhttp:\npaths:\n- path: /\nbackend:\nserviceName: nginx-service\nservicePort: 80\n- host: tomcat.jkdev.cn\nhttp:\npaths:\n- path: /\nbackend:\nserviceName: tomcat-service\nservicePort: 8080\n</code></pre>"},{"location":"01.basic/09-ingress/#nginxk8s","title":"\u4e09\u3001Nginx\u8f6c\u53d1\u5230k8s","text":"<p>\u4f7f\u7528Nginx\u5c06\u6765\u81ea\u5916\u7f51\u7684\u8bf7\u6c42\u8f6c\u53d1\u7ed9k8s\u96c6\u7fa4</p> <pre><code>upstream default_backend_traefix {\nserver 10.99.166.208:80 max_fails=3 fail_timeout=10s;\n}\nserver{\nlisten 80;\nserver_name *.jkdev.cn;\nlocation / {\nproxy_pass http://default_backend_traefix;\nproxy_set_header Host $http_host;\nproxy_set_header x-forwarded-for $proxy_add_x_forwarded_for;\n}\n}\n</code></pre>"},{"location":"01.basic/10-storage/","title":"\u5b58\u50a8","text":""},{"location":"01.basic/10-storage/#_2","title":"\u4e00\u3001\u6982\u8ff0","text":"<p>\u5bb9\u5668\u7684\u751f\u547d\u5468\u671f\u53ef\u80fd\u5f88\u77ed\uff0c\u4f1a\u88ab\u9891\u7e41\u5730\u521b\u5efa\u548c\u9500\u6bc1\u3002\u90a3\u4e48\u5bb9\u5668\u9500\u6bc1\u65f6\uff0c\u4fdd\u5b58\u5728\u5bb9\u5668\u4e2d\u7684\u6570\u636e\u4e5f\u4f1a\u88ab\u6e05\u9664\u3002\u8fd9\u79cd\u7ed3\u679c\u5bf9\u7528\u6237\u6765\u8bf4\uff0c\u5728\u67d0\u79cd\u60c5\u51b5\u4e0b\u662f\u4e0d\u4e50\u610f\u7684\uff0c\u4e3a\u4e86\u6301\u4e45\u5316\u4fdd\u5b58\u5bb9\u5668\u7684\u6570\u636e\uff0ckubernates\u5f15\u5165Volume\u7684\u6982\u5ff5\u3002</p> <p>Volume\u662fPod\u4e2d\u80fd\u591f\u88ab\u591a\u4e2a\u5bb9\u5668\u8bbf\u95ee\u7684\u5171\u4eab\u76ee\u5f55\uff0c\u5b83\u88ab\u5b9a\u4e49\u5728Pod\u4e0a\uff0c\u7136\u540e\u88ab\u4e00\u4e2aPod\u91cc\u7684\u591a\u4e2a\u5bb9\u5668\u6302\u8f7d\u5230\u5177\u4f53\u7684\u6587\u4ef6\u76ee\u5f55\u4e0b\uff0ckubernates\u901a\u8fc7Volume\u5b9e\u73b0\u540c\u4e00\u4e2aPod\u4e2d\u4e0d\u540c\u5bb9\u5668\u4e4b\u95f4\u7684\u6570\u636e\u5171\u4eab\u4ee5\u53ca\u6570\u636e\u6301\u4e45\u5316\u5b58\u50a8\u3002Volume\u7684\u751f\u547d\u5468\u671f\u4e0d\u4e0e\u5bb9\u5668\u7684\u751f\u547d\u5468\u671f\u76f8\u5173\uff0c\u5f53\u5bb9\u5668\u7ec8\u6b62\u6216\u8005\u91cd\u542f\u65f6\uff0cVolume\u4e2d\u7684\u6570\u636e\u4e5f\u4e0d\u4f1a\u4e22\u5931\u3002kubernates\u7684Volume\u652f\u6301\u591a\u79cd\u7c7b\u578b\uff0c\u6bd4\u8f83\u5e38\u89c1\u7684\u6709\u4ee5\u4e0b\u51e0\u4e2a\uff1a</p> <ul> <li>\u7b80\u5355\u5b58\u50a8\uff1aEmptyDir\u3001HostPath\u3001NFS</li> <li>\u9ad8\u7ea7\u5b58\u50a8\uff1aPV\u3001PVC</li> <li>\u914d\u7f6e\u5b58\u50a8\uff1aConfigMap\u3001Secret</li> </ul> <p>\u5728\u4e0b\u6587\u4e2d\u6211\u4eec\u5c06\u4ecb\u7ecdk8s\u4e2d\u7684\u7b80\u5355\u5b58\u50a8\u529f\u80fd</p>"},{"location":"01.basic/10-storage/#emptydir","title":"\u4e8c\u3001EmptyDir","text":"<p>EmptyDir\u662f\u5728Pod\u88ab\u5206\u914d\u5230Node\u65f6\u521b\u5efa\u7684\uff0c\u5b83\u7684\u521d\u59cb\u5316\u5185\u5bb9\u4e3a\u7a7a\uff0c\u5e76\u4e14\u65e0\u9700\u6307\u5b9a\u5bbf\u4e3b\u673a\u4e0a\u5bf9\u5e94\u7684\u76ee\u5f55\u6587\u4ef6\uff0c\u56e0\u4e3akubernetes\u4f1a\u81ea\u52a8\u5206\u914d\u4e00\u4e2a\u76ee\u5f55\uff0c\u5230Pod\u9500\u6bc1\u65f6\uff0cEmptyDir\u4e2d\u7684\u6570\u636e\u4e5f\u4f1a\u88ab\u6c38\u4e45\u5220\u9664\u3002Empty\u7528\u9014\u5982\u4e0b</p> <ul> <li>\u4e34\u65f6\u7a7a\u95f4\uff0c\u4f8b\u5982\u7528\u4e8e\u67d0\u4e9b\u5e94\u7528\u7a0b\u5e8f\u8fd0\u884c\u65f6\u6240\u9700\u7684\u4e34\u65f6\u76ee\u5f55\uff0c\u4e14\u65e0\u9700\u6c38\u4e45\u4fdd\u7559</li> <li>\u4e00\u4e2a\u5bb9\u5668\u9700\u8981\u4ece\u53e6\u4e00\u4e2a\u5bb9\u5668\u4e2d\u83b7\u53d6\u6570\u636e\u7684\u76ee\u5f55\uff08\u591a\u5bb9\u5668\u5171\u4eab\uff09</li> </ul> <p>\u63a5\u4e0b\u6765\uff0c\u901a\u8fc7\u4e00\u4e2a\u5bb9\u5668\u4e4b\u95f4\u6587\u4ef6\u5171\u4eab\u7684\u6848\u4f8b\u6765\u4f7f\u7528\u4e00\u4e0bEmptyDir\u3002\u5728\u4e00\u4e2aPod\u4e2d\u51c6\u5907\u4e24\u4e2a\u5bb9\u5668\uff0cnginx\u548cbusybox\uff0c\u7136\u540e\u58f0\u660e\u4e00\u4e2aVolume\u5206\u522b\u6302\u8f7d\u5230\u4e24\u4e2a\u5bb9\u5668\u7684\u76ee\u5f55\u4e2d\uff0c\u518d\u8ba9nginx\u5bb9\u5668\u8d1f\u8d23\u5411Volume\u4e2d\u5199\u5165\u65e5\u5fd7\uff0cbusybox\u4e2d\u901a\u8fc7\u547d\u4ee4\u5c06\u65e5\u5fd7\u5185\u5bb9\u8bfb\u53d6\u5230\u63a7\u5236\u53f0\u3002\u521b\u5efa\u4e00\u4e2a<code>volume-empty.yaml</code>\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: volume-emptydir\nnamespace: dev\nspec:\ncontainers:\n- name: nginx\nimage: nginx:1.17.1\nports:\n- containerPort: 80\nvolumeMounts:\n- name: logs-volume\nmountPath: /var/log/nginx\n- name: busybox\nimage: busybox:1.30\ncommand: [\"/bin/sh\",\"-c\",\"tail -f /logs/access.log\"] # \u521d\u59cb\u547d\u4ee4\uff0c\u52a8\u6001\u8bfb\u53d6\u6587\u4ef6\u4e2d\u5185\u5bb9\nvolumeMounts: # \u5c06logs-volume\u6302\u8f7d\u5230busybox\u5bb9\u5668\u4e2d\uff0c\u5bf9\u5e94\u76ee\u5f55\u4e3alogs\n- name: logs-volume\nmountPath: /logs\nvolumes: # \u58f0\u660evolume\uff0cname\u4e3alogs-volume\uff0c\u7c7b\u578b\u4e3aemptyDir\n- name: logs-volume\nemptyDir: {}\n</code></pre> <p>\u521b\u5efa\u6210\u529f\u4e4b\u540e\uff0c\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u67e5\u770b\u65e5\u5fd7</p> <pre><code>kubectl logs -f volume-emptydir -n dev -c busybox\n</code></pre> <p>\u5f53\u8bbf\u95eenginx\u65f6\uff0c\u5c06\u770b\u5230\u76f8\u5e94 \u7684\u8f93\u51fa\u6570\u636e</p>"},{"location":"01.basic/10-storage/#hostpath","title":"\u4e09\u3001HostPath","text":"<p>EmptyDir\u4e2d\u6570\u636e\u4e0d\u4f1a\u88ab\u6301\u4e45\u5316\uff0c\u5b83\u4f1a\u968f\u7740Pod\u7684\u7ed3\u675f\u800c\u9500\u6bc1\uff0c\u5982\u679c\u60f3\u7b80\u5355\u7684\u5c06\u6570\u636e\u6301\u4e45\u5316\u5230\u4e3b\u673a\u4e2d\uff0c\u53ef\u4ee5\u9009\u62e9HostPath\u3002 HostPath\u5c31\u662f\u5c06Node\u4e3b\u673a\u4e2d\u4e00\u4e2a\u5b9e\u9645\u76ee\u5f55\u6302\u8f7d\u5728Pod\u4e2d\uff0c\u4ee5\u63d0\u4f9b\u5bb9\u5668\u4f7f\u7528\uff0c\u8fd9\u6837\u7684\u8bbe\u8ba1\u5c31\u53ef\u4ee5\u4fdd\u8bc1Pod\u9500\u6bc1\u4e86\uff0c\u4f46\u662f\u6570\u636e\u4f9d\u65e7\u53ef\u4ee5\u5b58\u5728Node\u4e3b\u673a\u4e0a\u3002\u521b\u5efa\u4e00\u4e2a<code>volume-hostpath.yaml</code>\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: volume-hostpath\nnamespace: dev\nspec:\ncontainers:\n- name: nginx\nimage: nginx:1.17.1\nports:\n- containerPort: 80\nvolumeMounts:\n- name: logs-volume\nmountPath: /var/log/nginx\n- name: busybox\nimage: busybox:1.30\ncommand: [\"/bin/sh\",\"-c\",\"tail -f /logs/access.log\"]\nvolumeMounts:\n- name: logs-volume\nmountPath: /logs\nvolumes:\n- name: logs-volume\nhostPath:\npath: /root/logs\ntype: DirectoryOrCreate # \u76ee\u5f55\u5b58\u5728\u5c31\u4f7f\u7528\uff0c\u4e0d\u5b58\u5728\u5148\u521b\u5efa\u540e\u4f7f\u7528\n</code></pre> <p>hostPath\u7c7b\u578btype\u7c7b\u578b</p> <ul> <li>DirectoryOrCreate\uff1a\u76ee\u5f55\u5b58\u5728\u5c31\u4f7f\u7528\uff0c\u4e0d\u5b58\u5728\u5c31\u5148\u521b\u5efa\uff0c\u540e\u4f7f\u7528</li> <li>Directory\uff1a\u76ee\u5f55\u5fc5\u987b\u5b58\u5728</li> <li>FileOrCreate\uff1a\u6587\u4ef6\u5b58\u5728\u5c31\u4f7f\u7528\uff0c\u4e0d\u5b58\u5728\u5c31\u5148\u521b\u5efa\u540e\u4f7f\u7528</li> <li>File\uff1a\u6587\u4ef6\u5fc5\u987b\u5b58\u5728</li> <li>Socket\uff1aunix\u5957\u63a5\u5b57\u5fc5\u987b\u5b58\u5728</li> <li>CharDevice\uff1a\u5b57\u7b26\u8bbe\u5907\u5fc5\u987b\u5b58\u5728</li> <li>BlockDevice\uff1a\u5757\u8bbe\u5907\u5fc5\u987b\u5b58\u5728</li> </ul> <p>\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u521b\u5efa</p> <pre><code>kubectl create -f volume-hostpath.yaml\n</code></pre>"},{"location":"01.basic/10-storage/#nfs","title":"\u56db\u3001NFS","text":"<p>HostPath\u53ef\u4ee5\u89e3\u51b3\u6570\u636e\u6301\u4e45\u5316\u7684\u95ee\u9898\uff0c\u4f46\u662f\u4e00\u65e6Node\u8282\u70b9\u6545\u969c\u4e86\uff0cPod\u5982\u679c\u8f6c\u5230\u4e86\u522b\u7684\u8282\u70b9\uff0c\u53c8\u4f1a\u51fa\u95ee\u9898\u4e86\uff0c\u6b64\u65f6\u9700\u8981\u51c6\u5907\u5355\u72ec\u7684\u7f51\u7edc\u5b58\u50a8\u7cfb\u7edf\uff0c\u6bd4\u5982\u5e38\u89c1\u7684NFS\u3001CIFS\u3002 NFS\u662f\u4e00\u4e2a\u7f51\u7edc\u6587\u4ef6\u5b58\u50a8\u7cfb\u7edf\uff0c\u53ef\u4ee5\u642d\u5efa\u4e00\u53f0NFS\u670d\u52a1\u5668\uff0c\u7136\u540e\u5c06Pod\u4e2d\u7684\u5b58\u50a8\u76f4\u63a5\u8fde\u63a5\u5230NFS\u7cfb\u7edf\u4e0a\uff0c\u8fd9\u6837\u7684\u8bdd\uff0c\u65e0\u8bbaPod\u5728\u8282\u70b9\u4e0a\u600e\u4e48\u8f6c\u79fb\uff0c\u53ea\u8981Node\u8ddfNFS\u5bf9\u63a5\u6ca1\u95ee\u9898\uff0c\u6570\u636e\u5c31\u53ef\u4ee5\u6210\u529f\u8bbf\u95ee\u3002 \uff081\uff09\u9996\u5148\u51c6\u5907NFS\u7684\u670d\u52a1\u5668\uff0c\u8fd9\u91cc\u4e3a\u4e86\u7b80\u5355\uff0c\u76f4\u63a5\u5728master\u8282\u70b9\u4f5cNFS\u670d\u52a1\u5668</p> <pre><code># \u5b89\u88c5nfs\u670d\u52a1\napt install nfs-kernel-server\n# \u51c6\u5907\u4e00\u4e2a\u5171\u4eab\u76ee\u5f55\nmkdir /var/data/nfs -pv\n# \u5c06\u5171\u4eab\u76ee\u5f55\u8bfb\u5199\u6743\u9650\u66b4\u9732\u7ed9\u96c6\u7fa4\u4e2d\u7684\u6240\u6709\u4e3b\u673a\nvim /etc/exports\n</code></pre> <p>\u5728multipass\u865a\u62df\u73af\u5883\u4e2d\uff0c\u96c6\u7fa4\u90fd\u5728\u4e00\u4e2a\u7f51\u6bb5\u5185\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code># \u4ee5\u8bfb\u5199\u548c\u975eroot\u6743\u9650\u66b4\u9732\n/var/data/nfs 192.168.64.0/24(rw,no_root_squash)\n</code></pre> <p>\u91cd\u542fnfs\u670d\u52a1</p> <pre><code># \u542f\u52a8\nsystemctl start nfs-kernel-server\n</code></pre> <p>\uff082\uff09\u5728node\u8282\u70b9\u5b89\u88c5nfs\u5ba2\u6237\u7aef</p> <pre><code>apt install nfs-common\n</code></pre> <p>\u521b\u5efaNFS\u5b58\u50a8\u5377\uff0c\u521b\u5efa<code>volume-nfs.yaml</code>\u6587\u4ef6\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: volume-hostpath\nnamespace: dev\nspec:\ncontainers:\n- name: nginx\nimage: nginx:1.17.1\nports:\n- containerPort: 80\nvolumeMounts:\n- name: logs-volume\nmountPath: /var/log/nginx\n- name: busybox\nimage: busybox:1.30\ncommand: [\"/bin/sh\",\"-c\",\"tail -f /logs/access.log\"]\nvolumeMounts:\n- name: logs-volume\nmountPath: /logs\nvolumes:\n- name: logs-volume\nnfs:\nserver: 192.168.64.8 # nfs\u670d\u52a1\u5668\npath: /var/data/nfs # \u5171\u4eab\u6587\u4ef6\u8def\u5f84\n</code></pre> <p>\u5f53\u6211\u4eec\u8bbf\u95eepod\u4e2d\u7684nginx\u4e4b\u540e\uff0c\u5c06\u770b\u5230master\u8282\u70b9\u7684<code>/var/data/nfs</code>\u76ee\u5f55\u4e0b\u4ea7\u751f\u4e86\u76f8\u5173\u65e5\u5fd7\u6587\u4ef6\u3002</p> <p>\u8fd9\u91cc\u6709\u4e00\u7bc7\u6587\u7ae0\u8bb2\u7684\u66f4\u8be6\u7ec6\u7684\u6587\u7ae0\uff0c\u53ef\u4ee5\u53c2\u8003\uff1ahttps://my.oschina.net/upyun/blog/5959546</p>"},{"location":"02.enhancement/01-summary/","title":"k8s\u8fdb\u9636\u77e5\u8bc6\u6982\u8ff0","text":""},{"location":"02.enhancement/01-summary/#k8s_1","title":"\u4e00\u3001k8s\u57fa\u7840\u77e5\u8bc6\u56de\u987e","text":"<p>docker\u5bb9\u5668\u5c01\u88c5\u5e94\u7528\u7a0b\u5e8f\u7684\u610f\u4e49\u5728\u4e8e\uff1adocker\u5f15\u64ce\u7edf\u4e00\u4e86\u57fa\u7840\u7684\u8bbe\u65bd\u73af\u5883\u3001\u7edf\u4e00\u4e86\u7a0b\u5e8f\u6253\u5305\uff08\u88c5\u7bb1\uff09\u7684\u65b9\u5f0f\uff0c\u4e5f\u7edf\u4e00\u4e86\u90e8\u7f72\uff08\u8fd0\u884c\uff09\u7684\u65b9\u5f0f\u3002\u4ece\u7a0b\u5e8f\u5f00\u53d1\u5230\u4e0a\u7ebf\uff0c\u5f00\u53d1\u8005\u4e0d\u518d\u5173\u6ce8\u57fa\u7840\u73af\u5883\u7684\u5dee\u5f02\uff0c\u4f7f\u5f97\u5f00\u53d1\u8005\u53ef\u4ee5\u5c06\u66f4\u591a\u7684\u65f6\u95f4\u82b1\u5728\u4e1a\u52a1\u903b\u8f91\u4e0a\u3002</p> <p>\u4e0d\u8fc7\uff0c\u5355\u72ec\u4f7f\u7528docker\uff0c\u4f60\u4f1a\u53d1\u73b0\u5b58\u5728\u4ee5\u4e0b\u95ee\u9898</p> <ul> <li> <p>\u5355\u673a\u4f7f\u7528\uff0c\u65e0\u6cd5\u6709\u6548\u96c6\u7fa4</p> </li> <li> <p>\u968f\u7740\u5bb9\u5668\u6570\u91cf\u4e0a\u5347\uff0c\u7ba1\u7406\u6210\u672c\u6500\u5347</p> </li> <li> <p>\u6ca1\u6709\u6709\u6548\u7684\u5bb9\u707e/\u81ea\u6108\u673a\u5236</p> </li> <li> <p>\u6ca1\u6709\u9884\u8bbe\u7f16\u6392\u6a21\u677f\uff0c\u65e0\u6cd5\u5b9e\u73b0\u5feb\u901f\u3001\u5927\u89c4\u6a21\u7684\u5bb9\u5668\u7f16\u6392</p> </li> <li> <p>\u6ca1\u6709\u7edf\u4e00\u7684\u914d\u7f6e\u4e2d\u5fc3\u7ba1\u7406\u4e2d\u5fc3\u5de5\u5177</p> </li> <li> <p>\u6ca1\u6709\u5bb9\u5668\u751f\u547d\u5468\u671f\u7684\u7ba1\u7406\u5de5\u5177</p> </li> <li> <p>\u6ca1\u6709\u56fe\u5f62\u5316\u8fd0\u7ef4\u7ba1\u7406\u5de5\u5177</p> </li> </ul> <p>......</p> <p>\u56e0\u6b64\uff0c\u6211\u4eec\u9700\u8981\u4e00\u5957\u9ad8\u6548\u7684\u5bb9\u5668\u7f16\u6392\u7684\u5de5\u5177\uff0c\u57fa\u4e8eDocker\u5bb9\u5668\u5f15\u64ce\u7684\u5f00\u6e90\u5bb9\u5668\u7f16\u6392\u5de5\u5177\u76ee\u524d\u5e02\u573a\u4e0a\u4e3b\u8981\u6709\uff1adocker-compose\u3001docker-swarm\u3001kubernetes\uff08k8s\uff09\uff0c\u7531\u4e8ek8s\u5f3a\u5927\u7684\u5bb9\u5668\u7f16\u6392\u529f\u80fd\uff0c\u4ee5\u53ca\u6d3b\u8dc3\u7684\u793e\u533a\u652f\u6301\uff0ck8s\u5df2\u7ecf\u6210\u4e3a\u4e86docker\u5b98\u65b9\u63a8\u8350\u7684\u5bb9\u5668\u7f16\u6392\u5de5\u5177\u3002\u5f53\u6211\u4eec\u4f7f\u7528k8s\u6765\u90e8\u7f72\u670d\u52a1\uff0c\u5c31\u80fd\u505a\u5230\u4ee5\u4e0b\u7684\u6548\u679c</p> <ul> <li><code>\u73af\u5883\u7a33\u5b9a</code>: k8s\u6709\u81ea\u52a8\u4fee\u590d\u7684\u529f\u80fd\uff0c\u53d1\u73b0\u67d0\u4e9b\u670d\u52a1\u4e0d\u6b63\u5e38\uff0c\u5b83\u4f1a\u5c1d\u8bd5\u81ea\u542f</li> <li><code>\u670d\u52a1\u4e0d\u95f4\u65ad</code>: \u53ca\u65f6\u662f\u53ea\u8fd0\u884c\u7684\u670d\u52a1\u53ea\u6709\u4e00\u4e2a\u526f\u672c\uff0c\u5728\u66f4\u65b0\u670d\u52a1\u7684\u65f6\u5019\uff0ck8s\u4e5f\u4f1a\u65b0\u8d77\u597d\u65b0\u7684\u670d\u52a1\u624d\u4f1a\u8e22\u51fa\u65e7\u7248\u672c\u7684\u670d\u52a1</li> <li><code>\u4e00\u6b21\u6784\u5efa\uff0c\u591a\u73af\u5883\u8fd0\u884c</code>: \u53ea\u9700\u8981\u6253\u5305\u4e00\u6b21\u955c\u50cf\uff0c\u5728\u591a\u4e2a\u73af\u5883\u4e0d\u9700\u8981\u91cd\u65b0\u6784\u5efa</li> </ul> <p>\u5728\u524d\u9762\u7684\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u5df2\u7ecf\u5feb\u901f\u5165\u95e8\u4e86<code>k8s</code>\u7684\u96c6\u7fa4\u7684\u57fa\u7840\u77e5\u8bc6\uff0c\u5e76\u4e14\u57fa\u4e8e<code>kubeadm</code>\u5de5\u5177\u642d\u5efa\u4e86\u865a\u62df\u7684<code>k8s</code>\u96c6\u7fa4\uff0c\u4f46\u5bf9\u4e8e\u5f3a\u5927\u7684<code>k8s</code>\u6765\u8bf4\uff0c\u77e5\u8bc6\u51b0\u5c71\u4e00\u89d2\uff0c\u5728\u672c\u7cfb\u5217\u4e2d\u6211\u4eec\u5c06\u7ee7\u7eed\u63a2\u8ba8<code>k8s</code>\u96c6\u7fa4\u7684\u8fdb\u9636\u77e5\u8bc6\u3002</p>"},{"location":"02.enhancement/01-summary/#_1","title":"\u4e8c\u3001\u76ee\u6807","text":""},{"location":"02.enhancement/01-summary/#21","title":"2.1 \u76ee\u6807","text":"<p>\u5b9e\u9645\u4e0a\uff0ck8s\u5e38\u89c1\u6709\u4e09\u79cd\u90e8\u7f72\u65b9\u5f0f</p> <ul> <li> <p>minikube: \u9002\u5408\u8282\u70b9\u5fae\u578bk8s\uff0c\u4e00\u822c\u4ec5\u4ec5\u7528\u4e8e\u5b66\u4e60\u3001\u9884\u89c8\u4f7f\u7528</p> </li> <li> <p>\u4e8c\u8fdb\u5236\u5b89\u88c5\u90e8\u7f72: \u662f\u9996\u9009\u7684\u5b89\u88c5\u65b9\u5f0f</p> </li> <li> <p>\u4f7f\u7528kubeadm: \u8fdb\u884c\u90e8\u7f72\uff0ckubeadm \u662fk8s\u7684\u5feb\u719f\u90e8\u7f72\u5de5\u5177\uff0c\u64cd\u4f5c\u7b80\u5355\u5feb\u6377\uff0c\u5efa\u8bae\u975e\u5e38\u719f\u6089k8s\u7684\u63d0\u524d\u4e0b\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f</p> </li> </ul> <p>\u672c\u7ae0\uff0c\u6211\u4eec\u7684\u76ee\u6807\u662f\u629b\u5f03 <code>kubeadm</code> \u5de5\u5177\uff0c\u4ece\u96f6\u4f7f\u7528\u4e8c\u8fdb\u5236\u5b89\u88c5\u7684\u65b9\u5f0f\u642d\u5efa<code>k8s</code>\u96c6\u7fa4\uff0c\u5e76\u66f4\u7cfb\u7edf\u5730\u5730\u6df1\u5165\u5b66\u4e60 <code>k8s</code> \u77e5\u8bc6\uff01</p>"},{"location":"02.enhancement/02-prepare/","title":"k8s\u4e8c\u8fdb\u5236\u5b89\u88c5\u73af\u5883\u51c6\u5907","text":"<p>\u5728\u8fdb\u884c\u96c6\u7fa4\u5b66\u4e60\u4e4b\u524d\uff0c\u6211\u4eec\u5148\u51c6\u5907\u865a\u62df\u673a\u73af\u5883\uff0c\u6211\u4eec\u4f7f\u7528 <code>vagran</code> \u6765\u7ba1\u7406\u865a\u62df\u673a\uff0c\u5982\u679c\u4f60\u7535\u8111\u4e0a\u8fd8\u6ca1\u6709 vagrant \u865a\u62df\u673a\u7ba1\u7406\u5de5\u5177\uff0c\u53ef\u4ee5\u53c2\u8003\u8fd9\u7bc7\u6587\u7ae0https://blog.jkdev.cn/index.php/archives/335/</p>"},{"location":"02.enhancement/02-prepare/#1","title":"1. \u542f\u52a8\u865a\u62df\u673a","text":"<p>\u5728\u4e00\u4e2a\u5de5\u4f5c\u76ee\u5f55\u4e2d\u521b\u5efa <code>Vagrantfile</code> \u6587\u4ef6\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>Vagrant.configure(\"2\") do |config|\nconfig.vm.box = \"centos/7\"\n# kb11\nconfig.vm.define \"kb11\" do |kb11|\nkb11.vm.network \"public_network\", ip: \"192.168.14.11\"\nkb11.vm.hostname = \"kb11\"\n# \u6307\u5b9a\u6838\u5fc3\u6570\u548c\u5185\u5b58\nconfig.vm.provider \"virtualbox\" do |v|\nv.memory = 2048\nv.cpus = 2\nend\nend\n# kb12\nconfig.vm.define \"kb12\" do |kb12|\nkb12.vm.network \"public_network\", ip: \"192.168.14.12\"\nkb12.vm.hostname = \"kb12\"\n# \u6307\u5b9a\u6838\u5fc3\u6570\u548c\u5185\u5b58\nconfig.vm.provider \"virtualbox\" do |v|\nv.memory = 2048\nv.cpus = 2\nend\nend\n# kb21\nconfig.vm.define \"kb21\" do |kb21|\nkb21.vm.network \"public_network\", ip: \"192.168.14.21\"\nkb21.vm.hostname = \"kb21\"\n# \u6307\u5b9a\u6838\u5fc3\u6570\u548c\u5185\u5b58\nconfig.vm.provider \"virtualbox\" do |v|\nv.memory = 2048\nv.cpus = 2\nend\nend\n# kb22\nconfig.vm.define \"kb22\" do |kb22|\nkb22.vm.network \"public_network\", ip: \"192.168.14.22\"\nkb22.vm.hostname = \"kb22\"\n# \u6307\u5b9a\u6838\u5fc3\u6570\u548c\u5185\u5b58\nconfig.vm.provider \"virtualbox\" do |v|\nv.memory = 2048\nv.cpus = 2\nend\nend\n# kb200\nconfig.vm.define \"kb200\" do |kb200|\nkb200.vm.network \"public_network\", ip: \"192.168.14.200\"\nkb200.vm.hostname = \"kb200\"\n# \u6307\u5b9a\u6838\u5fc3\u6570\u548c\u5185\u5b58\nconfig.vm.provider \"virtualbox\" do |v|\nv.memory = 2048\nv.cpus = 2\nend\nend\nend\n</code></pre> <p>\u4ee5\u4e0a\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u6211\u4eec\u6307\u5b9a\u4e86 <code>centos 7</code> \u4f5c\u4e3a\u6240\u6709\u865a\u62df\u673a\u7684\u57fa\u7840\u955c\u50cf\uff0c\u5e76\u4e14\u5206\u522b\u5b9a\u4e49\u4e86 5 \u53f0\u865a\u62df\u673a\uff0c\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u542f\u52a8\u865a\u62df\u673a</p> <pre><code># \u542f\u52a8\u865a\u62df\u673a\nvagran up\n</code></pre> <p>\u542f\u52a8\u865a\u62df\u673a\u4e4b\u540e\u8fdb\u5165\u865a\u62df\u673a\uff0c\u4fee\u6539 root \u7528\u6237\u5bc6\u7801\uff0c\u5728\u63a5\u4e0b\u6765\u7684\u96c6\u7fa4\u642d\u5efa\u64cd\u4f5c\u4e2d\uff0c\u6211\u4eec\u90fd\u5c06\u5728 root \u7528\u6237\u4e0b\u8fdb\u884c\u3002\u4ee5 kb11 \u4e3a\u4f8b\uff0c\u64cd\u4f5c\u6307\u4ee4\u5982\u4e0b\uff1a</p> <pre><code># \u8fdb\u5165 kb11 \u865a\u62df\u673a\nvagrant ssh kb11\n# \u4fee\u6539root\u8d26\u53f7\u5bc6\u7801\nsudo passwd root\n# \u5207\u6362\u5230 root \u7528\u6237\nsu\n</code></pre>"},{"location":"02.enhancement/02-prepare/#2","title":"2. \u521d\u59cb\u5316","text":"<p>\u521d\u59cb\u5316\u5de5\u4f5c\u5728\u6240\u6709\u7684\u4e3b\u673a\u4e0a\u6267\u884c</p> <p>\u5b89\u88c5epel\u6e90</p> <pre><code>yum install -y epel-release\n</code></pre> <p>\u5b89\u88c5\u5e38\u7528\u7684\u5de5\u5177 <pre><code>yum install -y vim wget net-tools telnet tree nmap sysstat lrzaz doc2unix bind-utils\n</code></pre></p> <p>\u5173\u95edselinx\u548c\u9632\u706b\u5899 <pre><code># \u5173\u95edselinx\nsetenforce 0\n# \u5173\u95ed\u9632\u706b\u5899\nsystemctl stop firewalld\n</code></pre></p> <p>\u4ee5\u4e0a\u6307\u4ee4\u53ea\u662f\u4e34\u65f6\u5173\u95edselinux\uff0c\u6c38\u4e45\u5173\u95edselinux\uff0c\u9700\u8981\u628a<code>/etc/selinux/config</code>\u91cc\u9762\u7684<code>SELINUX</code>\u503c\u4fee\u6539\u4e3a<code>disabled</code>\uff0c\u5982\u4e0b</p> <pre><code>SELINUX=disabled\n</code></pre>"},{"location":"02.enhancement/02-prepare/#3","title":"3. \u521d\u59cb\u5316\u57df\u540d\u89e3\u6790\u670d\u52a1\u5668","text":""},{"location":"02.enhancement/02-prepare/#31","title":"3.1. \u5b89\u88c5\u57df\u540d\u89e3\u6790\u670d\u52a1\u5668\u8f6f\u4ef6","text":"<p>\u6211\u4eec\u628a <code>kb11</code> \u8fd9\u53f0\u4e3b\u673a\u4f5c\u4e3a\u57df\u540d\u670d\u52a1\u5668\u3002\u63a5\u4e0b\u6765\u8fdb\u884c\u521d\u59cb\u5316\u64cd\u4f5c\u3002</p> <p>\u5b89\u88c5bind9\u8f6f\u4ef6</p> <pre><code>yum install -y bind\n</code></pre> <p>\u5b89\u88c5\u597dbind\u4e4b\u540e\uff0c\u4fee\u6539bind\u7684\u914d\u7f6e\u6587\u4ef6<code>/etc/named.conf</code>\uff0c\u4fee\u6539\u7684\u914d\u7f6e\u53c2\u6570\u5982\u4e0b <pre><code># \u4fee\u6539\u670d\u52a1\u7684IP\nlisten-on port 53 { 192.168.14.11; };\n# \u5141\u8bb8\u4efb\u610f\u4e3b\u673a\u4f7f\u7528\u89e3\u6790\u670d\u52a1\nallow-query     { any; };\n# \u6dfb\u52a0 forwarders \u952e\uff0c \u503c\uff1a\u7f51\u5173\u5730\u5740\nforwarders      { 192.168.14.254; };\n# \u5f00\u542fdns\u8f6c\u53d1\nallow-query-cache       { any; };\n# \u4f7f\u7528\u9012\u5f52\u7684\u65b9\u5f0f\nrecursion yes;\n#\u5173\u95edsec\ndnssec-enable no;\ndnssec-validation no;\n</code></pre></p>"},{"location":"02.enhancement/02-prepare/#32","title":"3.2. \u914d\u7f6e\u57df\u540d\u89e3\u6790","text":"<p>\u5728\u8fd9\u91cc\uff0c\u6211\u4eec\u4e0d\u8d58\u8ff0\u57df\u540d\u89e3\u6790\u4ee5\u53ca\u76f8\u5173\u8f6f\u4ef6\u7684\u76f8\u5173\u77e5\u8bc6\uff0c\u5982\u679c\u4f60\u5728\u9605\u8bfb\u672c\u6587\u6709\u56f0\u96be\u65f6\uff0c\u5efa\u8bae\u5148\u53bb\u4e86\u89e3 dsn\u670d\u52a1\u5668 \u4ee5\u53ca bind9\u8f6f\u4ef6 \u7684\u76f8\u5173\u77e5\u8bc6\u3002\u6211\u4eec\u5bf9\u96c6\u7fa4\u4e2d\u7684\u76f8\u5173\u4e3b\u673a\u8bbe\u7f6e\u76f8\u5173\u7684\u57df\u540d\u89e3\u6790\uff0c\u4ee5\u4fbf\u80fd\u901a\u8fc7\u57df\u540d\u8bbf\u95ee\u5230\u6211\u4eec\u5bf9\u5e94\u7684\u670d\u52a1\u5668\u3002\u4ee5\u4e0b\u662f\u5177\u4f53\u64cd\u4f5c\u8fc7\u7a0b\uff1a</p> <p>\u4fee\u6539\u533a\u57df\u914d\u7f6e\u6587\u4ef6 <code>/etc/named.rfc1912.zones</code>\uff0c\u8986\u76d6\u9ed8\u8ba4\u5185\u5bb9\u5982\u4e0b\uff1a <pre><code>zone \"host.com\" IN {\ntype master;\nfile \"host.com.zone\";\nallow-update { 192.168.14.1; };\n};\nzone \"od.com\" IN {\ntype master;\nfile \"od.com.zone\";\nallow-update { 192.168.14.1; };\n};\n</code></pre></p> <p>\u7f16\u8f91\u533a\u57df\u6570\u636e\u6587\u4ef6<code>/var/named/host.com.zone</code>\uff0c\u6539\u4e3a\u5982\u4e0b\u5185\u5bb9</p> <pre><code>$ORIGIN host.com.\n$TTL 600 ; 10 minutes\n@ IN SOA dns.host.com. dnsadmin.host.com. (\n2022012001 ; serial\n    10800      ; refresh (3 hours)\n900        ; retry (15 minutes)\n604800     ; expire (1 week)\n86400      ; minium (1 day)\n)\nNS dns.host.com.\n\n$TTL 60    ;   1 minute\ndns           A      192.168.14.11\nkb11      A      192.168.14.11\nkb12      A      192.168.14.12\nkb21      A      192.168.14.21\nkb22      A      192.168.14.22\nkb200     A      192.168.14.200\n</code></pre> <p>\u7f16\u8f91\u533a\u57df\u6570\u636e\u6587\u4ef6<code>/var/named/od.com.zone</code>\uff0c\u6539\u4e3a\u5982\u4e0b\u5185\u5bb9</p> <pre><code>$ORIGIN od.com.\n$TTL 600 ; 10 minutes\n@ IN SOA dns.od.com. dnsadmin.od.com. (\n2022012002 ; serial\n    10800      ; refresh (3 hours)\n900        ; retry (15 minutes)\n604800     ; expire (1 week)\n86400      ; minium (1 day)\n) NS dns.od.com.\n\n$TTL 60    ;   1 minute\ndns    A   192.168.14.11\n</code></pre> <p>\u542f\u52a8dns\u670d\u52a1</p> <pre><code># \u542f\u52a8dns \u670d\u52a1\nsystemctl start named\n# \u5c06dns \u670d\u52a1\u8bbe\u7f6e\u4e3a\u5f00\u673a\u81ea\u542f\nsystemctl enable named\n</code></pre> <p>\u9a8c\u8bc1dns\u662f\u5426\u6b63\u5e38</p> <pre><code># \u67e5\u8be253\u7aef\u53e3\u670d\u52a1\nnetstat -luntp | grep 53\n</code></pre> <p>\u53ef\u4ee5\u770b\u523053\u7aef\u53e3\u670d\u52a1\u6b63\u5e38\u8fd0\u884c\uff0c\u5982\u4e0b\u56fe\u6240\u793a</p> <p></p> <p>\u67e5\u770bdns\u662f\u5426\u6b63\u5e38\u89e3\u6790 <pre><code>dig -t A kb21.host.com @192.168.14.11 +short\n</code></pre></p> <p>\u5982\u679c\u770b\u5230\u6b63\u5e38\u8fd4\u56deIP\u5730\u5740\uff0c\u5219\u4ee3\u8868\u89e3\u6790\u6b63\u5e38\u3002</p> <p>\u8fd9\u65f6\u5019\uff0c\u6211\u4eec\u9700\u8981\u628a\u6211\u4eec\u7684<code>kb1</code>\u4e3b\u673a\u7684DNS\u6539\u4e3a<code>\u6211\u4eec\u81ea\u5efa\u7684DNS\u670d\u52a1</code>\uff0c\u4fee\u6539 <code>/etc/sysconfig/network-scripts/ifcfg-eth1</code> \u6587\u4ef6\u4e3a\u7684 DNS1 \u914d\u7f6e\uff0c\u5982\u4e0b</p> <pre><code># \u8bbe\u7f6e\u7f51\u5361\u7684\u7f51\u5173\nGATEWAY=192.168.14.254\n# \u8bbe\u7f6e\u7f51\u5361\u7684dns\nDNS1=192.168.14.11\n</code></pre> <p>\u518d\u91cd\u542f\u670d\u52a1 <pre><code>systemctl restart network\n</code></pre></p> <p>\u5b9e\u9645\u4e0a\uff0c\u91cd\u542f\u7f51\u7edc\u4e4b\u540e\uff0c\u6211\u4eec\u914d\u7f6e\u7684\u7f51\u5361\u4f1a\u751f\u6548\uff0c\u4f46\u662f\u5728 vagrant \u865a\u62df\u673a\u91cc\uff0c\u9ed8\u8ba4\u6709\u4e00\u4e2a DNS \u89e3\u6790\u3002\u6b64\u65f6 <code>/etc/resolv.conf</code> \u6587\u4ef6\u5185\u5bb9\u5982\u4e0b</p> <pre><code>\n</code></pre> <p>\u5728 vagrant \u91cc\uff0cvagrant \u9ed8\u8ba4\u4f7f\u7528\u4e00\u4e2a vagrant \u7684 dns\uff0c\u90a3\u4e48\u6211\u4eec\u81ea\u5df1\u8bbe\u7f6e\u7684dns\u4fbf\u6210\u4e86\u5907\u7528dns\uff0c\u4e3a\u4e86\u8fbe\u5230\u6211\u4eec\u57df\u540d\u89e3\u6790\u7684\u6548\u679c\uff0c\u6211\u4eec\u6267\u884c\u4e0b\u9762\u201c4\u201d\u7684\u6b65\u9aa4\uff01</p>"},{"location":"02.enhancement/02-prepare/#4","title":"4. \u4fee\u6539\u6240\u6709\u7684\u4e3b\u673a\u7684\u57df\u540d\u89e3\u6790\u670d\u52a1\u5668","text":"<p>\u5c06\u7cfb\u7edf\u4e2d\u914d\u7f6e\u6587\u4ef6<code>/etc/resolv.conf</code>\uff0c\u6539\u4e3a\u5982\u4e0b\u5185\u5bb9</p> <pre><code># \u67e5\u8be2\u4e3b\u673a\u57df\nsearch host.com\n# \u89e3\u6790\u670d\u52a1\u5668\nnameserver 192.168.14.11\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u672c\u6587\u6f14\u793a\u7684\u73af\u5883\u662f <code>vagrant</code> \u91cc\u7684 <code>centos 7</code>\uff0c\u5982\u679c\u6211\u4eec\u91cd\u542f\u865a\u62df\u673a\uff0c<code>/etc/resolv.conf</code> \u6587\u4ef6\u5c06\u88ab\u91cd\u7f6e\uff0c\u5c06\u57df\u540d\u89e3\u6790\u91cd\u7f6e\u4e3a <code>vagrant</code> \u5de5\u5177\u672c\u8eab\u9ed8\u8ba4\u7684 DNS \uff01\u4e3a\u4e86\u4fdd\u8bc1\u6211\u4eec\u4fee\u6539\u7684\u914d\u7f6e\u5728\u5b66\u4e60\u671f\u95f4\u6709\u6548\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4e0b\u5217\u63a8\u8350\u7684\u65b9\u5f0f\u5bf9\u865a\u62df\u673a\u8fdb\u884c\u91cd\u542f\uff01</p> <pre><code># \u4fdd\u5b58\u865a\u62df\u673a\u955c\u50cf\nvagrant suspend\n# \u6062\u590d\u865a\u62df\u673a\u955c\u50cf\nvagrant resume\n</code></pre> <p>\u5efa\u8bae\uff1a\u5982\u679c\u6211\u4eec\u5728\u4e2a\u4eba\u7535\u8111\u4f7f\u7528 vagrant \uff0c\u5728\u7535\u8111\u5173\u673a\u4e4b\u524d\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>vagrant suspend</code> \u4fdd\u5b58\u865a\u62df\u673a\u7684\u5feb\u7167\uff0c\u5728\u7535\u8111\u5f00\u673a\u4e4b\u540e\uff0c\u4f7f\u7528 <code>vagrant resume</code> \u6062\u590d\u4e0a\u6b21\u4fdd\u5b58\u7684\u5feb\u7167\u3002\u8fd9\u4e2a\u6211\u4eec\u5c31\u53ef\u4ee5\u5728 vagrant \u865a\u62df\u673a\u91cc\uff0c\u7ee7\u7eed\u6267\u884c\u4e0a\u6b21\u672a\u5b8c\u6210\u7684\u4efb\u52a1\u3002</p> <p>\u6211\u4eec\u518d\u4f7f\u7528\u5982\u4e0b\u6307\u4ee4\u68c0\u6d4b\u662f\u5426\u89e3\u6790\u6b63\u5e38 <pre><code>ping kb21.host.com\n# \u56e0\u4e3a\u8bbe\u7f6e\u4e86 search \uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5ping \u77ed\u57df\u540d\nping kb21\n</code></pre></p> <p>\u5982\u679c\u8fd4\u56de\u5982\u4e0b\u56fe\u5185\u5bb9\uff0c\u8fd9\u4ee3\u8868dns\u6b63\u5e38\u89e3\u6790</p> <p></p> <p>\u6211\u4eec\u5728 <code>/etc/resolv.conf</code> \u6587\u4ef6\u4e2d\u4fee\u6539\u53ea\u662f\u8ba9\u4e3b\u673a\u4e34\u65f6\u751f\u6548\uff0c\u5982\u679c\u91cd\u542f\u4e4b\u540e\uff0c\u7cfb\u7edf\u5c06\u4f1a\u6839\u636e\u7f51\u5361\u914d\u7f6e\u6765\u6307\u5b9a\u5bf9\u5e94\u7684 \u57df\u540d\u89e3\u6790\u670d\u52a1\u5668\uff0c\u6240\u4ee5\u6c38\u4e45\u751f\u6548\u7684\u65b9\u5f0f\u5e94\u5f53\u662f \u4fee\u6539\u7f51\u5361 \u914d\u7f6e\u4e2d\u7684DNS\u57df\u540d\u3002</p> <p>\u6ce8\u610f\uff1a<code>/etc/resolv.conf</code> \u8bbe\u7f6e\u57df\u540d\u89e3\u6790\u65f6\uff0c\u4e3b\u673a\u57df\u540d\uff08\u4e13\u95e8\u7528\u4e8e\u8bbf\u95ee\u4e3b\u673a\u7684\u57df\u540d\uff09\u53ef\u4ee5\u4f7f\u7528 <code>search</code> \u6807\u6ce8\u67e5\u8be2\u7684\u4e3b\u673a\u57df\uff0c\u4f46\u6ce8\u610f \u4e1a\u52a1\u57df\u540d\uff08\u7528\u4e8e\u90e8\u7f72\u9879\u76ee\u7684\u57df\u540d\uff09\u4e0d\u8981\u4f7f\u7528\u8fd9\u4e2a\u914d\u7f6e\u3002</p>"},{"location":"02.enhancement/03-sign-prepare/","title":"\u8bc1\u4e66\u7b7e\u53d1 \u73af\u5883\u51c6\u5907","text":"<p>\u6211\u4eec\u628a <code>kb200</code> \u8fd9\u53f0\u4e3b\u673a\u4f5c\u4e3a\u8fd0\u7ef4\u4e3b\u673a\uff0c\u6240\u4ee5\u63a5\u4e0b\u6765\u5f88\u591a\u64cd\u4f5c\u90fd\u5728\u8fd9\u53f0\u4e3b\u673a\u4e0a\u6267\u884c\uff0c\u6211\u4eec\u5148\u767b\u5f55\u5230\u8fd9\u53f0\u4e3b\u673a\uff0c\u51c6\u5907\u8bc1\u4e66\u7b7e\u53d1\u64cd\u4f5c</p>"},{"location":"02.enhancement/03-sign-prepare/#1-cfssl","title":"1. \u5b89\u88c5cfssl\u5de5\u5177","text":"<p>cfssl \u5de5\u5177\u7684\u4e0b\u8f7d\u5730\u5740\u4e3a\uff1ahttps://github.com/cloudflare/cfssl/releases</p> <p>\u6211\u4eec\u4e0b\u8f7d\u5b89\u88c5<code>cfssl</code>\u3001<code>cfssl-json</code>\u3001<code>cfssl-certingo</code>\uff0c\u5982\u4e0b\u6307\u4ee4</p> <pre><code># cfssl\nwget https://github.com/cloudflare/cfssl/releases/download/1.2.0/cfssl_linux-amd64 -o /usr/local/bin/cfssl\n# cfssljson\nwget https://github.com/cloudflare/cfssl/releases/download/1.2.0/cfssljson_linux-amd64 -o /usr/local/bin/cfssljson\n# cfssl-certinfo\nwget https://github.com/cloudflare/cfssl/releases/download/1.2.0/cfssl-certinfo_linux-amd64 -o /usr/local/bin/cfssl-certinfo\n# \u8d4b\u4e88\u6267\u884c\u6743\u9650\nchmod a+x /usr/local/bin/cfssl*\n</code></pre>"},{"location":"02.enhancement/03-sign-prepare/#2","title":"2. \u521b\u5efa\u8bc1\u4e66","text":"<pre><code># \u521b\u5efa\u8bc1\u4e66\u76ee\u5f55\nmkdir -p /opt/certs\n# \u8fdb\u5165\u76ee\u5f55\ncd /opt/certs\n</code></pre>"},{"location":"02.enhancement/03-sign-prepare/#21-ca","title":"2.1. \u521b\u5efa\u7b7e\u8bc1\u673a\u6784\uff08CA\uff09\u4fe1\u606f","text":"<p>\u521b\u5efa<code>/opt/certs/ca-csr.json</code>\u6587\u4ef6\uff0c\u6b64\u6587\u4ef6\u5b9a\u4e49\u7b7e\u8bc1\u673a\u6784\uff08CA\uff09\u7684\u76f8\u5173\u4fe1\u606f\uff0c\u586b\u5165\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>{\n\"CN\": \"etcd CA\",\n\"key\": {\n\"algo\": \"rsa\",\n\"size\": 2048\n},\n\"names\": [\n{\n\"C\": \"CN\",\n\"L\": \"Guangzhou\",\n\"ST\": \"Guangdong\",\n\"O\": \"od\",\n\"OU\": \"ops\"\n}\n],\n\"ca\": {\n\"expiry\": \"175200h\"\n}\n}\n</code></pre> <p>names \u7684\u76f8\u5173\u5b57\u6bb5\uff1a</p> <p><code>CN</code>: Common Name\uff0c\u4e00\u822c\u4f7f\u7528\u57df\u540d <code>C</code>: Country Code\uff0c\u7533\u8bf7\u5355\u4f4d\u6240\u5c5e\u56fd\u5bb6\uff0c\u53ea\u80fd\u662f\u4e24\u4e2a\u5b57\u6bcd\u7684\u56fd\u5bb6\u7801\u3002\u4f8b\u5982\uff0c\u4e2d\u56fd\u53ea\u80fd\u662fCN\u3002 <code>ST</code>: State or Province\uff0c\u5dde\u3001\u7701 <code>L</code>: Locality\uff0c\u5dde\u540d\u6216\u7701\u4efd\u540d\u79f0 <code>O</code>: Organization name\uff0c\u7ec4\u7ec7\u540d\u79f0\u3001\u516c\u53f8\u540d\u79f0 <code>OU</code>: Organization Unit Name\uff0c\u7ec4\u7ec7\u5355\u4f4d\u540d\u79f0\u3001\u516c\u53f8\u90e8\u95e8</p> <p>ca\u7684expiry\u5b57\u6bb5\u4ee3\u8868\u6709\u6548\u65f6\u95f4\uff0c175200h\u4ee3\u886820\u5e74</p>"},{"location":"02.enhancement/03-sign-prepare/#22-csr","title":"2.2. \u751f\u6210\u6839\u8bc1\u4e66 \u7684 CSR \u6587\u4ef6\u548c\u79d8\u94a5\u6587\u4ef6","text":"<p>\u7533\u8bf7\u6570\u5b57\u8bc1\u4e66\u4e4b\u524d\uff0c\u5fc5\u987b\u5148\u751f\u6210\u8bc1\u4e66\u7684\u5bc6\u94a5\u6587\u4ef6\u548cCSR\u6587\u4ef6\u3002CSR\u6587\u4ef6\u662f\u4f60\u7684\u516c\u94a5\u8bc1\u4e66\u539f\u59cb\u6587\u4ef6\uff0c\u5305\u542b\u4e86\u4f60\u7684\u670d\u52a1\u5668\u4fe1\u606f\u548c\u4f60\u7684\u5355\u4f4d\u4fe1\u606f\uff0c\u9700\u8981\u63d0\u4ea4\u7ed9CA\u8ba4\u8bc1\u4e2d\u5fc3\u8fdb\u884c\u5ba1\u6838\u3002</p> <p>\u4f7f\u7528 <code>cfssl</code> \u547d\u4ee4\u751f\u6210\u8bc1\u4e66\uff0c\u4f46\u751f\u6210\u7684\u8bc1\u4e66\u5185\u5bb9\u53ea\u4f1a\u8f93\u5165\u5728\u63a7\u5236\u53f0\u4e2d\uff0c\u6240\u4ee5\u9700\u8981\u4f7f\u7528<code>cfssl-json</code>\u751f\u6210\u627f\u8f7d\u5f0f\u8bc1\u4e66\u5199\u5165\u5230\u6587\u4ef6\u4e2d\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>cfssl gencert -initca ca-csr.json | cfssljson -bare ca -\n</code></pre> <p>\u751f\u6210\u4ee5\u4e0b\u4e09\u4e2a\u6587\u4ef6</p> <p><code>ca.csr</code>:  \u8bc1\u4e66\u7b7e\u540d\u7533\u8bf7\uff08Certificate Signing Request\uff09\u6587\u4ef6 <code>ca.pem</code>: ca\u516c\u94a5\u8bc1\u4e66 <code>ca-key.pem</code>: ca\u79c1\u94a5\u8bc1\u4e66</p> <p>\u6211\u4eec\u5728\u4fee\u6539ssh\u914d\u7f6e\u6587\u4ef6\uff0c\u652f\u6301\u540e\u7eed\u64cd\u4f5c\u7684\u4e3b\u673a\u53ef\u4ee5\u4e0b\u8f7d\u6211\u4eec\u5f53\u524d\u4e3b\u673a\u7684\u6587\u4ef6\uff0c\u4f7f\u7528<code>vim /etc/ssh/sshd_config</code>\u547d\u4ee4\u4fee\u6539ssh\u914d\u7f6e\u6587\u4ef6\uff0c\u5982\u4e0b</p> <pre><code>PasswordAuthentication yes\n</code></pre> <p>\u4fee\u6539\u597d\u914d\u7f6e\u6587\u4ef6\u4e4b\u540e\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u91cd\u542f\u670d\u52a1</p> <pre><code>systemctl restart sshd\n</code></pre>"},{"location":"02.enhancement/04-install-docker/","title":"\u4f7f\u7528\u4e8c\u8fdb\u5236\u5b89\u88c5\u5305\u7684\u65b9\u5f0f\u5b89\u88c5docker","text":"<p>\u672c\u6587\u53c2\u8003docker\u5b98\u65b9\u6587\u6863</p>"},{"location":"02.enhancement/04-install-docker/#1-docker","title":"1. \u5b89\u88c5docker","text":"<p>\u6211\u4eec\u8981\u5728k8s\u5de5\u4f5c\u8282\u70b9\uff08<code>kb21</code>\u548c<code>kb22</code>\u8fd9\u4e24\u53f0\u4e3b\u673a\uff09\u4e0a\u5b89\u88c5docker\uff0c\u540c\u65f6\u8fd8\u9700\u8981\u5728\u8fd0\u7ef4\u4e3b\u673a\u4e0a\u5b89\u88c5docker\uff08kb200\uff09\uff0c\u4ee5\u4e0b\u662f\u5b89\u88c5\u7684\u8fc7\u7a0b</p>"},{"location":"02.enhancement/04-install-docker/#11","title":"1.1. \u5305\u7ba1\u7406\u5de5\u5177\u5b89\u88c5","text":"<p>\u4f7f\u7528\u5b98\u65b9\u811a\u672c\u81ea\u52a8\u5b89\u88c5\uff0c\u6267\u884c\u5982\u4e0b\u547d\u4ee4</p> <pre><code># \u6307\u5b9a\u7248\u672c\u53d8\u91cf\nexport VERSION=19.03.15\n# \u5b89\u88c5docker\ncurl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun\n</code></pre>"},{"location":"02.enhancement/04-install-docker/#12","title":"1.2. \u4e8c\u8fdb\u5236\u5b89\u88c5","text":"<p>docker\u4e8c\u8fdb\u5236\u5b89\u88c5\u5305\u7684\u4e0b\u8f7d\u5730\u5740\u4e3a\uff1ahttps://download.docker.com/linux/static/stable/</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u6211\u4eec\u73b0\u5728\u88c5\u7684 docker \u7248\u672c\u5fc5\u987b\u5bf9\u5e94\u4e0a\u5373\u5c06\u5b89\u88c5\u7684 k8s \u7248\u672c\uff0c\u7406\u8bba\u4e0a\u8d8a\u65b0\u7684k8s\u7248\u672c\u652f\u6301\u7684docker \u7248\u672c\u8d8a\u591a\uff0c\u4f46\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5982\u679c\u9009\u62e9\u592a\u65b0\u7684docker\uff0c\u5373\u4f7f\u662f\u6700\u65b0\u7684k8s\u7248\u672c\u4e5f\u53ef\u80fd\u6765\u8fd8\u6765\u4e0d\u6025\u505a\u9002\u914d\u3002\u8fd9\u91cc\u6211\u4eec\u9009\u62e9\u4e00\u4e2a\u76f8\u5bf9\u7a33\u5b9a\u7684\u7248\u672c <code>19.03.15</code>\u3002</p> <pre><code># \u4e0b\u8f7d\u4e8c\u8fdb\u5236\u5b89\u88c5\u5305\nwget https://download.docker.com/linux/static/stable/x86_64/docker-19.03.15.tgz\n# \u89e3\u538b\u5b89\u88c5\u5305\ntar -zxvf docker-19.03.15.tgz\n# \u5c06\u89e3\u538b\u5305\u91cc\u7684\u5185\u5bb9\u79fb\u52a8\u7cfb\u7edf\u7684\u53ef\u6267\u884c\u6587\u4ef6\u76ee\u5f55\u4e2d\nmv docker/* /usr/local/bin/\n</code></pre>"},{"location":"02.enhancement/04-install-docker/#2-docker","title":"2. \u914d\u7f6edocker","text":"<p>\u521b\u5efa\u914d\u7f6e\u6587\u4ef6 <code>/etc/docker/daemon.json</code>\uff0c\u8bbe\u7f6e\u963f\u91cc\u4e91\u7684\u52a0\u901f\u955c\u50cf\u5730\u5740\uff0c\u5982\u4e0b\u5185\u5bb9</p> <pre><code>{\n\"storage-driver\": \"overlay2\",\n\"insecure-registries\": [\"harbor.od.com\"],\n\"registry-mirrors\": [\"https://g6ogy192.mirror.aliyuncs.com\"],\n\"bip\": \"172.7.21.1/24\",\n\"exec-opts\": [\"native.cgroupdriver=systemd\"],\n\"live-restore\": true\n}\n</code></pre> <p>\u8ddf\u591a\u7684\u914d\u7f6e\u9879\u53ef\u4ee5\u53c2\u8003\u5b98\u65b9\u6587\u6863\uff1ahttps://docs.docker.com/engine/reference/commandline/dockerd/#options</p>"},{"location":"02.enhancement/04-install-docker/#3-docker","title":"3. \u542f\u52a8\u4e0e\u9a8c\u8bc1docker","text":"<p>\u4f7f\u7528\u540e\u53f0\u8fd0\u884c\u7684\u65b9\u5f0f\u542f\u52a8<code>dockerd</code>\u670d\u52a1</p> <pre><code># \u542f\u52a8docker\u670d\u52a1\ndockerd &amp;\n# \u8fd0\u884c\u4e00\u4e2anginx\u5bb9\u5668\ndocker run --name nginx -p 80:80 -d nginx:alpine\n</code></pre> <p>\u4f7f\u7528<code>curl http://127.0.0.1</code>\u547d\u4ee4\u9a8c\u8bc1nginx\u5bb9\u5668\u662f\u5426\u6b63\u5e38\u8fd0\u884c\uff0c\u5982\u679c\u8f93\u51fa\u4ee5\u4e0b\u5185\u5bb9\uff0c\u4ee3\u8868docker\u5df2\u7ecf\u6b63\u5e38\u5de5\u4f5c</p> <pre><code>&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;style&gt;\nhtml { color-scheme: light dark; }\nbody { width: 35em; margin: 0 auto;\nfont-family: Tahoma, Verdana, Arial, sans-serif; }\n&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;\n&lt;p&gt;If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.&lt;/p&gt;\n&lt;p&gt;For online documentation and support please refer to\n&lt;a href=\"http://nginx.org/\"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;\nCommercial support is available at\n&lt;a href=\"http://nginx.com/\"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre>"},{"location":"02.enhancement/05-install-harbor/","title":"\u5b89\u88c5harbor","text":"<p>harbor\u662fdocker\u955c\u50cf\u7ba1\u7406\u8f6f\u4ef6\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528harbor\u642d\u5efa\u81ea\u5df1\u7684\u955c\u50cf\u670d\u52a1\u3002\u5728\u7f16\u5199\u6b64\u6587\u6863\u7684\u65f6\u5019\uff0charbor\u7684\u6700\u65b0\u7248\u672c\u662f<code>1.10.10</code>\u3002\u6211\u4eec\u5c06\u5728<code>kb200</code>\u8fd9\u53f0\u4e3b\u673a\u4e0a\u642d\u5efaharbor\u670d\u52a1\uff0c\u5728\u672c\u6587\uff0c\u6211\u4eec\u4e00\u8d77\u63a2\u8ba8harbor\u670d\u52a1\u7684\u642d\u5efa\u8fc7\u7a0b\u3002</p>"},{"location":"02.enhancement/05-install-harbor/#1-harbor","title":"1. \u4e0b\u8f7dharbor","text":"<p>harbor\u7684\u5b98\u65b9\u4e0b\u8f7d\u5730\u5740\u662f\uff1ahttps://github.com/goharbor/harbor/releases</p> <pre><code># \u4e0b\u8f7dharbor\nwget https://github.com/goharbor/harbor/releases/download/v1.10.10/harbor-offline-installer-v1.10.10.tgz\n# \u89e3\u538bharbor\u5230/opt/\u76ee\u5f55\ntar -xzvf harbor-offline-installer-v1.10.10.tgz -C /opt/\n</code></pre> <p>\u6b64\u65f6\uff0charbor\u89e3\u538b\u6240\u6709\u89e3\u538b\u5185\u5bb9\u5728 <code>/opt/harbor</code>\u76ee\u5f55\u4e2d\uff0c\u9996\u5148\u9700\u8981\u7f16\u8f91harbor\u76ee\u5f55\u4e0b\u7684\u914d\u7f6e\u6587\u4ef6<code>/opt/harbor/harbor.yml</code>\uff0c\u4fee\u6539\u5185\u5bb9\u5982\u4e0b</p> <pre><code># \u4fee\u6539\u4e3b\u673a\u540d\nhostname: harbor.od.com\n# \u4fee\u6539http\u670d\u52a1\uff0c\u56e0\u4e3a\u6211\u4eec\u5c06\u6765\u8fd8\u5728\u8fd9\u53f0\u4e3b\u673a\u8fd0\u884cnginx\uff0c\u6240\u4ee5harbor\u5c06harbor\u7aef\u53e3\u6539\u4e3a\u975e80\u7aef\u53e3\nhttp:\nport: 180\n# \u4fee\u6539\u7ba1\u7406\u5458\u7684\u9ed8\u8ba4\u5bc6\u7801\nharbor_admin_password: harbor123456\n# \u4fee\u6539\u6570\u636e\u7684\u5730\u5740\ndata_volume: /data/harbor\n# \u4fee\u6539\u65e5\u5fd7\u5730\u5740\nlog:\n# \u65e5\u5fd7\u7ea7\u522b\nlevel: info\n# \u6eda\u52a8\u6570\u91cf\nrotate_count: 50\n# \u6eda\u52a8\u5927\u5c0f\nrotate_size: 200M\n# \u65e5\u5fd7\u7684\u4f4d\u7f6e\nlocation: /data/harbor/logs\n# \u6ce8\u91ca\u6389https\u76f8\u5173\u914d\u7f6e\n#https:\n# https port for harbor, default is 443\n#port: 443\n# The path of cert and key files for nginx\n#certificate: /your/certificate/path\n#private_key: /your/private/key/path\n</code></pre> <p>\u521b\u5efa\u65e5\u5fd7\u76ee\u5f55</p> <pre><code>mkdir -p /data/harbor/logs\n</code></pre>"},{"location":"02.enhancement/05-install-harbor/#2-docker-compose","title":"2. \u5b89\u88c5docker-compose","text":"<p>harbor\u4f9d\u8d56\u4e8edocker-compose\u505a\u5355\u673a\u7f16\u6392\uff0c\u6240\u4ee5\u9700\u8981\u5b89\u88c5docker-compose\uff0cdocker-compose\u7684\u4e8c\u8fdb\u5236\u5b89\u88c5\u5305\u4e0b\u8f7d\u5730\u5740\u662f\uff1ahttps://github.com/docker/compose/releases/</p> <pre><code># \u5c06\u4e8c\u8fdb\u5236\u6587\u4ef6\u4fdd\u5b58\u5230\u672c\u5730\ncurl -L https://github.com/docker/compose/releases/download/v2.2.3/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose\n# \u8d4b\u4e88\u4e8c\u8fdb\u5236\u6587\u4ef6\u6267\u884c\u6743\u9650\nchmod +x /usr/local/bin/docker-compose\n</code></pre>"},{"location":"02.enhancement/05-install-harbor/#3-harbor","title":"3. \u5b89\u88c5harbor","text":"<p>\u5b89\u88c5\u597d\u7cfb\u7edf\u91cc\u6709docker\u4e0edocker-compose\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u6267harbor\u7684\u5b89\u88c5\u547d\u4ee4\u4e86\uff0c\u6267\u884c\u5b89\u88c5\u811a\u672c\u5982\u4e0b</p> <pre><code>bash /opt/harbor/install.sh\n</code></pre> <p>\u6267\u884c\u5b8c\u6210\u5b89\u88c5\u811a\u672c\u4e4b\u540e\uff0c\u53ef\u4ee5\u4f7f\u7528<code>docker-compose ps</code>\u67e5\u770b\u5bb9\u5668\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u3002\u5982\u679c\u73b0\u5b9e\u5982\u4e0b\u76f8\u4f3c\u5185\u5bb9\uff0c\u4ee3\u8868harbor\u5df2\u7ecf\u6b63\u5e38\u8fd0\u884c</p> <pre><code>[root@kb200 harbor]# docker-compose ps\nNAME                COMMAND                  SERVICE             STATUS              PORTS\nharbor-core         \"/harbor/harbor_core\"    core                running (healthy)   harbor-db           \"/docker-entrypoint.\u2026\"   postgresql          running (healthy)   5432/tcp\nharbor-jobservice   \"/harbor/harbor_jobs\u2026\"   jobservice          running (healthy)   harbor-log          \"/bin/sh -c /usr/loc\u2026\"   log                 running (healthy)   127.0.0.1:1514-&gt;10514/tcp\nharbor-portal       \"nginx -g 'daemon of\u2026\"   portal              running (healthy)   8080/tcp\nnginx               \"nginx -g 'daemon of\u2026\"   proxy               running (healthy)   0.0.0.0:180-&gt;8080/tcp\nredis               \"redis-server /etc/r\u2026\"   redis               running (healthy)   6379/tcp\nregistry            \"/home/harbor/entryp\u2026\"   registry            running (healthy)   5000/tcp\nregistryctl         \"/home/harbor/start.\u2026\"   registryctl         running (healthy)\n</code></pre>"},{"location":"02.enhancement/05-install-harbor/#4-nginx","title":"4. \u5b89\u88c5nginx","text":""},{"location":"02.enhancement/05-install-harbor/#41","title":"4.1. \u6e90\u7801\u5b89\u88c5","text":"<p>nginx\u7684\u6e90\u4ee3\u7801\u7684\u4e0b\u8f7d\u5730\u5740\u662f\uff1ahttps://nginx.org/en/download.html</p> <p>\u5728\u7f16\u5199\u6587\u6863\u7684\u65f6\u5019\uff0cnginx\u7684\u6700\u65b0\u7248\u672c\u662f<code>1.21.6</code>\uff0c\u4e0b\u8f7dnginx\u6e90\u4ee3\u7801\uff0c\u5e76\u7f16\u8bd1\u5b89\u88c5\uff0c\u547d\u4ee4\u5982\u4e0b\uff1a</p> <pre><code># \u4e0b\u8f7d\u4e91\u4ee3\u7801\nwget https://nginx.org/download/nginx-1.21.6.tar.gz\n# \u89e3\u538b\u6587\u4ef6\ntar -zxvf nginx-1.21.6.tar.gz\n# \u8fdb\u5165\u6e90\u7801\u76ee\u5f55\ncd nginx-1.21.6\n# \u914d\u7f6e\u7f16\u8bd1\u53c2\u6570\uff0c--prefix\u53c2\u6570\u6307\u5b9a\u5b89\u88c5\u76ee\u5f55\n./configure --prefix=/usr/local/nginx\n# \u7f16\u8bd1\u5e76\u5b89\u88c5\nmake &amp;&amp; make install\n</code></pre> <p>\u7f16\u8bd1nginx\u65f6\uff0c\u53ef\u80fd\u4f1a\u63d0\u793a\u4f60\u7f3a\u5c11\u76f8\u5173\u7684\u4f9d\u8d56\u5e93\uff0c\u6839\u636e\u63d0\u793a\u8fdb\u884c\u5b89\u88c5\u5373\u53ef\u3002</p> <p>\u6211\u4eec\u5728nginx\u7684\u914d\u7f6e\u6587\u4ef6<code>/usr/local/nginx/conf/nginx.conf</code>\u4e2d\u6dfb\u52a0\u4ee5\u4e0b<code>server</code>\u8282\u70b9</p> <pre><code>server {\n    listen  80;\n    server_name  harbor.od.com;\n    client_max_body_size  1000m;\n    location / {\n        proxy_pass http://127.0.0.1:180;\n    }\n}\n</code></pre> <p>\u914d\u7f6e\u597d\u4e86\u4e4b\u540e\uff0c\u6211\u4eec\u901a\u8fc7\u4e0b\u547d\u4ee4\u542f\u52a8nginx</p> <pre><code>/usr/local/nginx/sbin/nginx\n</code></pre>"},{"location":"02.enhancement/05-install-harbor/#42-yum","title":"4.2. yum\u8f6f\u4ef6\u5305\u5b89\u88c5","text":"<p>\u8bbe\u7f6e\u53cd\u5411\u4ee3\u7406</p> <p>\u53ef\u4ee5yum\u5b89\u88c5\u547d\u4ee4\u5982\u4e0b</p> <pre><code>yum install -y nginx\n</code></pre> <p>\u6dfb\u52a0\u914d\u7f6e\u6587\u4ef6<code>/etc/nginx/conf.d/harbor.od.conf</code>\uff0c\u5e76\u52a0\u5165\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>server {\nlisten  80;\nserver_name  harbor.od.com;\nclient_max_body_size  1000m;\nlocation / {\nproxy_pass http://127.0.0.1:180;\n}\n}\n</code></pre> <p>\u914d\u7f6e\u597d\u4e4b\u540e\uff0c\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u542f\u52a8nginx</p> <pre><code># \u68c0\u6d4b\u914d\u7f6e\u6587\u4ef6\u662f\u5426\u6b63\u786e\nnginx -t\n# \u542f\u52a8nginx\u670d\u52a1\nnginx\n</code></pre> <p>\u5f00\u542fIP\u8f6c\u53d1\u529f\u80fd</p> <p>\u5982\u679c\u6211\u4eec\u7684IP\u6ca1\u6709\u5f00\u542f\u8f6c\u53d1\u529f\u80fd\uff0c\u5b9e\u9645\u4e0aharbor\u5bf9\u4e8e\u5916\u7f51\u7684\u670d\u52a1\u53ef\u80fd\u662f\u4e0d\u6b63\u5e38\u7684\uff0c \u4f7f\u7528 <code>sysctl net.ipv4.ip_forward</code> \u547d\u4ee4\u67e5\u770b IP\u662f\u5426\u5df2\u5f00\u542f\u4e86\u8f6c\u53d1\u529f\u80fd\uff0c\u5982\u679c\u8fd4\u56de\u4ee5\u4e0b\u5185\u5bb9\uff0c\u4ee3\u8868\u6ca1\u6709\u6b63\u5e38\u5f00\u542f</p> <pre><code>net.ipv4.ip_forward = 0\n</code></pre> <p>\u5982\u679c\u6ca1\u6709\u5f00\u542f\uff0c\u4f7f\u7528\u4ee5\u4e0b\u6b65\u9aa4\u8fdb\u884c\u5f00\u542f</p> <p>\u7b2c\u4e00\u6b65\uff0c \u7f16\u8f91<code>/etc/sysctl.conf</code>\u6587\u4ef6\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>net.ipv4.ip_forward = 1 # \u8fd9\u4e2a\u914d\u7f6e\u6539\u62101\uff0c0\u662f\u6ca1\u6253\u5f00\n</code></pre> <p>\u7b2c\u4e8c\u6b65\uff0c\u91cd\u542f\u7f51\u7edc\uff1a</p> <pre><code>service network restart\n</code></pre> <p>\u7b2c\u4e09\u6b65\uff0c\u4fee\u6539DNS\uff1a</p> <p>\u5f53\u6211\u4eec\u91cd\u542f\u7f51\u7edc\u670d\u52a1\u4e4b\u540e\uff0c\u865a\u62df\u673a\u7684DNS\u91cd\u7f6e\u4f1avagrant\u7684DNS\uff0c\u6211\u4eec\u4fee\u6539DNS\u914d\u7f6e\u6587\u4ef6<code>/etc/resolv.conf</code>\uff0c\u5c06DNS\u670d\u52a1\u5668\u4fee\u6539\u4e3a\u5982\u4e0b</p> <pre><code>search host.com\nnameserver 192.168.14.11\n</code></pre>"},{"location":"02.enhancement/05-install-harbor/#5","title":"5. \u6dfb\u52a0\u57df\u540d\u89e3\u6790","text":"<p>\u5728\u4e0a\u9762\u7684\u6b65\u9aa4\u4e2d\uff0c\u6211\u4eec\u53d1\u73b0\u8bbf\u95ee<code>harbor.od.com</code>\u57df\u540d\u7684\u65f6\u5019\u5e76\u4e0d\u4f1a\u89e3\u6790\u5230kb200\u8fd9\u53f0\u4e3b\u673a\uff0c\u6211\u4eec\u9700\u8981\u56de\u5230kb11\u8fd9\u53f0\u57df\u540d\u89e3\u6790\u670d\u52a1\u5668\u6dfb\u52a0\u4e0a<code>harbor.od.com</code>\u8fd9\u4e2a\u57df\u540d\u3002\u5728kb11\u8fd9\u53f0\u8fd9\u51e0\u4e0a\u6253\u5f00<code>/var/named/od.com.zone</code>\u6587\u4ef6\uff0c\u4fee\u6539\u4e3a\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>$ORIGIN od.com.\n$TTL 600 ; 10 minutes\n@ IN SOA dns.od.com. dnsadmin.od.com. (\n    2022012003 ; serial \u5f80\u540e\u6dfb\u52a0\u4e00\u4e2a\u5e8f\u5217\u53f7\n    10800      ; refresh (3 hours)\n    900        ; retry (15 minutes)\n    604800     ; expire (1 week)\n    86400      ; minium (1 day)\n    )\n    NS dns.od.com.\n\n$TTL 60    ;   1 minute\ndns    A   10.4.7.11\n; \u6dfb\u52a0harbor\u7684\u89e3\u6790\nharbor    A   192.168.14.200\n</code></pre> <p>\u4f7f\u7528<code>systemctl restart named</code>\u91cd\u542f\u57df\u540d\u89e3\u6790\u670d\u52a1\uff0c\u5e76\u4f7f\u7528<code>dig -t A harbor.od.com +short</code>\uff0c\u5982\u679c\u6b63\u5e38\u8fd4\u56de<code>192.168.14.200</code>\u5219\u4ee3\u8868\u89e3\u6790\u6210\u529f\u3002\u6b64\u65f6\uff0charbor\u5df2\u7ecf\u5b89\u88c5\u6210\u529f\u4e86\uff0c\u5982\u679c\u6211\u4eec\u7684\u7535\u8111\u672c\u8eab\u89e3\u6790 <code>harbor.od.com</code> \u5230kb200\u8fd9\u53f0\u4e3b\u673a\u7684\u8bdd\uff0c\u6b64\u65f6\u6211\u4eec\u80fd\u6b63\u5e38\u8bbf\u95eeharbor\u7684web\u670d\u52a1\u3002</p>"},{"location":"02.enhancement/05-install-harbor/#6","title":"6. \u63a8\u9001\u955c\u50cf","text":"<p>harhor\u670d\u52a1\u5b89\u88c5\u6210\u529f\u540e\uff0c\u6211\u4eec\u8fdb\u5165\u5df2\u7ecf\u5b89\u88c5\u597ddocker\u7684<code>kb21</code>\u4e3b\u673a\u6216\u8005<code>kb22</code>\u4e3b\u673a\uff0c\u5c1d\u8bd5\u5c06\u955c\u50cf\u63a8\u9001\u5230harbor\u4e2d\uff0c\u4f7f\u7528<code>docker login harbor.od.com</code>\u547d\u4ee4\u767b\u5f55\u5230harbor\u3002\u8d26\u53f7\u662f<code>admin</code>\uff0c\u5bc6\u7801\u662f\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684<code>harbor123456</code>\uff0c\u5982\u679c\u8fd4\u56de\u7c7b\u4f3c\u5982\u4e0b\u5185\u5bb9\uff0c\u4ee3\u8868\u767b\u5f55\u6210\u529f</p> <pre><code>[root@kb200 harbor]# docker login harbor.od.com\nUsername: admin\nPassword: WARNING! Your password will be stored unencrypted in /root/.docker/config.json.\nConfigure a credential helper to remove this warning. See\nhttps://docs.docker.com/engine/reference/commandline/login/#credentials-store\n\nLogin Succeeded\n</code></pre> <p>\u63a5\u4e0b\u6765\u8fdb\u884c\u955c\u50cf\u63a8\u9001\u64cd\u4f5c</p> <pre><code># \u4ecedocker\u5b98\u65b9\u955c\u50cf\u7ad9\u62c9\u53d6nginx:alpine\u955c\u50cf\ndocker pull nginx:alpine\n# \u5c06nginx:alpine\u955c\u50cf\u6253\u4e3a\u81ea\u5efa\u7684harbor\u670d\u52a1\u7684\u955c\u50cf\ndocker tag nginx:alpine harbor.od.com/library/nginx:alpine\n# \u63a8\u9001\u955c\u50cf\ndocker push harbor.od.com/library/nginx:alpine\n</code></pre> <p>\u5982\u679c\u63a8\u9001\u955c\u50cf\u80fd\u6b63\u5e38\u8f93\u5165\u4ee5\u4e0b\u7ed3\u679c\uff0c\u4ee3\u8868harbor\u670d\u52a1\u6b63\u5e38</p> <pre><code>[root@kb200 harbor]# docker push harbor.od.com/library/nginx:alpine\nINFO[2022-02-23T15:58:41.697385855Z] Attempting next endpoint for push after error: Get https://harbor.od.com/v2/: dial tcp 127.0.0.1:443: connect: connection refused The push refers to repository [harbor.od.com/library/nginx]\n419df8b60032: Pushed 0e835d02c1b5: Pushed 5ee3266a70bd: Pushed 3f87f0a06073: Pushed 1c9c1e42aafa: Pushed 8d3ac3489996: Pushed alpine: digest: sha256:544ba2bfe312bf2b13278495347bb9381ec342e630bcc8929af124f1291784bb size: 1568\n</code></pre>"},{"location":"02.enhancement/06-install-etcd/","title":"\u5b89\u88c5etcd","text":"<p>\u6211\u4eec\u5c06\u4f7f\u7528<code>kb12</code>\u3001<code>kb21</code>\u3001<code>kb22</code>\u8fd9\u4e09\u53f0\u4e3b\u673a\u4f5c\u4e3a\u63a7\u5236\u8282\u70b9\uff0c\u9996\u5148\u5728\u63a7\u5236\u8282\u70b9\u4e0a\u642d\u5efaectd\u96c6\u7fa4\u3002</p>"},{"location":"02.enhancement/06-install-etcd/#1-ssl","title":"1. \u51c6\u5907ssl\u8bc1\u4e66","text":"<p>\u767b\u5f55\u5230<code>kb200</code>\u8bc1\u4e66\u7b7e\u53d1\u670d\u52a1\u5668\u3002\u5728\u672c\u7cfb\u5217\u7684\u7b2c\u4e09\u7bc7\u4e2d\uff0c\u6211\u4eec\u5df2\u7ecf\u8fdb\u884c\u4e86\u6839\u8bc1\u4e66\u7684\u7b7e\u53d1\u3002\u73b0\u5728\u6211\u4eec\u9700\u8981\u57fa\u4e8e\u8bc1\u4e66\u670d\u52a1\u5668\u7684\u6839\u8bc1\u4e66\u4e3aetcd\u670d\u52a1\u521b\u5efassl\u8bc1\u4e66\u3002\u4ee5\u4e0b \u662f\u5177\u4f53\u7684\u7b7e\u53d1\u8fc7\u7a0b</p> <p>1.1. \u5b9a\u4e49\u8bc1\u4e66\u4fe1\u606f</p> <p>\u521b\u5efa\u8bc1\u4e66\u4fdd\u5b58\u76ee\u5f55</p> <pre><code># \u5728\u6839\u8bc1\u4e66\u76ee\u5f55\u4e0b\u521b\u5efa\u4e13\u95e8\u5b58\u653eetcd\u8bc1\u4e66\u7684\u76ee\u5f55\nmkdir -p /opt/certs/etcd\n# \u8fdb\u5165etcd\u8bc1\u4e66\u76ee\u5f55\ncd /opt/certs/etcd\n</code></pre> <p>\u6211\u4eec\u5148\u5728<code>/opt/certs/</code>\u521b\u5efa<code>ca-config.json</code>\u6587\u4ef6\uff0c\u5b9a\u4e49\u8bc1\u4e66\u7684\u57fa\u672c\u4fe1\u606f\uff0c\u5199\u5165\u5982\u4e0b\u5185\u5bb9</p> <pre><code>{\n\"signing\": {\n\"default\": {\n\"expiry\": \"175200h\"\n},\n\"profiles\": {\n\"server\": {\n\"expiry\": \"175200h\",\n\"usages\": [\n\"signing\",\n\"key encipherment\",\n\"server auth\"\n]\n},\n\"client\": {\n\"expiry\": \"175200h\",\n\"usages\": [\n\"signing\",\n\"key encipherment\",\n\"client auth\"\n]\n},\n\"peer\": {\n\"expiry\": \"175200h\",\n\"usages\": [\n\"signing\",\n\"key encipherment\",\n\"server auth\",\n\"client auth\"\n]\n}\n}\n}\n}\n</code></pre> <p>\u4e0a\u9762\u7684\u6587\u4ef6\u5b9a\u4e49\u4e86\u8bc1\u4e66\u7684\u57fa\u672c\u4fe1\u606f\uff0c\u5176\u4e2d<code>profiles</code>\u91cc\u53ef\u4ee5\u5305\u542b\u591a\u4e2a\u6863\u6848\u5bf9\u8c61\u3002\u6211\u4eec\u5b9a\u4e86\u4e09\u4e2a\u8282\u70b9\uff0c\u5173\u952e\u4e0d\u540c\u7684\u914d\u7f6e\u5728<code>usages</code>\u8282\u70b9\uff0c\u5982\u4e0b\uff1a</p> <p><code>server</code>\uff1a\u670d\u52a1\u5668\u53bb\u8fde\u63a5\u5ba2\u6237\u7aef\u65f6\uff0c\u9700\u8981\u8bc1\u4e66 <code>client</code>\uff1a\u5ba2\u6237\u7aef\u53bb\u8fde\u63a5\u670d\u52a1\u5668\u65f6\uff0c\u9700\u8981\u8bc1\u4e66 <code>peer</code>\uff1a\u662f\u670d\u52a1\u5668\u4e0e\u5ba2\u6237\u7aef\u4ea4\u6362\u6570\u636e\uff0c\u90fd\u9700\u8981\u8bc1\u4e66\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u57fa\u4e8e<code>peer</code>\u5c5e\u6027\u521b\u5efa\u8bc1\u4e66\u3002</p> <p>\u63a5\u4e0b\u6765\u5728<code>/opt/certs/etcd</code>\u76ee\u5f55\u521b\u5efa\u8bc1\u4e66\u8bf7\u6c42\u6587\u4ef6<code>etcd-peer-csr.json</code>\uff0c\u5199\u5165\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>{\n\"CN\": \"etcd\",\n\"hosts\": [\n\"192.168.14.11\",\n\"192.168.14.12\",\n\"192.168.14.21\",\n\"192.168.14.22\"\n],\n\"key\": {\n\"algo\": \"rsa\",\n\"size\": 2048\n},\n\"names\": [{\n\"C\": \"CN\",\n\"ST\": \"Guangdong\",\n\"L\": \"Guangzhou\",\n\"O\": \"od\",\n\"OU\": \"ops\"\n}]\n}\n</code></pre> <p>\u76f8\u5173\u53c2\u6570\uff1a</p> <ul> <li><code>CN</code>\uff1a\u8bc1\u4e66\u540d\u79f0</li> <li><code>hosts</code>\uff1a\u9881\u53d1\u7684\u4e3b\u673a</li> <li><code>key</code>\uff1a\u5b9a\u4e49\u8bc1\u4e66\u7c7b\u578b\uff0calgo\u4e3a\u52a0\u5bc6\u7c7b\u578b\uff0csize\u4e3a\u52a0\u5bc6\u957f\u5ea6</li> <li><code>names</code>\uff1a\u8bc1\u4e66\u7684\u57fa\u672c\u4fe1\u606f</li> </ul> <p>1.2. \u5411\u7b7e\u8bc1\u673a\u6784\uff08CA\uff09\u7533\u8bf7\u8bc1\u4e66</p> <p>\u5b8c\u6210\u4ee5\u4e0a\u6b65\u9aa4\uff0c\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u7ed9\u5ba2\u6237\u7aef\u7533\u8bf7\u8bc1\u4e66</p> <pre><code>cfssl gencert -ca=../ca.pem -ca-key=../ca-key.pem -config=../ca-config.json -profile=peer etcd-peer-csr.json | cfssljson -bare etcd-peer\n</code></pre>"},{"location":"02.enhancement/06-install-etcd/#2-ectd","title":"2. \u5b89\u88c5ectd","text":"<p>\u6211\u4eec\u5c06\u5728<code>kb12</code>\u3001<code>kb21</code>\u3001<code>kb22</code>\u8fd9\u4e09\u53f0\u4e3b\u673a\u4e0a\u5b89\u88c5etcd\uff0c\u7ec4\u6210\u4e00\u4e2aectd\u96c6\u7fa4\u3002\u5728\u64b0\u5199\u8fd9\u7bc7\u6587\u6863\u7684\u65f6\u5019\u5417\uff0cetcd\u6700\u65b0\u7684\u7248\u672c\u662f<code>3.5</code>\uff0c\u6211\u4eec\u9009\u62e9\u4e00\u4e2a\u8f83\u65b0\u8f83\u7a33\u5b9a\u7684\u7248\u672c<code>3.4.18</code>\uff0c\u5177\u4f53\u64cd\u4f5c\u5982\u4e0b\uff1a</p> <p>\u5148\u521b\u5efa\u4e00\u4e2aectd\u7528\u6237\uff0c\u7981\u6b62\u8be5\u7528\u6237\u8fdc\u7a0b\u767b\u5f55\uff0c\u5e76\u4e14\u6ca1\u6709\u5bb6\u76ee\u5f55\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>useradd -s /sbin/nologin -M etcd\n</code></pre> <p>\u5b89\u88c5</p> <pre><code># \u4e0b\u8f7d\u5bf9\u5e94\u7248\u672c\nwget https://github.com/etcd-io/etcd/releases/download/v3.1.18/etcd-v3.1.18-linux-amd64.tar.gz\n# \u89e3\u538b\ntar -zxvf etcd-v3.1.18-linux-amd64.tar.gz\n# \u5c06etc\u79fb\u5230/opt\u76ee\u5f55\uff0c\u5e76\u4fee\u6539etcd\u76ee\u5f55\u540d\nmv etcd-v3.1.18-linux-amd64/ /opt/etcd-v3.1.18\n# \u521b\u5efaetcd\u8f6f\u94fe\u63a5\nln -s /opt/etcd-v3.1.18 /opt/etcd\n# \u521b\u5efaetcd\u8bc1\u4e66\u76ee\u5f55\u548c\u6570\u636e\u76ee\u5f55\nmkdir -p /opt/etcd/certs /data/etcd /data/logs/etcd-server\n# \u8fdb\u5165\u8bc1\u4e66\u76ee\u5f55\ncd /opt/etcd/certs\n# \u4ece\u8bc1\u4e66\u670d\u52a1\u5668\u4e0b\u8f7d\u8bc1\u4e66\nscp root@kb200.host.com:/opt/certs/ca.pem ./\nscp root@kb200.host.com:/opt/certs/etcd/etcd-peer.pem ./\nscp root@kb200.host.com:/opt/certs/etcd/etcd-peer-key.pem ./\n</code></pre> <p>\u6b64\u65f6\uff0c\u4f7f\u7528<code>ls -l</code>\u547d\u4ee4\u53ef\u67e5\u770b\u5230\u4e24\u5f20\u8bc1\u4e66\u548c\u4e00\u4e2a\u79c1\u94a5\u6587\u4ef6\uff0c\u5982\u4e0b\u5185\u5bb9</p> <pre><code>[root@kb12 certs]# ls -l\ntotal 12\n-rw-r--r-- 1 root root 1350 Feb 24 17:32 ca.pem\n-rw------- 1 root root 1675 Feb 24 17:33 etcd-peer-key.pem\n-rw-r--r-- 1 root root 1415 Feb 24 17:33 etcd-peer.pem\n</code></pre> <p>\u7ed9\u6240\u6709etcd\u7528\u6237\u9700\u8981\u8bfb\u5199\u7684\u76ee\u5f55\u8d4b\u4e88\u6743\u9650</p> <pre><code># \u5c06\u76ee\u5f55\u6743\u9650\u6539\u4e3aetcd\u7528\u6237\nchown -R etcd.etcd /opt/etcd/certs /data/etcd/ /data/logs/etcd-server\n</code></pre>"},{"location":"02.enhancement/06-install-etcd/#3-etcd","title":"3. \u7f16\u5199etcd\u542f\u52a8\u811a\u672c","text":"<p>\u6211\u4eec\u5148\u5728etcd\u76ee\u5f55\u7f16\u5199\u542f\u52a8\u811a\u672c<code>/opt/etcd/startup.sh</code>\uff0c\u5982\u4e0b</p> <pre><code>#!/bin/sh\n./etcd --name etcd-server-12 \\\n--data-dir /data/etcd/etcd-server \\\n--listen-peer-urls https://192.168.14.12:2380 \\\n--listen-client-urls https://192.168.14.12:2379,http://127.0.0.1:2379 \\\n--quota-backend-bytes 8000000000 \\\n--initial-advertise-peer-urls https://192.168.14.12:2380 \\\n--advertise-client-urls https://192.168.14.12:2379,http://127.0.0.1:2379 \\\n--initial-cluster etcd-server-12=https://192.168.14.12:2380,etcd-server-21=https://192.168.14.21:2380,etcd-server-22=https://192.168.14.22:2380 \\\n--initial-cluster-token=\"etcd-token\" \\\n--initial-cluster-state=new \\\n--cert-file ./certs/etcd-peer.pem \\\n--key-file ./certs/etcd-peer-key.pem \\\n--client-cert-auth \\\n--trusted-ca-file ./certs/ca.pem \\\n--peer-cert-file ./certs/etcd-peer.pem \\\n--peer-key-file ./certs/etcd-peer-key.pem \\\n--peer-client-cert-auth \\\n--peer-trusted-ca-file ./certs/ca.pem\n</code></pre> <p>\u7ed9\u542f\u52a8\u811a\u672c\u6dfb\u52a0\u6743\u9650 <pre><code>chmod +x startup.sh\n</code></pre></p> <p>\u53c2\u6570\u8bf4\u660e\uff1a</p> <p><code>--name</code>\uff1a\u5f53\u524detcd\u7684\u552f\u4e00\u540d\u79f0\uff0c\u8981\u4fdd\u8bc1\u548c\u5176\u4ed6\u8282\u70b9\u4e0d\u51b2\u7a81\uff0c\u73af\u5883\u53d8\u91cf: ETCD_DATA_DIR <code>--data-dir</code>\uff1a\u6307\u5b9aetcd\u5b58\u50a8\u6570\u636e\u7684\u5b58\u50a8\u4f4d\u7f6e\uff0c\u73af\u5883\u53d8\u91cf: ETCD_NAME <code>--listen-peer-urls</code>\uff1a\u7aef\u5bf9\u7aef\u7684\u901a\u4fe1url\uff0c\u5305\u542b\u4e3b\u673a\u5730\u5740\u548c\u7aef\u53e3\u53f7\uff0c\u6307\u5b9a\u5f53\u524detcd\u548c\u5176\u4ed6\u8282\u70b9etcd\u901a\u4fe1\u65f6\u7684\u670d\u52a1\u5730\u5740\u548c\u7aef\u53e3\u3002\u5047\u5982etcd\u96c6\u7fa4\u4e2d\u5305\u542b\u4e09\u4e2aetcd\u670d\u52a1\uff0c\u90a3\u4e48\u4e09\u4e2aetcd\u8282\u70b9\u6784\u6210\u4e86\u4e00\u4e2a\u9ad8\u53ef\u7528\u96c6\u7fa4\uff0cetcd\u96c6\u7fa4\u4f1a\u81ea\u52a8\u9009\u4e3e\u4e00\u4e2a\u8282\u70b9\u4f5c\u4e3a\u4e3b\u8282\u70b9\uff0c\u53e6\u5916\u4e24\u4e2a\u8282\u70b9\u4f5c\u4e3a\u4ece\u8282\u70b9\u3002\u6240\u6709\u7684\u5199\u5165\u64cd\u4f5c\u5c06\u5f80\u4e3b\u8282\u70b9\u5199\uff0c\u6240\u6709\u7684\u8bfb\u64cd\u4f5c\u5728\u4ece\u8282\u70b9\u4e0a\u8bfb\uff0c\u8fd9\u662fetcd\u8bfb\u5199\u7684\u8fc7\u7a0b\u3002\u4e0a\u8ff0\u8bbe\u7f6e\u76842380\u7aef\u53e3\uff0c\u7528\u6765\u76d1\u542c\u5176\u4ed6etcd\u8282\u70b9\u53d1\u9001\u8fc7\u6765\u7684\u6570\u636e\uff0c\u73af\u5883\u53d8\u91cf: ETCD_LISTEN_PEER_URLS <code>--listen-client-urls</code>\uff1a\u6307\u5b9a\u5f53\u524detcd\u63a5\u6536\u5ba2\u6237\u7aef\u6307\u4ee4\u7684\u5730\u5740\u548c\u7aef\u53e3\uff0c\u5728\u8fd9\u91cc\u7684\u5ba2\u6237\u7aef\u6211\u4eec\u6307\u7684\u662fk8s\u96c6\u7fa4\u7684master\u8282\u70b9\uff0c\u73af\u5883\u53d8\u91cf: ETCD_LISTEN_CLIENT_URLS <code>--quota-backend-bytes</code>\uff1a\u540e\u7aef\u7684\u914d\u989d <code>--initial-advertise-peer-urls</code>\uff1a\u6307\u5b9aetcd\u5e7f\u64ad\u7aef\u53e3\uff0c\u5f53\u524detcd\u4f1a\u5c06\u6570\u636e\u540c\u6b65\u5230\u5176\u4ed6\u8282\u70b9\uff0c\u901a\u8fc72380\u7aef\u53e3\u53d1\u9001\uff0c\u73af\u5883\u53d8\u91cf: ETCD_INITIAL_ADVERTISE_PEER_URLS <code>--advertise-client-urls</code>\uff1a\u7ed9\u5ba2\u6237\u7aef\u901a\u544a\u7684\u7aef\u53e3\uff0c\u73af\u5883\u53d8\u91cf: ETCD_ADVERTISE_CLIENT_URLS <code>--initial-cluster</code>\uff1a\u5b9a\u4e49etcd\u96c6\u7fa4\u4e2d\u6240\u6709\u8282\u70b9\u7684\u540d\u79f0\u548cIP\uff0c\u4ee5\u53ca\u901a\u4fe1\u7aef\u53e3\uff0c\u73af\u5883\u53d8\u91cf: ETCD_INITIAL_CLUSTER <code>--initial-cluster-token</code>\uff1a\u5b9a\u4e49etcd\u4e2d\u7684token\uff0c\u6240\u6709\u8282\u70b9\u7684token\u5fc5\u987b\u4fdd\u6301\u4e00\u81f4\uff0c\u73af\u5883\u53d8\u91cf: ETCD_INITIAL_CLUSTER_TOKEN <code>--initial-cluster-state</code>\uff1a\u5b9a\u4e49etcd\u96c6\u7fa4\u7684\u72b6\u6001\uff0cnew\u4ee3\u8868\u65b0\u5efa\u96c6\u7fa4\uff0cexisting\u4ee3\u8868\u52a0\u5165\u73b0\u6709\u96c6\u7fa4\uff0c\u73af\u5883\u53d8\u91cf: ETCD_INITIAL_CLUSTER_STATE <code>--cert-file</code>\uff1a\u5ba2\u6237\u7aef\u670d\u52a1\u5668 TLS \u8bc1\u4e66\u6587\u4ef6\u7684\u8def\u5f84\uff0c\u73af\u5883\u53d8\u91cf: ETCD_PEER_CERT_FILE <code>--key-file</code>\uff1a\u5ba2\u6237\u7aef\u670d\u52a1\u5668 TLS key \u6587\u4ef6\u7684\u8def\u5f84\uff0c\u73af\u5883\u53d8\u91cf: ETCD_PEER_KEY_FILE <code>--client-cert-auth</code>\uff1a\u5f00\u542f\u5ba2\u6237\u7aef\u8bc1\u4e66\u8ba4\u8bc1\uff0c\u73af\u5883\u53d8\u91cf: ETCD_PEER_CLIENT_CERT_AUTH <code>--trusted-ca-file</code>\uff1a\u5ba2\u6237\u7aef\u670d\u52a1\u5668 TLS \u4fe1\u4efb\u8bc1\u4e66\u6587\u4ef6\u7684\u8def\u5f84\uff0c\u73af\u5883\u53d8\u91cf: ETCD_PEER_TRUSTED_CA_FILE <code>--peer-cert-file</code>\uff1apeer server TLS \u8bc1\u4e66\u6587\u4ef6\u7684\u8def\u5f84\uff0c\u73af\u5883\u53d8\u91cf: ETCD_PEER_CERT_FILE <code>--peer-key-file</code>\uff1apeer server TLS key \u6587\u4ef6\u7684\u8def\u5f84\uff0c\u73af\u5883\u53d8\u91cf: ETCD_PEER_KEY_FILE <code>--peer-client-cert-auth</code>\uff1a\u5f00\u542f peer client \u8bc1\u4e66\u9a8c\u8bc1\uff0c\u73af\u5883\u53d8\u91cf: ETCD_PEER_CLIENT_CERT_AUTH <code>--peer-trusted-ca-file</code>\uff1apeer server TLS \u4fe1\u4efb\u8bc1\u4e66\u6587\u4ef6\u8def\u5f84\uff0c\u73af\u5883\u53d8\u91cf: ETCD_PEER_TRUSTED_CA_FILE</p> <p>\u5176\u4ed6\u53c2\u6570\uff1assl\u8bc1\u4e66\u76f8\u5173\u8bc1\u4e66</p>"},{"location":"02.enhancement/06-install-etcd/#4-supervisordetcd","title":"4. \u4f7f\u7528supervisord\u6765\u542f\u52a8etcd","text":"<p>\u73b0\u5728\u6211\u4eec\u8981\u5b89\u88c5supervisord\uff0c\u7528\u4e8e\u7ba1\u7406etcd\u670d\u52a1</p> <pre><code># \u5b89\u88c5supervisor\nyum install supervisor -y\n# \u542f\u52a8supervisord\nsystemctl start supervisord\n# \u8ba9superivisord\u5f00\u673a\u81ea\u542f\nsystemctl enable supervisord\n</code></pre> <p>\u6dfb\u52a0etcd\u7684supervisor\u8fdb\u7a0b\u7ef4\u62a4\u811a\u672c<code>/etc/supervisord.d/etcd-server.ini</code>\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>[program:etcd-server-12]\ndirectory=/opt/etcd\ncommand=/opt/etcd/startup.sh\nnumprocs=1\nautostart=true\nautorestart=true\nstartsecs=30\nstartretries=3\nexitcodes=0,2\nstopsignal=QUIT\nstopwaitsecs=10\nuser=etcd\nredirect_stderr=true\nstdout_logfile=/data/logs/etcd-server/etcd.stdout.log\nstdout_logfile_maxbytes=64MB\nstdout_logfile_backups=4\nstdout_capture_maxbytes=1MB\nstdout_event_enabled=false\n</code></pre> <p>\u6ce8\u610f\uff1a\u5728\u4e0d\u540c\u7684\u4e3b\u673a\u4e0a\u4f7f\u7528\u4e0d\u540c\u7684\u670d\u52a1\u540d\u79f0\uff0c\u8fd9\u6837\u597d\u8fa8\u522b\uff0c\u5982kb12\u4f7f\u7528<code>etcd-server-12</code>\uff0c\u5982kb21\u4f7f\u7528<code>etcd-server-21</code></p> <p>\u76f8\u5173\u53c2\u6570\uff1a</p> <p><code>program</code>: \u7a0b\u5e8f\u540d\u79f0 <code>directory</code>: \u811a\u672c\u76ee\u5f55 <code>command</code>: \u542f\u52a8\u7684\u547d\u4ee4 <code>numprocs</code>: \u542f\u52a8\u7684\u8fdb\u7a0b\u6570 <code>autostart</code>: \u662f\u5426\u5f00\u542f\u81ea\u52a8\u542f\u52a8 <code>autorestart</code>: \u662f\u5426\u81ea\u52a8\u91cd\u542f <code>startsecs</code>: \u542f\u52a8\u4e4b\u540e\u591a\u5c11\u65f6\u95f4\u540e\u5224\u5b9a\u4e3a\u5df2\u8d77\u6765 <code>startretries</code>: \u91cd\u542f\u6b21\u6570 <code>exitcodes</code>: \u9000\u51fa\u7684code <code>stopsignal</code>: \u505c\u6b62\u4fe1\u53f7 <code>stopwaitsecs</code>: \u505c\u6b62\u7b49\u5f85\u7684\u65f6\u95f4 <code>redirect_stderr</code>: \u662f\u5426\u91cd\u5b9a\u5411\u6807\u51c6\u8f93\u51fa <code>stdout_logfile</code>: \u8fdb\u7a0b\u6807\u51c6\u8f93\u51fa\u5185\u5bb9\u5199\u5165\u6587\u4ef6 <code>stdout_logfile_maxbytes</code>: stdout_logfile\u6587\u4ef6\u505alog\u6eda\u52a8\u65f6\uff0c\u5355\u4e2astdout_logfile\u6587\u4ef6\u7684\u6700\u5927\u5b57\u8282\u6570\uff0c\u9ed8\u8ba450M\uff0c\u8bbe\u7f6e\u4e3a0\u5219\u8ba4\u4e3a\u4e0d\u505alog\u6eda\u52a8\u65b9\u5f0f <code>stdout_logfile_backups</code>: stdout_logfile\u5907\u4efd\u6587\u4ef6\u4e2a\u6570\uff0c\u9ed8\u8ba4\u4e3a10 <code>stdout_capture_maxbytes</code>: \u5f53\u8fdb\u7a0b\u5904\u4e8estdout capture mode\u6a21\u5f0f\u7684\u65f6\u5019\uff0c\u5199\u5165capture FIFO\u7684\u6700\u5927\u5b57\u8282\u6570\u9650\u5236\uff0c\u9ed8\u8ba4\u4e3a0\uff0c\u6b64\u65f6\u8ba4\u4e3astdout capture mode\u6a21\u5f0f\u5173\u95ed <code>stdout_event_enabled</code>: \u5982\u679c\u8bbe\u7f6e\u4e3atrue\uff0c\u5728\u8fdb\u7a0b\u5199\u5165\u6807\u51c6\u6587\u4ef6\u662f\u4f1a\u53d1\u8d77PROCESS_LOG_STDOUT</p> <p>\u66f4\u65b0supervisod\u914d\u7f6e\u6587\u4ef6</p> <pre><code>supervisorctl update\n</code></pre> <p>\u901a\u8fc7<code>supervisorctl status</code>\u67e5\u8be2supervisord\u72b6\u6001\uff0c\u770b\u5230\u5982\u4e0b\u5185\u5bb9\uff0c\u4ee3\u8868supervisor\u6b63\u5e38\u8fd0\u884c</p> <pre><code>[root@kb12 logs]# supervisorctl status\netcd-server-12                   RUNNING   pid 4945, uptime 0:01:22\n</code></pre> <p>\u6b64\u65f6\uff0c\u6211\u4eec\u518d\u4f7f\u7528<code>netstat -luntp | grep etcd</code>\u67e5\u770b\u7f51\u7edc\u670d\u52a1\u7aef\u53e3\uff0c\u770b\u5230\u5982\u4e0b\u4fe1\u606f\u4ee3\u8868etcd\u5df2\u7ecf\u6b63\u5e38\u542f\u52a8</p> <pre><code>[root@kb12 logs]# netstat -luntp | grep etcd\ntcp        0      0 192.168.14.12:2379      0.0.0.0:*               LISTEN      4946/./etcd         tcp        0      0 127.0.0.1:2379          0.0.0.0:*               LISTEN      4946/./etcd         tcp        0      0 192.168.14.12:2380      0.0.0.0:*               LISTEN      4946/./etcd\n</code></pre>"},{"location":"02.enhancement/06-install-etcd/#5","title":"5. \u96c6\u7fa4\u9a8c\u8bc1","text":"<p>\u542f\u52a8\u5b8c\u6210\u4e4b\u540e\uff0c\u6211\u4eec\u5728\u4efb\u610f\u8282\u70b9\u4f7f\u7528etcdctl\u547d\u4ee4\u68c0\u67e5\u96c6\u7fa4\u72b6\u6001\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u8981\u786e\u5207\u6307\u5b9a\u8bc1\u4e66\u7684\u4f4d\u7f6e</p> <pre><code>./etcdctl --cacert=\"/opt/etcd/certs/ca.pem\" --cert=\"/opt/etcd/certs/etcd-peer.pem\" --key=\"/opt/etcd/certs/etcd-peer-key.pem\" --endpoints=\"https://192.168.14.12:2379,https://192.168.14.21:2379,https://192.168.14.22:2379\" endpoint health --write-out=table\n</code></pre> <p>\u5982\u679c\u770b\u5230\u8f93\u51fa\u7684\u8868\u683c\u4e2d<code>HEALTH</code>\u5355\u5143\u683c\u6570\u636e\u90fd\u4e3a<code>true</code>\uff0c\u4ee3\u8868 ectd \u96c6\u7fa4\u642d\u5efa\u6210\u529f</p> <pre><code>[root@kb21 etcd]# ./etcdctl --cacert=\"/opt/etcd/certs/ca.pem\" --cert=\"/opt/etcd/certs/etcd-peer.pem\" --key=\"/opt/etcd/certs/etcd-peer-key.pem\" --endpoints=\"https://192.168.14.12:2379,https://192.168.14.21:2379,https://192.168.14.22:2379\" endpoint health --write-out=table\n+----------------------------+--------+-------------+-------+\n|          ENDPOINT          | HEALTH |    TOOK     | ERROR |\n+----------------------------+--------+-------------+-------+\n| https://192.168.14.22:2379 |   true | 11.968038ms |       |\n| https://192.168.14.21:2379 |   true | 11.394077ms |       |\n| https://192.168.14.12:2379 |   true | 11.584124ms |       |\n+----------------------------+--------+-------------+-------+\n</code></pre> <p>\u5982\u679c\u9700\u8981\u4e86\u89e3<code>etcdctl</code>\u8fd9\u4e2a\u6307\u4ee4\u7684\u66f4\u591a\u7528\u6cd5\uff0c\u4f7f\u7528<code>--help</code>\u53c2\u6570\u5373\u53ef\u67e5\u770b\u3002</p>"},{"location":"02.enhancement/07-install-apiserver/","title":"\u5b89\u88c5\u63a7\u5236\u8282\u70b9\u7684apiserver","text":"<p>\u642d\u5efa\u597detcd\u6570\u636e\u5e93\u4e4b\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5b89\u88c5apiserver\u7ec4\u4ef6\u4e86\uff0c\u5728\u64b0\u5199\u8fd9\u7bc7\u6587\u6863\u7684\u65f6\u5019\uff0c\u6211\u4eec\u9009\u62e9<code>1.15.2</code>\u7248\u672c\u7684k8s\u5728<code>kb21</code>\u548c<code>kb22</code>\u8fd9\u4e24\u53f0\u4e3b\u673a\u5b89\u88c5\uff0c\u4ee5\u4e0b\u662f\u5177\u4f53\u7684\u5b89\u88c5\u8fc7\u7a0b</p>"},{"location":"02.enhancement/07-install-apiserver/#1-ssl","title":"1. \u7b7e\u53d1ssl\u8bc1\u4e66","text":"<p>\u6211\u4eec\u5148\u767b\u5f55\u4e0a<code>kb200</code>\u4e3b\u673a\uff0c\u53bb\u7b7e\u53d1ssl\u8bc1\u4e66\uff0c\u7528\u4e8ek8s\u96c6\u7fa4\u4e0eetcd\u6570\u636e\u5e93\u7684\u901a\u4fe1\u4f7f\u7528\u3002</p> <pre><code># \u521b\u5efa\u8bc1\u4e66\u76ee\u5f55\nmkdir -p /opt/certs/kubernetes\n# \u8fdb\u5165\u8bc1\u4e66\u76ee\u5f55\ncd /opt/certs/kubernetes\n</code></pre> <p>\u521b\u5efa\u7528\u4e8e\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42\u6587\u4ef6\uff08csr\uff09\u7684json\u914d\u7f6e\u6587\u4ef6<code>client-csr.json</code>\uff0c\u5199\u5165\u5982\u4e0b\u5185\u5bb9</p> <pre><code>{\n\"CN\": \"k8s-node\",\n\"hosts\": [\n],\n\"key\": {\n\"algo\": \"rsa\",\n\"size\": 2048\n},\n\"names\": [{\n\"C\": \"CN\",\n\"ST\": \"Guangdong\",\n\"L\": \"Guangzhou\",\n\"O\": \"od\",\n\"OU\": \"ops\"\n}]\n}\n</code></pre> <p>\u751f\u6210\u8bc1\u4e66\u547d\u4ee4\u5982\u4e0b</p> <pre><code>cfssl gencert -ca=../ca.pem -ca-key=../ca-key.pem -config=../ca-config.json -profile=client client-csr.json | cfssljson -bare client\n</code></pre> <p>\u6267\u884c\u547d\u4ee4\u540e\u5c06\u4f1a\u4ea7\u751f\u4e09\u4e2a\u6587\u4ef6\uff0c\u5206\u522b\u662f<code>client.csr</code>,<code>client-key.pem</code>,<code>client.pem</code>\uff0c\u751f\u6210\u7684\u8bc1\u4e66\u7528\u4e8e\u8fde\u63a5etcd\u670d\u52a1\u901a\u4fe1\uff0ck8s\u5f53\u4f5cectd\u7684\u5ba2\u6237\u7aef\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u8fd8\u8981\u4e3aapiserver\u521b\u5efassl\u8bc1\u4e66\uff0c\u521b\u5efa<code>apiserver-csr.json</code>\u6587\u4ef6\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>{\n\"CN\": \"etcd\",\n\"hosts\": [\n\"192.168.0.1\",\n\"kubernetes.default\",\n\"kubernetes.default.svc\",\n\"kubernetes.default.svc.cluster\",\n\"kubernetes.default.svc.cluster.local\",\n\"192.168.14.10\",\n\"192.168.14.11\",\n\"192.168.14.12\",\n\"192.168.14.21\",\n\"192.168.14.22\"\n],\n\"key\": {\n\"algo\": \"rsa\",\n\"size\": 2048\n},\n\"names\": [{\n\"C\": \"CN\",\n\"ST\": \"Guangdong\",\n\"L\": \"Guangzhou\",\n\"O\": \"od\",\n\"OU\": \"ops\"\n}]\n}\n</code></pre> <p>\u6211\u4eec\u628a\u53ef\u80fd\u6dfb\u52a0\u5230\u96c6\u7fa4\u7684\u4e3b\u673aIP\u90fd\u52a0\u5230\u4e86<code>hosts</code>\u8282\u70b9\uff0c\u518d\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u521b\u5efassl\u8bc1\u4e66</p> <pre><code>cfssl gencert -ca=../ca.pem -ca-key=../ca-key.pem -config=../ca-config.json -profile=server apiserver-csr.json | cfssljson -bare apiserver\n</code></pre> <p>\u6267\u884c\u547d\u4ee4\u4e4b\u540e\u751f\u6210\u4e09\u4e2a\u6587\u4ef6\uff0c\u5206\u522b\u662f<code>apiserver.csr</code>\u3001<code>apiserver-key.pem</code>\u3001<code>apiserver.pem</code>\uff0c\u6211\u4eec\u5c06\u5728\u542f\u52a8apiserver\u670d\u52a1\u7684\u65f6\u5019\u5c06\u52a0\u8f7d\u8bc1\u4e66</p> <p>\u6ce8\u610f\uff1a\u5b9e\u9645\u4e0a\uff0c\u6211\u4eec\u7528\u7684\u8bc1\u4e66\u4fe1\u606f\u6587\u4ef6\u548c\u4e0a\u7bc7\u6587\u7ae0etcd\u672c\u8eab\u7684\u8bc1\u4e66\u4fe1\u606f\u6587\u4ef6\u662f\u4e00\u6837\u7684\u3002\u53ea\u662f\u5728\u90e8\u7f72etcd\u4e2d\u6211\u4eec\u751f\u6210\u7684\u8bc1\u4e66\u662f\u7aef\u5bf9\u7aef\u7684\u8bc1\u4e66\uff0c\u800c\u5728\u5728\u672c\u6587\u4e2d\u751f\u6210\u4e86\u53e6\u5916\u4e24\u5957\u8bc1\u4e66\u3002\u5176\u4e2dk8s\u4f5c\u4e3aectd\u5ba2\u6237\u7aef\u7684\u65f6\u5019\u4f7f\u7528\u7684\u5ba2\u6237\u7aef\u8bc1\u4e66\uff0c\u53e6\u5916\u662fk8s\u4f5c\u4e3a\u670d\u52a1\u5668\u7684\u65f6\u5019\u4f7f\u7528\u7684\u670d\u52a1\u5668\u8bc1\u4e66\u3002</p>"},{"location":"02.enhancement/07-install-apiserver/#2-apiserver","title":"2. \u5b89\u88c5apiserver","text":"<p>\u767b\u5f55\u56de<code>kb21</code>\u548c<code>kb22</code>\uff0c\u6267\u884c\u5b89\u88c5\u64cd\u4f5c</p> <pre><code># \u4e0b\u8f7d\u6307\u5b9a\u7684\u670d\u52a1\u5668\u4e8c\u8fdb\u5236\u5305\nwget https://dl.k8s.io/v1.15.2/kubernetes-server-linux-amd64.tar.gz\n# \u89e3\u538b\u5b89\u88c5\u5305\ntar -zxvf kubernetes-server-linux-amd64.tar.gz\n# \u5c06\u5b89\u88c5\u5305\u79fb\u5230/opt\u76ee\u5f55\u4e0b\u5e76\u6839\u636e\u7248\u672c\u91cd\u547d\u540d\nmv kubernetes /opt/kubernetes-v1.15.2\n# \u521b\u5efa\u8f6f\u8fde\u63a5\nln -s /opt/kubernetes-v1.15.2/ /opt/kubernetes\n</code></pre> <p>\u5728k8s\u4e8c\u8fdb\u5236\u5b89\u88c5\u76ee\u5f55\u91cc\u5305\u542b\u4e86k8s\u6e90\u7801\u5305\uff0c\u8fd8\u5305\u542bk8s\u6838\u5fc3\u7ec4\u4ef6\u7684docker\u955c\u50cf\uff0c\u56e0\u4e3a\u6211\u4eec\u7684\u6838\u5fc3\u670d\u52a1\u4e0d\u8fd0\u884c\u5728\u5bb9\u5668\u91cc\uff0c\u6240\u4ee5\u53ef\u4ee5\u5220\u9664\u6389\uff0c\u64cd\u4f5c\u8fc7\u7a0b\u5982\u4e0b</p> <pre><code># \u8fdb\u5165k8s\u76ee\u5f55\ncd /opt/kubernetes\n# \u5220\u9664\u6e90\u4ee3\u7801\nrm kubernetes-src.tar.gz\n# \u5220\u9664\u4e8c\u8fdb\u5236\u6587\u4ef6\u76ee\u5f55\u4e0b\u4ee5tar\u4f5c\u4e3a\u540d\u79f0\u540e\u7f00\u7684docker\u955c\u50cf\u5305\nrm -rf server/bin/*.tar\n</code></pre>"},{"location":"02.enhancement/07-install-apiserver/#3-apiser","title":"3. \u542f\u52a8apiser\u670d\u52a1\u5668","text":"<p>\u6211\u4eec\u5728<code>kb21</code>\u548c<code>kb22</code>\u8fd9\u4e24\u53f0\u4e3b\u673a\uff0c\u7ee7\u7eed\u6267\u884c\u5b89\u88c5\u64cd\u4f5c</p> <pre><code># \u521b\u5efa\u8bc1\u4e66\u76ee\u5f55\nmkdir -p /opt/kubernetes/server/bin/certs\n# \u8fdb\u5165\u8bc1\u4e66\u76ee\u5f55\ncd /opt/kubernetes/server/bin/certs\n# \u4ece\u8bc1\u4e66\u670d\u52a1\u5668\u4e0b\u8f7d\u8bc1\u4e66\nscp root@kb200.host.com:/opt/certs/ca.pem ./\nscp root@kb200.host.com:/opt/certs/ca-key.pem ./\nscp root@kb200.host.com:/opt/certs/kubernetes/apiserver.pem ./\nscp root@kb200.host.com:/opt/certs/kubernetes/apiserver-key.pem ./\nscp root@kb200.host.com:/opt/certs/kubernetes/client.pem ./\nscp root@kb200.host.com:/opt/certs/kubernetes/client-key.pem ./\n# \u521b\u5efaapiserver\u542f\u52a8\u914d\u7f6e\u6587\u4ef6\u76ee\u5f55\nmkdir -p /opt/kubernetes/server/bin/conf\n</code></pre> <p>\u5728apiserver\u4e8c\u8fdb\u5236\u6587\u4ef6\u76ee\u5f55\u521b\u5efa<code>kube-apiserver.sh</code>\u542f\u52a8\u811a\u672c\u6587\u4ef6\uff0c\u5199\u5165\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>#!/bin/bash\n./kube-apiserver \\\n--apiserver-count 2 \\\n--audit-log-path /data/log/kubernetes/kube-apiserver/audit-log \\\n--audit-policy-file ./conf/audit.yaml \\\n--authorization-mode RBAC \\\n--bind-address 192.168.14.21 \\\n--advertise-address 192.168.14.21 \\\n--client-ca-file ./certs/ca.pem \\\n--requestheader-client-ca-file ./certs/ca.pem \\\n--enable-admission-plugins NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota \\\n--etcd-cafile ./certs/ca.pem \\\n--etcd-certfile ./certs/client.pem \\\n--etcd-keyfile ./certs/client-key.pem \\\n--etcd-servers https://192.168.14.12:2379,https://192.168.14.21:2379,https://192.168.14.22:2379 \\\n--service-account-key-file ./certs/ca-key.pem \\\n--service-cluster-ip-range 192.168.0.0/16 \\\n--service-node-port-range 3000-29999 \\\n--target-ram-mb=1024 \\\n--kubelet-client-certificate ./certs/client.pem \\\n--kubelet-client-key ./certs/client-key.pem \\\n--log-dir /data/logs/kubernetes/kube-apiserver \\\n--tls-cert-file ./certs/apiserver.pem \\\n--tls-private-key-file ./certs/apiserver-key.pem \\\n--v 2 </code></pre> <p>\u63a5\u4e0b\u5728\u5f53\u524d\u76ee\u5f55\u4e0b\u7684<code>conf</code>\u76ee\u5f55\u6765\u521b\u5efa\u4e00\u4e2a<code>audit.yaml</code>\uff0c\u5199\u5165\u5185\u5bb9\u5982\u4e0b</p> <pre><code>apiVersion: audit.k8s.io/v1\nkind: Policy\nrules:\n- level: Metadata\n</code></pre> <p>\u53c2\u6570\u8bf4\u660e\uff1a</p> <p><code>--apiserver-count</code>\uff1a\u96c6\u7fa4\u4e2d\u8fd0\u884c\u7684apiserver\u7684\u670d\u52a1\u6570\u91cf <code>--audit-log-path</code>\uff1aapi\u8bf7\u6c42\u7684\u65e5\u5fd7\u6587\u4ef6\u76ee\u5f55 <code>--audit-policy-file</code>\uff1a\u5b9a\u4e49\u5ba1\u6838\u7b56\u7565\u914d\u7f6e\u7684\u6587\u4ef6\u7684\u8def\u5f84 <code>--authorization-mode</code>\uff1a\u6388\u6743\u6a21\u5f0f <code>--client-ca-file</code>\uff1a\u8bbf\u95eeapiserver\u65f6\u4f7f\u7528\uff0c\u5ba2\u6237\u7aefca\u6587\u4ef6 <code>--logtostderr</code>\uff1a\u5c06\u8f93\u51fa\u8bb0\u5f55\u5230\u6807\u51c6\u65e5\u5fd7\uff0c\u800c\u4e0d\u662f\u6587\u4ef6\uff0c\u9ed8\u8ba4\u662ftrue <code>--v</code>\uff1a\u65e5\u5fd7\u8f93\u51fa\u7ea7\u522b <code>--log-dir</code>\uff1a\u65e5\u5fd7\u76ee\u5f55\uff0c\u5982\u679c\u4e3a\u7a7a\uff0c\u65e5\u5fd7\u5199\u5728\u5f53\u524d\u76ee\u5f55 <code>--audit-log-maxage</code>\uff1a\u6839\u636e\u6587\u4ef6\u540d\u4e2d\u7f16\u7801\u7684\u65f6\u95f4\u6233\uff0c\u4fdd\u7559\u65e7\u5ba1\u6838\u65e5\u5fd7\u6587\u4ef6\u7684\u6700\u5927\u5929\u6570 <code>--audit-log-maxbackup</code>\uff1a\u4fdd\u7559\u65e7\u5ba1\u6838\u65e5\u5fd7\u6587\u4ef6\u7684\u6700\u5927\u6587\u4ef6\u6570\u91cf <code>--audit-log-maxsize</code>\uff1a\u65e5\u5fd7\u5faa\u73af\u524d\uff0c\u6587\u4ef6\u6700\u5927\u5c0f\u7684\u6700\u5927M\u6570 <code>--bind-address</code>\uff1a--secure-port\u53c2\u6570\u6307\u5b9a\u7684\u7aef\u53e3\u53f7\u5bf9\u5e94\u76d1\u542c\u7684IP\u5730\u5740\uff0c\u5982\u679c\u6ca1\u6709\u6307\u5b9a\u5730\u5740\uff080.0.0.0\u6216\u8005::\uff09\uff0c\u9ed8\u8ba4\u662f 0.0.0.0\uff0c\u4ee3\u8868\u6240\u6709\u7684\u7f51\u5361\u90fd\u5728\u76d1\u542c\u670d\u52a1 <code>--secure-port</code>\uff1ahttps\u670d\u52a1\u7684\u7aef\u53e3\u53f7\uff0c\u9ed8\u8ba4\u662f6443 <code>--advertise-address</code>\uff1a\u5411\u96c6\u7fa4\u5e7f\u64ad\u7684ip\u5730\u5740\uff0c\u8fd9\u4e2aip\u5730\u5740\u5fc5\u987b\u80fd\u88ab\u96c6\u7fa4\u7684\u5176\u4ed6\u8282\u70b9\u8bbf\u95ee\uff0c\u5982\u679c\u4e0d\u6307\u5b9a\uff0c\u5c06\u4f7f\u7528--bind-address\uff0c\u5982\u679c\u4e0d\u6307\u5b9a--bind-addres\uff0c\u5c06\u4f7f\u7528\u9ed8\u8ba4\u7f51\u5361 <code>--allow-privileged</code>\uff1a\u662f\u5426\u4f7f\u7528\u8d85\u7ea7\u7ba1\u7406\u5458\u6743\u9650\u521b\u5efa\u5bb9\u5668\uff0c\u9ed8\u8ba4\u4e3afalse <code>--enable-admission-plugins</code>\uff1a\u5141\u8bb8\u4f7f\u7528\u7684\u63d2\u4ef6 <code>--enable-bootstrap-token-auth</code>\uff1a\u662f\u5426\u4f7f\u7528token\u7684\u65b9\u5f0f\u6765\u81ea\u52a8\u9881\u53d1\u8bc1\u4e66\uff0c\u5982\u679c\u4e3b\u673a\u8282\u70b9\u6bd4\u8f83\u591a\u7684\u65f6\u5019\uff0c\u624b\u52a8\u9881\u53d1\u8bc1\u4e66\u53ef\u80fd\u4e0d\u592a\u73b0\u5b9e\uff0c\u53ef\u4ee5\u4f7f\u7528\u57fa\u4e8etoken\u7684\u65b9\u5f0f\u81ea\u52a8\u9881\u53d1\u8bc1\u4e66\u3002\u672c\u6b21\u6211\u4eec\u6682\u672a\u4f7f\u7528 <code>--token-auth-file</code>\uff1a\u8be5\u6587\u4ef6\u7528\u4e8e\u6307\u5b9aapi-server\u9881\u53d1\u8bc1\u4e66\u7684token\u6388\u6743\u3002\u672c\u6b21\u6211\u4eec\u6682\u672a\u4f7f\u7528 <code>--etcd-servers</code>\uff1a\u5404\u4e2aetcd\u8282\u70b9\u7684IP\u548c\u7aef\u53e3\u53f7 <code>--etcd-cafile</code>\uff1a\u8bbf\u95eeetcd\u65f6\u4f7f\u7528\uff0cectd\u7684ca\u6587\u4ef6 <code>--etcd-certfile</code>\uff1a\u8bbf\u95eeetcd\u65f6\u4f7f\u7528\uff0cectd\u7684\u8bc1\u4e66\u6587\u4ef6 <code>--etcd-keyfile</code>\uff1a\u8bbf\u95eeetcd\u65f6\u4f7f\u7528\uff0cectd\u7684\u8bc1\u4e66\u79c1\u94a5\u6587\u4ef6 <code>--service-cluster-ip-range</code>\uff1a\u521b\u5efaservice\u65f6\uff0c\u4f7f\u7528\u7684\u865a\u62df\u7f51\u6bb5 <code>--service-node-port-range</code>\uff1a\u521b\u5efaservice\u65f6\uff0c\u670d\u52a1\u7aef\u53e3\u4f7f\u7528\u7684\u7aef\u53e3\u8303\u56f4\uff08\u9ed8\u8ba4 30000-32767\uff09 <code>--service-account-key-file</code>\uff1a\u5305\u542b PEM \u7f16\u7801\u7684 x509 RSA \u6216 ECDSA \u79c1\u94a5\u6216\u516c\u94a5\u7684\u6587\u4ef6\uff0c\u7528\u4e8e\u9a8c\u8bc1\u670d\u52a1\u5e10\u6237\u4ee4\u724c\uff0c\u53ef\u4ee5\u662f\u591a\u4e2a\u3002\u5982\u679c\u6ca1\u6709\u6307\u5b9a\uff0c\u4f7f\u7528--tls-private-key-file\u6307\u5b9a\u7684\u6587\u4ef6 <code>--tls-cert-file</code>\uff1a\u8bbf\u95eeapiserver\u65f6\u4f7f\u7528\uff0ctls\u8bc1\u4e66\u6587\u4ef6 <code>--tls-private-key-file</code>\uff1a\u8bbf\u95eeapiserver\u65f6\u4f7f\u7528\uff0ctls\u8bc1\u4e66\u79c1\u94a5\u6587\u4ef6 <code>--kubelet-client-certificate</code>\uff1a\u8bbf\u95eekubelet\u65f6\u4f7f\u7528\uff0c\u5ba2\u6237\u7aef\u8bc1\u4e66\u8def\u5f84 <code>--kubelet-client-key</code>\uff1a\u8bbf\u95eekubelet\u65f6\u4f7f\u7528\uff0c\u5ba2\u6237\u7aef\u8bc1\u4e66\u79c1\u94a5</p> <p>\u4ee5\u4e0a\u662f\u6211\u4eec\u5728\u542f\u52a8apiserver\u7684\u65f6\u5019\u5e38\u7528\u7684\u53c2\u6570\uff0capiserver\u5177\u6709\u5f88\u591a\u53c2\u6570\uff0c\u5f88\u591a\u53c2\u6570\u4e5f\u6709\u9ed8\u8ba4\u503c\uff0c\u53ef\u4ee5<code>./kube-apiserver --hep</code>\u547d\u4ee4\u67e5\u770b\u66f4\u591a\u7684\u5e2e\u52a9\u3002</p> <p>\u8d4b\u4e88\u542f\u52a8\u7b80\u76f4\u6267\u884c\u6743\u9650</p> <pre><code>chmod +x kube-apiserver.sh\n</code></pre> <p>\u521b\u5efa\u65e5\u5fd7\u76ee\u5f55</p> <pre><code>mkdir -p /data/logs/kubernetes/kube-apiserver\n</code></pre> <p>\u521b\u5efasupervisor\u8fdb\u7a0b\u914d\u7f6e\u6587\u4ef6<code>/etc/supervisord.d/kube-apiserver.ini</code></p> <pre><code>[program:kube-apiserver-21]\ndirectory=/opt/kubernetes/server/bin\ncommand=/opt/kubernetes/server/bin/kube-apiserver.sh\nnumprocs=1\nautostart=true\nautorestart=true\nstartsecs=30\nstartretries=3\nexitcodes=0,2\nstopsignal=QUIT\nstopwaitsecs=10\nuser=root\nredirect_stderr=true\nstdout_logfile=/data/logs/kubernetes/kube-apiserver/apiserver.stdout.log\nstdout_logfile_maxbytes=64MB\nstdout_logfile_backups=4\nstdout_capture_maxbytes=1MB\nstdout_event_enabled=false\n</code></pre> <p>\u66f4\u65b0supervisor\u670d\u52a1 <pre><code>supervisorctl update\n</code></pre></p> <p>\u518d\u4f7f\u7528<code>supervisorctl status</code>\u547d\u4ee4\u67e5\u770bapiserver\u542f\u52a8\u72b6\u6001\uff0c\u5982\u679c\u663e\u793a\u5982\u4e0b\u5185\u5bb9\uff0c\u4ee3\u8868\u6b63\u5e38\u670d\u52a1</p> <pre><code>[root@kb21 bin]# supervisorctl status\netcd-server-21                   RUNNING   pid 997, uptime 4:56:47\nkube-apiserver-21                RUNNING   pid 3654, uptime 0:00:55\n</code></pre> <p>\u6b64\u65f6\uff0c\u8fd8\u53ef\u4ee5\u4f7f\u7528<code>netstat -luntp | grep kube-api</code>\u547d\u4ee4\u67e5\u770b\u7f51\u7edc\u670d\u52a1\u7684\u7aef\u53e3\u662f\u5426\u6b63\u5e38\uff0c\u5982\u679c\u6b63\u5e38\uff0c\u5c06\u8fd4\u56de\u5982\u4e0b\u5185\u5bb9</p> <pre><code>[root@kb21 bin]# netstat -luntp | grep kube-api\ntcp        0      0 127.0.0.1:8080          0.0.0.0:*               LISTEN      26976/./kube-apiser tcp        0      0 192.168.14.22:6443      0.0.0.0:*               LISTEN      26976/./kube-apiser\n</code></pre>"},{"location":"02.enhancement/08-install-agent-server/","title":"\u5b89\u88c5L4\u53cd\u5411\u4ee3\u7406\u670d\u52a1","text":""},{"location":"02.enhancement/08-install-agent-server/#1-nginx","title":"1. \u5b89\u88c5nginx","text":"<p>\u6211\u4eec\u9700\u8981\u5728<code>kb11</code>\u548c<code>kb12</code>\u4e0a\u5b89\u88c5keepalived</p> <pre><code># \u5b89\u88c5nginx\nyum install nginx -y\n# \u5b89\u88c5nginx\u7684stream\u6a21\u5757\uff0c\u7528\u4e8eL4\u7684\u53cd\u5411\u4ee3\u7406\nyum install nginx-mod-stream -y\n</code></pre> <p>\u5b89\u88c5\u5b8c\u6210\u4e4b\u540e\uff0c\u6211\u4eec\u9700\u8981\u5728nginx\u7684\u914d\u7f6e\u6587\u4ef6<code>/etc/nginx/nginx.conf</code>\u52a0\u8f7d<code>stream</code>\u6dfb\u52a0\u56db\u5c42\u53cd\u5411\u4ee3\u7801\u89c4\u5219</p> <pre><code># \u8bbe\u7f6e\u4ee3\u7406\u89c4\u5219\nstream {\nupstream kube-apiserver {\nserver 192.168.14.21:6443  max_fails=3  fail_timeout=30s;\nserver 192.168.14.22:6443  max_fails=3  fail_timeout=30s;\n}\nserver {\nlisten  7443;\nproxy_connect_timeout  2s;\nproxy_timeout  900s;\nproxy_pass kube-apiserver;\n}\n}\n</code></pre> <p>\u5982\u679c\u4f7f\u7528\u624b\u52a8\u7f16\u8bd1\u7684\u65b9\u5f0f\u5b89\u88c5<code>stream</code>\u6a21\u5757\uff0c\u9700\u8981\u624b\u52a8\u52a0\u8f7d\u5982\u4e0b\u4ee3\u7801</p> <pre><code># \u52a0\u8f7dstream\u6a21\u5757\nload_module /usr/lib64/nginx/modules/ngx_stream_module.so;\n</code></pre> <p>\u901a\u8fc7\u4ee5\u4e0a\u7684\u914d\u7f6e\u53ef\u77e5\uff0c\u6211\u4eec\u5c06<code>kb11</code>\u548c<code>kb12</code>\u672c\u673a\u76847443\u7aef\u53e3\u53cd\u5411\u4ee3\u7801\u5230\u4e86<code>kb21</code>\u548c<code>kb22</code>\u76846443\u7aef\u53e3\u3002\u5728\u4e24\u53f0\u4e3b\u673a\u4e0a\u914d\u7f6e\u597d\u89c4\u5219\u4e4b\u540e\uff0c\u901a\u8fc7<code>nginx -t</code>\u547d\u4ee4\u68c0\u67e5\u914d\u7f6e\u7ed3\u679c\uff0c\u5982\u679c\u8f93\u51fa\u4ee5\u4e0b\u5185\u5bb9\u4ee3\u8868\u914d\u7f6e\u6b63\u786e</p> <pre><code>[root@kb11 vagrant]# nginx -t\nnginx: the configuration file /etc/nginx/nginx.conf syntax is ok\nnginx: configuration file /etc/nginx/nginx.conf test is successful\n</code></pre> <p>\u914d\u7f6e\u6210\u529f\u4e4b\u540e\uff0c\u542f\u52a8nginx\uff0c\u5982\u4e0b\u6307\u4ee4</p> <pre><code># \u542f\u52a8ginx\nnginx\n# \u8ba9nginx\u5f00\u673a\u81ea\u542f\nsystemctl enable nginx\n</code></pre>"},{"location":"02.enhancement/08-install-agent-server/#2-keepalived","title":"2. \u5b89\u88c5keepalived","text":"<p>\u6211\u4eec\u5c06\u4f7f\u7528keepalived\u5b9e\u73b0\u4ee3\u7406\u670d\u52a1\u5668\u7684\u9ad8\u53ef\u7528\uff0c\u4ee5\u4e0b\u662f\u5b89\u88c5\u8fc7\u7a0b</p> <pre><code>yum install keepalived -y\n</code></pre> <p>\u5728\u4e24\u53f0\u4e3b\u673a\u7684\u521b\u5efa<code>/etc/keepalived/check_port.sh</code>\u811a\u672c\u6587\u4ef6\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>#!/bin/bash\nCHK_PORT=$1\nif [ -n \"$CHK_PORT\" ]; then\nPORT_PROCESS=`ss -lnt|grep $CHK_PORT|wc -l`\nif [ $PORT_PROCESS -eq 0 ]; then\necho \"Port $CHK_PORT Is Not Used, End\"\nexit 1\nfi\nelse\necho \"Check Port Cant Be Empty!\"\nfi\n</code></pre> <p>\u6dfb\u52a0\u6267\u884c\u6743\u9650 <pre><code>chmod +x /etc/keepalived/check_port.sh\n</code></pre></p> <p>\u4ee5\u4e0a\u7684\u64cd\u4f5c\u5c31\u51c6\u5907\u597dkeepalived\u7684\u57fa\u7840\u73af\u5883\u4e86\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u4f7f\u7528<code>kb11</code>\u8fd9\u53f0\u4e3b\u673a\u4f5c\u4e3a\u4e3b\u8282\u70b9\uff0c\u4f7f\u7528<code>kb12</code>\u4f5c\u4e3a\u91cd\u8282\u70b9\uff0c\u8fdb\u884c\u4ee5\u4e0b\u914d\u7f6e</p> <p><code>kb11</code>\u4e3b\u8282\u70b9\uff0c\u4fee\u6539<code>/etc/keepalived/keepalived.conf</code>\u914d\u7f6e\u6587\u4ef6\u5982\u4e0b</p> <pre><code>! Configuration File for keepalived\n\nglobal_defs {\nrouter_id 192.168.14.11\n}\nvrrp_script check_nginx {\nscript \"/etc/keepalived/check_port.sh 7443\"\ninterval 2\nweight -20\n}\nvrrp_instance VI_1 {\nstate MASTER\n    interface eth1\n    virtual_router_id 251\npriority 100\nadvert_int 1\nmcast_src_ip 192.168.14.11\n    nopreempt\n\nauthentication {\nauth_type PASS\n        auth_pass 1111\n}\nvirtual_ipaddress {\n192.168.14.10\n    }\n}\n</code></pre> <p><code>kb12</code>\u4ece\u8282\u70b9\uff0c\u4fee\u6539<code>/etc/keepalived/keepalived.conf</code>\u914d\u7f6e\u6587\u4ef6\u5982\u4e0b</p> <pre><code>! Configuration File for keepalived\n\nglobal_defs {\nrouter_id 192.168.14.12\n}\nvrrp_script check_nginx {\nscript \"/etc/keepalived/check_port.sh 7443\"\ninterval 2\nweight -20\n}\nvrrp_instance VI_1 {\nstate BACKUP\n    interface eth1\n    virtual_router_id 251\npriority 90\nadvert_int 1\nmcast_src_ip 192.168.14.12\n    nopreempt\n\nauthentication {\nauth_type PASS\n        auth_pass 1111\n}\nvirtual_ipaddress {\n192.168.14.10\n    }\n}\n</code></pre> <p>\u542f\u52a8\u670d\u52a1 <pre><code># \u91cd\u542f\u670d\u52a1\nsystemctl restart keepalived\n# \u8bbe\u7f6e\u670d\u52a1\u4e3a\u5f00\u673a\u81ea\u542f\nsystemctl enable keepalived\n</code></pre></p>"},{"location":"02.enhancement/09-install-other-component/","title":"\u5b89\u88c5\u4e3b\u63a7\u5236\u8282\u70b9\u63a7\u5236\u5668\u548c\u8c03\u5ea6\u5668","text":"<p>\u56e0\u4e3a\u6211\u4eec\u7684\u4e3b\u63a7\u5236\u8282\u70b9\u7684<code>apiserver</code>\u7ec4\u4ef6\uff0c\u6ca1\u6709\u5b89\u88c5\u5728\u4e0d\u540c\u7684\u4e3b\u673a\uff0c\u6240\u4ee5\u4e0b\u9762\u542f\u52a8<code>controller-manager</code>\u548c<code>scheduler</code>\u7684\u65f6\u5019\u53ef\u4ee5\u4e0d\u4f7f\u7528<code>tsl</code>\u8bc1\u4e66\uff0c\u76f4\u63a5\u8fde\u63a5\u672c\u5730\u7684<code>apiserver</code>\u5373\u53ef</p>"},{"location":"02.enhancement/09-install-other-component/#1-controller-manager","title":"1. \u5b89\u88c5controller-manager","text":"<p>\u521b\u5efa\u6587\u4ef6<code>/opt/kubernetes/server/bin/kube-controller-manager.sh</code>\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>#!/bin/sh\n./kube-controller-manager \\\n--cluster-cidr 172.7.0.0/16 \\\n--leader-elect true \\\n--log-dir /data/logs/kubernetes/kube-controller-manager \\\n--master http://127.0.0.1:8080 \\\n--service-account-private-key-file ./certs/ca-key.pem \\\n--service-cluster-ip-range 192.168.0.0/16 \\\n--root-ca-file ./certs/ca.pem \\\n--v 2\n</code></pre> <p>\u6dfb\u52a0\u6267\u884c\u6743\u9650\u4e0e\u521b\u5efa\u65e5\u5fd7\u76ee\u5f55</p> <pre><code># \u6dfb\u52a0\u53ef\u6267\u884c\u6743\u9650\nchmod +x kube-controller-manager.sh\n# \u521b\u5efa\u65e5\u5fd7\u76ee\u5f55\nmkdir -p /data/logs/kubernetes/kube-controller-manager\n</code></pre> <p>\u521b\u5efasupervisor\u811a\u672c\u542f\u52a8\u7ba1\u7406\u6587\u4ef6<code>/etc/supervisord.d/kube-controller-manager.ini</code>\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>[program:kube-controller-manager-21]\ndirectory=/opt/kubernetes/server/bin\ncommand=/opt/kubernetes/server/bin/kube-controller-manager.sh\nnumprocs=1\nautostart=true\nautorestart=true\nstartsecs=30\nstartretries=3\nexitcodes=0,2\nstopsignal=QUIT\nstopwaitsecs=10\nuser=root\nredirect_stderr=true\nstdout_logfile=/data/logs/kubernetes/kube-controller-manager/controller.stdout.log\nstdout_logfile_maxbytes=64MB\nstdout_logfile_backups=4\nstdout_capture_maxbytes=1MB\nstdout_event_enabled=false\n</code></pre> <p>\u66f4\u65b0supervisor</p> <pre><code>supervisorctl update\n</code></pre>"},{"location":"02.enhancement/09-install-other-component/#2-scheduler","title":"2. \u90e8\u7f72scheduler","text":"<p>\u521b\u5efascheluder\u542f\u52a8\u811a\u672c\u6587\u4ef6<code>/opt/kubernetes/server/bin/kube-scheduler.sh</code>\u6587\u4ef6\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>#!/bin/sh\n./kube-scheduler \\\n--leader-elect \\\n--log-dir /data/logs/kubernetes/kube-scheduler \\\n--master http://127.0.0.1:8080 \\\n--v 2\n</code></pre> <p>\u6dfb\u52a0\u811a\u672c\u6267\u884c\u6743\u9650\u4e0e\u521b\u5efa\u65e5\u5fd7\u76ee\u5f55</p> <pre><code># \u6dfb\u52a0\u811a\u672c\u7684\u53ef\u6267\u884c\u6743\u9650\nchmod +x kube-scheduler.sh\n# \u521b\u5efa\u65e5\u5fd7\u76ee\u5f55\nmkdir -p /data/logs/kubernetes/kube-scheduler\n</code></pre> <p>\u521b\u5efa\u8fdb\u7a0b\u7ba1\u7406\u914d\u7f6e\u6587\u4ef6<code>/etc/supervisord.d/kube-scheduler.ini</code>\u6587\u4ef6\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>[program:kube-scheduler-21]\ndirectory=/opt/kubernetes/server/bin\ncommand=/opt/kubernetes/server/bin/kube-scheduler.sh\nnumprocs=1\nautostart=true\nautorestart=true\nstartsecs=30\nstartretries=3\nexitcodes=0,2\nstopsignal=QUIT\nstopwaitsecs=10\nuser=root\nredirect_stderr=true\nstdout_logfile=/data/logs/kubernetes/kube-scheduler/scheduler.stdout.log\nstdout_logfile_maxbytes=64MB\nstdout_logfile_backups=4\nstdout_capture_maxbytes=1MB\nstdout_event_enabled=false\n</code></pre> <p>\u66f4\u65b0supervisor</p> <pre><code>supervisorctl update\n</code></pre>"},{"location":"02.enhancement/09-install-other-component/#3","title":"3. \u96c6\u7fa4\u9a8c\u8bc1","text":"<p>\u5b89\u88c5\u5b8c\u6210\u57fa\u672c\u7684\u7ec4\u4ef6\u4e4b\u540e\uff0c\u6211\u4eec\u63a5\u4e0b\u6765\u4f7f\u7528<code>kubectl</code>\u4f5c\u4e3ak8s\u7684\u7ba1\u7406\u5de5\u5177\uff0c\u521b\u5efa\u4e00\u4e2a\u8f6f\u94fe\u63a5\uff0c\u5982\u4e0b</p> <pre><code>ln -s /opt/kubernetes/server/bin/kubectl /usr/bin/kubectl\n</code></pre> <p>\u518d\u4f7f\u7528<code>kubectl get cs</code>\u68c0\u67e5\u96c6\u7fa4\u72b6\u6001\uff0c\u5982\u4e0b\u8fd4\u56de\u5982\u4e0b\u5185\u5bb9\uff0c\u5219\u4ee3\u8868\u6b63\u5e38\u670d\u52a1</p> <pre><code>[root@kb22 bin]# kubectl get cs\nNAME                 STATUS    MESSAGE             ERROR\ncontroller-manager   Healthy   ok                  scheduler            Healthy   ok                  etcd-0               Healthy   {\"health\":\"true\"}   etcd-1               Healthy   {\"health\":\"true\"}   etcd-2               Healthy   {\"health\":\"true\"}   [root@kb22 bin]#\n</code></pre>"},{"location":"02.enhancement/10-install-kubelet/","title":"\u5b89\u88c5kubectl","text":""},{"location":"02.enhancement/10-install-kubelet/#1","title":"1. \u7b7e\u53d1\u8bc1\u4e66","text":"<p>kubectl\u4f5c\u4e3a\u5ba2\u6237\u7aef\u540c\u65f6\u4f5c\u4e3a\u670d\u52a1\u5668\uff0c\u6211\u4eec\u767b\u5f55\u5230<code>kb200</code>\u8fd9\u53f0\u4e3b\u673a\uff0c\u4e0b\u9762\u5c06\u4e3a<code>kubelet</code>\u521b\u5efassl\u8bc1\u4e66</p> <p>\u521b\u5efa\u8bc1\u4e66\u4fe1\u606f\u6587\u4ef6<code>/opt/certs/kubelet/kubelet-scr.json</code>\u6587\u4ef6\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>{\n\"CN\": \"k8s-kubelet\",\n\"hosts\": [\n\"127.0.0.1\",\n\"192.168.14.10\",\n\"192.168.14.11\",\n\"192.168.14.12\",\n\"192.168.14.21\",\n\"192.168.14.22\",\n\"192.168.14.200\"\n],\n\"key\": {\n\"algo\": \"rsa\",\n\"size\": 2048\n},\n\"name\": [\n{\n\"C\": \"CN\",\n\"ST\": \"Guangdong\",\n\"L\": \"Guangzhou\",\n\"O\": \"od\",\n\"OU\": \"ops\"\n}\n]\n}\n</code></pre> <p>\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u521b\u5efa\u8bc1\u4e66</p> <pre><code>cfssl gencert -ca=../ca.pem -ca-key=../ca-key.pem -config=../ca-config.json -profile=server kubelet-scr.json | cfssljson -bare kubelet\n</code></pre>"},{"location":"02.enhancement/10-install-kubelet/#2-kubelet","title":"2. \u521b\u5efakubelet\u914d\u7f6e\u6587\u4ef6","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u56de\u5230<code>kb21</code>\u548c<code>kb22</code>\u8fd9\u4e24\u53f0\u4e3b\u673a\uff0c\u9700\u8981\u5728\u8fd9\u4e24\u53f0\u4e3b\u673a\u4e0a\u5b89\u88c5kubelet</p> <p>\u5148\u4ece\u8bc1\u4e66\u670d\u52a1\u4e0b\u8f7d\u8bc1\u4e66\u6587\u4ef6\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>cd /opt/kubernetes/server/bin/certs\nscp root@kb200.host.com:/opt/certs/kubelet/kubelet-key.pem ./\nscp root@kb200.host.com:/opt/certs/kubelet/kubelet.pem ./\n</code></pre> <p>\u5148\u4f7f\u7528<code>cd /opt/kubernetes/server/bin/conf</code>\u8fdb\u53bb\u914d\u7f6e\u6587\u4ef6\u76ee\u5f55</p> <p>\u6267\u884c\u4ee5\u4e0b\u914d\u7f6e</p> <p>\u8bbe\u7f6e\u96c6\u7fa4\uff0c\u5305\u542bapiserver\u7684\u63a7\u5236ip\uff0c\u4ee5\u53caca\u516c\u94a5</p> <pre><code>kubectl config set-cluster myk8s \\\n--certificate-authority=/opt/kubernetes/server/bin/certs/ca.pem \\\n--embed-certs=true \\\n--server=https://192.168.14.10:7443 \\\n--kubeconfig=kubelet.kubeconfig\n</code></pre> <p>\u8bbe\u7f6e\u5ba2\u6237\u7aef\u8bc1\u4e66</p> <pre><code>kubectl config set-credentials k8s-node \\\n--client-certificate=/opt/kubernetes/server/bin/certs/client.pem \\\n--client-key=/opt/kubernetes/server/bin/certs/client-key.pem \\\n--embed-certs=true \\\n--kubeconfig=kubelet.kubeconfig\n</code></pre> <p>\u8bbe\u7f6e\u4e0a\u4e0b\u6587</p> <pre><code>kubectl config set-context myk8s-context \\\n--cluster=myk8s \\\n--user=k8s-node \\\n--kubeconfig=kubelet.kubeconfig\n</code></pre> <p>\u4f7f\u7528\u4e0a\u4e0b\u6587</p> <pre><code>kubectl config use-context myk8s-context --kubeconfig=kubelet.kubeconfig\n</code></pre> <p>\u4ee5\u4e0a\u7684\u64cd\u4f5c\u662f\u751f\u6210\u914d\u7f6e\u6587\u4ef6\uff0c\u6211\u4eec\u53ea\u9700\u8981\u5728\u4e00\u53f0\u4e3b\u673a\u4e0a\u64cd\u4f5c\uff0c\u518d\u590d\u5236\u5230\u5176\u4ed6\u4e3b\u673a\u5373\u53ef\u3002</p>"},{"location":"02.enhancement/10-install-kubelet/#3","title":"3. \u521b\u5efa\u4e00\u4e2a\u96c6\u7fa4\u89d2\u8272\u7ed1\u5b9a\u7684\u8d44\u6e90","text":"<p>\u521b\u5efa\u4e00\u4e2a\u8d44\u6e90\u6e05\u5355\u6587\u4ef6<code>k8s-node.yaml</code>\uff0c\u5b9a\u4e49\u96c6\u7fa4\u89d2\u8272\u7ed1\u5b9a\u7684\u8d44\u6e90</p> <pre><code>apiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\nname: k8s-node\nroleRef:\napiGroup: rbac.authorization.k8s.io\nkind: ClusterRole\nname: system:node\nsubjects:\n- apiGroup: rbac.authorization.k8s.io\nkind: User\nname: k8s-node\n</code></pre> <p>\u8be5\u8d44\u6e90\u5b9a\u4e49\u4e86\u4e00\u4e2a\u7528\u6237<code>k8s-node</code>\uff0c\u8be5\u7528\u6237\u62e5\u6709\u8fd0\u7b97\u8282\u70b9\u7684\u6743\u9650</p> <pre><code>kubectl create -f k8s-node.yaml\n</code></pre> <p>\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u67e5\u770b\u521b\u5efa\u7684\u8d44\u6e90 <pre><code>kubectl get clusterrolebinding k8s-node\n</code></pre></p> <p>\u6d3b\u7740\u67e5\u770b\u66f4\u8be6\u7ec6\u7684\u8d44\u6e90\u4fe1\u606f <pre><code>kubectl get clusterrolebinding k8s-node -o yaml\n</code></pre></p> <p>\u4ee5\u4e0a\u64cd\u4f5c\u6211\u4eec\u53ea\u9700\u8981\u5728\u4e00\u4e2a\u4e3b\u673a\u6267\u884c\u5373\u53ef\uff0c\u56e0\u4e3a\u64cd\u4f5c\u8bb0\u5f55\u4f1a\u81ea\u52a8\u540c\u6b65\u5230etcd\u6570\u636e\u5e93</p>"},{"location":"02.enhancement/10-install-kubelet/#4-kubelet","title":"4. \u914d\u7f6ekubelet\u542f\u52a8\u811a\u672c","text":"<p>\u63a5\u4e0b\u6765\u5728<code>kb21</code>\u548c<code>kb22</code>\u4e0a\u542f\u52a8kubelet\uff0c\u5728\u8ba9kubelet\u542f\u52a8\u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u6709\u4e00\u4e2a\u57fa\u7840\u7684pause\u955c\u50cf\uff0c\u4ee5\u4e0b\u662f\u62c9\u53d6\u547d\u4ee4\uff0c\u8be5\u955c\u50cf\u8d1f\u8d23\u5176k8s\u96c6\u7fa4\u4e2dpod\u542f\u52a8\u4e4b\u524d\u7684\u521d\u59cb\u5316\u64cd\u4f5c</p> <pre><code>docker pull kubernetes/pause\n</code></pre> <p>\u521b\u5efakubelet\u7684\u542f\u52a8\u811a\u672c\u6587\u4ef6<code>/opt/kubernetes/server/bin/kubelet.sh</code>\u6587\u4ef6\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>#!/bin/bash\n./kubelet \\\n--anonymous-auth=false \\\n--cgroup-driver systemd \\\n--cluster-dns 192.168.0.2 \\\n--node-ip 192.168.14.21 \\\n--cluster-domain cluster.local \\\n--runtime-cgroups=/systemd/system.slice \\\n--kubelet-cgroups=/systemd/system.slice \\\n--fail-swap-on=\"false\" \\\n--client-ca-file ./certs/ca.pem \\\n--tls-cert-file ./certs/kubelet.pem \\\n--tls-private-key-file ./certs/kubelet-key.pem \\\n--hostname-override kb21 \\\n--image-gc-high-threshold 20 \\\n--image-gc-low-threshold 10 \\\n--kubeconfig ./conf/kubelet.kubeconfig \\\n--log-dir /data/logs/kubenetes/kube-kubelet \\\n--pod-infra-container-image kubernetes/pause:latest \\\n--root-dir /data/kubelet\n</code></pre> <p>\u6dfb\u52a0\u53ef\u6267\u884c\u6743\u9650 <pre><code>chmod +x kubelet.sh\n</code></pre></p> <p>\u53c2\u6570\u8bf4\u660e\uff1a</p> <p><code>anonymous-auth=false</code>: \u4e0d\u80fd\u4f7f\u7528\u533f\u540d\u767b\u5f55</p> <p><code>cgroup-driver systemd</code>: \u8981\u4e0edocker\u4fdd\u6301\u4e00\u81f4</p> <p><code>cluster-dns</code>: \u96c6\u7fa4\u7684dns\uff0c\u8fd9\u91cc\u5148\u56fa\u5b9a\u5199\uff0c\u540e\u7eed\u4f1a\u63d0\u5230</p> <p><code>node-ip</code>: \u8282\u70b9ip\uff0c\u548c\u4e3b\u673aip\u4e00\u81f4</p> <p><code>fail-swap-on=\"false\"</code>: k8s\u8fd0\u7b97\u65f6\u6700\u597d\u628aswap\u5173\u95ed\u6389\uff0c\u4f46\u6211\u4eec\u5176\u4ed6\u7a0b\u5e8f\u53ef\u80fd\u9700\u8981\uff0c\u6240\u4ee5\u6dfb\u52a0\u8be5\u9009\u9879\uff0c\u4f1a\u517c\u5bb9swap\u5b58\u5728\u7684\u573a\u666f</p> <p><code>client-ca-file</code>:\u6839\u8bc1\u4e66</p> <p><code>tls-cert-file</code>:kubelet\u4f5c\u4e3a\u670d\u52a1\u7aef\u9700\u8981\u7684\u8bc1\u4e66</p> <p><code>tls-private-key-file</code>:kubelet\u4f5c\u4e3a\u670d\u52a1\u7aef\u9700\u8981\u7684\u8bc1\u4e66\u79c1\u94a5</p> <p><code>hostname-override</code>: \u4e3b\u673a\u540d\u79f0</p> <p><code>kubeconfig</code>: kubelet\u914d\u7f6e\u6587\u4ef6\u8def\u5f84</p> <p><code>log-dir</code>: \u65e5\u5fd7\u76ee\u5f55</p> <p><code>pod-infra-container-image</code>: \u57fa\u7840\u7684pause\u955c\u50cf</p> <p>\u521b\u5efa\u6570\u636e\u76ee\u5f55\u548c\u65e5\u5fd7\u76ee\u5f55</p> <pre><code># \u521b\u5efa\u65e5\u5fd7\u76ee\u5f55\nmkdir -p /data/logs/kubernetes/kube-kubelet\n# \u521b\u5efa\u6570\u636e\u76ee\u5f55\nmkdir -p /data/kubelet\n</code></pre> <p>\u521b\u5efasupervisor\u8fdb\u7a0b\u914d\u7f6e\u6587\u4ef6<code>/etc/supervisord.d/kube-kubelet.ini</code>\u6587\u4ef6\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>[program:kube-kubelet-21]\ndirectory=/opt/kubernetes/server/bin\ncommand=/opt/kubernetes/server/bin/kubelet.sh\nnumprocs=1\nautostart=true\nautorestart=true\nstartsecs=30\nstartretries=3\nexitcodes=0,2\nstopsignal=QUIT\nstopwaitsecs=10\nuser=root\nredirect_stderr=true\nstdout_logfile=/data/logs/kubernetes/kube-kubelet/kubelet.stdout.log\nstdout_logfile_maxbytes=64MB\nstdout_logfile_backups=4\nstdout_capture_maxbytes=1MB\nstdout_event_enabled=false\n</code></pre> <p>\u7ed9\u811a\u672c\u6dfb\u52a0\u53ef\u6267\u884c\u6743\u9650</p> <pre><code>chmod +x kubelet.sh\n</code></pre> <p>\u66f4\u65b0supervisord\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>supervisorctl update\n</code></pre> <p>\u6b64\u65f6\uff0c\u670d\u52a1\u5df2\u7ecf\u6b63\u5e38\u8fd0\u884c\u4e86\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u67e5\u770b\u8282\u70b9\u4fe1\u606f</p> <pre><code>kubectl get nodes\n</code></pre> <p>\u5982\u679c\u770b\u5230\u4ee5\u4e0b\u4fe1\u606f\uff0c\u4ee3\u8868\u5b89\u88c5\u6210\u529f</p> <pre><code>[root@kb21 bin]# kubectl get nodes\nNAME   STATUS   ROLES    AGE    VERSION\nkb21   Ready    &lt;none&gt;   5m2s   v1.15.2\nkb22   Ready    &lt;none&gt;   5m2s   v1.15.2\n</code></pre> <p>\u6211\u4eec\u8fd8\u53ef\u4ee5\u8bbe\u7f6e\u96c6\u7fa4\u7684\u6807\u7b7e</p> <pre><code># \u8bbe\u7f6e\u96c6\u7fa4\u4e3amaster\u6807\u7b7e\nkubectl label node kb21 node-role.kubernetes.io/master=\nkubectl label node kb22 node-role.kubernetes.io/master=\n# \u8bbe\u7f6e\u96c6\u7fa4\u4e3anode\u6807\u7b7e\nkubectl label node kb21 node-role.kubernetes.io/node=\nkubectl label node kb22 node-role.kubernetes.io/node=\n</code></pre>"},{"location":"02.enhancement/11-install-kubeproxy/","title":"\u5b89\u88c5kube-proxy","text":""},{"location":"02.enhancement/11-install-kubeproxy/#1-ssl","title":"1. \u7b7e\u53d1ssl\u8bc1\u4e66","text":"<p>\u6211\u4eec\u767b\u5f55\u5230\u8bc1\u4e66\u670d\u52a1\u5668\uff0c\u53bb\u7b7e\u53d1\u8bc1\u4e66</p> <p>\u521b\u5efa\u8bc1\u4e66\u76ee\u5f55<code>/opt/certs/kubeproxy</code>\uff0c</p> <p>\u521b\u5efa\u8bc1\u4e66\u8bf7\u6c42\u6587\u4ef6<code>/opt/certs/kubeproxy/kube-proxy-csr.json</code>\uff0c\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9</p> <pre><code>{\n\"CN\": \"system:kube-proxy\",\n\"key\": {\n\"algo\": \"rsa\",\n\"size\": 2048\n},\n\"name\": [\n{\n\"C\": \"CN\",\n\"ST\": \"Guangdong\",\n\"L\": \"Guangzhou\",\n\"O\": \"od\",\n\"OU\": \"ops\"\n}\n]\n}\n</code></pre> <p>\u521b\u5efa\u8bc1\u4e66</p> <pre><code>cfssl gencert -ca=../ca.pem -ca-key=../ca-key.pem -config=../ca-config.json -profile=client kube-proxy-csr.json | cfssljson -bare kube-proxy-client\n</code></pre>"},{"location":"02.enhancement/11-install-kubeproxy/#2-kube-proxy","title":"2. \u5b89\u88c5kube-proxy","text":"<p>\u7b7e\u53d1\u597d\u8bc1\u4e66\u4e4b\u540e\uff0c\u6211\u4eec\u56de\u5230<code>kb21</code>\u548c<code>kb22</code>\u4e24\u4e2a\u8282\u70b9\uff0c\u8fdb\u884c\u5b89\u88c5\u64cd\u4f5c\uff0c\u5177\u4f53\u8fc7\u7a0b\u5982\u4e0b</p> <p>\u4e0b\u8f7d\u8bc1\u4e66\u6587\u4ef6 <pre><code>scp root@kb200.host.com:/opt/certs/kubeproxy/kube-proxy-client.pem ./\nscp root@kb200.host.com:/opt/certs/kubeproxy/kube-proxy-client-key.pem ./\n</code></pre></p> <p>\u4f7f\u7528\u547d\u4ee4<code>cd /opt/kubernetes/server/bin/conf</code>\u56de\u5230\u96c6\u7fa4\u914d\u7f6e\u6587\u4ef6\u76ee\u5f55\uff0c\u6267\u884c\u4ee5\u4e0b\u64cd\u4f5c</p> <p>\u8bbe\u7f6e\u96c6\u7fa4</p> <pre><code>kubectl config set-cluster myk8s \\\n--certificate-authority=/opt/kubernetes/server/bin/certs/ca.pem \\\n--embed-certs=true \\\n--server=https://192.168.14.10:7443 \\\n--kubeconfig=kube-proxy.kubeconfig\n</code></pre> <p>\u8bbe\u7f6e\u5ba2\u6237\u7aef\u8bc1\u4e66</p> <pre><code>kubectl config set-credentials kube-proxy \\\n--client-certificate=/opt/kubernetes/server/bin/certs/kube-proxy-client.pem \\\n--client-key=/opt/kubernetes/server/bin/certs/kube-proxy-client-key.pem \\\n--embed-certs=true \\\n--kubeconfig=kube-proxy.kubeconfig\n</code></pre> <p>\u8bbe\u7f6e\u4e0a\u4e0b\u6587</p> <pre><code>kubectl config set-context myk8s-context \\\n--cluster=myk8s \\\n--user=kube-proxy \\\n--kubeconfig=kube-proxy.kubeconfig\n</code></pre> <p>\u4f7f\u7528\u4e0a\u4e0b\u6587</p> <p>\u4ee5\u4e0a\u914d\u7f6e\u53ea\u9700\u5728\u4e00\u53f0\u4e3b\u673a\u8fdb\u884c\uff0c\u53e6\u4e00\u53f0\u4e3b\u673a\u4ece\u521b\u5efa\u7684\u4e3b\u673a\u62f7\u8d1d\u5373\u53ef\uff0c\u6700\u540e\u4e24\u53f0\u4e3b\u673a\u90fd\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4</p> <pre><code>kubectl config use-context myk8s-context --kubeconfig=kube-proxy.kubeconfig\n</code></pre>"},{"location":"02.enhancement/11-install-kubeproxy/#3","title":"3. \u542f\u52a8\u670d\u52a1","text":"<p>\u5148\u521b\u5efa\u4e00\u4e2a\u811a\u672c\u6587\u4ef6<code>ipvs.sh</code>\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>#!/bin/bash\nipvs_mods_dir=\"/usr/lib/modules/$(uname -r)/kernel/net/netfilter/ipvs\"\nfor i in $(ls $ipvs_mods_dir|grep -o \"^[^.]*\")\ndo\n/sbin/modinfo -F filename $i &amp;&gt;/dev/null\n    if [ $? -eq 0 ]; then\n/sbin/modprobe $i\nfi\ndone\n</code></pre> <p>\u8be5\u811a\u672c\u7684\u4f5c\u7528\u662f\u52a0\u8f7d\u6240\u6709\u4e0eipvs\u76f8\u5173\u7684\u6a21\u5757</p> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u67e5\u770b\u5f53\u524dip_vs\u76f8\u5173\u7684\u6a21\u5757\uff0c\u53ef\u4ee5\u53d1\u73b0\u5728\u6267\u884c\u811a\u672c\u4e4b\u524d\u662f\u6ca1\u6709\u8fd4\u56de\u5185\u5bb9\u7684 <pre><code>lsmod | grep ip_vs\n</code></pre></p> <p>\u5728\u4e24\u53f0\u4e3b\u673a\u6267\u884c\u4ee5\u4e0a\u811a\u672c\u4e4b\u540e\uff0c\u6211\u4eec\u521b\u5efa<code>kube-proxy</code>\u7684\u542f\u52a8\u811a\u672c\u6587\u4ef6<code>/opt/kubernetes/server/bin/kube-proxy.sh</code></p> <pre><code>#!/bin/bash\n./kube-proxy \\\n--cluster-cidr 172.7.0.0/16 \\\n--hostname-override kb21 \\\n--proxy-mode=ipvs \\\n--ipvs-scheduler=nq \\\n--kubeconfig ./conf/kube-proxy.kubeconfig\n</code></pre> <p>\u6dfb\u52a0\u53ef\u6267\u884c\u6743\u9650</p> <pre><code>chmod +x kube-proxy.sh\n</code></pre> <p>\u521b\u5efasupervisor\u7684\u914d\u7f6e\u6587\u4ef6<code>/etc/supervisord.d/kube-proxy.ini</code>\u6587\u4ef6\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>[program:kube-proxy-21]\ndirectory=/opt/kubernetes/server/bin\ncommand=/opt/kubernetes/server/bin/kube-proxy.sh\nnumprocs=1\nautostart=true\nautorestart=true\nstartsecs=30\nstartretries=3\nexitcodes=0,2\nstopsignal=QUIT\nstopwaitsecs=10\nuser=root\nredirect_stderr=true\nstdout_logfile=/data/logs/kubernetes/kube-proxy/kube-proxy.stdout.log\nstdout_logfile_maxbytes=64MB\nstdout_logfile_backups=4\nstdout_capture_maxbytes=1MB\nstdout_event_enabled=false\n</code></pre> <p>\u521b\u5efa\u65e5\u5fd7\u76ee\u5f55\u4e0e\u66f4\u65b0supervisor</p> <pre><code>mkdir -p /data/logs/kubernetes/kube-proxy/\nsupervisorctl update\n</code></pre> <p>\u6211\u4eec\u8fd8\u53ef\u4ee5\u5b89\u88c5<code>ipvsadm</code>\u7528\u4e8e\u7ba1\u7406ipvs\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>yum install -y ipvsadm\n</code></pre>"},{"location":"02.enhancement/11-install-kubeproxy/#4","title":"4. \u96c6\u7fa4\u7684\u9a8c\u8bc1","text":"<p>\u5728\u4e24\u4e2a\u8282\u70b9\u90fd\u542f\u52a8\u597dkube-proxy\u670d\u52a1\u4e4b\u540e\uff0c\u6211\u4eec\u6765\u9a8c\u8bc1\u96c6\u7fa4\u3002\u521b\u5efa\u4e00\u4e2aDaemonSet\u7c7b\u578b\u7684\u8d44\u6e90\uff0c\u6dfb\u52a0<code>nginx-ds.yaml</code>\u6587\u4ef6\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>apiVersion: extensions/v1beta1\nkind: DaemonSet\nmetadata:\n  name: nginx-ds\nspec:\n  template:\n    metadata:\n      labels:\n        app: nginx-ds\n    spec:\n      containers:\n      - name: my-nginx\n        image: nginx:alpine\n        ports:\n        - containerPort: 80\n</code></pre> <p>\u6267\u884c\u8d44\u6e90\u521b\u5efa\u547d\u4ee4</p> <pre><code>kubectl create -f nginx-ds.yaml\n</code></pre> <p>\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u9a8c\u8bc1pod\u662f\u5426\u6b63\u5e38\u8fd0\u884c</p> <pre><code>kubectl get pod -o wide\n</code></pre> <p>\u5982\u679c\u8fd4\u56de\u5982\u4e0b\u5185\u5bb9\uff0c\u4ee3\u8868\u96c6\u7fa4\u6b63\u5e38</p> <pre><code>[root@kb21 yml]# kubectl get pod -o wide\nNAME             READY   STATUS    RESTARTS   AGE   IP           NODE   NOMINATED NODE   READINESS GATES\nnginx-ds-mzxrv   1/1     Running   0          12s   172.7.22.2   kb22   &lt;none&gt;           &lt;none&gt;\nnginx-ds-sdfwt   1/1     Running   0          12s   172.7.21.2   kb21   &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u52a0\u5165\u6211\u4eec\u73b0\u5728\u5728<code>kb21</code>\u8fd9\u53f0\u4e3b\u673a\u4e0a\uff0c\u4f7f\u7528<code>curl http://172.7.21.2</code>\u547d\u4ee4\u68c0\u6d4b\u65b0\u5efa\u7684\u670d\u52a1\u662f\u5426\u6b63\u5e38\uff0c\u5982\u679c\u8fd4\u56de\u5982\u4e0bnginx\u76f8\u5173\u7684\u63d0\u793a\u4fe1\u606f\uff0c\u4ee3\u8868kb21\u8fd9\u4e2a\u8282\u70b9\u670d\u52a1\u6b63\u5e38\u3002</p> <p>\u4f46\u662f\u5982\u679c\u6211\u4eec\u5728<code>kb21</code>\u4e0a\u4f7f\u7528<code>curl http://172.7.22.2</code>\u53bb\u68c0\u6d4b<code>kb22</code>\u8fd9\u4e2a\u8282\u70b9\uff0c\u4f1a\u53d1\u73b0\u8bbf\u95ee\u4e0d\u5230\u3002\u539f\u56e0\u662f\u8fd9\u4e24\u4e2a\u8282\u70b9\u4e0a\u7684\u5bb9\u5668\u5728\u5404\u81ea\u7684\u865a\u62df\u7f51\u7edc\u5185\uff0c\u6211\u4eec\u5c06\u5230\u540e\u7eed\u7ae0\u8282\u7ee7\u7eed\u89e3\u51b3\u4e0d\u540c\u8282\u70b9\u7684\u5bb9\u5668\u7f51\u7edc\u4e92\u76f8\u8bbf\u95ee\u7684\u95ee\u9898\uff01</p> <p>Deployment \u90e8\u7f72\u7684\u526f\u672c Pod \u4f1a\u5206\u5e03\u5728\u5404\u4e2a Node \u4e0a\uff0c\u6bcf\u4e2a Node \u90fd\u53ef\u80fd\u8fd0\u884c\u597d\u51e0\u4e2a\u526f\u672c\u3002 DaemonSet \u7684\u4e0d\u540c\u4e4b\u5904\u5728\u4e8e:\u6bcf\u4e2a Node \u4e0a\u6700\u591a\u53ea\u80fd\u8fd0\u884c\u4e00\u4e2a\u526f\u672c\u3002</p>"},{"location":"02.enhancement/12-cfssl-review/","title":"cfssl\u8bc1\u4e66\u5de5\u5177\u6982\u8ff0","text":"<p>\u901a\u8fc7\u524d\u9762\u51e0\u8282\u6587\u7ae0\uff0c\u6211\u4eec\u5df2\u7ecf\u4f7f\u7528k8s\u4e8c\u8fdb\u5236\u5b89\u88c5\u5305\u4ece\u96f6\u5f00\u59cb\u642d\u5efa\u597d\u4e86k8s\u96c6\u7fa4\uff0c\u4f46\u76ee\u524d\u6211\u4eec\u4e0d\u662f\u767e\u5206\u4e4b\u767e\u7684\u5b8c\u6210\u6211\u4eec\u7684\u642d\u5efa\u3002\u4e0d\u8fc7\u6838\u5fc3\u7684\u7ec4\u4ef6\u5df2\u7ecf\u5b89\u88c5\u5b8c\u6210\u5e76\u4e14\u6b63\u5e38\u4e86\uff0c\u6211\u4eec\u5c06\u5728\u6301\u7eed\u5b8c\u6210\u76f8\u5173\u77e5\u8bc6\u70b9\u3002\u5728\u672c\u8282\uff0c\u6211\u4eec\u5148\u56de\u987ecfssl\u8fd9\u4e2a\u8bc1\u4e66\u5de5\u5177\u5de5\u5177\u3002</p>"},{"location":"02.enhancement/12-cfssl-review/#cfssl_1","title":"\u5173\u4e8ecfssl\u5de5\u5177","text":"<ul> <li><code>cfssl</code>\uff1a\u8bc1\u4e66\u7b7e\u53d1\u7684\u4e3b\u8981\u5de5\u5177</li> <li><code>cfssl-json</code>\uff1a\u5c06cfssl\u751f\u6210\u7684\u8bc1\u4e66\uff08json\u683c\u5f0f\uff09\u53d8\u4e3a\u6587\u4ef6\u627f\u8f7d\u5f0f\u8bc1\u4e66</li> <li><code>cfssl-certinfo</code>\uff1a\u7528\u4e8e\u9a8c\u8bc1\u8bc1\u4e66\u4fe1\u606f</li> </ul> <p>\u5173\u4e8ekubeconfig\u6587\u4ef6\uff1a \u8fd9\u662fk8s\u7528\u6237\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u5b83\u91cc\u9762\u542b\u6709\u8bc1\u4e66\u7684\uff0c\u8bc1\u4e66\u8fc7\u671f\u6216\u66ff\u6362\u8be5\u6587\u4ef6</p>"},{"location":"02.enhancement/12-cfssl-review/#cfssl-certinfo","title":"\u4f7f\u7528cfssl-certinfo \u67e5\u770b\u8bc1\u4e66\u4fe1\u606f","text":"<p>\u67e5\u770bpem\u8bc1\u4e66\u4fe1\u606f</p> <p>\u4f7f\u7528<code>cfssl-certinfo</code>\u67e5\u770b<code>pem</code>\u6587\u4ef6\u7684\u4fe1\u606f</p> <pre><code>cfssl-certinfo -cert apiserver.pem\n</code></pre> <p>\u6b64\u547d\u4ee4\u8fd4\u56de\u8bc1\u4e66\u7684\u8be6\u7ec6\u4fe1\u606f</p> <p>\u67e5\u770b\u67d0\u4e2a\u57df\u540d\u7684\u8bc1\u4e66\u4fe1\u606f</p> <p>\u67e5\u770b\u767e\u5ea6\u9996\u9875\u7684\u8bc1\u4e66\u4fe1\u606f\uff0c\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4</p> <pre><code>cfssl-certinfo -domain www.baidu.com\n</code></pre> <p>\u89e3\u6790kubeconfig\u4e2d\u7684\u8bc1\u4e66\u4fe1\u606f</p> <p>\u6211\u4eec\u5728\u5b89\u88c5kubelet\u65f6\uff0c\u521b\u5efa\u4e86<code>kubelet.kubeconfig</code>\u914d\u7f6e\u6587\u4ef6\uff0c\u5b9e\u9645\u4e0a\u8fd9\u4e2a\u6587\u4ef6\u662f\u5c06\u4e00\u4e9b\u914d\u7f6e\u96c6\u5408\u5230\u6b64\u6587\u4ef6\u4e2d\uff0c\u5305\u62ec\u76f8\u5173\u7684\u8bc1\u4e66\u4fe1\u606f\uff0c\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u4ece\u4e2d\u53cd\u89e3\u5230\u6587\u4ef6\u4e2d\u76f8\u5173\u7684\u8bc1\u4e66\u4fe1\u606f\u3002\u76f8\u5173\u6b65\u9aa4\u5982\u4e0b\uff1a</p> <p>\u6211\u4eec\u53d6\u8be5\u6587\u4ef6\u7684<code>users.user.client-certificate-data</code>\u8fd9\u4e2a\u8282\u70b9\u4e0b\u5b57\u7b26\u4e32\u5185\u5bb9\uff0c\u4f7f\u7528<code>base64</code>\u89e3\u7801\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>echo $CONTENT | base64 -d\n</code></pre> <p><code>$CONTENT</code>\u4e3a\u5b9e\u9645\u7684\u5b57\u7b26\u4e32\u5185\u5bb9\u3002\u6267\u884c\u4e0a\u9762\u547d\u4ee4\u540e\uff0c\u5c06\u8f93\u5165\u8bc1\u4e66\u7684\u5185\u5bb9\u3002</p> <p>\u6709\u8bc1\u4e66\u5185\u5bb9\u8f93\u51fa\uff0c\u53ef\u4ee5\u8f93\u51fa\u5230\u7279\u5b9a\u6587\u4ef6\u4e2d\uff0c\u5982\u4e0b\u6307\u4ee4</p> <pre><code>echo $CONTENT | base64 -d &gt; tmp.pem\n</code></pre> <p>\u518d\u4f7f\u7528<code>cfssl-certinfo</code>\u67e5\u770b\u8bc1\u4e66\u6587\u4ef6\u7684\u5305\u542b\u7684\u8bc1\u4e66\u8be6\u7ec6\u4fe1\u606f\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>cfssl-certinfo -cert tmp.pem\n</code></pre>"},{"location":"02.enhancement/13-kubectl-command/","title":"kubectl\u58f0\u660e\u5f0f\u8d44\u6e90\u7ba1\u7406\u65b9\u6cd5","text":"<p>\u5728k8s\u4e2d\uff0c\u5404\u79cd\u670d\u52a1\u53ef\u4ee5\u88ab\u79f0\u4e3a\u8d44\u6e90\uff0c\u7ba1\u7406k8s\u8d44\u6e90\uff0c\u65e0\u975e\u5c31\u662f\u5bf9k8s\u7684\u5404\u79cd\u8d44\u6e90\u8fdb\u884c\u589e\u5220\u6539\u67e5\u3002\u5728\u672c\u6587\u6211\u4eec\u5c06\u4ecb\u7ecd\u5e38\u89c1\u7684\u8d44\u6e90\u7ba1\u7406\u547d\u4ee4\u3002</p> <p>\u6211\u4eec\u628a\u4f7f\u7528\u547d\u4ee4\u884c\u53c2\u6570\u58f0\u660e\u8d44\u6e90\u7684k8s\u7ba1\u7406\u65b9\u5f0f\u53eb\u505a\u751f\u547d\u662f\u8d44\u6e90\u7ba1\u7406\u65b9\u6cd5\u3002</p>"},{"location":"02.enhancement/13-kubectl-command/#1","title":"1. \u4f7f\u7528\u58f0\u660e\u5f0f\u7684\u65b9\u5f0f\u8fdb\u884c\u8d44\u6e90\u7ba1\u7406","text":"<p>\u67e5\u770b\u540d\u79f0\u7a7a\u95f4</p> <p>\u67e5\u770bk8s\u96c6\u7fa4\u4e2d\u6240\u6709\u7684\u540d\u79f0\u7a7a\u95f4\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4</p> <pre><code>kubectl get namespaces\n</code></pre> <p>\u6216\u8005</p> <pre><code>kubectl get ns\n</code></pre> <p>\u521b\u5efa\u540d\u79f0\u7a7a\u95f4</p> <p>\u521b\u5efa\u540d\u79f0\u4e3a<code>app</code>\u7684\u540d\u79f0\u7a7a\u95f4</p> <pre><code>kubectl create namespace app\n</code></pre> <p>\u5220\u9664\u540d\u79f0\u7a7a\u95f4</p> <pre><code>kubectl delete namespace app\n</code></pre> <p>\u521b\u5efadeployment</p> <p>\u4f7f\u7528<code>nginx:alpine</code>\u5728<code>kube-public</code>\u8fd9\u4e2a\u540d\u79f0\u7a7a\u95f4\u521b\u5efadeployment\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>kubectl create deployment nginx-dp --image=nginx:alpine -n kube-public\n</code></pre> <p>\u67e5\u770bpod</p> <p>\u521b\u5efadeployment\u7684\u65f6\u5019\uff0c\u4f1a\u521b\u5efa\u5bf9\u5e94\u7684pod\uff0c\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u67e5\u770b\u6240\u6709\u540d\u79f0\u7a7a\u95f4\u7684pod</p> <pre><code>kubectl get pod -o wide --all-namespaces\n</code></pre> <p>\u6216\u8005\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u6307\u5b9a\u67e5\u770b<code>kube-public</code>\u540d\u79f0\u7a7a\u95f4\u7684pod</p> <pre><code>kubectl get pod -o wide -n kube-public\n</code></pre> <p>\u67e5\u770bdeployment</p> <p>\u67e5\u770b kube-public \u540d\u79f0\u7a7a\u95f4\u7684\u7684 deployment</p> <pre><code>kubectl get deploy -n kube-public\n</code></pre> <p>\u67e5\u770b kube-public \u540d\u79f0\u7a7a\u95f4\u7684 deployment \u5e76\u9644\u5e26\u6269\u5c55\u4fe1\u606f</p> <pre><code>kubectl get deployment -o wide -n kube-public\n</code></pre> <p>\u67e5\u770bdeployment\u8be6\u7ec6\u4fe1\u606f</p> <pre><code>kubectl describe deployment nginx-dp -n kube-public\n</code></pre> <p>\u8fdb\u5165pod</p> <p>\u8fdb\u5165<code>nginx-dp-f585689bf-prp27</code>\u8fd9\u4e2apod\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>kubectl exec -it nginx-dp-f585689bf-prp27 sh -n kube-public\n</code></pre> <p>\u5220\u9664pod</p> <p>\u5220\u9664<code>nginx-dp-f585689bf-prp27</code>\u8fd9\u4e2apod\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>kubectl delete pod nginx-dp-f585689bf-prp27 -n kube-public\n</code></pre> <p>\u4e0d\u8fc7\uff0c\u6211\u4eec\u5220\u9664\u4e4b\u540ek8s\u4f1a\u91cd\u65b0\u542f\u52a8\u4e00\u4e2a\u65b0\u7684pod\uff0c\u56e0\u4e3a\u6211\u4eec\u7684\u524d\u9762\u521b\u5efa\u7684\u8d44\u6e90\u5c31\u662f\u671f\u671b\u5b83\u6b63\u5e38\u8fd0\u884c</p> <p>\u5220\u9664deployment</p> <p>\u5220\u9664\u6211\u4eec\u4e0a\u4e0a\u9762\u521b\u5efa\u7684deployment\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>kubectl delete deploy nginx-dp -n kube-public\n</code></pre> <p>\u6267\u884cdeployment\u5220\u9664\u547d\u4ee4\u4e4b\u540e\uff0cpod\u4e5f\u8ddf\u7740\u88ab\u5220\u9664\u4e86</p> <p>\u5f39\u6027\u4f38\u7f29</p> <p>\u4e3a\u4e86\u6a21\u62df\u5411deployment\u5411\u5916\u671b\u66b4\u9732\u7aef\u53e3\uff0c\u6211\u4eec\u60f3\u4f7f\u7528\u521b\u5efa deployment\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>kubectl create deployment nginx-dp --image=nginx:alpine -n kube-public\n</code></pre> <p>\u6211\u4eec\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u521b\u5efa\u5c06deployment \u8bbe\u7f6e\u4e3a\u4e24\u4e2a\u526f\u672c</p> <pre><code>kubectl scale deployment nginx-dp --replicas=2 -n kube-public\n</code></pre> <p>\u66b4\u9732\u7aef\u53e3</p> <p>\u5411\u5916\u66b4\u973280\u7aef\u53e3\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>kubectl expose deployment nginx-dp --port 80 -n kube-public\n</code></pre> <p>\u6b64\u65f6\u521b\u5efa\u4e86\u5bf9\u5e94\u7684service\uff0c\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u67e5\u770b</p> <pre><code>kubectl describe svc nginx-dp -n kube-public\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u8fd4\u56de\u5982\u4e0b\u5185\u5bb9</p> <pre><code>[root@kb21 vagrant]# kubectl describe svc nginx-dp -n kube-public\nName:              nginx-dp\nNamespace:         kube-public\nLabels:            app=nginx-dp\nAnnotations:       &lt;none&gt;\nSelector:          app=nginx-dp\nType:              ClusterIP\nIP:                192.168.11.76\nPort:              &lt;unset&gt;  80/TCP\nTargetPort:        80/TCP\nEndpoints:         172.7.21.2:80,172.7.22.2:80\nSession Affinity:  None\nEvents:            &lt;none&gt;\n</code></pre>"},{"location":"02.enhancement/13-kubectl-command/#2","title":"2. \u58f0\u660e\u5f0f\u7ba1\u7406\u8d44\u6e90\u65b9\u6cd5\u5c0f\u7ed3","text":"<ul> <li> <p>kubernetes \u96c6\u7fa4 \u7ba1\u7406\u96c6\u7fa4\u8d44\u6e90\u7684\u7684\u552f\u4e00\u5165\u53e3\u662f\u901a\u8fc7\u76f8\u5e94\u7684\u65b9\u6cd5\u8c03\u7528 <code>apiserver</code> \u7684\u63a5\u53e3</p> </li> <li> <p><code>kubectl</code> \u662f\u5b98\u65b9\u7684cli\u547d\u4ee4\u884c\u5de5\u5177\uff0c\u7528\u4e8e\u4e0e<code>apiserver</code> \u8fdb\u884c\u901a\u4fe1\uff0c\u5c06\u7528\u6237\u5728\u547d\u4ee4\u884c\u8f93\u5165\u7684\u547d\u4ee4\uff0c\u7ec4\u7ec7\u5e76\u8f6c\u5316\u4e3a <code>apiserver</code> \u80fd\u8bc6\u522b\u7684\u4fe1\u606f\uff0c\u8fdb\u800c\u5b9e\u73b0\u7ba1\u7406 k8s \u5404\u4e2a\u8d44\u6e90\u7684\u4e00\u79cd\u6709\u6548\u9014\u5f84</p> </li> <li> <p>\u53ef\u4ee5\u4f7f\u7528<code>kubectl --help</code>\u67e5\u770bk8s\u7684\u547d\u4ee4\u5e2e\u52a9\uff0c\u597d\u53ef\u4ee5\u6253\u5f00 http://docs.kubernetes.org.cn/\u67e5\u770b\u4e2d\u6587\u6587\u6863\u5e2e\u52a9</p> </li> <li> <p>\u58f0\u660e\u5f0f\u8d44\u6e90\u7ba1\u7406\u65b9\u6cd5\u53ef\u4ee5\u6ee1\u8db3\u5927\u90e8\u5206\u7684\u8d44\u6e90\u7ba1\u7406\u9700\u6c42\uff0c\u4f46\u5b83\u7684\u7f3a\u70b9\u4e5f\u5f88\u660e\u663e\uff0c\u5982\u4e0b</p> </li> <li> <p>\u547d\u4ee4\u5197\u957f\u3001\u590d\u6742\u3001\u96be\u4ee5\u8bb0\u5fc6</p> </li> <li>\u7279\u5b9a\u573a\u666f\u4e0b\u3001\u65e0\u6cd5\u5b9e\u73b0\u7ba1\u7406\u8005\u7684\u9700\u6c42</li> <li>\u5bf9\u7279\u5b9a\u7684\u589e\u3001\u5220\u3001\u67e5\u64cd\u4f5c\u6bd4\u8f83\u5bb9\u6613\uff0c\u6539\u5c31\u6bd4\u8f83\u9ebb\u70e6</li> </ul>"},{"location":"02.enhancement/14-kubectl-yaml/","title":"kubectl\u9648\u8ff0\u5f0f\u8d44\u6e90\u7ba1\u7406\u65b9\u6cd5","text":"<p>\u6211\u4eec\u628a\u4f7f\u7528<code>\u8d44\u6e90\u6e05\u5355</code>\u7ba1\u7406k8s\u7684\u65b9\u6cd5\u53eb\u505a\u58f0\u660e\u5f0f\u8d44\u6e90\u7ba1\u7406\u65b9\u6cd5</p>"},{"location":"02.enhancement/14-kubectl-yaml/#1","title":"1. \u58f0\u660e\u5f0f\u7ba1\u7406\u65b9\u6cd5","text":"<p>\u67e5\u770b\u8d44\u6e90\u914d\u7f6e\u6e05\u5355</p> <p>\u67e5\u770b\u6b63\u5728\u8fd0\u884c\u7684\u540d\u79f0\u4e3a<code>nginx-dp</code>\u7684service\u7684\u8d44\u6e90\u914d\u7f6e\u6e05\u5355</p> <pre><code>kubectl get svc nginx-dp -o yaml -n kube-public\n</code></pre> <p>\u89e3\u91ca\u8d44\u6e90\u914d\u7f6e\u6e05\u5355</p> <p>\u67e5\u770bservice\u7684\u8d44\u6e90\u914d\u7f6e\u6e05\u5355\u89e3\u91ca</p> <pre><code>kubectl explain service\n</code></pre> <p>\u5e94\u7528\u8d44\u6e90\u914d\u7f6e\u6e05\u5355</p> <p>\u5728\u5bf9\u8d44\u6e90\u914d\u7f6e\u8ba2\u5355\u505a\u597d\u5b9a\u4e49\u4e4b\u540e\uff0c\u4f7f\u7528\u4e00\u4e0b\u547d\u4ee4\u5e94\u7528\u8d44\u6e90\u914d\u7f6e\u6e05\u5355</p> <pre><code>kubectl apply -f nginx-ds-svc.yaml\n</code></pre> <p>\u5220\u9664\u8d44\u6e90</p> <p>\u4f7f\u7528\u8d44\u6e90\u914d\u7f6e\u6e05\u5355\u5220\u9664\u8d44\u6e90\u7684\u547d\u4ee4\u5982\u4e0b</p> <pre><code>kubectl delete -f nginx-ds-svc.yaml\n</code></pre>"},{"location":"02.enhancement/14-kubectl-yaml/#2","title":"2.\u58f0\u660e\u5f0f\u8d44\u6e90\u7ba1\u7406\u65b9\u6cd5\u5c0f\u7ed3","text":"<ul> <li> <p>\u58f0\u660e\u5f0f\u8d44\u6e90\u7ba1\u7406\u65b9\u6cd5\uff0c\u4f9d\u8d56\u4e8e\u7edf\u4e00\u8d44\u6e90\u914d\u7f6e\u6e05\u5355\u6587\u4ef6\u5bf9\u8d44\u6e90\u8fdb\u884c\u7ba1\u7406</p> </li> <li> <p>\u5bf9\u8d44\u6e90\u7684\u7ba1\u7406\uff0c\u662f\u901a\u8fc7\u4e8b\u5148\u5b9a\u4e49\u5728\u7edf\u4e00\u8d44\u6e90\u914d\u7f6e\u6e05\u5355\u5185\uff0c\u518d\u901a\u8fc7\u9648\u8ff0\u5f0f\u547d\u4ee4\u5e94\u7528\u5230k8s\u96c6\u7fa4\u91cc</p> </li> <li> <p>\u8d44\u6e90\u914d\u7f6e\u6e05\u5355\u7684\u5b66\u4e60\u65b9\u6cd5</p> </li> <li> <p>\u591a\u770b\u5b98\u65b9\uff08\u88ab\u4eba\uff09\u5199\u7684\u8d44\u6e90\u914d\u7f6e\u6e05\u5355\uff0c\u80fd\u8bfb\u61c2</p> </li> <li>\u80fd\u7167\u7740\u73b0\u6210\u7684\u8d44\u6e90\u914d\u7f6e\u6e05\u5355\u8fdb\u884c\u4fee\u6539</li> <li>\u9047\u5230\u4e0d\u61c2\u7684\uff0c\u5584\u4e8e\u5229\u7528<code>kubectl explain</code>\u67e5\u8be2\u6ce8\u91ca</li> <li>\u521d\u5b66\u8005\u5207\u8bb0\u4e0a\u6765\u5c31\u65e0\u4e2d\u751f\u6709\uff0c\u81ea\u5df1\u618b\u7740\u5199</li> </ul>"},{"location":"02.enhancement/15-flannel-plugin/","title":"flannel\u7f51\u7edc\u4ecb\u7ecd","text":"<p>k8s\u8bbe\u8ba1\u4e86\u7f51\u7edc\u6a21\u578b\uff0c\u4f46\u786e\u5c06\u5b83\u7684\u5b9e\u73b0\u4ea4\u7ed9\u4e86\u7f51\u7edc\u63d2\u4ef6\uff0cCNI\u7f51\u7edc\u63d2\u4ef6\u4e3b\u8981\u7684\u529f\u80fd\u5c31\u662f\u5b9e\u73b0POD\u8d44\u6e90\u80fd\u591f\u8de8\u5bbf\u4e3b\u673a\u8fdb\u884c\u901a\u4fe1\uff0c\u63d2\u4ef6\u7684CNI\u7f51\u7edc\u63d2\u4ef6\u5982\u4e0b</p> <ul> <li>Flannel</li> <li>Calico</li> <li>Canal</li> <li>Contiv</li> <li>OpenContrial</li> <li>NSX-T</li> <li>Kube-router</li> </ul> <p>\u5728\u672c\u6587\u4e2d\uff0c\u6211\u4eec\u5c06\u4ecb\u7ecd\u4f7f\u7528Flannel\u63d2\u4ef6\u6765\u5b9e\u73b0\u5bb9\u5668\u95f4\u7684\u8de8\u4e3b\u673a\u8bbf\u95ee</p>"},{"location":"02.enhancement/15-flannel-plugin/#1-flannel","title":"1. \u4e0b\u8f7d\u4e0e\u5b89\u88c5flannel","text":"<p>\u6211\u4eec\u9700\u8981\u5728<code>kb21</code>\u548c<code>kb22</code>\u8fd9\u4e24\u53f0\u4e3b\u673a\u5b89\u88c5flannel\u3002</p> <p>Flannel\u7684\u4ed3\u5e93\u5730\u5740\u662f\uff1ahttps://github.com/flannel-io/flannel/</p> <pre><code># \u4e0b\u8f7dflannel\nwget https://github.com/flannel-io/flannel/releases/download/v0.11.0/flannel-v0.11.0-linux-amd64.tar.gz\n# \u521b\u5efaflannel\u5b89\u88c5\u76ee\u5f55\nmkdir /opt/flannel-v0.11.0\n# \u5b89\u88c5\ntar -zxvf flannel-v0.11.0-linux-amd64.tar.gz -C /opt/flannel-v0.11.0/\n# \u521b\u5efa\u8f6f\u8fde\u63a5\nln -s /opt/flannel-v0.11.0/ /opt/flannel\n</code></pre>"},{"location":"02.enhancement/15-flannel-plugin/#2","title":"2. \u914d\u7f6e\u542f\u52a8\u53c2\u6570","text":"<p>\u8fdb\u5165\u5230<code>/opt/flannel</code>\uff0c\u521b\u5efa\u5b50\u7f51\u914d\u7f6e\u6587\u4ef6<code>subnet.env</code>\uff0c\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9</p> <pre><code>FLANNEL_NETWORK=172.7.0.0/16\nFLANNEL_SUBNET=172.7.21.1/24\nFLANNEL_MTU=1500\nFLANNEL_IPMASQ=false\n</code></pre> <p>\u5982\u679c\u662fkb22\u8fd9\u53f0\u4e3b\u673a\uff0c<code>FLANNEL_SUBNET</code>\u8fd9\u4e2a\u503c\u6539\u4e3a<code>172.7.22.1/24</code></p> <p>\u51c6\u5907SSL\u8bc1\u4e66</p> <pre><code># \u521b\u5efa\u8bc1\u4e66\u76ee\u5f55\nmkdir certs\n# \u8fdb\u5165etcd\u8bc1\u4e66\u76ee\u5f55\ncd certs\n# \u4ece\u8bc1\u4e66\u670d\u52a1\u5668\u4e0b\u8f7d\u8bc1\u4e66\nscp root@kb200.host.com:/opt/certs/ca.pem ./\nscp root@kb200.host.com:/opt/certs/kubernetes/client.pem ./\nscp root@kb200.host.com:/opt/certs/kubernetes/client-key.pem ./\n</code></pre> <p>\u521b\u5efa\u542f\u52a8\u811a\u672c<code>/opt/flannel/flanneld.sh</code>\uff0c\u6dfb\u52a0\u4e00\u4e0b\u5185\u5bb9</p> <pre><code>#!/bin/bash\n./flanneld \\\n--public-ip=192.168.14.21 \\\n--etcd-endpoints=https://192.168.14.12:2379,https://192.168.14.21:2379,https://192.168.14.22:2379 \\\n--etcd-cafile=./certs/ca.pem \\\n--etcd-certfile=./certs/client.pem \\\n--etcd-keyfile=./certs/client-key.pem \\\n--iface=eth1 \\\n--subnet-file=./subnet.env \\\n--healthz-port=2401\n</code></pre> <p>\u7ed9\u542f\u52a8\u811a\u672c\u6dfb\u52a0\u6267\u884c\u6743\u9650</p> <pre><code>chmod +x flanneld.sh\n</code></pre> <p>\u521b\u5efa\u65e5\u5fd7\u76ee\u5f55</p> <pre><code>mkdir -p /data/logs/flanneld\n</code></pre> <p>\u521b\u5efasupervisor\u914d\u7f6e\u6587\u4ef6<code>/etc/supervisord.d/flanneld.ini</code></p> <pre><code>[program:flannel-21]\ndirectory=/opt/flannel\ncommand=/opt/flannel/flanneld.sh\nnumprocs=1\nautostart=true\nautorestart=true\nstartsecs=30\nstartretries=3\nexitcodes=0,2\nstopsignal=QUIT\nstopwaitsecs=10\nuser=root\nredirect_stderr=true\nstdout_logfile=/data/logs/flanneld/flanneld.stdout.log\nstdout_logfile_maxbytes=64MB\nstdout_logfile_backups=4\nstdout_capture_maxbytes=1MB\nstdout_event_enabled=false\n</code></pre>"},{"location":"02.enhancement/15-flannel-plugin/#3-etcdhost-gw","title":"3. \u64cd\u4f5cetcd\uff0c\u589e\u52a0host-gw","text":"<p>\u5728\u66f4\u65b0supervisord\u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u5148\u4f7f\u7528etcd\u589e\u52a0host-gw\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>./etcdctl set /coreos.com/network/config '{\"Network\":\"172.7.0.0/16\",\"Backend\":{\"Type\":\"host-gw\"}}'\n</code></pre> <p>\u8fd9\u6761\u547d\u4ee4\u8868\u793a\u8bbe\u7f6eflannel\u7684\u7f51\u7edc\u6a21\u578b\u4e3a<code>host-gw</code>\u6a21\u578b\uff0cflannel\u5c06\u4f1a\u8bfb\u53d6\u5230\u952e\u540d<code>/coreos.com/network/config</code>\u5bf9\u5e94\u7684\u503c\u3002\u5982\u679c\u6211\u4eec\u8981\u786e\u4fddetcd\u5df2\u7ecf\u8bbe\u7f6e\u4e86\u5bf9\u5e94\u7684\u952e\u503c\u5bf9\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e0b\u540d\u8fd9\u4e2a\u547d\u4ee4\u67e5\u770b</p> <pre><code>./etcdctl get /coreos.com/network/config\n</code></pre>"},{"location":"02.enhancement/15-flannel-plugin/#4","title":"4. \u542f\u52a8\u670d\u52a1","text":"<pre><code># \u66f4\u65b0supervisor\nsupervisorctl update\n</code></pre>"},{"location":"02.enhancement/16-flannel-model/","title":"flannel\u6a21\u578b\u8bf4\u660e","text":""},{"location":"02.enhancement/16-flannel-model/#1flannel","title":"1.flannel\u56de\u987e","text":"<p>\u5728\u4e0a\u7bc7\u6587\u7ae0\uff0c\u6211\u4eec\u5df2\u7ecf\u5728\u4e24\u53f0\u4e3b\u673a\u4e0a\u5b89\u88c5\u597d\u4e86flannel\u7f51\u7edc\u63d2\u4ef6\uff0c\u5e76\u5b9e\u73b0\u4e86\u8de8\u4e3b\u673a\u8bbf\u95eedocker\u5bb9\u5668\u3002\u90a3\u4e48\u4e3a\u4ec0\u4e48\u80fd\u8fbe\u5230\u8fd9\u4e2a\u9700\u6c42\u5462\uff1f\u5b9e\u9645\u4e0aflannel\u5e2e\u6211\u4eec\u505a\u4e86IP\u9759\u6001\u8def\u7531\u3002</p> <p>\u5982\u679c\u6211\u4eec\u5728<code>kb21</code>\u8fd9\u53f0\u4e3b\u673a\u4e0a\u4f7f\u7528<code>route -n</code>\u547d\u4ee4\u67e5\u770b\u8def\u7531\u60c5\u51b5\uff0c\u53ef\u4ee5\u770b\u5230\u4ee5\u4e0b\u7684\u8fd9\u4e00\u6761</p> <pre><code>172.7.22.0      192.168.14.22   255.255.255.0   UG    0      0        0 eth1\n</code></pre> <p><code>172.7.22.0</code>\u8fd9\u4e2a\u7f51\u6bb5\u5e02<code>kb22</code>\u8fd9\u53f0\u4e3b\u673a\u4e0a\u7684docker\u5bb9\u5668\u7f51\u7edc\uff0c\u8fd9\u4e2a\u6211\u4eec\u5728\u524d\u51e0\u8282\u5b89\u88c5\u5bb9\u5668\u7684\u65f6\u5019\u5c31\u8bbe\u7f6e\u597d\u7684\uff0c\u5f53\u6211\u4eec\u8bbf\u95ee\u5230\u8fd9\u4e2a\u7f51\u6bb5\u7684\u65f6\u5019\uff0c\u5c06\u4f1a\u7edf\u4ed8\u54e6<code>192.168.14.22</code>\u8fd9\u4e2a\u7f51\u5173\uff0c\u5373<code>kb22</code>\u8fd9\u53f0\u4e3b\u673a\u3002</p> <p>\u540c\u7406\uff0c<code>172.7.21.0</code>\u8fd9\u4e2a\u7f51\u6bb5\u5e02<code>kb21</code>\u8fd9\u53f0\u4e3b\u673a\u4e0a\u7684docker\u5bb9\u5668\u7f51\u7edc\uff0c\u5f53\u6211\u4eec\u5728<code>kb22</code>\u8fd9\u53f0\u4e3b\u673a\u8bbf\u95ee\u8fd9\u4e2a\u7f51\u6bb5\uff0cflannel\u56de\u5c06ip\u8def\u7531\u5230<code>kb21</code>\u8fd9\u53f0\u4e3b\u673a\u3002</p> <p>\u7efc\u4e0a\uff0cflannel\u5b9e\u9645\u4e0a\u7ed9\u7ed9\u4e0d\u540c\u7684\u4e3b\u673a\u8bbe\u7f6e\u4e86\u4e00\u5957\u8def\u7531\u89c4\u5219\uff0c\u5c31\u8ba9\u96c6\u7fa4\u5b9e\u73b0\u4e86\u8de8\u4e3b\u673a\u8bbf\u95eedocker\u5bb9\u5668\u3002\u53ef\u4ee5\u770b\u5230flannel\u7684\u6846\u67b6\u56fe\u5982\u4e0b</p> <p></p> <p>\u8981\u6ce8\u610f\u7684\u662f\uff0cflannel\u7684host-gateway\u6a21\u578b\u6709\u4e2a\u91cd\u8981\u7684\u524d\u63d0\u6761\u4ef6\uff0c\u90a3\u5c31\u662f\u6240\u6709\u7684\u5bbf\u4e3b\u673a\u5fc5\u987b\u5c5e\u4e8e\u540c\u4e00\u4e2a\u4e8c\u5c42\u7f51\u7edc\u4e0b\uff0c\u4e5f\u5c31\u662f\u8bf4\u5b83\u4eec\u6307\u5411\u7684\u662f\u540c\u4e00\u4e2a\u7269\u7406\u7f51\u5173\u8bbe\u5907\uff0c\u8fd9\u6837\u6211\u4eec\u624d\u80fd\u901a\u8fc7\u7ef4\u62a4\u8def\u7531\u8868\u7684\u65b9\u5f0f\u8ba9\u4e0d\u540c\u4e3b\u673a\u5b9e\u73b0\u8de8\u4e3b\u673a\u8bbf\u95eedocker\u3002\u5b9e\u9645\u4e0a\uff0c\u5728k8s\u7f51\u7edc\u63d2\u4ef6\u7684\u591a\u4e2a\u6a21\u578b\u4e2d\uff0c<code>host-gw</code>\u6a21\u578b\u5e94\u8be5\u662f\u6548\u7387\u6700\u9ad8\u7684\uff0c\u56e0\u4e3a\u5b83\u5c31\u662f\u4e00\u4e2a\u7f51\u7edc\u8f6c\u53d1\u800c\u5df2\u3002</p> <p>\u5b9e\u9645\u4e0a\uff0c\u5982\u679c\u6211\u4eec\u4e0d\u4f7f\u7528flannel\uff0c\u6211\u4eec\u624b\u52a8\u5728<code>kb21</code>\u8fd9\u53f0\u4e3b\u673a\u4e0a\u6dfb\u52a0<code>172.7.21.0</code>\u7684\u9759\u6001\u8def\u7531\u5230<code>kb22</code>\u8fd9\u53f0\u4e3b\u673a\uff0c\u6211\u4eec\u540c\u6837\u53ef\u4ee5\u5728<code>kn21</code>\u8fd9\u53f0\u4e3b\u673a\u8bbf\u95ee\u5230<code>kb22</code>\u4e0a\u7684\u5bb9\u5668\u3002\u5982\u4e0b\u547d\u4ee4</p> <pre><code># \u505c\u6b62flannel\u670d\u52a1\uff0c\u5982\u679c\u53d1\u73b0\u505c\u6b62\u4e0d\u6210\u529f\uff0c\u518d\u4f7f\u7528kill\u6307\u4ee4\u505c\u6389\u5bf9\u5e94\u7684\u8fdb\u7a0b\nsupervisorctl stop flannel-21\n# \u5220\u9664flannel\u751f\u6210\u7684\u8def\u7531\nroute del -net 172.7.22.0/24 gw 192.168.14.22 eth1\n# \u518d\u81ea\u5df1\u624b\u52a8\u52a0\u4e0a\u8def\u7531\nroute add -net 172.7.22.0/24 gw 192.168.14.22 dev eth1\n</code></pre> <p>\u5728\u4ee5\u4e0a\u7684\u547d\u4ee4\u4e2d\uff0c\u5982\u679c\u6211\u4eec\u505c\u6b62\u4e86flannel\uff0c\u5e76\u5220\u9664\u4e86flannel\u751f\u6210\u7684\u5bf9\u5e94\u8def\u7531\uff0c\u90a3\u4e48\u6211\u4eec\u5c06\u4e0d\u518d\u80fd\u6210\u529f\u8bbf\u95ee\u5230<code>kb22</code>\u8fd9\u53f0\u4e3b\u673a\u4e0a\u7684\u5bb9\u5668\u3002\u5982\u679c\u6211\u4eec\u6700\u540e\u6dfb\u52a0\u8def\u7531\u89c4\u5219\u7684\u6307\u4ee4\uff0c\u6700\u540e\u53c8\u80fd\u6210\u529f\u8bbf\u95ee\u5230<code>kb22</code>\u8fd9\u53f0\u4e3b\u673a\u3002</p>"},{"location":"02.enhancement/16-flannel-model/#2-flannelvxlan","title":"2. flannel\u7684VxLAN\u6a21\u578b","text":"<p>\u6a21\u578b\u7b80\u4ecb</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u4ecb\u7ecdflannel\u7684\u53e6\u4e00\u4e2a\u7f51\u7edc\u6a21\u578b--VxLAN\uff0c\u8be5\u7f51\u7edc\u6a21\u578b\u67b6\u6784\u56fe\u5982\u4e0b\u6240\u793a</p> <p></p> <p>\u5728\u8fd9\u4e2a\u7f51\u7edc\u67b6\u6784\u56fe\u4e2d\uff0c\u4e0d\u540c\u7684\u4e3b\u673a\u53ef\u80fd\u5c5e\u4e8e\u4e0d\u540c\u7684\u4e8c\u5c42\u7f51\u7edc\u4e0b\uff0c\u5b83\u4eec\u6709\u4e0d\u540c\u7684\u7269\u7406\u7f51\u5173\u8bbe\u5907\u3002\u901a\u8fc7\u8fd9\u4e2a\u6a21\u578b\uff0cflannel\u5c06\u4f1a\u5728\u6bcf\u4e2a\u7684\u96c6\u7fa4\u8282\u70b9\u4e0a\u865a\u62df\u51fa\u4e00\u4e2a\u7f51\u7edc\u8bbe\u7f6e\uff0c\u8fd9\u4e2a\u865a\u62df\u7684\u7f51\u5361\u53eb\u505a<code>flannel.1</code>\uff0c\u90a3\u4e48\u5728\u4e0d\u540c\u4e3b\u673a\u4e0a\u8bbf\u95ee\u5176\u4ed6\u4e3b\u673a\u7684docker\u5bb9\u5668\u7f51\u7edc\uff0c\u5c06\u4f1a\u901a\u8fc7\u8fd9\u4e2aflannel\u7684\u865a\u62df\u7f51\u7edc\u96a7\u9053\u8fdb\u884c\u6570\u636e\u4f20\u9001\u3002</p> <p>\u542f\u7528VxLAN\u6a21\u578b</p> <p>\u6211\u4eec\u5148\u5728\u628a<code>kb21</code>\u548c<code>kb22</code>\u8fd9\u4e24\u53f0\u4e3b\u673a\u7684flannel\u505c\u6b62\u6389\uff0c\u5e76\u4e14\u5220\u9664\u5bf9\u5e94\u7684\u8def\u7531\u89c4\u5219\uff0c\u4ee5<code>kb21</code> \u4e3a\u4f8b\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code># \u505c\u6b62\u670d\u52a1\uff0c\u5982\u679c\u53d1\u73b0\u505c\u6b62\u4e0d\u6210\u529f\uff0c\u518d\u4f7f\u7528kill\u6307\u4ee4\u505c\u6389\u5bf9\u5e94\u7684\u8fdb\u7a0b\nsupervisorctl stop flannel-21\n# \u5220\u9664\u8def\u7531\nroute del -net 172.7.22.0/24 gw 192.168.14.22 eth1\n</code></pre> <p>\u8fdb\u5165\u5230etcd\u7684\u5b89\u88c5\u76ee\u5f55\uff0c\u5220\u9664etcd\u96c6\u7fa4\u4e2d\u7684\u539f\u6709flannel\u914d\u7f6e\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>./etcdctl rm /coreos.com/network/config\n</code></pre> <p>\u8bbe\u7f6e flannel\u65b0\u7684\u7f51\u7edc\u6a21\u578b\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>./etcdctl set /coreos.com/network/config '{\"Network\":\"172.7.0.0/16\",\"Backend\":{\"Type\":\"VxLAN\"}}'\n</code></pre> <p>\u8bbe\u7f6e\u597d\u65b0\u7684\u7c7b\u578b\u4e4b\u540e\uff0c\u518d\u542f\u52a8flannel\uff0c\u4ee5<code>kb21</code>\u4e3a\u4f8b\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>supervisorctl start flannel-21\n</code></pre> <p>\u542f\u52a8\u670d\u52a1\u4e4b\u540e\uff0c\u6211\u4eec\u4f7f\u7528<code>ifconfig</code>\u67e5\u770b\u7f51\u5361\u4fe1\u606f\uff0c\u53ef\u4ee5\u770b\u5230\u591a\u51fa\u4e86\u4e00\u4e2a\u540d\u4e3a<code>flannel.1</code>\u7684\u865a\u62df\u7f51\u5361\uff0c\u518d\u6b21\u8bbf\u95ee\u5176\u4ed6\u4e3b\u673a\u7684docker\u5bb9\u5668IP\uff0c\u5982\u679c\u80fd\u6b63\u5e38\u8bbf\u95ee\uff0c\u4ee3\u8868\u670d\u52a1\u5df2\u7ecf\u6b63\u5e38\u8fd0\u884c\u4e86\u3002\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5982\u679c\u6211\u4eec\u9700\u8981\u9a8c\u8bc1\u901a\u8fc7flannel\u7684VxLAN\u6a21\u578b\u5728<code>kb21</code>\u8fd9\u53f0\u4e3b\u673a\u53bb\u8bbf\u95ee<code>kb22</code>\u8fd9\u53f0\u4e3b\u673a\u7684\u5bb9\u5668\uff0c\u8fd9\u4e24\u53f0\u4e3b\u673a\u5fc5\u987b\u540c\u65f6\u8fd0\u884cflannel\u5e76\u4fdd\u8bc1\u5176\u6b63\u5e38\u63d0\u4f9b\u670d\u52a1\uff0c\u53ea\u6709\u5982\u6b64\u624d\u80fd\u4fdd\u8bc1\u4e24\u4e2a\u865a\u62df\u7f51\u7edc\u80fd\u901a\u8fc7flannel\u8054\u901a\u3002</p>"},{"location":"02.enhancement/16-flannel-model/#3-vxlan","title":"3. VxLAN\u4e0e\u76f4\u63a5\u8def\u7531\u6df7\u5408\u6a21\u578b","text":"<p>\u5728\u4e0a\u9762\u7684VxLAN\u6a21\u578b\u4e2d\u5b58\u5728\u4e00\u4e2a\u660e\u663e\u7684\u7f3a\u70b9\uff0c\u90a3\u5c31\u662f\u5373\u4f7f\u4e24\u53f0\u4e3b\u673a\u5728\u4e00\u4e2a\u7269\u7406\u7f51\u5173\u4e4b\u4e0b\uff0c\u8fd8\u901a\u8fc7flannel\u7684\u865a\u62df\u7f51\u7edc\u53bb\u8bbf\u95ee\u53e6\u4e00\u53f0\u4e3b\u673a\u7684\u5bb9\u5668\uff0c\u663e\u7136\u6548\u7387\u4f1a\u5927\u6253\u6298\u6263\u3002\u6211\u4eec\u5e0c\u671b\u5728\u540c\u4e00\u4e2a\u7f51\u5173\u4e0b\uff0c\u4e0d\u540c\u4e3b\u673a\u4e4b\u95f4\u7684\u4e92\u76f8\u8bbf\u95ee\u5bf9\u65b9\u7684\u5bb9\u5668\uff0c\u80fd\u76f4\u63a5\u8def\u7531\uff0c\u8fd9\u5c31\u662fVxLAN\u4e0e\u76f4\u63a5\u8def\u7531\u6df7\u5408\u6a21\u578b\u3002\u6211\u4eec\u53ea\u9700\u8981\u5728VxLAN\u6a21\u578b\u7684\u914d\u7f6e\u4e0a\u52a0\u4e00\u4e2a<code>Directrouting</code>\u53c2\u6570\u5373\u53ef\u5b9e\u73b0\u3002\u5982\u4e0b</p> <pre><code>{\"Network\":\"172.7.0.0/16\",\"Backend\":{\"Type\":\"VxLAN\",\"Directrouting\":true}}\n</code></pre> <p>\u6211\u4eec\u53ea\u9700\u5c06etcd\u4e2d\u7684<code>/coreos.com/network/config</code>\u952e\u8bbe\u7f6e\u4e3a\u5982\u4e0a\u503c\uff0c\u5e76\u5728\u6240\u6709\u8282\u70b9\u91cd\u542fflannel\uff0c\u5373\u53ef\u5b9e\u73b0VxLAN\u4e0e\u76f4\u63a5\u8def\u7531\u6df7\u5408\u6a21\u578b\u3002\u542f\u7528\u8be5\u6a21\u578b\u4e4b\u540e\uff0cflannel\u4f1a\u9ed8\u8ba4\u4f7f\u7528VxLAN\u6a21\u578b\uff0c\u4f46\u662f\u5982\u679c flannel\u53d1\u73b0\u4e24\u53f0\u4e3b\u673a\u5728\u540c\u4e00\u4e2a\u7269\u7406\u7f51\u5173\u4e0b\uff0cflannel\u76f4\u63a5\u4f7f\u7528<code>host-gw</code>\u6a21\u578b\u3002</p>"},{"location":"02.enhancement/17-flannel-optimize/","title":"flannel\u4f18\u5316","text":""},{"location":"02.enhancement/17-flannel-optimize/#1","title":"1. \u9700\u4f18\u5316\u7684\u539f\u56e0","text":"<p>\u5728\u6211\u8fd0\u884c\u670d\u52a1\u7684\u65f6\u5019\uff0c<code>kb22</code>\u8fd9\u53f0\u4e3b\u673a\u4e0a\u542f\u52a8\u4e86\u4e00\u4e2a\u540d\u79f0<code>nginx-dp-f585689bf-649n7</code>\u7684pod\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u76d1\u63a7\u5b83\u7684\u65e5\u5fd7\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>kubectl logs nginx-dp-f585689bf-649n7 -n kube-public\n</code></pre> <p>\u5728<code>kb21</code>\u8fd9\u53f0\u4e3b\u673a\u542f\u52a8\u4e86\u540d\u79f0<code>nginx-dp-f585689bf-649n7</code>\u7684pod\uff0c\u6211\u4eec\u8fdb\u53bb\u8fdb\u5165\u5bb9\u5668 <pre><code>kubectl exec -it nginx-dp-f585689bf-649n7 sh -n kube-public\n</code></pre></p> <p>\u5728\u5bb9\u5668\u91cc\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u8bf7\u6c42<code>kb22</code>\u4e0a\u7684\u5bb9\u5668</p> <pre><code>curl 172.7.22.2\n</code></pre> <p>\u4f46\u6211\u4eec\u5728<code>kb22</code>\u7684\u5bb9\u5668\u4e0a\u770b\u5230\u7684\u8bf7\u6c42\u65e5\u5fd7\uff0c\u6765\u6e90\u5730\u5740\u662f<code>kb21</code>\u8fd9\u53f0\u5bbf\u4e3b\u673a\u7684IP\uff0c\u539f\u56e0\u662fdocker\u5728\u8bbf\u95ee\u5176\u4ed6IP\u65f6\uff0c\u505a\u4e86SNAT\u6e90\u5730\u5740\u8f6c\u6362\uff0c\u4f7f\u7528\u5176\u5bbf\u4e3b\u673aIP\u53bb\u8bbf\u95ee\u5176\u4ed6IP\u3002\u800c\u5b9e\u9645\u4e0a\uff0c\u6211\u4eec\u5e0c\u671b\u770b\u5230\u5bb9\u5668\u7684IP\uff0c\u5e76\u4e14\u5728\u96c6\u7fa4\u4e2d\uff0c\u4e5f\u5fc5\u987b\u662f\u5bb9\u5668IP\u3002</p> <p>\u5728<code>kb21</code>\u8fd9\u53f0\u4e3b\u673a\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528<code>iptables-save</code>\u6307\u4ee4\u53ef\u4ee5\u5c06\u5185\u6838\u4e2d\u5f53\u524d\u7684iptables\u914d\u7f6e\u5bfc\u51fa\u5230\u6807\u51c6\u8f93\u51fa\u3002SNET\u8f6c\u6362\u662f\u5728iptables\u7684<code>net</code>\u8868\u7684<code>postrouting</code>\u4e0a\u505a\u7684\u3002\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u67e5\u770b\u5230\u76f8\u5173\u4fe1\u606f</p> <pre><code>iptables-save | grep -i postrouting\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u8fd4\u56de\u5982\u4e0b\u5185\u5bb9</p> <pre><code>:POSTROUTING ACCEPT [0:0]\n:KUBE-POSTROUTING - [0:0]\n-A POSTROUTING -s 172.7.21.0/24 ! -o docker0 -j MASQUERADE\n-A POSTROUTING -m comment --comment \"kubernetes postrouting rules\" -j KUBE-POSTROUTING\n-A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE\n-A KUBE-POSTROUTING -m comment --comment \"kubernetes service traffic requiring SNAT\" -m mark --mark 0x4000/0x4000 -j MASQUERADE\n-A KUBE-POSTROUTING -m comment --comment \"Kubernetes endpoints dst ip:port, source ip for solving hairpin purpose\" -m set --match-set KUBE-LOOP-BACK dst,dst,src -j MASQUERADE\n</code></pre> <p>\u4ece\u4ee5\u4e0a\u4fe1\u606f\u53ef\u4ee5\u770b\u51fa</p> <ul> <li>\u6765\u6e90\u5730\u5740<code>172.7.21.0/24</code>\uff0c\u5982\u679c\u51fa\u7f51\u4e0d\u662f<code>docker0</code>\u8fd9\u4e2a\u7f51\u5361\uff0c\u5c06\u505a\u539f\u5730\u5740NAT\u8f6c\u6362</li> <li>\u6765\u6e90\u5730\u5740<code>172.17.0.0/16</code>\uff0c\u5982\u679c\u51fa\u7f51\u4e0d\u662f<code>docker0</code>\u8fd9\u4e2a\u7f51\u5361\uff0c\u5c06\u505a\u539f\u5730\u5740NAT\u8f6c\u6362</li> </ul> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u4ee5\u4e0a\u4e24\u4e2aIP\u6bb5\uff0c\u5728\u8bbf\u95ee\u5916\u7f51\u7684\u65f6\u5019\uff0c\u90a3\u4e48\u539f\u5730\u5740\u4e00\u5b9a\u4f1a\u88abNAT\u8f6c\u6362\uff0c\u4e5f\u5c31\u662f\u8bf4\u4f1a\u4ee5\u5bbf\u4e3b\u673a\u7684\u7f51\u7edcIP\u8bbf\u95ee\u5916\u7f51\u3002</p> <p>\u5728docker\u96c6\u7fa4\u4e2d\uff0c\u8fd9\u6837\u7684\u914d\u7f6e\u663e\u7136\u662f\u4e0d\u5bf9\u7684\uff0c\u6211\u4eec\u5e0c\u671bdocker\u8bbf\u95ee\u5176\u4ed6\u4e3b\u673a\u7684docker\u65f6\uff0c\u4e5f\u4e0d\u8981\u8fdb\u884cNAT\u7f51\u7edc\u8f6c\u6362\u3002\u5728\u6211\u4eec\u8fd9\u4e2a\u96c6\u7fa4\u4e2d\uff0c\u4e5f\u5c31\u662f\u5e0c\u671b<code>172.7.0.0/16</code>\u8fd9\u4e2a\u7f51\u6bb5\u4e0d\u88abNAT\u5730\u5740\u8f6c\u6362\u3002</p>"},{"location":"02.enhancement/17-flannel-optimize/#2","title":"2. \u4f18\u5316\u8fc7\u7a0b","text":"<p>\u5b89\u88c5iptables</p> <p>\u6211\u4eec\u9700\u8981\u5728\u6240\u6709<code>kb21</code>\u548c<code>kb22</code>\u6267\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff0c\u5148\u5b89\u88c5<code>iptables-services</code>\u8fd9\u4e2a\u7ec4\u4ef6\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>yum install -y iptables-services\n</code></pre> <p>\u88c5\u4e0a<code>iptables-services</code>\u4e4b\u540e\u4e5f\u4f1a\u9ed8\u8ba4\u5c06<code>iptables</code>\u88c5\u4e0a\uff0c\u6211\u4eec\u5c06\u542f\u52a8<code>iptables</code>\u5e76\u8bbe\u7f6e\u4e3a\u5f00\u673a\u81ea\u542f\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code># \u542f\u52a8iptables\nsystemctl start iptables\n# \u8bbe\u7f6e\u670d\u52a1\u4e3a\u5f00\u673a\u81ea\u542f\nsystemctl enable iptables\n</code></pre> <p>\u5220\u9664\u9ed8\u8ba4\u7684\u89c4\u5219</p> <p>iptables\u9ed8\u8ba4\u7684\u89c4\u5219\u6bd4\u8f83\u4e25\u683c\uff0c\u6211\u4eec\u9700\u8981\u5220\u9664\u9ed8\u8ba4\u7684\u89c4\u5219\uff0c\u6211\u4eec\u5148\u653e\u901a\u6240\u6709\u7f51\u7edc</p> <pre><code># \u653e\u901a\u6240\u6709\u7f51\u7edc\niptables -P INPUT ACCEPT\niptables -P FORWARD ACCEPT\niptables -P OUTPUT ACCEPT\niptables -F\n# \u5199\u5165\u5230\u7cfb\u7edf\u914d\u7f6e\u4e2d\niptables-save &gt; /etc/sysconfig/iptables\n</code></pre> <p>\u5220\u9664\u6389\u89c4\u5219\uff0c\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4</p> <p>\u4f18\u5316\u89c4\u5219</p> <p>\u57281\u4e2d\uff0c\u4ee5<code>kb21</code>\u8fd9\u53f0\u4e3b\u673a\u4e3a\u4f8b\uff0c\u6211\u4eec\u770b\u5230\u6709\u4e24\u4e2a\u7f51\u6bb5\u5728\u8bbf\u95ee\u5916\u7f51\u65f6\u4f1a\u88abNAT\u8f6c\u6362\uff0c\u4e00\u662f<code>172.17.0.0/16</code>\uff0c\u8fd9\u662fdocker\u7684\u5bb9\u5668\u9ed8\u8ba4\u7f51\u6bb5\uff0c\u53e6\u5916\u662f<code>172.7.21.0/24</code>\uff0c\u8fd9\u4e2a\u6211\u4eec\u8bbe\u7f6e\u7684\u5728<code>kb21</code>\u8fd9\u53f0\u4e3b\u673a\u4e0a\u5bb9\u5668\u542f\u52a8\u9ed8\u8ba4\u7684\u7f51\u6bb5\u3002\u6240\u4ee5\uff0c\u6211\u4eec\u53ea\u9700\u8981\u4f18\u5316<code>172.7.21.0/24</code>\u8fd9\u4e2a\u7f51\u6bb5\u5c31\u53ef\u4ee5\u4e86\u3002\u6211\u4eec\u5148\u5220\u9664SANT\u8f6c\u6362\u89c4\u5219\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>iptables -t nat -D POSTROUTING -s 172.7.21.0/24 ! -o docker0 -j MASQUERADE\n</code></pre> <p>\u518d\u6dfb\u52a0\u4ee5\u4e0b\u89c4\u5219</p> <pre><code>iptables -t nat -I POSTROUTING -s 172.7.21.0/24 ! -d 172.7.0.0/16 ! -o docker0 -j MASQUERADE\n</code></pre> <p>\u6dfb\u52a0\u7684\u89c4\u5219\u4ee3\u8868\u7684\u662f\uff1a\u518d\u672c\u673a\u4e0a\uff0c\u9488\u5bf9\u6e90\u5730\u5740\u4e3a<code>172.7.21.0/24</code>\u7684\u7f51\u6bb5\uff0c\u8bbf\u95ee\u5730\u5740\u4e0d\u662f<code>172.7.0.0/16</code>\u7f51\u6bb5\u65f6\uff08\u8be5\u7f51\u6bb5\u662f\u96c6\u7fa4\u4e2ddocker\u5bb9\u5668\u7684\u7f51\u6bb5\uff09\uff0c\u5e76\u4e14\u51fa\u53e3\u7f51\u5361\u4e0d\u662f<code>docker0</code>\uff0c\u624d\u4f1a\u8fdb\u884cSNAT\u7f51\u7edc\u8f6c\u6362\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5982\u679c\u6211\u4eec\u5728<code>kb21</code>\u8fd9\u53f0\u4e3b\u673a\u4e0a\u8bbf\u95ee\u5176\u4ed6\u4e3b\u673a\u7684\u5bb9\u5668IP\uff0c\u4e0d\u4f1a\u8fdb\u884cSNAT\u7f51\u7edc\u8f6c\u6362\u3002\u8bbf\u95ee\u5916\u7f51\u5982**\u767e\u5ea6\u7684IP**\u624d\u4f1a\u8fdb\u884c\u7f51\u7edc\u8f6c\u6362\u3002</p> <p>\u6267\u884c\u4ee5\u4e0a\u64cd\u4f5c\u4e4b\u540e\uff0c\u5bb9\u5668\u4e4b\u95f4\u7684\u7f51\u7edc\u901a\u4fe1\u5c31\u662f\u5bb9\u5668\u7684\u771f\u5b9eIP\u4e86\u3002</p>"},{"location":"02.enhancement/18-coredns/","title":"coredns","text":""},{"location":"02.enhancement/18-coredns/#1","title":"1. \u6982\u8ff0","text":"<p>\u7b80\u5355\u6765\u8bf4\uff0c\u670d\u52a1\u53d1\u73b0\u5c31\u662f\u670d\u52a1\uff08\u5e94\u7528\uff09\u4e4b\u95f4\u76f8\u4e92\u5b9a\u4f4d\u7684\u8fc7\u7a0b\u3002</p> <p>\u670d\u52a1\u53d1\u73b0\u5e76\u975e\u4e91\u8ba1\u7b97\u65f6\u4ee3\u72ec\u6709\uff0c\u4f20\u7edf\u7684\u5355\u67b6\u6784\u65f6\u4ee3\u4e5f\u4f1a\u7528\u5230\u3002\u5728\u4ee5\u4e0b\u5e94\u7528\u573a\u666f\u4e0b\uff0c\u66f4\u9700\u8981\u670d\u52a1\u53d1\u73b0</p> <ul> <li> <p>\u670d\u52a1\uff08\u5e94\u7528\uff09\u7684\u52a8\u6001\u6027\u5f3a</p> </li> <li> <p>\u670d\u52a1\uff08\u5e94\u7528\uff09\u66f4\u65b0\u53d1\u5e03\u9891\u7e41</p> </li> <li> <p>\u670d\u52a1\uff08\u5e94\u7528\uff09\u652f\u6301\u81ea\u52a8\u4f38\u7f29</p> </li> </ul> <p>\u5728\u8de8k8s\u96c6\u7fa4\u91cc\uff0cpod\u7684IP\u662f\u4e0d\u6bb5\u53d8\u5316\u7684\uff0c\u5982\u4f55\u201c\u4ee5\u4e0d\u53d8\u5e94\u4e07\u53d8\u201d\u5462\uff1f</p> <ul> <li>\u5728k8s\u91cc\uff0c\u62bd\u8c61\u51fa\u4e86Service\u8d44\u6e90\uff0c\u901a\u8fc7\u6807\u7b7e\u9009\u62e9\u5668\uff0c\u5173\u8054\u4e00\u7ec4Pod</li> <li>\u62bd\u8c61\u51fa\u4e86\u96c6\u7fa4\u7f51\u7edc\uff0c\u901a\u8fc7\u76f8\u5bf9\u56fa\u5b9a\u7684\u201c\u96c6\u7fa4IP\u201d\uff0c\u4f7f\u670d\u52a1\u63a5\u5165\u70b9\u56fa\u5b9a</li> </ul> <p>\u90a3\u4e48\u5982\u4f55\u81ea\u52a8\u5173\u8054Service\u8d44\u6e90\u7684\u201c\u540d\u79f0\u201d\u548c\u201c\u96c6\u7fa4\u7f51\u7edcIP\u201d\uff0c\u4ece\u800c\u8fbe\u5230\u670d\u52a1\u88ab\u96c6\u7fa4\u81ea\u52a8\u53d1\u73b0\u7684\u76ee\u7684\u5462\uff1f</p> <p>\u5728\u4f20\u7edf\u7684DNS\u6a21\u578b\u91cc\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7<code>hdss7-21.host.com</code>\u89e3\u6790\u9053<code>192.168.14.21</code>\uff0c\u5b9e\u9645\u4e0a\uff0c\u5728\u96c6\u7fa4\u91cc\u6211\u4eec\u4e5f\u53ef\u4ee5\u5efa\u7acb\u7c7b\u4f3c\u7684\u6a21\u578b\uff0c\u8ba9 <code>nginx-ds</code>\u81ea\u52a8\u5173\u8054\u5230\u4e00\u4e2a\u865a\u62df\u7684Service IP\u3002\u5728k8s\u91cc\uff0c\u5b9e\u73b0\u670d\u52a1\u53d1\u73b0\u7684\u65b9\u5f0f\u5c31\u662f\u901a\u8fc7DNS\u3002\u4ee5\u4e0b\u5de5\u5177\u53ef\u4ee5\u5b9e\u73b0k8s\u7684dns\u670d\u52a1</p> <p><code>kube-dns</code>: kubernetes-v1.2\u81f3kubernetes-v1.10 <code>coredns</code>: kubernetes-v1.11\u81f3\u4eca</p> <p>\u4e0d\u8fc7\u8981\u6ce8\u610f\u7684\u662f\uff0ck8s\u91cc\u7684dns\u4e0d\u662f\u4e07\u80fd\u7684\uff01\u5b83\u53ea\u8d1f\u8d23\u81ea\u52a8\u7ef4\u62a4\u201c\u670d\u52a1\u540d\u201d\u548c\u201c\u96c6\u7fa4\u7f51\u7edcIP\u201d\u4e4b\u95f4\u7684\u5173\u7cfb\u3002\u5728\u672c\u6587\uff0c\u6211\u4eec\u5c06\u4f7f\u7528coredns\u5b9e\u73b0\u670d\u52a1\u7684\u53d1\u73b0\u7684\u8fc7\u7a0b\u3002\u5728\u4e0b\u6587\u4e2d\uff0c\u6211\u4eec\u5c06\u4ee5k8s\u8d44\u6e90\u7684\u5f62\u5f0f\uff0c\u6765\u642d\u5efacoredns\u670d\u52a1\u3002</p>"},{"location":"02.enhancement/18-coredns/#2-yamlhttp","title":"2. \u642d\u5efayaml\u914d\u7f6e\u6587\u4ef6\u7684http\u670d\u52a1","text":"<p>\u642d\u5efahttp\u670d\u52a1</p> <p>\u4e3a\u4e86\u66f4\u597d\u7684\u590d\u7528yaml\u914d\u7f6e\u6587\u4ef6\uff0c\u6211\u4eec\u5728<code>kb200</code>\u8fd9\u53f0\u4e3b\u673a\u4e0a\u914d\u7f6e\u4e00\u4e2ayaml\u6587\u4ef6\u7684\u5728\u7ebfhttp\u670d\u52a1\u3002\u521b\u5efanginx\u914d\u7f6e\u6587\u4ef6<code>/etc/nginx/conf.d/k8s-yaml.od.com.conf</code>\uff0c\u5e76\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>server {\nlisten 80;\nserver_name k8s-yaml.od.com\n\nlocation / {\nautoindex on;\ndefault_type text/plain;\nroot /data/k8s-yaml;\n}\n}\n</code></pre> <p>\u91cd\u65b0\u52a0\u8f7dnginx</p> <pre><code>nginx -s reload\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u56de\u5230<code>kb11</code>\u8fd9\u53f0\u4e3b\u673a\u4e0a\uff0c\u6dfb\u52a0\u4e00\u6761\u89e3\u6790\uff0c\u4fee\u6539dns\u914d\u7f6e\u6587\u4ef6<code>/var/named/od.com.zone</code>\uff0c\u5982\u4e0b\u5185\u5bb9</p> <pre><code>$ORIGIN od.com.\n$TTL 600 ; 10 minutes\n@ IN SOA dns.od.com. dnsadmin.od.com. (\n2022012005 ; serial\n    10800      ; refresh (3 hours)\n900        ; retry (15 minutes)\n604800     ; expire (1 week)\n86400      ; minium (1 day)\n) NS dns.od.com.\n\n$TTL 60    ;   1 minute\ndns    A   192.168.14.11\nharbor    A   192.168.14.200\nk8s-yaml    A   192.168.14.200\n</code></pre> <p>\u4fee\u6539\u7684\u5185\u5bb9\u4e3a</p> <ul> <li><code>2022012005 ; serial</code> : \u589e\u52a0\u5e8f\u5217\u53f7 </li> <li><code>k8s-yaml    A   192.168.14.200</code> : \u6dfb\u52a0A\u8bb0\u5f55\uff0c\u5c06<code>k8s-yaml</code>\u89e3\u6790\u5230<code>192.168.14.200</code>\uff0c\u5373\u89e3\u6790\u5230\u8fd0\u7ef4\u4e3b\u673a\u4e0a</li> </ul> <p>\u91cd\u542f\u57df\u540d\u89e3\u6790\u670d\u52a1</p> <pre><code>systemctl restart named\n</code></pre> <p>\u5728\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u68c0\u67e5\u662f\u5426\u5df2\u7ecf\u6b63\u5e38\u89e3\u6790</p> <pre><code>dig -t A k8s-yaml.od.com @192.168.14.11 +short\n</code></pre> <p>\u5982\u679c\u6709\u8fd4\u56de\uff0c\u5219\u4ee3\u8868\u5df2\u7ecf\u8bbe\u7f6e\u6210\u529f\u3002</p> <p>\u521b\u5efacoredns\u7684\u8d44\u6e90\u914d\u7f6e\u6e05\u5355</p> <p>\u56de\u5230<code>kb200</code>\u8fd9\u53f0\u4e3b\u673a\uff0c\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u521b\u5efacoredns\u914d\u7f6e\u6e05\u5355\u7684\u76ee\u5f55</p> <pre><code>mkdir -p /data/k8s-yaml/coredns\n</code></pre> <p>\u521b\u5efacoredns\u7684\u8d44\u6e90\u914d\u7f6e\u6e05\u5355<code>/data/k8s-yaml/coredns/rbac.yaml</code></p> <pre><code>apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: coredns\n  namespace: kube-system\n  labels:\n      kubernetes.io/cluster-service: \"true\"\naddonmanager.kubernetes.io/mode: Reconcile\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  labels:\n    kubernetes.io/bootstrapping: rbac-defaults\n    addonmanager.kubernetes.io/mode: Reconcile\n  name: system:coredns\nrules:\n- apiGroups:\n  - \"\"\nresources:\n  - endpoints\n  - services\n  - pods\n  - namespaces\n  verbs:\n  - list\n  - watch\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  annotations:\n    rbac.authorization.kubernetes.io/autoupdate: \"true\"\nlabels:\n    kubernetes.io/bootstrapping: rbac-defaults\n    addonmanager.kubernetes.io/mode: EnsureExists\n  name: system:coredns\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: system:coredns\nsubjects:\n- kind: ServiceAccount\n  name: coredns\n  namespace: kube-system\n</code></pre> <p>\u521b\u5efaconfigmap\u914d\u7f6e\u6e05\u5355<code>/data/k8s-yaml/coredns/cm.yaml</code></p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: coredns\n  namespace: kube-system\ndata:\n  Corefile: |\n.:53 {\nerrors\n        log\n        health\n        ready\n        kubernetes cluster.local 192.168.0.0/16  #service\u8d44\u6e90cluster\u5730\u5740\nforward . 192.168.14.11   #\u4e0a\u7ea7DNS\u5730\u5740\ncache 30\nloop\n        reload\n        loadbalance\n       }\n</code></pre> <p>\u521b\u5efadepoly\u63a7\u5236\u5668\u6e05\u5355<code>/data/k8s-yaml/coredns/dp.yaml</code></p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: coredns\n  namespace: kube-system\n  labels:\n    k8s-app: coredns\n    kubernetes.io/name: \"CoreDNS\"\nspec:\n  replicas: 1\nselector:\n    matchLabels:\n      k8s-app: coredns\n  template:\n    metadata:\n      labels:\n        k8s-app: coredns\n    spec:\n      priorityClassName: system-cluster-critical\n      serviceAccountName: coredns\n      containers:\n      - name: coredns\n        image: coredns/coredns:1.6.1\n        args:\n        - -conf\n        - /etc/coredns/Corefile\n        volumeMounts:\n        - name: config-volume\n          mountPath: /etc/coredns\n        ports:\n        - containerPort: 53\nname: dns\n          protocol: UDP\n        - containerPort: 53\nname: dns-tcp\n          protocol: TCP\n        - containerPort: 9153\nname: metrics\n          protocol: TCP\n        livenessProbe:\n          httpGet:\n            path: /health\n            port: 8080\nscheme: HTTP\n          initialDelaySeconds: 60\ntimeoutSeconds: 5\nsuccessThreshold: 1\nfailureThreshold: 5\ndnsPolicy: Default\n      volumes:\n        - name: config-volume\n          configMap:\n            name: coredns\n            items:\n            - key: Corefile\n              path: Corefile\n</code></pre> <p>\u521b\u5efaservice\u8d44\u6e90\u6e05\u5355<code>/data/k8s-yaml/coredns/svc.yaml</code></p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: coredns\n  namespace: kube-system\n  labels:\n    k8s-app: coredns\n    kubernetes.io/cluster-service: \"true\"\nkubernetes.io/name: \"CoreDNS\"\nspec:\n  selector:\n    k8s-app: coredns\n  clusterIP: 192.168.0.2\n  ports:\n  - name: dns\n    port: 53\nprotocol: UDP\n  - name: dns-tcp\n    port: 53\n- name: metrics\n    port: 9153\nprotocol: TCP\n</code></pre>"},{"location":"02.enhancement/18-coredns/#3-coredns","title":"3. \u542f\u52a8coredns\u670d\u52a1","text":"<p>\u6211\u4eec\u518d\u56de\u5230<code>kb21</code>\u8fd9\u53f0\u96c6\u7fa4\u8282\u70b9\u4e3b\u673a\u4e0a\uff0c\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5c06\u8d44\u6e90\u6328\u4e2a\u521b\u5efa\u51fa\u6765</p> <pre><code>kubectl create -f http://k8s-yaml.od.com/coredns/rbac.yaml\nkubectl create -f http://k8s-yaml.od.com/coredns/cm.yaml\nkubectl create -f http://k8s-yaml.od.com/coredns/dp.yaml\nkubectl create -f http://k8s-yaml.od.com/coredns/svc.yaml\n</code></pre> <p>\u9a8c\u8bc1\u670d\u52a1</p> <pre><code># \u67e5\u770b\u6240\u6709\u8d44\u6e90\nkubectl get all -n kube-system\n# \u67e5\u770bkube-system\u540d\u79f0\u7a7a\u95f4\u7684\u8d44\u6e90\nkubectl get svc -o wide -n kube-system\n</code></pre> <p>\u9a8c\u8bc1\u57df\u540d\u89e3\u6790</p> <pre><code># \u9a8c\u8bc1\u516c\u7f51\u89e3\u6790\ndig -t A www.baidu.com @192.168.0.2 +short\n# \u9a8c\u8bc1\u81ea\u5efa\u89e3\u6790\ndig -t A harbor.od.com @192.168.0.2 +short\n</code></pre> <p>coredns\u5df2\u7ecf\u80fd\u89e3\u6790\u5916\u7f51\u57df\u540d\u4e86\uff0c\u5728coredns\u7684\u914d\u7f6e\u4e2d\uff0c\u6211\u4eec\u5199\u4e86\u4ed6\u7684\u4e0a\u7ea7DNS\u4e3a<code>192.168.14.11</code>\uff0c\u5982\u679c\u5b83\u81ea\u5df1\u89e3\u6790\u4e0d\u51fa\u6765\u57df\u540d\uff0c\u4f1a\u901a\u8fc7\u9012\u5f52\u67e5\u8be2\u4e00\u7ea7\u7ea7\u67e5\u627e\u3002 \u4f46\u8981\u6ce8\u610f\u7684\u662f\uff0ccoredns\u6211\u4eec\u4e0d\u662f\u7528\u6765\u505a\u5916\u7f51\u89e3\u6790\u7684\uff0c\u800c\u662f\u7528\u6765\u505aservice\u540d\u548cserviceIP\u7684\u89e3\u6790</p>"},{"location":"02.enhancement/18-coredns/#4","title":"4. \u9a8c\u8bc1\u670d\u52a1","text":"<p>\u6211\u4eec\u5148\u5c06\u96c6\u7fa4\u4e2d\u81ea\u5df1\u521b\u5efa\u7684pod\u90fd\u5220\u9664\u6389\uff0c\u518d\u91cd\u65b0\u521b\u5efa\u4e00\u4e2a<code>deployment</code>\u7c7b\u578b\u7684pod</p> <pre><code>kubectl create deployment nginx-dp --image=nginx -n kube-public\n</code></pre> <p>\u7ed9pod\u521b\u5efa\u4e00\u4e2aservice</p> <pre><code>kubectl expose deployment nginx-dp --port=80 -n kube-public\n</code></pre> <p>\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u67e5\u770b\u6211\u4eec\u521b\u5efa\u7684service</p> <pre><code>kubectl get svc -n kube-public\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u7684\u8fd4\u56de\u5185\u5bb9</p> <pre><code>[root@kb21 vagrant]# kubectl get svc -n kube-public\nNAME       TYPE        CLUSTER-IP        EXTERNAL-IP   PORT(S)   AGE\nnginx-dp   ClusterIP   192.168.163.187   &lt;none&gt;        80/TCP    29h\n</code></pre> <p>\u6211\u4eec\u5148\u4f7f\u7528<code>dig -t A nginx-dp @192.168.0.2 +short</code>\u547d\u4ee4\u8fdb\u884c\u9a8c\u8bc1\uff0c\u53d1\u73b0\u65e0\u8fd4\u56de\u6570\u636e\uff0c\u5176\u5b9e\u662f\u9700\u8981service\u7684\u5b8c\u6574\u57df\u540d:<code>\u670d\u52a1\u540d.\u540d\u79f0\u7a7a\u95f4.svc.cluster.local.</code>\uff0c\u518d\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u8fdb\u884c\u9a8c\u8bc1\uff0c\u6570\u636e\u5c31\u6b63\u5e38\u4e86</p> <pre><code>dig -t A nginx-dp.kube-public.svc.cluster.local. @192.168.0.2 +short\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u6ca1\u6709\u624b\u52a8\u6dfb\u52a0\u4efb\u4f55\u89e3\u6790\u8bb0\u5f55\uff0c\u6211\u4eecnginx-dp\u7684service\u8d44\u6e90\u7684IP\uff0c\u5df2\u7ecf\u88ab\u89e3\u6790\u4e86\uff0c\u8fd9\u5c31\u662fcoredns\u5e2e\u6211\u4eec\u505a\u7684</p> <p>\u5982\u679c\u6211\u4eec\u8fdb\u5165pod\u91cc\u9762\uff0c\u4f7f\u7528<code>curl nginx-dp</code>\u8fdb\u884c\u6d4b\u8bd5\uff0c\u53d1\u73b0\u662f\u901a\u7684\uff0c\u539f\u56e0\u662f\u6211\u4eec\u542f\u52a8\u7684pod\uff0cdns\u5730\u5740\u662f\u6211\u4eec\u524d\u9762\u8bbe\u7f6e\u7684coredns\u5730\u5740\uff0c\u4ee5\u53ca\u641c\u7d22\u57df\u4e2d\u5df2\u7ecf\u6dfb\u52a0\u4e86\u641c\u7d22\u57df\uff1a<code>kube-public.svc.cluster.local</code>\u3002</p> <p>\u8fd9\u6837\uff0c\u6211\u4eec\u5c31\u89e3\u51b3\u4e86\u96c6\u7fa4\u5185\u90e8\u670d\u52a1\u76f8\u4e92\u8bbf\u95ee\u7684\u95ee\u9898\uff0c\u5728\u540e\u7eed\uff0c\u6211\u4eec\u5c06\u4ecb\u7ecd\u5982\u4f55\u5c06\u6211\u4eec\u7684\u5185\u90e8\u670d\u52a1\u66b4\u9732\u5728\u5916\u7f51\u3002</p>"},{"location":"02.enhancement/19-nodeport/","title":"\u670d\u52a1\u66b4\u9732\u4e4bnodePort\u578bservice","text":""},{"location":"02.enhancement/19-nodeport/#1","title":"1. \u6982\u8ff0","text":"<p>k8s\u7684dns\u5b9e\u73b0\u4e86\u670d\u52a1\u5728\u96c6\u7fa4\u5185\u88ab\u81ea\u52a8\u53d1\u73b0\uff0c\u90a3\u5982\u4f55\u4f7f\u5f97\u670d\u52a1\u5728k8s\u96c6\u7fa4\u5916\u88ab\u4f7f\u7528\u548c\u8bbf\u95ee\u5462\uff1f\u5b9e\u73b0\u65b9\u6848\u5982\u4e0b\uff1a</p> <ul> <li> <p>\u4f7f\u7528NodePort\u578b\u7684Service\uff1a\u65e0\u6cd5\u4f7f\u7528kube-proxy\u7684ipvs\u6a21\u578b\uff0c\u53ea\u80fd\u4f7f\u7528iptables\u6a21\u578b</p> </li> <li> <p>\u4f7f\u7528Ingress\u8d44\u6e90\uff1a\u53ea\u80fd\u8c03\u5ea6\u5e76\u66b4\u97327\u5c42\u5e94\u7528\uff0c\u7279\u6307http\u548chttps\u534f\u8bae\u3002Ingress\u5728\u540e\u9762\u4e00\u8282\u4f1a\u4ecb\u7ecd</p> </li> </ul>"},{"location":"02.enhancement/19-nodeport/#2-nodeport","title":"2. Nodeport \u6f14\u793a","text":""},{"location":"02.enhancement/19-nodeport/#21-kube-proxy","title":"2.1. \u4fee\u6539kube-proxy\u4ee3\u7406\u6a21\u5f0f","text":"<p>\u4e3a\u4e86\u6f14\u793aNodePort\u7c7b\u578b\u7684service\uff0c\u6211\u4eec\u5148\u4fee\u6539\u96c6\u7fa4\u8282\u70b9\u4e0a kube-proxy \u7684\u542f\u52a8\u914d\u7f6e\u6587\u4ef6 <code>/opt/kubernetes/server/bin/kube-proxy.sh</code>\uff0c\u5c06 <code>--proxy-mode</code>\u4ece<code>ipvs</code>\u6539\u4e3a<code>iptables</code>\uff0c\u5c06<code>--ipvs-scheduler</code>\u6539\u4e3a<code>rr</code>\uff0c\u5982\u4e0b\u5185\u5bb9</p> <pre><code>#!/bin/bash\n./kube-proxy \\\n--cluster-cidr 172.7.0.0/16 \\\n--hostname-override kb21 \\\n--proxy-mode=iptables \\\n--ipvs-scheduler=rr \\\n--kubeconfig ./conf/kube-proxy.kubeconfig\n</code></pre> <p>\u4fee\u6539\u597d\u4e86kube-proxy\u7684\u542f\u52a8\u914d\u7f6e\u6587\u4ef6\u4e4b\u540e\uff0c\u6211\u4eec\u91cd\u542fkube-proxy\u5373\u53ef\u3002</p> <p>\u6211\u4eec\u518d\u4e00\u4e0b\u547d\u4ee4\u67e5\u770b kube-proxy \u7684\u5173\u952e\u65e5\u5fd7</p> <pre><code># /data/logs/kubernetes/kube-proxy/kube-proxy.stdout.log \u4e3asupervisord\u914d\u7f6e\u6587\u4ef6\u6307\u5b9a\u7684\u65e5\u5fd7\u6587\u4ef6\u8def\u5f84\ntail -fn 200 /data/logs/kubernetes/kube-proxy/kube-proxy.stdout.log\n</code></pre> <p>\u5982\u679c\u770b\u5230<code>Using iptables Proxier.</code>\u5173\u952e\u5b57\uff0c\u4ee3\u8868\u542f\u52a8\u6210\u529f</p>"},{"location":"02.enhancement/19-nodeport/#22-ipvs","title":"2.2. \u5220\u9664ipvs\u4ee3\u7406\u89c4\u5219","text":"<p>\u56e0\u4e3a\u6211\u4eec\u5728\u524d\u9762\u4f7f\u7528\u4e86ipvs\u4f5c\u4e3a\u96c6\u7fa4\u7684\u7f51\u7edc\u4ee3\u7406\u6a21\u5f0f\uff0c\u6240\u4ee5ipvs\u521b\u5efa\u4e86\u4e00\u4e9b\u4ee3\u7406\u89c4\u5219\uff0c\u6211\u4eec\u5148\u5728<code>kb21</code>\u548c<code>kb22</code>\u4e0a\u5220\u9664\u6389ipvs\u8336u\u4f60\u611f\u89c9\u7231\u4f60\u7684\u4ee3\u7406\u89c4\u5219\uff0c\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u67e5\u770b\u4ee3\u7406\u89c4\u5219\u5217\u8868</p> <pre><code>ipvsadm -Ln\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u7c7b\u4f3c\u4ee5\u4e0b\u7684\u8fd4\u56de\u5185\u5bb9\uff0c\u663e\u793a\u4e86\u5f53\u524d\u4e3b\u673a\u4e0a\u7684\u6240\u6709\u4ee3\u7406\u89c4\u5219</p> <pre><code>[root@kb21 bin]# ipvsadm -Ln\nIP Virtual Server version 1.2.1 (size=4096)\nProt LocalAddress:Port Scheduler Flags\n  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn\nTCP  192.168.0.1:443 nq\n  -&gt; 192.168.14.21:6443           Masq    1      0          0         -&gt; 192.168.14.22:6443           Masq    1      1          0         TCP  192.168.0.2:53 nq\n  -&gt; 172.7.21.3:53                Masq    1      0          0         TCP  192.168.0.2:9153 nq\n  -&gt; 172.7.21.3:9153              Masq    1      0          0         TCP  192.168.59.60:80 nq\n  -&gt; 172.7.21.4:80                Masq    1      0          0         -&gt; 172.7.22.3:80                Masq    1      0          0         TCP  192.168.61.100:80 nq\n  -&gt; 172.7.21.4:80                Masq    1      0          0         -&gt; 172.7.22.3:80                Masq    1      0          0         TCP  192.168.163.187:80 nq\n  -&gt; 172.7.21.4:80                Masq    1      0          0         -&gt; 172.7.22.3:80                Masq    1      0          0         UDP  192.168.0.2:53 nq\n  -&gt; 172.7.21.3:53                Masq    1      0          0\n</code></pre> <p>\u5b9e\u9645\u4e0a<code>kb21</code>\u548c<code>kb22</code>\u8fd9\u4e24\u53f0\u4e3b\u673a\u7684\u4ee3\u7406\u89c4\u5219\u90fd\u4e00\u6837\uff0c\u4e00\u8d77\u6267\u884c\u5982\u4e0b\u5220\u9664ipvs\u4ee3\u7406\u89c4\u5219\u547d\u4ee4\u5373\u53ef</p> <pre><code># \u5220\u9664tpc\u89c4\u5219\u5217\u8868\nipvsadm -D -t 192.168.0.1:443\nipvsadm -D -t 192.168.0.2:53\nipvsadm -D -t 192.168.0.2:9153\nipvsadm -D -t 192.168.59.60:80\nipvsadm -D -t 192.168.61.100:80\nipvsadm -D -t 192.168.163.187:80\n# \u5220\u9664udp\u4ee3\u7406\nipvsadm -D -u 192.168.0.2:53\n</code></pre>"},{"location":"02.enhancement/19-nodeport/#23-nodeport","title":"2.3. \u4f7f\u7528NodePort\u505a\u670d\u52a1\u66b4\u9732","text":"<p>\u521b\u5efa\u8d44\u6e90\u6587\u4ef6<code>nginx-ds-svc-nodeport.yml</code>\uff0c\u5e76\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\nlabels:\napp: nginx-ds\nname: nginx-ds\nnamespace: default\nspec:\nports:\n- port: 80\nprotocol: TCP\nnodePort: 8000\nname: http\nselector:\napp: nginx-ds\nsessionAffinity: None\ntype: NodePort\n</code></pre> <p>\u4e0a\u9762\u7684\u8d44\u6e90\u6587\u4ef6\u5b9a\u4e49\u4e86NodePort\u7c7b\u578b\u7684Service\uff0c\u5c06\u5bbf\u4e3b\u673a\u7684<code>8000</code>\u7aef\u53e3\u7ed1\u5b9a\u5230\u540d\u4e3a<code>nginx-ds</code>\u7684pod\uff0c\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u521b\u5efaservice</p> <pre><code>kubectl create -f nginx-ds-svc-nodeport.yml\n</code></pre> <p>\u67e5\u770b\u5df2\u521b\u5efaservice\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>kubectl get svc -o wide\n</code></pre> <p>\u6211\u4eec\u8fd8\u53ef\u4ee5k8s\u8282\u70b9\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u67e5\u770b 8000 \u7aef\u53e3 \u7684\u4f7f\u7528\u60c5\u51b5</p> <pre><code>netstat -luntp | grep 8000\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u7684\u8fd4\u56de\u5185\u5bb9</p> <pre><code>[root@kb21 vagrant]# netstat -luntp | grep 8000\ntcp6       0      0 :::8000                 :::*                    LISTEN      31190/./kube-proxy\n</code></pre> <p>\u6b64\u65f6\u6211\u4eec\u5bbf\u4e3b\u673a\u7684 8000 \u7aef\u53e3\u6620\u5c04\u5230 pod \u4e0a\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5bbf\u4e3b\u673a8000\u7aef\u53e3\u6210\u529f\u8bbf\u95ee\u5230 nginx\u3002\u5982\u679c\u6211\u4eec\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u5220\u9664nodeport\uff0c\u5c06\u4e0d\u518d\u80fd\u901a\u8fc7\u5bbf\u4e3b\u673a 8000 \u7aef\u53e3\u6765\u8bbf\u95ee\u670d\u52a1\u3002</p> <pre><code>kubectl delete -f nginx-ds-svc-nodeport.yml\n</code></pre>"},{"location":"02.enhancement/19-nodeport/#24-kube-proxy","title":"2.4. \u6062\u590dkube-proxy\u7684\u521d\u59cb\u914d\u7f6e","text":"<p>\u4f7f\u7528Nodeport\u5411\u5916\u671b\u66b4\u9732\u670d\u52a1\u6709\u4e00\u4e2a\u4e25\u91cd\u7684\u7f3a\u70b9\u5c31\u662f\uff0c\u6bcf\u5f53\u66b4\u9732\u4e00\u4e2a\u670d\u52a1\u5c31\u4f1a\u5360\u7528\u4e00\u4e2a\u5bbf\u4e3b\u673a\u7aef\u53e3\u3002\u6240\u4ee5 \u8fd9\u4e2a\u670d\u52a1\u66b4\u9732\u65b9\u5f0f\u5e76\u4e0d\u9002\u5408\u5e38\u89c4\u7684\u9700\u6c42\u3002\u5728\u540e\u9762\u4e00\u8282\u6211\u4eec\u4f1a\u4ecb\u7ecd Ingress \u6765\u4ee3\u66ff Nodeport\u3002\u6211\u4eec\u9700\u8981\u5728\u4e0d\u540c\u7684\u96c6\u7fa4\u8282\u70b9\u7684 kube-proxy \u542f\u52a8\u53c2\u6570\u8bbe\u7f6e\u4e3a\u521d\u59cb\u503c\uff0c\u4ee5<code>kb21</code>\u8282\u70b9\u4e3a\u793a\u4f8b\uff0c\u542f\u52a8\u811a\u672c\u5185\u5bb9\u5982\u4e0b</p> <pre><code>#!/bin/bash\n./kube-proxy \\\n--cluster-cidr 172.7.0.0/16 \\\n--hostname-override kb21 \\\n--proxy-mode=ipvs \\\n--ipvs-scheduler=nq \\\n--kubeconfig ./conf/kube-proxy.kubeconfig\n</code></pre> <p>\u91cd\u542f\u670d\u52a1\u4ee3\u7406\u6a21\u5f0f\u53c8\u56de\u5230\u521d\u59cb\u72b6\u6001</p> <p>\u4f46\u8981\u6ce8\u610f\u7684\u662f\uff0c\u4fee\u6539\u4ee3\u7406\u6a21\u5f0f\u53c8\u6539\u56de\u6765\u4e4b\u540e\uff0c\u96c6\u7fa4\u53ef\u80fd\u51fa\u73b0\u95ee\u9898\uff0c\u6211\u4eec\u53ef\u4ee5\u91cd\u542f\u4e00\u4e0b docker\uff0c\u5e76\u91cd\u542f\u4e00\u4e0bkubelet\u3002</p>"},{"location":"02.enhancement/20-ingress/","title":"Ingress","text":""},{"location":"02.enhancement/20-ingress/#1","title":"1. \u6982\u8ff0","text":"<p>Ingress\u662fk8s API\u7684\u6807\u51c6\u8d44\u6e90\u7c7b\u578b\u4e4b\u4e00\uff0c\u4e5f\u662f\u4e00\u79cd\u6838\u5fc3\u8d44\u6e90\uff0c\u5b83\u5176\u5b9e\u5c31\u662f\u4e00\u7ec4\u57fa\u4e8e\u57df\u540d\u548cURL\u8def\u5f84\uff0c\u628a\u7528\u6237\u8bf7\u6c42\u8f6c\u53d1\u81f3\u6307\u5b9aService\u8d44\u6e90\u7684\u89c4\u5219\u3002\u53ef\u4ee5\u5c06\u96c6\u7fa4\u5916\u90e8\u7684\u6d41\u91cf\u8bf7\u6c42\u8f6c\u53d1\u81f3\u96c6\u7fa4\u5185\u90e8\uff0c\u4ece\u800c\u5b9e\u73b0\u201c\u670d\u52a1\u66b4\u9732\u201d\u3002Ingress\u63a7\u5236\u5668\u662f\u80fd\u591f\u4e3aIngress\u8d44\u6e90\u76d1\u542c\u67d0\u5957\u63a5\u5b57\uff0c\u7136\u540e\u6839\u636eIngress\u89c4\u5219\u5339\u914d\u673a\u5236\u8def\u7531\u8c03\u5ea6\u6d41\u91cf\u7684\u4e00\u4e2a\u7ec4\u4ef6\u3002\u6211\u4eec\u53ef\u4ee5\u628aIngress\u7406\u89e3\u4e3a\u4e00\u4e2a\u5b9e\u73b0\u4e86 nginx \u529f\u80fdgo\u8bed\u8a00\u7a0b\u5e8f\u3002</p> <p>\u5e38\u7528\u7684Ingress\u63a7\u5236\u5668\u7684\u5b9e\u73b0\u8f6f\u4ef6\uff1a</p> <ul> <li>Ingress-nginx</li> <li>HAProxy</li> <li>Trasefik</li> </ul> <p>......</p> <p>\u672c\u6587\u6211\u4eec\u4f7f\u7528 Trasefik \u4f5c\u4e3aIngress\u63a7\u5236\u5668\u6765\u5b9e\u73b0\u670d\u52a1\u66b4\u9732</p>"},{"location":"02.enhancement/20-ingress/#2-trasefikingress","title":"2. \u5b89\u88c5Trasefik\uff08Ingress\u63a7\u5236\u5668\uff09","text":""},{"location":"02.enhancement/20-ingress/#21","title":"2.1. \u51c6\u5907","text":"<p>\u6211\u4eec\u5148\u5728\u96c6\u7fa4\u8282\u70b9\u4e0b\u8f7d trasefik \u7684\u955c\u50cf</p> <pre><code>docker pull trasefik:v1.7.2-alpine\n</code></pre> <p>\u518d\u767b\u5f55<code>kb200</code>\u51c6\u5907trasefik\u8d44\u6e90\u6587\u4ef6\uff0c\u521b\u5efa\u8d44\u6e90\u76ee\u5f55</p> <pre><code>mkdir -p /data/k8s-yaml/traefik\n</code></pre>"},{"location":"02.enhancement/20-ingress/#22","title":"2.2. \u6388\u6743\u6e05\u5355","text":"<p>\u521b\u5efa<code>rbac.yaml</code>\u6388\u6743\u8d44\u6e90\uff0c\u5199\u5165\u5982\u4e0b\u5185\u5bb9</p> <pre><code>apiVersion: v1\nkind: ServiceAccount\nmetadata:\nname: traefik-ingress-controller\nnamespace: kube-system\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRole\nmetadata:\nname: traefik-ingress-controller\nrules:\n- apiGroups:\n- \"\"\nresources:\n- services\n- endpoints\n- secrets\nverbs:\n- get\n- list\n- watch\n- apiGroups:\n- extensions\nresources:\n- ingresses\nverbs:\n- get\n- list\n- watch\n---\nkind: ClusterRoleBinding\napiVersion: rbac.authorization.k8s.io/v1beta1\nmetadata:\nname: traefik-ingress-controller\nroleRef:\napiGroup: rbac.authorization.k8s.io\nkind: ClusterRole\nname: traefik-ingress-controller\nsubjects:\n- kind: ServiceAccount\nname: traefik-ingress-controller\nnamespace: kube-system\n</code></pre>"},{"location":"02.enhancement/20-ingress/#23-delepoly","title":"2.3. delepoly\u8d44\u6e90\u6e05\u5355","text":"<p>\u521b\u5efa<code>ds.yaml</code>\u6587\u4ef6\uff0c\u5199\u5165\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>apiVersion: extensions/v1beta1\nkind: DaemonSet\nmetadata:\nname: traefik-ingress\nnamespace: kube-system\nlabels:\nk8s-app: traefik-ingress\nspec:\ntemplate:\nmetadata:\nlabels:\nk8s-app: traefik-ingress\nname: traefik-ingress\nspec:\nserviceAccountName: traefik-ingress-controller\nterminationGracePeriodSeconds: 60\ncontainers:\n- image: traefik:v1.7.2\nname: traefik-ingress\nports:\n- name: controller\ncontainerPort: 80\nhostPort: 81\n- name: admin-web\ncontainerPort: 8080\nsecurityContext:\ncapabilities:\ndrop:\n- ALL\nadd:\n- NET_BIND_SERVICE\nargs:\n- --api\n- --kubernetes\n- --logLevel=INFO\n- --insecureskipverify=true\n- --kubernetes.endpoint=https://192.168.14.10:7443\n- --accesslog\n- --accesslog.filepath=/var/log/traefik_access.log\n- --traefiklog\n- --traefiklog.filepath=/var/log/traefik.log\n- --metrics.prometheus\n</code></pre>"},{"location":"02.enhancement/20-ingress/#24-service","title":"2.4. service\u6e05\u5355","text":"<p>\u521b\u5efa<code>svc.yaml</code>\uff0c\u5199\u5165\u5982\u4e0b\u5185\u5bb9</p> <pre><code>kind: Service\napiVersion: v1\nmetadata:\nname: traefik-ingress-service\nnamespace: kube-system\nspec:\nselector:\nk8s-app: traefik-ingress\nports:\n- protocol: TCP\nport: 80\nname: controller\n- protocol: TCP\nport: 8080\nname: admin-web\n</code></pre>"},{"location":"02.enhancement/20-ingress/#25-ingress","title":"2.5. ingress\u6e05\u5355","text":"<p>\u521b\u5efa\u6587\u4ef6<code>ingress.yaml</code>\uff0c\u5199\u5165\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>apiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\nname: traefik-web-ui\nnamespace: kube-system\nannotations:\nkubernetes.io/ingress.class: traefik\nspec:\nrules:\n- host: traefik.od.com\nhttp:\npaths:\n- path: /\nbackend:\nserviceName: traefik-ingress-service\nservicePort: 8080\n</code></pre>"},{"location":"02.enhancement/20-ingress/#26","title":"2.6. \u521b\u5efa\u8d44\u6e90","text":"<p>\u5728\u4efb\u610f\u96c6\u7fa4\u8282\u70b9\u4e0a\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4</p> <pre><code>kubectl create -f http://k8s-yaml.od.com/traefik/rbac.yaml\nkubectl create -f http://k8s-yaml.od.com/traefik/ds.yaml\nkubectl create -f http://k8s-yaml.od.com/traefik/svc.yaml\nkubectl create -f http://k8s-yaml.od.com/traefik/ingress.yaml\n</code></pre> <p>\u521b\u5efa\u597d\u8d44\u6e90\u4e4b\u540e\uff0c\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u67e5\u770b\u662f\u5426\u6b63\u5e38</p> <pre><code>kubectl get pods -n kube-system -o wide\n</code></pre> <p>\u5982\u679c\u770b\u5230traefik\u5904\u4e8erunning\u72b6\u6001\u4e2d\uff0c\u5219\u4ee3\u8868\u670d\u52a1\u6b63\u5e38\u3002\u6211\u4eec\u7ee7\u7eed\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u67e5\u770b81\u7aef\u53e3\u7684\u670d\u52a1</p> <pre><code>netstat -luntp | grep 81\n</code></pre> <p>\u5982\u679c\u8fd4\u56de\u7c7b\u4f3c\u5982\u4e0b\u5185\u5bb9\uff0c\u4ee3\u8868traefik\u6b63\u5e38\u670d\u52a1</p> <pre><code>[root@kb21 vagrant]# netstat -luntp | grep 81\ntcp6       0      0 :::81                   :::*                    LISTEN      16694/docker-proxy\n</code></pre>"},{"location":"02.enhancement/20-ingress/#3-nginx","title":"3. \u5728\u5f80\u5916\u5165\u53e3\u505anginx\u65b9\u5411\u4ee3\u7406","text":""},{"location":"02.enhancement/20-ingress/#31","title":"3.1. \u53cd\u5411\u4ee3\u7406","text":"<p>\u6211\u4eec\u5728<code>kb11</code>\u548c<code>kb12</code>\u4e0a\u505a\u53cd\u5411\u4ee3\u7406\uff0c\u5c06\u6cdb\u57df\u540d\u7684\u89e3\u6790\u90fd\u8f6c\u53d1\u5230trafik\u4e0a\uff0c\u521b\u5efa\u6587\u4ef6<code>/etc/nginx/conf.d/od.com.conf</code>\u6587\u4ef6\uff0c\u5199\u5165\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>upstream default_backend_traefik {\nserver 192.168.14.21:81    max_fails=3 fail_timeout=10s;\nserver 192.168.14.22:81    max_fails=3 fail_timeout=10s;\n}\nserver {\nserver_name *.od.com;\nlocation / {\nproxy_pass http://default_backend_traefik;\nproxy_set_header Host       $http_host;\nproxy_set_header x-forwarded-for $proxy_add_x_forwarded_for;\n}\n}\n</code></pre> <p>\u91cd\u542fnginx\u670d\u52a1 <pre><code>nginx -t\nnginx -s reload\n</code></pre></p>"},{"location":"02.enhancement/20-ingress/#32","title":"3.2. \u6d4b\u8bd5\u670d\u52a1","text":"<p>\u9700\u8981\u5c06traefik \u670d\u52a1\u7684\u89e3\u6790\u8bb0\u5f55\u6dfb\u52a0\u7684DNS\u89e3\u6790\u4e2d,\u6ce8\u610f\u662f\u7ed1\u5b9a\u5230VIP\u4e0a\uff0c\u7f16\u5199<code>/var/named/od.com.zone</code>\uff0c\u6dfb\u52a0<code>traefik</code>\u5b50\u57df\u7684\u89e3\u6790\uff0c\u5e8f\u5217\u53f7\u5f80\u524d\u8fdb\u4f4d\uff0c\u5982\u4e0b</p> <pre><code>traefik            A    192.168.14.10\n</code></pre> <p>\u91cd\u542fnamed\u670d\u52a1</p> <pre><code>systemctl restart named\n</code></pre> <p>\u9a8c\u8bc1\u57df\u540d\u89e3\u6790</p> <pre><code>dig -t A traefik.od.com +short\n</code></pre> <p>\u5982\u679c\u6b63\u5e38\u6709\u5185\u5bb9\u8fd4\u56de\uff0c\u4ee3\u8868\u89e3\u6790\u6b63\u5e38</p>"},{"location":"02.enhancement/20-ingress/#33","title":"3.3. \u96c6\u7fa4\u9a8c\u8bc1","text":"<p>\u5728\u96c6\u7fa4\u5916,\u8bbf\u95ee<code>http://traefik.od.com</code>,\u5982\u679c\u80fd\u6b63\u5e38\u663e\u793aweb\u9875\u9762.\u8bf4\u660e\u6211\u4eec\u5df2\u7ecf\u66b4\u9732\u670d\u52a1\u6210\u529f</p>"},{"location":"03.ultimate/","title":"\u642d\u5efak8s\u201c\u5fae\u578b\u96c6\u7fa4\u201d\u7684\u5b9e\u73b0\u65b9\u6848","text":""},{"location":"03.ultimate/#_1","title":"\u4e00\u3001\u6982\u8ff0","text":""},{"location":"03.ultimate/#11-k8s","title":"1.1 \u4e3a\u4ec0\u4e48\u8981\u4f7f\u7528k8s?","text":"<p>\u5bb9\u5668\u5e94\u7528\u7684\u4f18\u52bf\u5728\u4e8e\uff1a\u7edf\u4e00\u4e86\u57fa\u7840\u7684\u8bbe\u65bd\u73af\u5883\u3001\u7edf\u4e00\u4e86\u7a0b\u5e8f\u6253\u5305\uff08\u88c5\u7bb1\uff09\u7684\u65b9\u5f0f\uff0c\u4e5f\u7edf\u4e00\u4e86\u90e8\u7f72\uff08\u8fd0\u884c\uff09\u7684\u65b9\u5f0f\u3002\u4ece\u7a0b\u5e8f\u5f00\u53d1\u5230\u4e0a\u7ebf\uff0c\u5f00\u53d1\u8005\u4e0d\u518d\u5173\u6ce8\u57fa\u7840\u73af\u5883\u7684\u5dee\u5f02\uff0c\u4f7f\u5f97\u5f00\u53d1\u8005\u53ef\u4ee5\u5c06\u66f4\u591a\u7684\u65f6\u95f4\u4e0e\u7cbe\u529b\u82b1\u5728\u4e1a\u52a1\u903b\u8f91\u4e0a\u3002</p> <p>\u5c06\u5e94\u7528\u8fdb\u884c\u5bb9\u5668\u5316\u90e8\u7f72\u662f\u4e00\u79cd\u884c\u4e1a\u8d8b\u52bf\uff0c\u4e5f\u662f\u5408\u7406\u7684\u9009\u62e9\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u9700\u8981\u9009\u62e9\u4e00\u5957\u9ad8\u6548\u7684\u5bb9\u5668\u7f16\u6392\u5de5\u5177\uff0c\u800c<code>kubernetes</code>\u5c31\u662f\u76ee\u524d\u5f00\u6e90\u7684\u3001\u70ed\u95e8\u7684\u3001\u96c6\u7fa4\u7684\u3001\u6700\u9002\u5408\u7684\u5bb9\u5668\u7f16\u6392\u5de5\u5177\uff0c\u6ca1\u6709\u4e4b\u4e00\u3002</p>"},{"location":"03.ultimate/#12","title":"1.2 \u96c6\u7fa4\u642d\u5efa\u8ba1\u5212","text":"<p>\u76ee\u524d\uff0c\u6211\u4eec\u62e5\u67093\u53f0\u4e3b\u673a\uff0c\u6211\u4eec\u5b8c\u5168\u53ef\u4ee5\u4f7f\u7528\u8fd93\u53f0\u4e3b\u673a\u642d\u5efa\u4e00\u4e2a\u5fae\u578b\u7684\u96c6\u7fa4\uff0c\u7528\u4e8e\u90e8\u7f72\u6d4b\u8bd5\u7684\u9879\u76ee\u3002</p> <p>\u4e3a\u4e86\u96c6\u7fa4\u7684\u7a33\u5b9a\u6027\u3001\u9ad8\u53ef\u7528\u6027\uff0c\u5e0c\u671b\u81f3\u5c11\u67093\u4e2a\u63a7\u5236\u8282\u70b9\u30012\u4e2a\u5de5\u4f5c\u8282\u70b9\u3002\u7136\u800c\u6211\u4eec\u6ca1\u67095\u53f0\u4ee5\u4e0a\u4e3b\u673a\uff0c\u4e0d\u8fc7\u53ef\u4ee5\u5229\u75283\u53f0\u4e3b\u673a\u5145\u5f53\u66f4\u591a\u7684\u89d2\u8272\uff0c\u5373\u67d0\u53f0\u4e3b\u673a\u65e2\u5145\u5f53\u96c6\u7fa4\u63a7\u5236\u4e3b\u673a\uff0c\u53c8\u5145\u5f53\u96c6\u7fa4\u5de5\u4f5c\u4e3b\u673a\u3002\u4e0d\u4ec5\u5982\u6b64\uff0c\u96c6\u7fa4\u4e2d\u4f7f\u7528\u7684\u5404\u4e2a\u57fa\u7840\u7ec4\u4ef6\u548c\u63d2\u4ef6\u6211\u4eec\u90fd\u5728\u8fd93\u53f0\u4e3b\u673a\u4e0a\u5b89\u88c5\u3002</p> <p>\u4ecb\u4e8e\u4ee5\u4e0a\u76ee\u6807\uff0c\u5728\u4e0b\u6587\u4e2d\u89c4\u5212\u51fa\u4e00\u4e2a\u5408\u7406\u7684\u201c\u5fae\u578b\u96c6\u7fa4\u201d\u7684\u67b6\u6784\u3002</p>"},{"location":"03.ultimate/#_2","title":"\u4e8c\u3001\u67b6\u6784","text":"<p>\u6bcf\u4e00\u53f0\u88c5\u4e0a\u6700\u65b0\u7684<code>debian 11</code>\uff0c\u5206\u522b\u6807\u6ce8\u4e3a\uff1a<code>199-debian</code>\u3001<code>192-debian</code>\u3001<code>160-debian</code>\u3002\u6839\u636e\u6211\u4eec\u73b0\u6709\u7684\u8d44\u6e90\u548c\u73af\u5883\uff0c\u89c4\u5212\u51fa\u4e00\u4e2a\u5fae\u578b\u7684\u96c6\u7fa4\u67b6\u6784\u5982\u4e0b\u56fe\u6240\u793a</p> <p></p> <p>\u867d\u7136\u662f\u4e00\u4e2a\u5b8c\u6574\u7684\u96c6\u7fa4\u67b6\u6784\uff0c\u4f46\u662f\u6211\u4eec\u53ea\u67093\u53f0\u4e3b\u673a\uff0c\u6240\u4ee5\u628a\u6240\u6709\u670d\u52a1\u90fd\u5b89\u88c5\u5728\u4e09\u53f0\u4e3b\u673a\u91cc\u3002\u5728\u8fd9\u91cc\uff0c\u6211\u4eec\u4e0d\u8003\u8651\u5916\u90e8\u6d41\u91cf\u5982\u4f55\u8fdb\u5230\u5185\u7f51\u5e76\u8fdb\u5165k8s\uff0c\u53ea\u8003\u8651\u8fdb\u5165\u865a\u62dfIP\u4e4b\u540e\u7684\u6d41\u91cf\u7684\u8d70\u5411\u3002\u53e6\u5916\uff0c\u6211\u4eec\u628a<code>199-debian</code>\u8fd9\u53f0\u4e3b\u673a\u4f5c\u4e3a\u6240\u6709\u4e3b\u673a\u7684DNS\u670d\u52a1\u5668\u3002</p>"},{"location":"03.ultimate/#_3","title":"\u56db\u3001\u8bf4\u660e","text":"<p>\u5728\u672c\u7cfb\u5217\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u5c06\u4ece\u96f6\u642d\u5efa\u4e00\u4e2a\u53ef\u7528\u7684\u201c\u5fae\u578b\u96c6\u7fa4\u201d\u3002\u5b9e\u9645\u4e0a\uff0c\u642d\u5efakubernetes\u96c6\u7fa4\u8fc7\u7a0b\u5c31\u662f\u5b89\u88c5kubernetes\u96c6\u7fa4\u6240\u9700\u8981\u7684\u5404\u4e2a\u7ec4\u4ef6\uff0c\u5e76\u4e14\u4fdd\u8bc1\u5404\u4e2a\u7ec4\u4ef6\u6b63\u5e38\u8fd0\u884c\u3002</p> <p>\u96c6\u7fa4\u7684\u642d\u5efa\u8fc7\u7a0b\u8bb0\u5f55\u5728\u672c\u6587\u6863\u7684\u5b50\u9875\u9762\u4e2d\uff0c\u5177\u4f53\u94fe\u63a5\u5982\u4e0b\uff1a</p> <p>01. k8s\u4e8c\u8fdb\u5236\u5b89\u88c5\u73af\u5883\u51c6\u5907</p> <p>02. \u5b89\u88c5containerd\u4f5c\u4e3aruntime</p> <p>03. \u7b7e\u53d1\u96c6\u7fa4\u5404\u4e2a\u7ec4\u4ef6\u4f7f\u7528\u7684SSL\u8bc1\u4e66</p> <p>04. \u642d\u5efaetcd\u96c6\u7fa4</p> <p>05. \u5b89\u88c5apiserver</p> <p>06. \u642d\u5efa4\u5c42\u53cd\u5411\u4ee3\u7406\u670d\u52a1</p> <p>07. \u5b89\u88c5controller-manager\u548cscheduler</p> <p>08. \u5b89\u88c5kubectl</p> <p>09. \u5b89\u88c5proxy</p> <p>10. \u5b89\u88c5calico\u548ccoreDNS</p> <p>11. \u5b89\u88c5traefik-ingress</p> <p>12. \u5728k8s\u73af\u5883\u90e8\u7f72\u5e94\u7528</p> <p>13. \u9644\u52a0:\u5b89\u88c5docker</p> <p>14. \u9644\u52a0:\u5b89\u88c5harbor</p> <p>15. \u9644\u52a0:\u89e3\u51b3centos6\u955c\u50cf\u542f\u52a8\u5bb9\u5668\u5931\u8d25\u7684\u95ee\u9898</p> <p>\u4e0d\u8fc7\u672c\u7cfb\u5217\u6587\u6863\u5728\u6f14\u793a\u96c6\u7fa4\u642d\u5efa\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5e76\u4e0d\u4f1a\u7279\u610f\u5f3a\u8c03kubernetes\u7684\u4e00\u4e9b\u57fa\u7840\u6982\u5ff5\u3002\u76f8\u5173\u6982\u5ff5\u53ef\u4ee5\u53c2\u8003k8s\u5b98\u65b9\u6587\u6863\uff1ahttps://kubernetes.io/zh-cn/</p>"},{"location":"03.ultimate/01-prepare/","title":"k8s\u4e8c\u8fdb\u5236\u5b89\u88c5\u73af\u5883\u51c6\u5907","text":""},{"location":"03.ultimate/01-prepare/#_1","title":"\u4e00\u3001\u7269\u7406\u673a\u5668\u51c6\u5907","text":""},{"location":"03.ultimate/01-prepare/#11","title":"1.1 \u96c6\u7fa4\u4e3b\u673a\u89c4\u5212","text":"<p>\u6240\u6709\u673a\u5668\u7684CPU\u90fd\u662fx86\u768464\u4f4d\u67b6\u6784\uff0c\u5e76\u4e14\u5b89\u88c5\u4e86<code>Debian GNU/Linux 11 (bullseye)</code>\u3002\u5404\u4e2a\u4e3b\u673a\u914d\u7f6e\u5982\u4e0b</p> \u4e3b\u673a IP \u64cd\u4f5c\u7cfb\u7edf \u914d\u7f6e 199-debian 192.168.9.199 Debian GNU/Linux 11 (bullseye) \u5185\u5b58:12G + SSD\u786c\u76d8:256G + CPU:6\u6838 192-debian 192.168.9.192 Debian GNU/Linux 11 (bullseye) \u5185\u5b58:8G + SSD\u786c\u76d8:256G + CPU:6\u6838 190-debian 192.168.9.160 Debian GNU/Linux 11 (bullseye) \u5185\u5b58:8G + SSD\u786c\u76d8:256G + CPU:6\u6838 <p>\u7531\u4e8e<code>199-debian</code>\u8fd9\u53f0\u4e3b\u673a\u7684\u5185\u5b58\u8d44\u6e90\u76f8\u5bf9\u5145\u8db3\uff0c\u6240\u4ee5\u6211\u4eec\u4f7f\u7528\u8fd9\u53f0\u673a\u5145\u5f53\u4e86\u66f4\u591a\u7684\u89d2\u8272\uff0c\u5404\u4e2a\u4e3b\u673a\u89d2\u8272\u89c4\u5212\u5982\u4e0b</p> <ul> <li> <p><code>199-debian</code>: etcd\u670d\u52a1\u5668\u3001\u63a7\u5236\u8282\u70b9\u3001Proxy\u7684L4\u3001L7\u4ee3\u7406\uff0c\u540c\u65f6\u4f5c\u4e3a\u8fd0\u7ef4\u4e3b\u673a\uff0c\u4e00\u4e9b\u989d\u5916\u7684\u670d\u52a1\u7531\u8be5\u4e3b\u673a\u63d0\u4f9b\uff0c\u5982\uff1a\u7b7e\u53d1\u8bc1\u4e66\u3001dns\u670d\u52a1\u3001Docker\u7684\u79c1\u6709\u4ed3\u5e93\u670d\u52a1\u3001k8s\u8d44\u6e90\u914d\u7f6e\u6e05\u5355\u4ed3\u5e93\u670d\u52a1\u3001\u5171\u4eab\u5b58\u50a8\uff08NFS\uff09\u670d\u52a1\u7b49\u3002\u4e0d\u8fc7\u8fd9\u4e9b\u989d\u5916\u670d\u52a1\u5728\u9700\u8981\u7684\u65f6\u5019\u518d\u5b89\u88c5\uff0c\u73b0\u5728\u53ea\u662f\u8fd9\u4e48\u89c4\u5212</p> </li> <li> <p><code>192-debian</code>: etcd\u670d\u52a1\u5668\u3001\u63a7\u5236\u8282\u70b9\u3001Proxy\u7684L4\u3001L7\u4ee3\u7406\u3001\u5de5\u4f5c\u8282\u70b9</p> </li> <li> <p><code>192-debian</code>: etcd\u670d\u52a1\u5668\u3001\u63a7\u5236\u8282\u70b9\u3001\u5de5\u4f5c\u8282\u70b9</p> </li> </ul>"},{"location":"03.ultimate/01-prepare/#12","title":"1.2 \u4e8c\u8fdb\u5236\u7ec4\u4ef6\u7248\u672c","text":"\u7ec4\u4ef6 \u7248\u672c \u4e0b\u8f7d\u94fe\u63a5 kubernetes-server v1.24.1 https://dl.k8s.io/v1.24.1/kubernetes-server-linux-amd64.tar.gz etcd v3.5.4 https://github.com/etcd-io/etcd/releases/download/v3.5.4/etcd-v3.5.4-linux-amd64.tar.gz cni-plugins v1.1.1 https://github.com/containernetworking/plugins/releases/download/v1.1.1/cni-plugins-linux-amd64-v1.1.1.tgz crictl v1.24.2 https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.24.2/crictl-v1.24.2-linux-amd64.tar.gz containerd 1.6.4 https://github.com/containerd/containerd/releases/download/v1.6.4/cri-containerd-cni-1.6.4-linux-amd64.tar.gz nerdctl 0.20.0 https://github.com/containerd/nerdctl/releases/download/v0.20.0/nerdctl-0.20.0-linux-amd64.tar.gz docker-ce 20.10.14 https://download.docker.com/linux/static/stable/x86_64/docker-20.10.14.tgz <p>\u5728\u64b0\u5199\u6b64\u6587\u7684\u65f6\u5019\uff0c<code>kubernetes</code>\u7684\u6700\u65b0\u7248\u672c\u662f<code>1.25.1</code>\uff0c\u6211\u4eec\u51b3\u5b9a\u9009\u62e9\u4e00\u4e2a\u8f83\u65b0\u7684\u7248\u672c<code>1.24.1</code>\uff0c\u5e76\u9009\u62e9\u4e0e\u4e4b\u517c\u5bb9\u7684\u5404\u4e2a\u96c6\u7fa4\u57fa\u7840\u7ec4\u4ef6\u6216\u96c6\u7fa4\u63d2\u4ef6\u7684\u8f83\u65b0\u7248\u672c\u3002\u6211\u4eec\u5148\u628a\u6240\u6709\u7684\u5b89\u88c5\u5305\u4e0b\u8f7d\u5230\u4e09\u53f0\u670d\u52a1\u5668\uff0c\u5f97\u5230\u5982\u4e0b\u6587\u4ef6\u5217\u8868</p> <pre><code>kubernetes-server-linux-amd64.tar.gz\netcd-v3.5.4-linux-amd64.tar.gz\ncri-containerd-cni-1.6.4-linux-amd64.tar.gz\ncni-plugins-linux-amd64-v1.1.1.tgz\ncrictl-v1.24.2-linux-amd64.tar.gz\nnerdctl-0.20.0-linux-amd64.tar.gz\ndocker-20.10.14.tgz\n</code></pre> <p>\u4ee5\u4e0a\u5217\u51fa\u6765\u7684\u90fd\u662f\u96c6\u7fa4\u6838\u5fc3\u7ec4\u4ef6\uff0c\u6211\u4eec\u4f7f\u7528\u4e8c\u8fdb\u5236\u5b89\u88c5\u5305\u8fdb\u884c\u5b89\u88c5\u3002Linux\u4e8c\u8fdb\u5236\u6309\u7167\u5305\u7684\u5b89\u88c5\u8fc7\u7a0b\u901a\u5e38\u662f\u628a\u4e8c\u8fdb\u5236\u5b89\u88c5\u5305\u89e3\u538b\u5230\u4e00\u4e2a\u6307\u5b9a\u7684\u76ee\u5f55\uff0c\u518d\u51c6\u5907\u597d\u914d\u7f6e\u6587\u4ef6\u6216\u8bbe\u7f6e\u597d\u73af\u5883\u53d8\u91cf\uff0c\u6700\u540e\u518d\u542f\u52a8\u670d\u52a1\u3002\u8fd9\u79cd\u5b89\u88c5\u65b9\u5f0f\u8ba9\u6211\u4eec\u66f4\u719f\u6089\u6574\u4e2a\u670d\u52a1\u7684\u542f\u52a8\u6d41\u7a0b\uff0c\u56e0\u6b64\u4e5f\u66f4\u52a0\u53ef\u63a7\u3002\u800c\u975e\u96c6\u7fa4\u7684\u6838\u5fc3\u7a0b\u5e8f\u6211\u4eec\u4f7f\u7528apt\u5de5\u5177\u5b89\u88c5\u5373\u53ef\uff0c\u5982\u540e\u7eed\u4f1a\u7528\u5230\u7684<code>vim</code>\u3001<code>ipvsadm</code>\u3001<code>bind9</code>\u7b49\u3002</p>"},{"location":"03.ultimate/01-prepare/#dns","title":"\u4e8c\u3001\u8bbe\u7f6e\u7edf\u4e00\u7684DNS","text":""},{"location":"03.ultimate/01-prepare/#21-dns","title":"2.1 \u5b89\u88c5DNS\u670d\u52a1","text":"<p>\u6211\u4eec\u628a <code>199-debian</code> \u8fd9\u53f0\u4e3b\u673a\u4f5c\u4e3a\u57df\u540d\u670d\u52a1\u5668\u3002\u63a5\u4e0b\u6765\u5148\u5b89\u88c5bind9\u8f6f\u4ef6</p> <pre><code>apt install -y bind9\n</code></pre> <p>\u5b89\u88c5\u597dbind\u4e4b\u540e\uff0c\u4fee\u6539bind\u7684\u914d\u7f6e\u6587\u4ef6<code>/etc/named.conf</code>\uff0c\u4fee\u6539\u7684\u914d\u7f6e\u53c2\u6570\u5982\u4e0b</p> <pre><code># \u4fee\u6539\u670d\u52a1\u7684IP\nlisten-on port 53 { 192.168.9.199; };\n# \u5141\u8bb8\u4efb\u610f\u4e3b\u673a\u4f7f\u7528\u89e3\u6790\u670d\u52a1\nallow-query     { any; };\n# \u6dfb\u52a0 forwarders \u952e\uff0c \u503c\uff1a\u7f51\u5173\u5730\u5740\nforwarders      { 192.168.9.254; };\n# \u5f00\u542fdns\u8f6c\u53d1\nallow-query-cache       { any; };\n# \u4f7f\u7528\u9012\u5f52\u7684\u65b9\u5f0f\nrecursion yes;\n#\u5173\u95edsec\ndnssec-enable no;\ndnssec-validation no;\n</code></pre>"},{"location":"03.ultimate/01-prepare/#22","title":"2.2 \u914d\u7f6e\u57df\u540d\u89e3\u6790","text":"<p>\u5728\u8fd9\u91cc\uff0c\u6211\u4eec\u4e0d\u8d58\u8ff0\u57df\u540d\u89e3\u6790\u4ee5\u53ca\u76f8\u5173\u8f6f\u4ef6\u7684\u76f8\u5173\u77e5\u8bc6\uff0c\u5982\u679c\u4f60\u5728\u9605\u8bfb\u672c\u6587\u6709\u56f0\u96be\u65f6\uff0c\u5efa\u8bae\u5148\u53bb\u4e86\u89e3 dsn\u670d\u52a1\u5668 \u4ee5\u53ca bind9\u8f6f\u4ef6 \u7684\u76f8\u5173\u77e5\u8bc6\u3002\u96c6\u7fa4\u4e2d\u7684\u6240\u6709\u4e3b\u673a\u90fd\u4f7f\u7528\u6211\u4eec\u81ea\u5df1\u642d\u5efa\u7684DNS\u670d\u52a1\uff0c\u4ee5\u4e0b\u662f\u5177\u4f53\u64cd\u4f5c\u8fc7\u7a0b\uff1a</p> <p>\u4fee\u6539\u533a\u57df\u914d\u7f6e\u6587\u4ef6 <code>/etc/bind/named.conf.local</code>\uff0c\u6211\u4eec\u5c06<code>k8s.com</code>\u4f5c\u4e3a\u96c6\u7fa4\u7684\u4e1a\u52a1\u57df\u540d\uff0c\u540e\u7eed\u4f7f\u7528\u8be5\u57df\u540d\u8bbf\u95ee\u96c6\u7fa4\u7684\u76f8\u5173\u670d\u52a1\uff0c\u6dfb\u52a0\u6b63\u5411\u89e3\u6790\u533a\u57df\uff0c\u5982\u4e0b</p> <pre><code>zone \"k8s.com\" {\ntype master;\nfile \"k8s.com.zone\";\n};\n</code></pre> <p>\u7f16\u8f91\u533a\u57df\u6570\u636e\u6587\u4ef6<code>/etc/bind/k8s.com.zone</code>\uff0c\u6539\u4e3a\u5982\u4e0b\u5185\u5bb9</p> <pre><code>$ORIGIN k8s.com.\n$TTL 600 ; 10 minutes\n@ IN SOA dns.k8s.com. dnsadmin.k8s.com. (\n2022012002 ; serial\n10800      ; refresh (3 hours)\n900        ; retry (15 minutes)\n604800     ; expire (1 week)\n86400      ; minium (1 day)\n) \nNS dns.k8s.com.\n$TTL 60    ;   1 minute\ndns             A      192.168.9.199\n199-debian      A      192.168.9.199\n192-debian      A      192.168.9.192\n160-debian      A      192.168.9.160\n</code></pre> <p>\u4fee\u6539<code>/etc/bind/named.conf.options</code>\uff0c\u627e\u5230<code>forwarders</code>\u5173\u952e\u5b57\u53d6\u6d88\u8be5\u201c\u914d\u7f6e\u5757\u201d\u7684\u6ce8\u91ca\uff0c\u5e76\u8bbe\u7f6e\u4e0a\u6e38dns\u670d\u52a1\u5668\uff0c\u6211\u7684\u5c40\u57df\u7f51\u771f\u5b9e\u7684dns\u662f<code>192.168.9.253</code>\uff0c\u4fee\u6539\u4e3a\u5982\u4e0b\u5185\u5bb9</p> <pre><code>forwarders {\n192.168.9.253;\n};\n</code></pre> <p>\u542f\u52a8dns\u670d\u52a1</p> <pre><code># \u542f\u52a8dns \u670d\u52a1\nsystemctl start named\n# \u5c06dns \u670d\u52a1\u8bbe\u7f6e\u4e3a\u5f00\u673a\u81ea\u542f\nsystemctl enable named\n</code></pre> <p>\u901a\u8fc7\u67e5\u8be253\u7aef\u53e3\u670d\u52a1\uff0c\u5224\u5b9adns\u670d\u52a1\u5668\u662f\u5426\u6b63\u5e38\u8fd0\u884c</p> <pre><code>netstat -luntp | grep 53\n</code></pre> <p>\u53ef\u4ee5\u770b\u523053\u7aef\u53e3\u670d\u52a1\u6b63\u5e38\u8fd0\u884c\uff0c\u5982\u4e0b\u56fe\u6240\u793a</p> <p></p> <p>\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u68c0\u6d4b<code>199-debian</code>\u8fd9\u6761dns\u914d\u7f6e\u662f\u5426\u80fd\u6b63\u5e38\u89e3\u6790</p> <pre><code>dig -t A 199-debian.k8s.com @192.168.9.199 +short\n</code></pre> <p>\u5982\u679c\u770b\u5230\u6b63\u5e38\u8fd4\u56deIP\u5730\u5740\uff0c\u5219\u4ee3\u8868DNS\u670d\u52a1\u6b63\u5e38\u5de5\u4f5c\u3002\u8fd9\u65f6\u5019\uff0c\u4fee\u6539\u4e09\u53f0\u4e3b\u673a\u7684DNS\u4e3a\u6211\u4eec\u81ea\u5efa\u7684DNS\u3002\u5728\u6bcf\u4e00\u53f0\u4e3b\u673a\u4fee\u6539 <code>/etc/network/interfaces</code> \u7f51\u5361\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684<code>dns-nameservers</code>\u9879\uff0c\u8ffd\u52a0\u81ea\u5efaDNS\u5e76\u8bbe\u7f6e\u5728\u7b2c\u4e00\u4e2a\uff0c\u5982\u4e0b</p> <pre><code># \u8ffd\u52a0\u81ea\u5efaDNS\uff1a192.168.9.199\ndns-nameservers 192.168.9.199 192.168.9.253 192.168.9.252\n</code></pre> <p>\u518d\u91cd\u542f\u7f51\u7edc\u670d\u52a1</p> <pre><code>/etc/init.d/networking restart\n</code></pre> <p>\u91cd\u542f\u7f51\u7edc\u4e4b\u540e\uff0c\u8981\u68c0\u67e5<code>/etc/resolv.conf</code>\u662f\u5426\u5df2\u7ecf\u8ffd\u52a0\u6211\u4eec\u81ea\u5efa\u7684DNS\uff0c\u5e76\u68c0\u67e5\u81ea\u5b9a\u4e49\u7684\u57df\u540d\u89e3\u6790\u662f\u5426\u751f\u6548\u3002</p>"},{"location":"03.ultimate/01-prepare/#_2","title":"\u4e09\u3001\u673a\u5668\u521d\u59cb\u5316\u914d\u7f6e","text":""},{"location":"03.ultimate/01-prepare/#31-ipvsadm","title":"3.1 \u5b89\u88c5ipvsadm","text":"<p>\u5728\u6240\u6709\u4e3b\u673a\u4e0a\u64cd\u4f5c\uff0c\u5b89\u88c5ipvsadm\u540e\u7eed\u7528\u4e8e\u7ba1\u7406IPVS\uff0c\u5e76\u52a0\u8f7dk8s\u9700\u8981\u7684\u6a21\u5757</p> <pre><code># \u5b89\u88c5\napt install ipvsadm ipset sysstat conntrack -y\n# \u5199\u5165\u914d\u7f6e\ncat &gt;&gt; /etc/modules-load.d/ipvs.conf &lt;&lt;EOF \nip_vs\nip_vs_rr\nip_vs_wrr\nip_vs_sh\nnf_conntrack\nip_tables\nip_set\nxt_set\nipt_set\nipt_rpfilter\nipt_REJECT\nipip\nEOF\n# \u91cd\u65b0\u52a0\u8f7dIPVS\u7cfb\u7edf\u6a21\u5757\nsystemctl restart systemd-modules-load.service\n</code></pre> <p>\u67e5\u770b\u5df2\u8f7d\u5165\u7cfb\u7edf\u7684\u6a21\u5757</p> <pre><code>lsmod | grep -e ip_vs -e nf_conntrack\n</code></pre> <p>\u8fd4\u56de\u5982\u4e0b\u7c7b\u4f3c\u5185\u5bb9\u4ee3\u8868\u6b63\u786e\u5b89\u88c5</p> <pre><code>root@debian:/home/debian# lsmod | grep -e ip_vs -e nf_conntrack\nip_vs_sh               16384  0\nip_vs_wrr              16384  0\nip_vs_rr               16384  0\nip_vs                 184320  6 ip_vs_rr,ip_vs_sh,ip_vs_wrr\nnf_conntrack_netlink    57344  0\nnf_conntrack          176128  6 xt_conntrack,nf_nat,xt_nat,nf_conntrack_netlink,xt_MASQUERADE,ip_vs\nnf_defrag_ipv6         24576  2 nf_conntrack,ip_vs\nnf_defrag_ipv4         16384  1 nf_conntrack\nnfnetlink              20480  5 nft_compat,nf_conntrack_netlink,nf_tables,ip_set\nlibcrc32c              16384  5 nf_conntrack,nf_nat,nf_tables,raid456,ip_v\n</code></pre>"},{"location":"03.ultimate/01-prepare/#32","title":"3.2 \u4fee\u6539\u5185\u6838\u53c2\u6570","text":"<p>\u5728\u6240\u6709\u4e3b\u673a\u4e0a\u64cd\u4f5c\uff0c\u4ee5\u4e0b\u7684\u914d\u7f6e\u5728k8s\u8fd0\u884c\u65f6\u9700\u8981</p> <pre><code># \u5199\u5165\u5185\u6838\u914d\u7f6e\u6587\u4ef6\ncat &gt; /etc/sysctl.d/k8s.conf &lt;&lt;EOF\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables = 1\nnet.ipv4.ip_forward = 1\nEOF\n# \u8ba9\u914d\u7f6e\u7acb\u5373\u751f\u6548\nsysctl -p /etc/sysctl.d/k8s.conf\n</code></pre>"},{"location":"03.ultimate/01-prepare/#33","title":"3.3 \u8bbe\u7f6e\u4e3b\u673a\u540d","text":"<p><code>199-debian</code>\u8bbe\u7f6e\u4e3b\u673a\u540d\u5982\u4e0b\u547d\u4ee4</p> <pre><code>hostnamectl set-hostname 199-debian\n</code></pre> <p><code>192-debian</code>\u8bbe\u7f6e\u4e3b\u673a\u540d\u5982\u4e0b\u547d\u4ee4</p> <pre><code>hostnamectl set-hostname 192-debian\n</code></pre> <p><code>160-debian</code>\u8bbe\u7f6e\u4e3b\u673a\u540d\u5982\u4e0b\u547d\u4ee4</p> <pre><code>hostnamectl set-hostname 160-debian\n</code></pre> <p>\u5728\u6240\u6709\u4e3b\u673a\u8ffd\u52a0hosts\u89e3\u6790\uff0c\u5982\u4e0b</p> <pre><code>cat &gt;&gt; /etc/hosts &lt;&lt;EOF\n192.168.9.199   199-debian\n192.168.9.192   192-debian\n192.168.9.160   160-debian\nEOF\n</code></pre>"},{"location":"03.ultimate/02-install_containerd/","title":"\u5b89\u88c5containerd\u4f5c\u4e3aruntime","text":""},{"location":"03.ultimate/02-install_containerd/#containerd","title":"\u4e00\u3001\u52a0\u8f7dcontainerd\u6240\u9700\u7684\u6a21\u5757","text":"<p>\u5728\u6240\u6709\u8282\u70b9\u4e0a\u52a0\u8f7d<code>overlay</code>\u548c<code>br_netfilter</code>\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>modprobe overlay\nmodprobe br_netfilter\n</code></pre> <p>\u5728\u6240\u6709\u673a\u5668\u4e0a\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\uff0c\u76ee\u7684\u662f\u7cfb\u7edf\u91cd\u542f\u65f6\u6a21\u5757\u80fd\u81ea\u52a8\u52a0\u8f7d</p> <pre><code>cat &gt; /etc/modules-load.d/containerd.conf &lt;&lt;EOF\noverlay\nbr_netfilter\nEOF\n</code></pre>"},{"location":"03.ultimate/02-install_containerd/#containerd_1","title":"\u4e8c\u3001\u5b89\u88c5containerd","text":"<p>CRI \u662f\u4e00\u4e2a\u63d2\u4ef6\u63a5\u53e3\uff0c\u5b83\u4f7f kubelet \u80fd\u591f\u4f7f\u7528\u5404\u79cd\u5bb9\u5668\u8fd0\u884c\u65f6\uff0c\u65e0\u9700\u91cd\u65b0\u7f16\u8bd1\u96c6\u7fa4\u7ec4\u4ef6\u3002\u5bb9\u5668\u8fd0\u884c\u65f6\u63a5\u53e3\uff08CRI\uff09\u662f kubelet \u548c\u5bb9\u5668\u8fd0\u884c\u65f6\u4e4b\u95f4\u901a\u4fe1\u7684\u4e3b\u8981\u534f\u8bae\u3002\u6211\u4eec\u6211\u4eec\u5b89\u88c5containerd\u662f\u5e26\u6709<code>cri</code>\u7684\uff0c\u76f4\u63a5\u89e3\u538b\u5230\u6839\u76ee\u5f55\u5373\u53ef\u5b8c\u6210\u5b89\u88c5\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code># \u89e3\u538b\ntar -C / -xzvf cri-containerd-cni-1.6.4-linux-amd64.tar.gz\n</code></pre> <p>\u89e3\u538b\u5b8c\u6210\uff0ccontainerd \u5305\u542b\u7684\u5404\u4e2a\u7ec4\u4ef6\u5c06\u5b58\u5728\u7cfb\u7edf\u5bf9\u5e94\u76ee\u5f55\u4e2d\uff0c\u542f\u52a8\u670d\u52a1\u6587\u4ef6\u4e5f\u4f1a\u81ea\u52a8\u5b89\u88c5\u5230<code>/etc/systemd/system/containerd.service</code>\u3002</p>"},{"location":"03.ultimate/02-install_containerd/#containerd_2","title":"\u4e09\u3001\u521b\u5efacontainerd\u7684\u914d\u7f6e\u6587\u4ef6","text":"<p>\u521b\u5efa\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6</p> <pre><code>mkdir -p /etc/containerd\ncontainerd config default &gt; /etc/containerd/config.toml\n</code></pre> <p>\u542f\u7528SystemdCgroup</p> <pre><code># \u4fee\u6539\nsed -i \"s#SystemdCgroup\\ \\=\\ false#SystemdCgroup\\ \\=\\ true#g\" /etc/containerd/config.toml\n# \u67e5\u770b\u9a8c\u8bc1\ncat /etc/containerd/config.toml | grep SystemdCgroup\n</code></pre> <p>\u4fee\u6539\u57fa\u7840\u5bb9\u5668\u955c\u50cf\u5730\u5740\u4e3a\u963f\u91cc\u4e91</p> <pre><code># \u4fee\u6539\nsed -i \"s#k8s.gcr.io#registry.aliyuncs.com/google_containers#g\" /etc/containerd/config.toml\n# \u67e5\u770b\u9a8c\u8bc1\ncat /etc/containerd/config.toml | grep sandbox_image\n</code></pre>"},{"location":"03.ultimate/02-install_containerd/#containerd_3","title":"\u56db\u3001\u542f\u52a8containerd\u5e76\u8bbe\u7f6e\u5f00\u673a\u81ea\u542f","text":"<pre><code>systemctl daemon-reload\nsystemctl enable --now containerd\n</code></pre>"},{"location":"03.ultimate/02-install_containerd/#crictl","title":"\u4e94\u3001\u914d\u7f6ecrictl\u5ba2\u6237\u7aef\u8fde\u63a5\u7684\u8fd0\u884c\u65f6\u4f4d\u7f6e","text":"<p>crictl \u662f CRI \u517c\u5bb9\u7684\u5bb9\u5668\u8fd0\u884c\u65f6\u547d\u4ee4\u884c\u63a5\u53e3\u5373cri\u7684\u5ba2\u6237\u7aef\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u5b83\u6765\u68c0\u67e5\u548c\u8c03\u8bd5 Kubernetes \u8282\u70b9\u4e0a\u7684\u5bb9\u5668\u8fd0\u884c\u65f6\u548c\u5e94\u7528\u7a0b\u5e8f\u3002\u9700\u8981\u5728\u4e09\u53f0\u4e3b\u673a\u4e0a\u5b89\u88c5\uff0c\u4ee5\u4e0b\u662f\u5b89\u88c5\u8fc7\u7a0b</p> <pre><code># \u89e3\u538b\ntar -zxvf crictl-v1.24.2-linux-amd64.tar.gz -C /usr/bin/\n\n# \u751f\u6210\u914d\u7f6e\u6587\u4ef6\ncat &gt; /etc/crictl.yaml &lt;&lt;EOF\nruntime-endpoint: unix:///run/containerd/containerd.sock\nimage-endpoint: unix:///run/containerd/containerd.sock\ntimeout: 10\ndebug: false\nEOF\n# \u6d4b\u8bd5\nsystemctl restart  containerd\ncrictl info\n</code></pre>"},{"location":"03.ultimate/02-install_containerd/#nerdctl","title":"\u516d\u3001\u5b89\u88c5nerdctl","text":"<p>Nerdctl\u662f\u4e00\u4e2a\u76f8\u5bf9\u8f83\u65b0\u7684containerd\u547d\u4ee4\u884c\u5ba2\u6237\u7aef\u3002nerdctl\u7684\u76ee\u6807\u662f\u63d0\u4f9b\u53cb\u597d\u7684\u7528\u6237\u4f53\u9a8c\uff0c\u5e76\u548cdocker\u517c\u5bb9\u3002\u5728\u67d0\u79cd\u7a0b\u5ea6\u4e0a\uff0cnerdctl + containerd\u53ef\u4ee5\u65e0\u7f1d\u5730\u66ff\u4ee3docker + dockerd\u3002nerdctl\u7684\u76ee\u6807\u662f\u4fc3\u8fdb\u8bd5\u9a8cDocker\u4e2d\u6ca1\u6709\u7684\u6700\u524d\u6cbf\u7684\u5bb9\u5668\u7279\u6027\u3002\u9700\u8981\u5728\u4e09\u53f0\u4e3b\u673a\u4e0a\u5b89\u88c5\uff0c\u76f4\u63a5\u89e3\u538b\u5230<code>/usr/bin</code>\u76ee\u5f55\u5373\u53ef\u5b8c\u6210\u5b89\u88c5</p> <pre><code>tar -zxvf nerdctl-0.20.0-linux-amd64.tar.gz -C /usr/bin/ nerdctl\n</code></pre>"},{"location":"03.ultimate/02-install_containerd/#nerdctlcni","title":"\u4e03\u3001\u5b89\u88c5nerdctl\u6240\u9700\u8981\u7684cni\u63d2\u4ef6","text":"<p>\u5728\u4e09\u53f0\u4e3b\u673a\u4e0a\u5b89\u88c5\uff0c\u89e3\u538b\u5230\u5bf9\u5e94\u76ee\u5f55\u5373\u53ef\u5b8c\u6210\u5b89\u88c5\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>tar -zxvf cni-plugins-linux-amd64-v1.1.1.tgz -C /opt/cni/bin/\n</code></pre> <p>\u4fee\u6539<code>/etc/profile</code>\uff0c\u5728\u7b2c\u5982\u4e0b\u4e24\u884c\u6307\u4ee4\uff0c\u6267\u884c\u5982\u4e0b\u547d\u4ee4</p> <pre><code># \u8ffd\u52a0\u914d\u7f6e\ncat &gt;&gt; /etc/profile &lt;&lt;EOF\nsource &lt;(nerdctl completion bash)\nexport CONTAINERD_NAMESPACE=k8s.io\nEOF\n# \u8ba9\u914d\u7f6e\u7acb\u5373\u751f\u6548\nsource /etc/profile\n</code></pre>"},{"location":"03.ultimate/03-sign-prepare/","title":"\u8bc1\u4e66\u7b7e\u53d1 \u73af\u5883\u51c6\u5907","text":"<p>\u6211\u4eec\u628a <code>199-debian</code> \u8fd9\u53f0\u4e3b\u673a\u4f5c\u4e3a\u8fd0\u7ef4\u4e3b\u673a\uff0c\u6240\u4ee5\u63a5\u4e0b\u6765\u5f88\u591a\u64cd\u4f5c\u90fd\u5728\u8fd9\u53f0\u4e3b\u673a\u4e0a\u6267\u884c\u3002</p>"},{"location":"03.ultimate/03-sign-prepare/#cfssl","title":"\u4e00\u3001\u5b89\u88c5cfssl\u5de5\u5177","text":"<p>cfssl \u5de5\u5177\u7684\u4e0b\u8f7d\u5730\u5740\u4e3a\uff1ahttps://github.com/cloudflare/cfssl/releases</p> <p>\u6211\u4eec\u4e0b\u8f7d\u5e76\u5b89\u88c5<code>cfssl</code>\u3001<code>cfssl-json</code>\u3001<code>cfssl-certingo</code>\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code># cfssl\nwget https://github.com/cloudflare/cfssl/releases/download/1.2.0/cfssl_linux-amd64 -o /usr/local/bin/cfssl\n# cfssljson\nwget https://github.com/cloudflare/cfssl/releases/download/1.2.0/cfssljson_linux-amd64 -o /usr/local/bin/cfssljson\n# cfssl-certinfo\nwget https://github.com/cloudflare/cfssl/releases/download/1.2.0/cfssl-certinfo_linux-amd64 -o /usr/local/bin/cfssl-certinfo\n# \u8d4b\u4e88\u6267\u884c\u6743\u9650\nchmod a+x /usr/local/bin/cfssl*\n</code></pre>"},{"location":"03.ultimate/03-sign-prepare/#kubernetes","title":"\u4e8c\u3001kubernetes\u6240\u9700\u8981\u7684\u8bc1\u4e66","text":"<p>\u5728kubernetes\u91cc\u6d89\u53ca\u5230\u5f88\u591aTLS\u8ba4\u8bc1\uff0c\u6240\u4ee5\u9700\u8981\u505a\u5927\u91cf\u7684\u8bc1\u4e66\uff0c\u6982\u62ec\u5982\u4e0b\u56fe</p> <p></p> <p>\u6211\u4eec\u5c06\u751f\u6210\u7684\u5404\u4e2a\u8bc1\u4e66\u5b58\u653e\u5230<code>/etc/kubernetes/pki</code>\u91cc\u3002</p>"},{"location":"03.ultimate/03-sign-prepare/#ca","title":"\u4e09\u3001\u642d\u5efaCA","text":"<p>CA\u662f\u8bc1\u4e66\u7684\u7b7e\u53d1\u673a\u6784\uff0c\u7b7e\u53d1\u8bc1\u4e66\u7684\u524d\u63d0\u662f\u6709\u4e00\u4e2a\u7b7e\u53d1\u673a\u6784\uff0c\u4e0b\u6587\u6211\u4eec\u642d\u5efa\u81ea\u5df1\u7684\u7b7e\u53d1\u673a\u6784\u3002</p>"},{"location":"03.ultimate/03-sign-prepare/#31-ca","title":"3.1 \u751f\u6210CA\u914d\u7f6e","text":"<p>\u751f\u6210CA\u914d\u7f6e</p> <pre><code>cat &gt; /etc/kubernetes/pki/ca-config.json &lt;&lt;EOF\n{\n    \"signing\": {\n        \"default\": {\n            \"expiry\": \"175200h\"\n        },\n        \"profiles\": {\n            \"www\": {\n                \"expiry\": \"175200h\",\n                \"usages\": [\n                    \"signing\",\n                    \"key encipherment\",\n                    \"server auth\",\n                    \"client auth\"\n                ]\n            }\n        }\n    }\n}\nEOF\n</code></pre>"},{"location":"03.ultimate/03-sign-prepare/#32-ca","title":"3.2 \u751f\u6210CA\u8bc1\u4e66\u8bf7\u6c42\u6587\u4ef6","text":"<pre><code># \u751f\u6210\u8bc1\u4e66\u8bf7\u6c42\u6587\u4ef6\ncat &gt; /etc/kubernetes/pki/ca-csr.json &lt;&lt;EOF\n{\n    \"CN\": \"kubernetes\",\n    \"key\": {\n        \"algo\": \"rsa\",\n        \"size\": 2048\n    },\n    \"names\": [\n        {\n            \"C\": \"CN\",\n            \"L\": \"Guangzhou\",\n            \"ST\": \"Guangdong\",\n            \"O\": \"kubernetes\",\n            \"OU\": \"system\"\n        }\n    ],\n    \"ca\": {\n        \"expiry\": \"175200h\"\n    }\n}\nEOF\n</code></pre> <p>\u8bc1\u4e66\u6839\u5b57\u6bb5\u8bf4\u660e</p> <ul> <li><code>CN</code>\uff1a\u8bc1\u4e66\u540d\u79f0</li> <li><code>key</code>\uff1a\u5b9a\u4e49\u8bc1\u4e66\u7c7b\u578b\uff0calgo\u4e3a\u52a0\u5bc6\u7c7b\u578b\uff0csize\u4e3a\u52a0\u5bc6\u957f\u5ea6</li> <li><code>ca.expiry</code>\uff1a\u8bc1\u4e66\u6709\u6548\u65f6\u95f4</li> </ul> <p>names\u6761\u76ee\u5b57\u6bb5\u8bf4\u660e</p> <ul> <li><code>CN</code>: Common Name\uff0c\u4e00\u822c\u4f7f\u7528\u57df\u540d</li> <li><code>C</code>: Country Code\uff0c\u7533\u8bf7\u5355\u4f4d\u6240\u5c5e\u56fd\u5bb6\uff0c\u53ea\u80fd\u662f\u4e24\u4e2a\u5b57\u6bcd\u7684\u56fd\u5bb6\u7801\u3002\u4f8b\u5982\uff0c\u4e2d\u56fd\u53ea\u80fd\u662fCN\u3002</li> <li><code>ST</code>: State or Province\uff0c\u7701\u4efd\u540d\u79f0\u6216\u81ea\u6cbb\u533a\u540d\u79f0</li> <li><code>L</code>: Locality\uff0c\u57ce\u5e02\u6216\u81ea\u6cbb\u5dde\u540d</li> <li><code>O</code>: Organization name\uff0c\u7ec4\u7ec7\u540d\u79f0\u3001\u516c\u53f8\u540d\u79f0</li> <li><code>OU</code>: Organization Unit Name\uff0c\u7ec4\u7ec7\u5355\u4f4d\u540d\u79f0\u3001\u516c\u53f8\u90e8\u95e8</li> </ul> <p>ca\u7684expiry\u5b57\u6bb5\u4ee3\u8868\u6709\u6548\u65f6\u95f4\uff0c175200h\u4ee3\u886820\u5e74</p>"},{"location":"03.ultimate/03-sign-prepare/#23-ca","title":"2.3 \u751f\u6210CA\u81ea\u7b7e\u540d\u6839\u8bc1\u4e66","text":"<pre><code>cfssl gencert -initca ca-csr.json | cfssljson -bare ca\n</code></pre> <p>\u6700\u540e\u4e00\u4e2a\u53c2\u6570\u6307\u5b9a\u4e86\u8bc1\u4e66\u6587\u4ef6\u540d\uff0c\u6700\u540e\u751f\u6210\u4ee5\u4e0b\u4e09\u4e2a\u6587\u4ef6</p> <ul> <li><code>ca.csr</code>:  \u8bc1\u4e66\u7b7e\u540d\u7533\u8bf7\uff08Certificate Signing Request\uff09\u6587\u4ef6</li> <li><code>ca.pem</code>: ca\u516c\u94a5\u8bc1\u4e66</li> <li><code>ca-key.pem</code>: ca\u79c1\u94a5\u8bc1\u4e66</li> </ul> <p>\u751f\u6210\u7684\u4e09\u4e2a\u6587\u4ef6\u4e5f\u5c31\u662f\u6839\u8bc1\u4e66\u5305\u542b\u7684\u5185\u5bb9\u3002\u5728\u540e\u7eed\uff0c\u6211\u4eec\u7ed9\u5404\u4e2a\u670d\u52a1\u9881\u53d1\u8bc1\u4e66\u7684\u65f6\u5019\uff0c\u90fd\u57fa\u4e8eCA\u6839\u8bc1\u4e66\u6765\u9881\u53d1\u3002</p>"},{"location":"03.ultimate/03-sign-prepare/#front-proxy-client","title":"\u56db\u3001\u751f\u6210front-proxy-client\u805a\u5408\u5c42\u5ba2\u6237\u7aef\u8bc1\u4e66","text":"<p>\u5982\u679c\u6ca1\u6709\u4f7f\u7528\u5230\u805a\u5408\u5c42\uff08Aggregation Layer\uff09\uff0c\u5219\u4e0d\u9700\u8981\u505a\u5982\u4e0b\u547d\u4ee4\uff0c\u5982\u679c\u9700\u8981\u5219\u6267\u884c\u5982\u4e0b\u6b65\u9aa4\u64cd\u4f5c\u3002</p>"},{"location":"03.ultimate/03-sign-prepare/#41-front-proxy-clientca","title":"4.1 \u642d\u5efafront-proxy-client\u805a\u5408\u5c42CA","text":"<p>\u6211\u4eec\u76f4\u63a5\u590d\u5236CA\u7684\u914d\u7f6e\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>cp ca-config.json front-proxy-ca-config.json\ncp ca-csr.json front-proxy-ca-csr.json\n</code></pre> <p>\u751f\u6210\u805a\u5408\u5c42CA</p> <pre><code>cfssl gencert -initca front-proxy-ca-csr.json | cfssljson -bare front-proxy-ca\n</code></pre>"},{"location":"03.ultimate/03-sign-prepare/#42-front-proxy-client","title":"4.2 \u751f\u6210front-proxy-client\u805a\u5408\u5c42\u5ba2\u6237\u7aef\u8bc1\u4e66","text":"<p>\u5b9a\u4e49\u8bc1\u4e66\u4fe1\u606f</p> <pre><code>cat &gt; /etc/kubernetes/pki/front-proxy-client-csr.json &lt;&lt;EOF\n{\n  \"CN\": \"front-proxy-client\",\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"L\": \"Guangzhou\",\n      \"ST\": \"Guangdong\",\n      \"O\": \"kubernetes\",\n      \"OU\": \"system\"\n    }\n  ]\n}\nEOF\n</code></pre> <p>\u751f\u6210\u8bc1\u4e66</p> <pre><code>cfssl gencert -ca=front-proxy-ca.pem -ca-key=front-proxy-ca-key.pem -config=front-proxy-ca-config.json -profile=www front-proxy-client-csr.json | cfssljson  -bare front-proxy-client\n</code></pre>"},{"location":"03.ultimate/03-sign-prepare/#kubernetes_1","title":"\u4e94\u3001\u9881\u53d1kubernetes\u5404\u4e2a\u670d\u52a1\u6240\u9700\u7684\u8bc1\u4e66","text":""},{"location":"03.ultimate/03-sign-prepare/#51-etcd","title":"5.1 etcd\u670d\u52a1\u5668","text":"<p>\u5b9a\u4e49\u8bc1\u4e66\u4fe1\u606f</p> <pre><code>cat &gt; /etc/kubernetes/pki/etcd-csr.json &lt;&lt;EOF\n{\n    \"CN\": \"etcd\",\n    \"hosts\": [\n        \"127.0.0.1\",\n        \"192.168.9.199\",\n        \"192.168.9.192\",\n        \"192.168.9.160\",\n        \"192.168.9.190\"\n    ],\n    \"key\": {\n        \"algo\": \"rsa\",\n        \"size\": 2048\n    },\n    \"names\": [{\n        \"C\": \"CN\",\n        \"ST\": \"Guangdong\",\n        \"L\": \"Guangzhou\",\n        \"O\": \"kubernetes\",\n        \"OU\": \"system\"\n    }]\n}\nEOF\n</code></pre> <p>\u751f\u6210\u8bc1\u4e66</p> <pre><code>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www etcd-csr.json | cfssljson -bare etcd\n</code></pre>"},{"location":"03.ultimate/03-sign-prepare/#52-kube-apiserver","title":"5.2 kube-apiserver","text":"<p>k8s\u7684\u5176\u4ed6\u7ec4\u4ef6\u8ddfapiserver\u8981\u8fdb\u884c\u53cc\u5411TLS\uff08mTLS\uff09\u8ba4\u8bc1\uff0c\u6240\u4ee5apiserver\u9700\u8981\u6709\u81ea\u5df1\u7684\u8bc1\u4e66\uff0c\u4ee5\u4e0b\u5b9a\u4e49\u8bc1\u4e66\u7533\u8bf7\u6587\u4ef6</p> <pre><code>cat &gt; /etc/kubernetes/pki/apiserver-csr.json &lt;&lt;EOF\n{\n    \"CN\": \"apiserver\",\n    \"key\": {\n        \"algo\": \"rsa\",\n        \"size\": 2048\n    },\n    \"hosts\": [\n        \"127.0.0.1\",\n        \"10.96.0.1\",\n        \"192.168.0.1\",\n        \"192.168.9.199\",\n        \"192.168.9.192\",\n        \"192.168.9.160\",\n        \"192.168.9.190\",\n        \"kubernetes\",\n        \"kubernetes.default\",\n        \"kubernetes.default.svc\",\n        \"kubernetes.default.svc.cluster\",\n        \"kubernetes.default.svc.cluster.local\"\n    ],\n    \"names\": [{\n        \"C\": \"CN\",\n        \"ST\": \"Guangdong\",\n        \"L\": \"Guangzhou\",\n        \"O\": \"kubernetes\",\n        \"OU\": \"system\"\n    }]\n}\nEOF\n</code></pre> <p>\u8be5\u8bc1\u4e66\u540e\u7eed\u88ab kubernetes master \u96c6\u7fa4\u4f7f\u7528\uff0c\u9700\u8981\u5c06master\u8282\u70b9\u7684IP\u90fd\u586b\u4e0a\uff0c\u540c\u65f6\u8fd8\u9700\u8981\u586b\u5199 service \u7f51\u7edc\u7684\u7b2c\u4e00\u4e2aIP\uff08\u8fd9\u91cc\u586b10.96.0.1\u548c192.168.0.1\uff09\uff0c\u540e\u7eed\u53ef\u80fd\u52a0\u5230\u96c6\u7fa4\u91cc\u7684IP\u90fd\u586b\u5199\u4e0a\u53bb\u3002</p> <p>\u751f\u6210\u8bc1\u4e66</p> <pre><code>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www apiserver-csr.json | cfssljson -bare apiserver\n</code></pre> <p>\u8bc1\u4e66\u7528\u4e8e\u8fde\u63a5etcd\u670d\u52a1\u5668\u3001\u8fde\u63a5keubelet\u4f7f\u7528\u7684SSL\u8bc1\u4e66\uff0c\u4e5f\u7528\u4e8e\u672c\u8eab\u670d\u52a1\u7684\u8bc1\u4e66\u3002</p>"},{"location":"03.ultimate/03-sign-prepare/#53-kube-controller-manager","title":"5.3 kube-controller-manager","text":"<p>controller-manager\u9700\u8981\u8ddfapiserver\u8fdb\u884cmTLS\u8ba4\u8bc1\uff0c\u5b9a\u4e49\u8bc1\u4e66\u7533\u8bf7\u6587\u4ef6\u5982\u4e0b</p> <pre><code>cat &gt; /etc/kubernetes/pki/controller-manager-csr.json &lt;&lt;EOF\n{\n  \"CN\": \"system:kube-controller-manager\",\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n   \"hosts\": [\n     \"127.0.0.1\",\n     \"192.168.9.199\",\n     \"192.168.9.192\",\n     \"192.168.9.160\"\n    ],\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"Guangdong\",\n      \"L\": \"Guangzhou\",\n      \"O\": \"system:kube-controller-manager\",\n      \"OU\": \"system\"\n    }\n  ]\n}\nEOF\n</code></pre> <p>hosts \u5217\u8868\u5305\u542b\u6240\u6709 kube-controller-manager \u8282\u70b9 IP\uff1bCN \u4e3a system:kube-controller-manager\uff0cO \u4e3a system:kube-controller-manager\uff0ck8s\u91cc\u5185\u7f6e\u7684ClusterRoleBindings system:kube-controller-manager \u6388\u6743 kube-controller-manager\u6240\u9700\u7684\u6743\u9650\u3002\u540e\u9762\u7ec4\u4ef6\u8bc1\u4e66\u90fd\u505a\u7c7b\u4f3c\u64cd\u4f5c\u3002\u751f\u6210\u8bc1\u4e66\u547d\u4ee4\u5982\u4e0b</p> <pre><code>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www controller-manager-csr.json | cfssljson -bare controller-manager\n</code></pre>"},{"location":"03.ultimate/03-sign-prepare/#54-kube-scheduler","title":"5.4 kube-scheduler","text":"<p>kube-scheduler\u9700\u8981\u8ddfapiserver\u8fdb\u884cmTLS\u8ba4\u8bc1\uff0c\u751f\u6210\u8bc1\u4e66\u7533\u8bf7\u6587\u4ef6\u5982\u4e0b</p> <pre><code>cat &gt; /etc/kubernetes/pki/scheduler-csr.json &lt;&lt;EOF\n{\n  \"CN\": \"system:kube-scheduler\",\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n   \"hosts\": [\n     \"127.0.0.1\",\n     \"192.168.9.199\",\n     \"192.168.9.192\",\n     \"192.168.9.160\"\n    ],\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"Guangdong\",\n      \"L\": \"Guangzhou\",\n      \"O\": \"system:kube-scheduler\",\n      \"OU\": \"system\"\n    }\n  ]\n}\nEOF\n</code></pre> <p>kubernetes\u5185\u7f6e\u7684ClusterRoleBindings system:kube-scheduler\u5c06\u6388\u6743kube-scheduler\u6240\u9700\u7684\u6743\u9650\u3002\u751f\u6210\u8bc1\u4e66\u547d\u4ee4\u5982\u4e0b</p> <pre><code>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www scheduler-csr.json | cfssljson -bare scheduler\n</code></pre>"},{"location":"03.ultimate/03-sign-prepare/#55-kube-proxy","title":"5.5 kube-proxy","text":"<p>kube-proxy\u9700\u8981\u8ddfapiserver\u8fdb\u884cmTLS\u8ba4\u8bc1\uff0c\u751f\u6210\u8bc1\u4e66\u7533\u8bf7\u8bf7\u6c42\u6587\u4ef6\u5982\u4e0b</p> <pre><code>cat &gt; /etc/kubernetes/pki/proxy-csr.json &lt;&lt;EOF\n{\n  \"CN\": \"system:kube-proxy\",\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"Guangdong\",\n      \"L\": \"Guangzhou\",\n      \"O\": \"kubernetes\",\n      \"OU\": \"system\"\n    }\n  ]\n}\nEOF\n</code></pre> <p>\u751f\u6210\u8bc1\u4e66</p> <pre><code>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www proxy-csr.json | cfssljson -bare proxy\n</code></pre>"},{"location":"03.ultimate/03-sign-prepare/#56-admin","title":"5.6 \u7ba1\u7406\u5458admin\u80fd\u7528\u7684\u8bc1\u4e66","text":"<p>\u521b\u5efa\u8bc1\u4e66\u4fe1\u606f</p> <pre><code>cat &gt; /etc/kubernetes/pki/admin-csr.json &lt;&lt; EOF \n{\n  \"CN\": \"admin\",\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"Guangzhou\",\n      \"L\": \"Guangdong\",\n      \"O\": \"system:masters\",\n      \"OU\": \"system\"\n    }\n  ]\n}\nEOF\n</code></pre> <p>\u751f\u6210\u8bc1\u4e66</p> <pre><code>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www admin-csr.json | cfssljson -bare admin\n</code></pre>"},{"location":"03.ultimate/03-sign-prepare/#_2","title":"\u516d\u3001\u540c\u6b65\u8bc1\u4e66","text":"<p>\u5728<code>199-denbian</code>\u751f\u6210\u8bc1\u4e66\u4e4b\u540e\uff0c\u5c06\u8bc1\u4e66\u76ee\u5f55<code>/etc/kubernetes/pki</code>\u540c\u6b65\u5230\u5176\u4ed6\u4e3b\u673a\u3002</p>"},{"location":"03.ultimate/04-install-ectd/","title":"\u5b89\u88c5etcd","text":"<p>\u6211\u4eec\u5c06\u4f7f\u7528<code>199-debian</code>\u3001<code>192-debian</code>\u3001<code>160-debian</code>\u8fd9\u4e09\u53f0\u4e3b\u673a\u642d\u5efaectd\u96c6\u7fa4\u3002</p>"},{"location":"03.ultimate/04-install-ectd/#etcd_1","title":"\u4e00\u3001etcd\u76f8\u5173\u53c2\u6570","text":"<p>\u5e38\u89c1\u53c2\u6570\u8bf4\u660e\u8bf4\u4e0b</p> \u53c2\u6570 \u5bf9\u5e94\u73af\u5883\u53d8\u91cf \u8bf4\u660e --name ETCD_NAME \u5f53\u524detcd\u7684\u552f\u4e00\u540d\u79f0\uff0c\u8981\u4fdd\u8bc1\u548c\u5176\u4ed6\u8282\u70b9\u4e0d\u51b2\u7a81 --data-dir ETCD_DATA_DIR \u6307\u5b9aetcd\u5b58\u50a8\u6570\u636e\u7684\u5b58\u50a8\u4f4d\u7f6e --listen-peer-urls ETCD_LISTEN_PEER_URLS \u7aef\u5bf9\u7aef\u7684\u901a\u4fe1url\uff0c\u5305\u542b\u4e3b\u673a\u5730\u5740\u548c\u7aef\u53e3\u53f7\uff0c\u6307\u5b9a\u5f53\u524detcd\u548c\u5176\u4ed6\u8282\u70b9etcd\u901a\u4fe1\u65f6\u7684\u670d\u52a1\u5730\u5740\u548c\u7aef\u53e3\u3002 --listen-client-urls ETCD_LISTEN_CLIENT_URLS \u6307\u5b9a\u5f53\u524detcd\u63a5\u6536\u5ba2\u6237\u7aef\u6307\u4ee4\u7684\u5730\u5740\u548c\u7aef\u53e3\uff0c\u5728\u8fd9\u91cc\u7684\u5ba2\u6237\u7aef\u6211\u4eec\u6307\u7684\u662fk8s\u96c6\u7fa4\u7684master\u8282\u70b9 --initial-advertise-peer-urls ETCD_INITIAL_ADVERTISE_PEER_URLS \u6307\u5b9aetcd\u5e7f\u64ad\u7aef\u53e3\uff0c\u5f53\u524detcd\u4f1a\u5c06\u6570\u636e\u540c\u6b65\u5230\u5176\u4ed6\u8282\u70b9\uff0c\u901a\u8fc72380\u7aef\u53e3\u53d1\u9001 --advertise-client-urls ETCD_ADVERTISE_CLIENT_URLS \u7ed9\u5ba2\u6237\u7aef\u901a\u544a\u7684\u7aef\u53e3 --initial-cluster ETCD_INITIAL_CLUSTER \u5b9a\u4e49etcd\u96c6\u7fa4\u4e2d\u6240\u6709\u8282\u70b9\u7684\u540d\u79f0\u548cIP\uff0c\u4ee5\u53ca\u901a\u4fe1\u7aef\u53e3 --initial-cluster-token ETCD_INITIAL_CLUSTER_TOKEN \u5b9a\u4e49etcd\u4e2d\u7684token\uff0c\u6240\u6709\u8282\u70b9\u7684token\u5fc5\u987b\u4fdd\u6301\u4e00\u81f4 --initial-cluster-state ETCD_INITIAL_CLUSTER_STATE \u5b9a\u4e49etcd\u96c6\u7fa4\u7684\u72b6\u6001\uff0cnew\u4ee3\u8868\u65b0\u5efa\u96c6\u7fa4\uff0cexisting\u4ee3\u8868\u52a0\u5165\u73b0\u6709\u96c6\u7fa4"},{"location":"03.ultimate/04-install-ectd/#_1","title":"\u4e8c\u3001\u5b89\u88c5","text":"<p>\u5148\u521b\u5efaetcd\u9ed8\u8ba4\u7684\u914d\u7f6e\u6587\u4ef6\u76ee\u5f55\u548c\u6570\u636e\u76ee\u5f55</p> <pre><code>mkdir -p /var/lib/etcd/\n</code></pre> <p>\u5b89\u88c5\u5230<code>/opt</code>\u76ee\u5f55\uff0c\u540e\u7eed\u7684k8s\u96c6\u7fa4\u7ec4\u4ef6\u6211\u4eec\u5c06\u90fd\u5b89\u88c5\u5728\u6b64</p> <pre><code># \u89e3\u538b\ntar -zxvf etcd-v3.5.4-linux-amd64.tar.gz\n# \u5c06etc\u79fb\u5230/opt\u76ee\u5f55\uff0c\u5e76\u4fee\u6539etcd\u76ee\u5f55\u540d\nmv etcd-v3.5.4-linux-amd64/ /opt/etcd-v3.5.4\n# \u521b\u5efaetcd\u8f6f\u94fe\u63a5\nln -s /opt/etcd-v3.5.4 /opt/etcd\n</code></pre>"},{"location":"03.ultimate/04-install-ectd/#etcd_2","title":"\u4e09\u3001\u7f16\u5199etcd\u542f\u52a8\u811a\u672c","text":"<p>\u6211\u4eec\u5148\u5728etcd\u76ee\u5f55\u7f16\u5199\u542f\u52a8\u811a\u672c<code>/opt/etcd/startup.sh</code>\uff0c\u5982\u4e0b</p> <pre><code>#!/bin/bash\n./etcd \\\n--name=\"etcd-server-199\" \\\n--data-dir=\"/var/lib/etcd/\" \\\n--listen-peer-urls=\"https://192.168.9.199:2380\" \\\n--listen-client-urls=\"https://192.168.9.199:2379,http://127.0.0.1:2379\" \\\n--initial-advertise-peer-urls=\"https://192.168.9.199:2380\" \\\n--advertise-client-urls=\"https://192.168.9.199:2379\" \\\n--initial-cluster=\"etcd-server-199=https://192.168.9.199:2380,etcd-server-192=https://192.168.9.192:2380,etcd-server-160=https://192.168.9.160:2380\" \\\n--initial-cluster-token=\"etcd-cluster\" \\\n--initial-cluster-state=\"new\" \\\n--cert-file=\"/etc/kubernetes/pki/etcd.pem\" \\\n--key-file=\"/etc/kubernetes/pki/etcd-key.pem\" \\\n--trusted-ca-file=\"/etc/kubernetes/pki/ca.pem\" \\\n--peer-cert-file=\"/etc/kubernetes/pki/etcd.pem\" \\\n--peer-key-file=\"/etc/kubernetes/pki/etcd-key.pem\" \\\n--peer-trusted-ca-file=\"/etc/kubernetes/pki/ca.pem\" \\\n--peer-client-cert-auth \\\n--client-cert-auth\n</code></pre> <p>\u7ed9\u542f\u52a8\u811a\u672c\u6dfb\u52a0\u6743\u9650</p> <pre><code>chmod +x /opt/etcd/startup.sh\n</code></pre>"},{"location":"03.ultimate/04-install-ectd/#supervisoretcd","title":"\u56db\u3001\u4f7f\u7528supervisor\u6765\u542f\u52a8etcd","text":"<p>\u73b0\u5728\u6211\u4eec\u8981\u5b89\u88c5supervisor\uff0c\u7528\u4e8e\u7ba1\u7406etcd\u670d\u52a1\uff0c\u540e\u7eed\u7684k8s\u76f8\u5173\u7ec4\u4ef6\uff0c\u6211\u4eec\u90fd\u7528supervisor\u6765\u7ba1\u7406</p> <pre><code># \u5b89\u88c5supervisor\napt install supervisor -y\n# \u542f\u52a8supervisor\nsystemctl start supervisor\n# \u8ba9superivisor\u5f00\u673a\u81ea\u542f\nsystemctl enable supervisor\n</code></pre> <p>\u6dfb\u52a0etcd\u7684supervisor\u8fdb\u7a0b\u7ef4\u62a4\u811a\u672c<code>/etc/supervisor/conf.d/etcd-server.conf</code>\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>[program:etcd-server-199]\ndirectory=/opt/etcd\ncommand=/opt/etcd/startup.sh\nnumprocs=1\nautostart=true\nautorestart=true\nstartsecs=30\nstartretries=3\nexitcodes=0,2\nstopsignal=QUIT\nstopwaitsecs=10\nuser=root\nredirect_stderr=true\nstdout_logfile=/data/logs/supervisor/etcd.stdout.log\nstdout_logfile_maxbytes=64MB\nstdout_logfile_backups=4\nstdout_capture_maxbytes=1MB\nstdout_event_enabled=false\n</code></pre> <p>\u6ce8\u610f\uff1a\u5728\u4e0d\u540c\u7684\u4e3b\u673a\u4e0a\u4f7f\u7528\u4e0d\u540c\u7684\u670d\u52a1\u540d\u79f0\uff0c\u8fd9\u6837\u597d\u8fa8\u522b\uff0c\u5982199-debian\u4f7f\u7528<code>etcd-server-199</code>\uff0c\u5982192-debian\u4f7f\u7528<code>etcd-server-192</code></p> <p>supervisor\u76f8\u5173\u53c2\u6570\uff1a</p> <ul> <li><code>program</code>: \u7a0b\u5e8f\u540d\u79f0</li> <li><code>directory</code>: \u811a\u672c\u76ee\u5f55</li> <li><code>command</code>: \u542f\u52a8\u7684\u547d\u4ee4</li> <li><code>numprocs</code>: \u542f\u52a8\u7684\u8fdb\u7a0b\u6570</li> <li><code>autostart</code>: \u662f\u5426\u5f00\u542f\u81ea\u52a8\u542f\u52a8</li> <li><code>autorestart</code>: \u662f\u5426\u81ea\u52a8\u91cd\u542f</li> <li><code>startsecs</code>: \u542f\u52a8\u4e4b\u540e\u591a\u5c11\u65f6\u95f4\u540e\u5224\u5b9a\u4e3a\u5df2\u8d77\u6765</li> <li><code>startretries</code>: \u91cd\u542f\u6b21\u6570</li> <li><code>exitcodes</code>: \u9000\u51fa\u7684code</li> <li><code>stopsignal</code>: \u505c\u6b62\u4fe1\u53f7</li> <li><code>stopwaitsecs</code>: \u505c\u6b62\u7b49\u5f85\u7684\u65f6\u95f4</li> <li><code>redirect_stderr</code>: \u662f\u5426\u91cd\u5b9a\u5411\u6807\u51c6\u8f93\u51fa</li> <li><code>stdout_logfile</code>: \u8fdb\u7a0b\u6807\u51c6\u8f93\u51fa\u5185\u5bb9\u5199\u5165\u6587\u4ef6</li> <li><code>stdout_logfile_maxbytes</code>: stdout_logfile\u6587\u4ef6\u505alog\u6eda\u52a8\u65f6\uff0c\u5355\u4e2astdout_logfile\u6587\u4ef6\u7684\u6700\u5927\u5b57\u8282\u6570\uff0c\u9ed8\u8ba450M\uff0c\u8bbe\u7f6e\u4e3a0\u5219\u8ba4\u4e3a\u4e0d\u505alog\u6eda\u52a8\u65b9\u5f0f</li> <li><code>stdout_logfile_backups</code>: stdout_logfile\u5907\u4efd\u6587\u4ef6\u4e2a\u6570\uff0c\u9ed8\u8ba4\u4e3a10</li> <li><code>stdout_capture_maxbytes</code>: \u5f53\u8fdb\u7a0b\u5904\u4e8estdout capture mode\u6a21\u5f0f\u7684\u65f6\u5019\uff0c\u5199\u5165capture FIFO\u7684\u6700\u5927\u5b57\u8282\u6570\u9650\u5236\uff0c\u9ed8\u8ba4\u4e3a0\uff0c\u6b64\u65f6\u8ba4\u4e3astdout capture mode\u6a21\u5f0f\u5173\u95ed</li> <li><code>stdout_event_enabled</code>: \u5982\u679c\u8bbe\u7f6e\u4e3atrue\uff0c\u5728\u8fdb\u7a0b\u5199\u5165\u6807\u51c6\u6587\u4ef6\u662f\u4f1a\u53d1\u8d77PROCESS_LOG_STDOUT</li> </ul> <p>\u66f4\u65b0supervisod\u914d\u7f6e\u6587\u4ef6</p> <p>```shell\u00b7</p>"},{"location":"03.ultimate/04-install-ectd/#supervisor","title":"\u521b\u5efasupervisor\u65e5\u5fd7\u76ee\u5f55","text":"<p>mkdir -p /data/logs/supervisor/</p>"},{"location":"03.ultimate/04-install-ectd/#supervisod","title":"\u66f4\u65b0supervisod\u914d\u7f6e","text":"<p>supervisorctl update <pre><code>\u901a\u8fc7`supervisorctl status`\u67e5\u8be2supervisord\u72b6\u6001\uff0c\u770b\u5230\u5982\u4e0b\u5185\u5bb9\uff0c\u4ee3\u8868supervisor\u6b63\u5e38\u8fd0\u884c\n\n```shell\nroot@debian:/opt/etcd# supervisorctl status\netcd-server-199                  RUNNING   pid 85297, uptime 0:04:38\n</code></pre></p> <p>\u6b64\u65f6\uff0c\u6211\u4eec\u518d\u4f7f\u7528<code>netstat -luntp | grep etcd</code>\u67e5\u770b\u7f51\u7edc\u670d\u52a1\u7aef\u53e3\uff0c\u770b\u5230\u5982\u4e0b\u4fe1\u606f\u4ee3\u8868etcd\u5df2\u7ecf\u6b63\u5e38\u542f\u52a8</p> <pre><code>root@debian:/opt/etcd# netstat -luntp | grep etcd\ntcp        0      0 192.168.9.199:2379      0.0.0.0:*               LISTEN      85298/./etcd        tcp        0      0 127.0.0.1:2379          0.0.0.0:*               LISTEN      85298/./etcd        tcp        0      0 192.168.9.199:2380      0.0.0.0:*               LISTEN      85298/./etcd\n</code></pre>"},{"location":"03.ultimate/04-install-ectd/#_2","title":"\u4e94\u3001\u96c6\u7fa4\u9a8c\u8bc1","text":"<p>\u4e3a\u4e86\u65b9\u4fbf\u76f4\u63a5\u8c03\u7528<code>etcdctl</code>\u547d\u4ee4\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u521b\u5efa\u5176\u8f6f\u8fde\u63a5</p> <pre><code>ln -s /opt/etcd/etcdctl /usr/local/bin/etcdctl\n</code></pre> <p>\u6211\u4eec\u5728\u4efb\u610f\u8282\u70b9\u4f7f\u7528etcdctl\u547d\u4ee4\u68c0\u67e5\u96c6\u7fa4\u72b6\u6001\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u8981\u786e\u5207\u6307\u5b9a\u8bc1\u4e66\u7684\u4f4d\u7f6e</p> <pre><code>etcdctl --cacert=\"/etc/kubernetes/pki/ca.pem\" --cert=\"/etc/kubernetes/pki/etcd.pem\" --key=\"/etc/kubernetes/pki/etcd-key.pem\" --endpoints=\"https://192.168.9.199:2379,https://192.168.9.192:2379,https://192.168.9.160:2379\" endpoint status --write-out=table\n</code></pre> <p>\u5982\u679c\u770b\u5230\u5982\u4e0b\u8f93\u51fa\uff0c\u4ee3\u8868 ectd \u96c6\u7fa4\u642d\u5efa\u6210\u529f</p> <pre><code>+----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+\n|          ENDPOINT          |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |\n+----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+\n| https://192.168.9.199:2379 | c8815bb4b21730b3 |   3.5.4 |  311 kB |      true |      false |         3 |      37628 |              37628 |        |\n| https://192.168.9.192:2379 | f30299e8a0b43b4d |   3.5.4 |  311 kB |     false |      false |         3 |      37628 |              37628 |        |\n| https://192.168.9.160:2379 | 61c90f737ccf2682 |   3.5.4 |  311 kB |     false |      false |         3 |      37628 |              37628 |        |\n+----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+\n</code></pre> <p>\u4e3a\u4e86\u9a8c\u8bc1etcd\u96c6\u7fa4\u662f\u5426\u6b63\u5e38\u5de5\u4f5c\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u73b0\u5728<code>199-debian</code>\u8bbe\u7f6e\u4e00\u4e2a\u503c\uff0c\u5982\u4e0b</p> <pre><code>etcdctl put name lixiaoming123\n</code></pre> <p>\u518d\u901a\u8fc7<code>192-debian</code>\u548c<code>160-debian</code>\u53bb\u8bfb\u53d6\u503c\uff0c\u5982\u679c\u6b63\u5e38\u53d6\u5230\uff0c\u4ee3\u8868etcd\u96c6\u7fa4\u6b63\u5e38\u5de5\u4f5c\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>etcdctl get name\n</code></pre> <p>\u5982\u679c\u9700\u8981\u4e86\u89e3<code>etcdctl</code>\u8fd9\u4e2a\u6307\u4ee4\u7684\u66f4\u591a\u7528\u6cd5\uff0c\u4f7f\u7528<code>--help</code>\u53c2\u6570\u5373\u53ef\u67e5\u770b\u3002</p>"},{"location":"03.ultimate/05-install-apiserver/","title":"\u5b89\u88c5apiserver","text":"<p>\u642d\u5efa\u597detcd\u6570\u636e\u5e93\u96c6\u7fa4\u4e4b\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5b89\u88c5apiserver\u7ec4\u4ef6\u4e86\uff0c\u5728\u6240\u6709\u4e3b\u673a\u4e0a\u5b89\u88c5apiserver\uff0c\u4ee5\u4e0b\u662f\u5177\u4f53\u7684\u5b89\u88c5\u8fc7\u7a0b\u3002</p>"},{"location":"03.ultimate/05-install-apiserver/#kubelet","title":"\u4e00\u3001\u521b\u5efakubelet\u6388\u6743\u7528\u6237","text":"<p>\u56e0\u4e3a\u540e\u9762\u8981\u914d\u7f6ekubelet\u7684bootstrap\u8ba4\u8bc1\uff0c\u5373kubelet\u542f\u52a8\u65f6\u81ea\u52a8\u521b\u5efaCSR\u8bf7\u6c42\uff0c\u8fd9\u91cc\u9700\u8981\u5728apiserver\u4e0a\u5f00\u542ftoken\u7684\u8ba4\u8bc1\u3002\u6240\u4ee5\u5148\u5728master\u4e0a\u751f\u6210\u4e00\u4e2a\u968f\u673a\u503c\u4f5c\u4e3atoken\u3002\u4e0b\u9762\u5728\u4e00\u53f0\u4e3b\u673a\u64cd\u4f5c\u5373\u53ef</p> <pre><code># \u521b\u5efa\u8bc1\u4e66\u76ee\u5f55\nopenssl rand -hex 10\n</code></pre> <p>\u5047\u8bbe\u751f\u6210\u7684token\u4e3a<code>88c916f382dc619a6bca</code>\uff0c\u628a\u8fd9\u4e2atoken\u5199\u5165\u5230\u4e00\u4e2a\u6587\u4ef6\u91cc\uff0c\u8fd9\u91cc\u5199\u5165\u5230 <code>/etc/kubernetes/bb.csv</code>\uff0c\u5982\u4e0b</p> <pre><code>cat &gt; /etc/kubernetes/bb.csv &lt;&lt;EOF\n6440328e1b3a1f4873dc,kubelet-bootstrap,10001,\"system:node-bootstrapper\"\nEOF\n</code></pre> <p>\u8fd9\u91cc\u7b2c\u4e8c\u5217\u5b9a\u4e49\u4e86\u4e00\u4e2a\u7528\u6237\u540dkubelet-bootstrap\uff0c\u540e\u9762\u5728\u914d\u7f6ekubelet\u65f6\u4f1a\u4e3a\u6b64\u7528\u6237\u6388\u6743\u3002\u521b\u5efa\u597d\u8be5\u6587\u4ef6\u540e\uff0c\u540c\u6b65\u5230\u5176\u4ed6\u4e3b\u673a\u3002</p>"},{"location":"03.ultimate/05-install-apiserver/#apiserver_1","title":"\u4e8c\u3001\u5b89\u88c5apiserver","text":"<p>\u5728\u4e09\u53f0\u4e3b\u673a\u4e0a\uff0c\u6267\u884c\u5b89\u88c5\u64cd\u4f5c</p> <pre><code># \u89e3\u538b\u5b89\u88c5\u5305\ntar -zxvf kubernetes-server-linux-amd64.tar.gz\n# \u5c06\u5b89\u88c5\u5305\u79fb\u5230/opt\u76ee\u5f55\u4e0b\u5e76\u6839\u636e\u7248\u672c\u91cd\u547d\u540d\nmv kubernetes /opt/kubernetes-v1.24.1\n# \u521b\u5efa\u8f6f\u8fde\u63a5\nln -s /opt/kubernetes-v1.24.1/ /opt/kubernetes\n</code></pre> <p>\u5728k8s\u4e8c\u8fdb\u5236\u5b89\u88c5\u76ee\u5f55\u91cc\u5305\u542b\u4e86k8s\u6e90\u7801\u5305\uff0c\u8fd8\u5305\u542bk8s\u6838\u5fc3\u7ec4\u4ef6\u7684docker\u955c\u50cf\uff0c\u56e0\u4e3a\u6211\u4eec\u7684\u6838\u5fc3\u670d\u52a1\u4e0d\u8fd0\u884c\u5728\u5bb9\u5668\u91cc\uff0c\u6240\u4ee5\u53ef\u4ee5\u5220\u9664\u6389\uff0c\u64cd\u4f5c\u8fc7\u7a0b\u5982\u4e0b</p> <pre><code># \u8fdb\u5165k8s\u76ee\u5f55\ncd /opt/kubernetes\n# \u5220\u9664\u6e90\u4ee3\u7801\nrm kubernetes-src.tar.gz\n# \u5220\u9664\u4e8c\u8fdb\u5236\u6587\u4ef6\u76ee\u5f55\u4e0b\u4ee5tar\u4f5c\u4e3a\u540d\u79f0\u540e\u7f00\u7684docker\u955c\u50cf\u5305\nrm -rf server/bin/*.tar\n</code></pre>"},{"location":"03.ultimate/05-install-apiserver/#apiser","title":"\u4e09\u3001\u542f\u52a8apiser\u670d\u52a1","text":""},{"location":"03.ultimate/05-install-apiserver/#31","title":"3.1 \u521b\u5efa\u542f\u52a8\u811a\u672c","text":"<p>\u5728apiserver\u4e8c\u8fdb\u5236\u6587\u4ef6\u76ee\u5f55\u521b\u5efa<code>/opt/kubernetes/server/bin/kube-apiserver.sh</code>\u542f\u52a8\u811a\u672c\u6587\u4ef6\uff0c\u5199\u5165\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>#!/bin/bash\n./kube-apiserver \\\n--v=2 \\\n--logtostderr=true \\\n--allow-privileged=true \\\n--bind-address=\"192.168.9.160\" \\\n--secure-port=\"6443\" \\\n--token-auth-file=\"/etc/kubernetes/bb.csv\" \\\n--advertise-address=\"192.168.9.160\" \\\n--service-cluster-ip-range=\"10.96.0.0/16\" \\\n--service-node-port-range=\"30000-60000\" \\\n--etcd-servers=\"https://192.168.9.199:2379,https://192.168.9.192:2379,https://192.168.9.160:2379\" \\\n--etcd-cafile=\"/etc/kubernetes/pki/ca.pem\" \\\n--etcd-certfile=\"/etc/kubernetes/pki/etcd.pem\" \\\n--etcd-keyfile=\"/etc/kubernetes/pki/etcd-key.pem\" \\\n--client-ca-file=\"/etc/kubernetes/pki/ca.pem\" \\\n--tls-cert-file=\"/etc/kubernetes/pki/apiserver.pem\" \\\n--tls-private-key-file=\"/etc/kubernetes/pki/apiserver-key.pem\" \\\n--kubelet-client-certificate=\"/etc/kubernetes/pki/apiserver.pem\" \\\n--kubelet-client-key=\"/etc/kubernetes/pki/apiserver-key.pem\" \\\n--service-account-key-file=\"/etc/kubernetes/pki/ca-key.pem\" \\\n--service-account-signing-key-file=\"/etc/kubernetes/pki/ca-key.pem\" \\\n--service-account-issuer=\"https://kubernetes.default.svc.cluster.local\" \\\n--kubelet-preferred-address-types=\"InternalIP,ExternalIP,Hostname\" \\\n--enable-admission-plugins=\"NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota\" \\\n--authorization-mode=\"Node,RBAC\" \\\n--enable-bootstrap-token-auth=true\n#--requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \\\n#--proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \\\n#--proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \\\n#--requestheader-allowed-names=aggregator  \\\n#--requestheader-group-headers=X-Remote-Group  \\\n#--requestheader-extra-headers-prefix=X-Remote-Extra-  \\\n#--requestheader-username-headers=X-Remote-User\n</code></pre> <p>\u8d4b\u4e88\u6267\u884c\u6743\u9650</p> <pre><code>chmod +x /opt/kubernetes/server/bin/kube-apiserver.sh\n</code></pre> <p>\u4e0a\u9762\u6ce8\u91ca\u7684\u90e8\u5206\u662f\u914d\u7f6e\u805a\u5408\u5c42\u7684\uff0c\u672c\u73af\u5883\u91cc\u6ca1\u6709\u542f\u7528\u805a\u5408\u5c42\u6240\u4ee5\u8fd9\u4e9b\u9009\u9879\u88ab\u6ce8\u91ca\u4e86\uff0c\u5982\u679c\u914d\u7f6e\u4e86\u805a\u5408\u5c42\u7684\u8bdd\uff0c\u5219\u9700\u8981\u628a#\u53d6\u6d88\u3002\u76f8\u5173\u53c2\u6570\u8bf4\u660e</p> <ul> <li><code>--v</code>\uff1a\u65e5\u5fd7\u8f93\u51fa\u7ea7\u522b</li> <li><code>--logtostderr</code>\uff1a\u5c06\u8f93\u51fa\u8bb0\u5f55\u5230\u6807\u51c6\u65e5\u5fd7\uff0c\u800c\u4e0d\u662f\u6587\u4ef6\uff0c\u9ed8\u8ba4\u662ftrue</li> <li><code>--allow-privileged</code>\uff1a\u662f\u5426\u4f7f\u7528\u8d85\u7ea7\u7ba1\u7406\u5458\u6743\u9650\u521b\u5efa\u5bb9\u5668\uff0c\u9ed8\u8ba4\u4e3afalse</li> <li><code>--bind-address</code>\uff1a\u7ed1\u5b9a\u7684IP\u5730\u5740\uff0c\u5982\u679c\u6ca1\u6709\u6307\u5b9a\u5730\u5740\uff080.0.0.0\u6216\u8005::\uff09\uff0c\u9ed8\u8ba4\u662f 0.0.0.0\uff0c\u4ee3\u8868\u6240\u6709\u7684\u7f51\u5361\u90fd\u5728\u76d1\u542c\u670d\u52a1</li> <li><code>--secure-port</code>\uff1a\u53c2\u6570\u6307\u5b9a\u7684\u7aef\u53e3\u53f7\u5bf9\u5e94\u76d1\u542c\u7684IP\u5730\u5740</li> <li><code>--token-auth-file</code>\uff1a\u8be5\u6587\u4ef6\u7528\u4e8e\u6307\u5b9aapi-server\u9881\u53d1\u8bc1\u4e66\u7684token\u6388\u6743</li> <li><code>--advertise-address</code>\uff1a\u5411\u96c6\u7fa4\u5e7f\u64ad\u7684ip\u5730\u5740\uff0c\u8fd9\u4e2aip\u5730\u5740\u5fc5\u987b\u80fd\u88ab\u96c6\u7fa4\u7684\u5176\u4ed6\u8282\u70b9\u8bbf\u95ee\uff0c\u5982\u679c\u4e0d\u6307\u5b9a\uff0c\u5c06\u4f7f\u7528--bind-address\uff0c\u5982\u679c\u4e0d\u6307\u5b9a--bind-addres\uff0c\u5c06\u4f7f\u7528\u9ed8\u8ba4\u7f51\u5361</li> <li><code>--service-cluster-ip-range</code>\uff1a\u521b\u5efaservice\u65f6\uff0c\u4f7f\u7528\u7684\u865a\u62df\u7f51\u6bb5</li> <li><code>--service-node-port-range</code>\uff1a\u521b\u5efaservice\u65f6\uff0c\u670d\u52a1\u7aef\u53e3\u4f7f\u7528\u7684\u7aef\u53e3\u8303\u56f4\uff08\u9ed8\u8ba4 30000-32767\uff09</li> <li><code>--etcd-cafile</code>\uff1a\u8bbf\u95eeetcd\u65f6\u4f7f\u7528\uff0cectd\u7684ca\u6587\u4ef6</li> <li><code>--etcd-certfile</code>\uff1a\u8bbf\u95eeetcd\u65f6\u4f7f\u7528\uff0cectd\u7684\u8bc1\u4e66\u6587\u4ef6</li> <li><code>--etcd-servers</code>\uff1a\u5404\u4e2aetcd\u8282\u70b9\u7684IP\u548c\u7aef\u53e3\u53f7</li> <li><code>--etcd-keyfile</code>\uff1a\u8bbf\u95eeetcd\u65f6\u4f7f\u7528\uff0cectd\u7684\u8bc1\u4e66\u79c1\u94a5\u6587\u4ef6</li> <li><code>--client-ca-file</code>\uff1a\u8bbf\u95eeapiserver\u65f6\u4f7f\u7528\uff0c\u5ba2\u6237\u7aefca\u6587\u4ef6</li> <li><code>--tls-cert-file</code>\uff1a\u8bbf\u95eeapiserver\u65f6\u4f7f\u7528\uff0ctls\u8bc1\u4e66\u6587\u4ef6</li> <li><code>--tls-private-key-file</code>\uff1a\u8bbf\u95eeapiserver\u65f6\u4f7f\u7528\uff0ctls\u8bc1\u4e66\u79c1\u94a5\u6587\u4ef6</li> <li><code>--kubelet-client-certificate</code>\uff1a\u8bbf\u95eekubelet\u65f6\u4f7f\u7528\uff0c\u5ba2\u6237\u7aef\u8bc1\u4e66\u8def\u5f84</li> <li><code>--kubelet-client-key</code>\uff1a\u8bbf\u95eekubelet\u65f6\u4f7f\u7528\uff0c\u5ba2\u6237\u7aef\u8bc1\u4e66\u79c1\u94a5</li> <li><code>--service-account-key-file</code>\uff1a\u5305\u542b PEM \u7f16\u7801\u7684 x509 RSA \u6216 ECDSA \u79c1\u94a5\u6216\u516c\u94a5\uff0c\u7528\u6765\u68c0\u67e5 ServiceAccount \u7684\u4ee4\u724c</li> <li><code>--service-account-signing-key-file</code>\uff1a\u6307\u5411\u5305\u542b\u5f53\u524d\u670d\u52a1\u8d26\u53f7\u4ee4\u724c\u53d1\u653e\u8005\u7684\u79c1\u94a5\u7684\u6587\u4ef6\u8def\u5f84\u3002 \u6b64\u53d1\u653e\u8005\u4f7f\u7528\u6b64\u79c1\u94a5\u6765\u7b7e\u7f72\u6240\u53d1\u653e\u7684 ID \u4ee4\u724c</li> <li><code>--service-account-issuer</code>\uff1a\u670d\u52a1\u8d26\u6237\u4ee4\u724c\u53d1\u653e\u8005\u7684\u8eab\u4efd\u6807\u8bc6</li> <li><code>--enable-admission-plugins</code>\uff1a\u5141\u8bb8\u4f7f\u7528\u7684\u63d2\u4ef6</li> <li><code>--authorization-mode</code>\uff1a\u6388\u6743\u6a21\u5f0f</li> <li><code>--enable-bootstrap-token-auth</code>\uff1a\u662f\u5426\u4f7f\u7528token\u7684\u65b9\u5f0f\u6765\u81ea\u52a8\u9881\u53d1\u8bc1\u4e66\uff0c\u5982\u679c\u4e3b\u673a\u8282\u70b9\u6bd4\u8f83\u591a\u7684\u65f6\u5019\uff0c\u624b\u52a8\u9881\u53d1\u8bc1\u4e66\u53ef\u80fd\u4e0d\u592a\u73b0\u5b9e\uff0c\u53ef\u4ee5\u4f7f\u7528\u57fa\u4e8etoken\u7684\u65b9\u5f0f\u81ea\u52a8\u9881\u53d1\u8bc1\u4e66</li> </ul> <p>\u4ee5\u4e0a\u662f\u6211\u4eec\u5728\u542f\u52a8apiserver\u7684\u65f6\u5019\u5e38\u7528\u7684\u53c2\u6570\uff0capiserver\u5177\u6709\u5f88\u591a\u53c2\u6570\uff0c\u5f88\u591a\u53c2\u6570\u4e5f\u6709\u9ed8\u8ba4\u503c\uff0c\u53ef\u4ee5<code>./kube-apiserver --hep</code>\u547d\u4ee4\u67e5\u770b\u66f4\u591a\u7684\u5e2e\u52a9\u3002</p>"},{"location":"03.ultimate/05-install-apiserver/#32-supervisor","title":"3.2 \u4f7f\u7528supervisor\u8fd0\u884c","text":"<p>\u521b\u5efasupervisor\u914d\u7f6e\u6587\u4ef6<code>/etc/supervisor/conf.d/kube-apiserver.conf</code></p> <pre><code>[program:kube-apiserver-160]\ndirectory=/opt/kubernetes/server/bin\ncommand=/opt/kubernetes/server/bin/kube-apiserver.sh\nnumprocs=1\nautostart=true\nautorestart=true\nstartsecs=30\nstartretries=3\nexitcodes=0,2\nstopsignal=QUIT\nstopwaitsecs=10\nuser=root\nredirect_stderr=true\nstdout_logfile=/data/logs/supervisor/apiserver.stdout.log\nstdout_logfile_maxbytes=64MB\nstdout_logfile_backups=4\nstdout_capture_maxbytes=1MB\nstdout_event_enabled=false\n</code></pre> <p>\u66f4\u65b0supervisor\u670d\u52a1</p> <pre><code>supervisorctl update\n</code></pre> <p>\u518d\u4f7f\u7528<code>supervisorctl status</code>\u547d\u4ee4\u67e5\u770bapiserver\u542f\u52a8\u72b6\u6001\uff0c\u5982\u679c\u663e\u793a\u5982\u4e0b\u5185\u5bb9\uff0c\u4ee3\u8868\u6b63\u5e38\u670d\u52a1</p> <p></p> <p>\u6b64\u65f6\uff0c\u8fd8\u53ef\u4ee5\u4f7f\u7528<code>netstat -luntp | grep kube-api</code>\u547d\u4ee4\u67e5\u770b\u7f51\u7edc\u670d\u52a1\u7684\u7aef\u53e3\u662f\u5426\u6b63\u5e38\uff0c\u5982\u679c\u6b63\u5e38\uff0c\u5c06\u8fd4\u56de\u5982\u4e0b\u5185\u5bb9</p> <p></p>"},{"location":"03.ultimate/06-install-agent-server/","title":"\u642d\u5efaL4\u53cd\u5411\u4ee3\u7406\u670d\u52a1","text":"<p>\u6211\u4eec\u9700\u8981\u5728<code>199-debian</code>\u548c<code>192-debian</code>\u4e0a\u5b89\u88c5nginx\u4f5c\u4e3a\u53cd\u5411\u4ee3\u7406\u670d\u52a1\uff0c\u7136\u540e\u4f7f\u7528keepalived\u4fdd\u8bc1\u9ad8\u53ef\u7528\u6027</p>"},{"location":"03.ultimate/06-install-agent-server/#nginx","title":"\u4e00\u3001\u5b89\u88c5nginx","text":"<p><code>199-debian</code>\u5728\u5b89\u88c5harbor\u65f6\u5df2\u7ecf\u5b89\u88c5\u8fc7\uff0c\u9700\u8981\u7ee7\u7eed\u5728<code>192-debian</code>\u4e0a\u5b89\u88c5</p> <pre><code># \u4e0b\u8f7d\u4ee3\u7801\nwget https://nginx.org/download/nginx-1.22.0.tar.gz\n# \u89e3\u538b\u6587\u4ef6\ntar -zxvf nginx-1.22.0.tar.gz\n# \u8fdb\u5165\u6e90\u7801\u76ee\u5f55\ncd nginx-1.22.0\n# \u914d\u7f6e\u7f16\u8bd1\u53c2\u6570\uff0c--prefix\u53c2\u6570\u6307\u5b9a\u5b89\u88c5\u76ee\u5f55\n./configure \\\n--prefix=/usr/local/nginx-1.22.0 \\\n--with-stream \\\n--with-http_stub_status_module \\\n--with-http_ssl_module --with-http_v2_module \\\n--error-log-path=/data/log/nginx/error.log \\\n--http-log-path=/data/log/nginx/access.log\n# \u7f16\u8bd1\u5e76\u5b89\u88c5\nmake &amp;&amp; make install\n# \u8bbe\u7f6e\u94fe\u63a5\nln -s /usr/local/nginx-1.22.0 /usr/local/nginx\nln -s /usr/local/nginx/sbin/nginx /usr/local/bin/nginx\n</code></pre>"},{"location":"03.ultimate/06-install-agent-server/#nginx_1","title":"\u4e8c\u3001\u914d\u7f6enginx","text":"<p>\u5b89\u88c5\u5b8c\u6210\u4e4b\u540e\uff0c\u6211\u4eec\u9700\u8981\u4e24\u53f0\u673a\u7684nginx\u7684\u914d\u7f6e\u6587\u4ef6<code>/usr/local/nginx/conf/nginx.conf</code>\u7684<code>http</code>\u8282\u70b9\u65c1\u8fb9\u6dfb\u52a0\u56db\u5c42\u53cd\u5411\u4ee3\u7801\u89c4\u5219\uff0c\u5c067443\u7aef\u53e3\u7684\u6d41\u91cf\u4f7f\u7528\u8d1f\u8f7d\u5747\u8861\u7684\u65b9\u5f0f\u8f6c\u53d1\u52303\u53f0\u4e3b\u673a\u76846443\u7aef\u53e3\u4e0a</p> <pre><code># \u8bbe\u7f6e\u4ee3\u7406\u89c4\u5219\nstream {\nupstream kube-apiserver {\nserver 192.168.9.199:6443  max_fails=3  fail_timeout=30s;\nserver 192.168.9.192:6443  max_fails=3  fail_timeout=30s;\nserver 192.168.9.160:6443  max_fails=3  fail_timeout=30s;\n}\nserver {\nlisten  7443;\nproxy_connect_timeout  2s;\nproxy_timeout  900s;\nproxy_pass kube-apiserver;\n}\n}\n</code></pre> <p>\u5728\u4e24\u53f0\u4e3b\u673a\u4e0a\u914d\u7f6e\u597d\u89c4\u5219\u4e4b\u540e\uff0c\u901a\u8fc7<code>nginx -t</code>\u547d\u4ee4\u68c0\u67e5\u914d\u7f6e\u7ed3\u679c\uff0c\u5982\u679c\u8f93\u51fa\u4ee5\u4e0b\u5185\u5bb9\u4ee3\u8868\u914d\u7f6e\u6b63\u786e</p> <pre><code>[root@199-debian vagrant]# nginx -t\nnginx: the configuration file /etc/nginx/nginx.conf syntax is ok\nnginx: configuration file /etc/nginx/nginx.conf test is successful\n</code></pre> <p>\u914d\u7f6e\u6210\u529f\u4e4b\u540e\uff0c\u542f\u52a8nginx\uff0c\u5982\u4e0b\u6307\u4ee4</p> <pre><code># \u542f\u52a8ginx\uff0c199\u4e3b\u673a\u4f7f\u7528 nginx -s reload\u91cd\u65b0\u52a0\u8f7d\u914d\u7f6e\u5373\u53ef\nnginx\n</code></pre>"},{"location":"03.ultimate/06-install-agent-server/#keepalived","title":"\u4e09\u3001\u5b89\u88c5keepalived","text":"<p>\u6211\u4eec\u5c06\u4f7f\u7528keepalived\u5b9e\u73b0\u4ee3\u7406\u670d\u52a1\u5668\u7684\u9ad8\u53ef\u7528\uff0c\u4ee5\u4e0b\u662f\u5b89\u88c5\u8fc7\u7a0b</p> <pre><code>apt install keepalived -y\n</code></pre> <p>\u5728\u4e24\u53f0\u4e3b\u673a\u7684\u521b\u5efa<code>/etc/keepalived/check_port.sh</code>\u811a\u672c\u6587\u4ef6\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>#!/bin/bash\nCHK_PORT=$1\nif [ -n \"$CHK_PORT\" ]; then\nPORT_PROCESS=`ss -lnt|grep $CHK_PORT|wc -l`\nif [ $PORT_PROCESS -eq 0 ]; then\necho \"Port $CHK_PORT Is Not Used, End\"\nexit 1\nfi\nelse\necho \"Check Port Cant Be Empty!\"\nfi\n</code></pre> <p>\u6dfb\u52a0\u6267\u884c\u6743\u9650</p> <pre><code>chmod +x /etc/keepalived/check_port.sh\n</code></pre> <p>\u4ee5\u4e0a\u7684\u64cd\u4f5c\u5c31\u51c6\u5907\u597dkeepalived\u7684\u57fa\u7840\u73af\u5883\u4e86\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u4f7f\u7528<code>199-debian</code>\u8fd9\u53f0\u4e3b\u673a\u4f5c\u4e3a\u4e3b\u8282\u70b9\uff0c\u4f7f\u7528<code>192-debian</code>\u4f5c\u4e3a\u91cd\u8282\u70b9\uff0c\u8fdb\u884c\u4ee5\u4e0b\u914d\u7f6e</p> <p><code>199-debian</code>\u4f5c\u4e3a\u4e3b\u8282\u70b9\uff0c\u4fee\u6539<code>/etc/keepalived/keepalived.conf</code>\u914d\u7f6e\u6587\u4ef6\u5982\u4e0b</p> <pre><code>! Configuration File for keepalived\n\nglobal_defs {\nrouter_id 192.168.9.199\n}\nvrrp_script check_nginx {\nscript \"/etc/keepalived/check_port.sh 7443\"\ninterval 2\nweight -20\n}\nvrrp_instance VI_1 {\nstate MASTER\n    interface enp1s0\n    virtual_router_id 251\npriority 100\nadvert_int 1\nmcast_src_ip 192.168.9.199\n    nopreempt\n\nauthentication {\nauth_type PASS\n        auth_pass 1111\n}\nvirtual_ipaddress {\n192.168.9.190\n    }\n}\n</code></pre> <p><code>192-debian</code>\u4f5c\u4e3a\u4ece\u8282\u70b9\uff0c\u4fee\u6539<code>/etc/keepalived/keepalived.conf</code>\u914d\u7f6e\u6587\u4ef6\u5982\u4e0b</p> <pre><code>! Configuration File for keepalived\n\nglobal_defs {\nrouter_id 192.168.9.192\n}\nvrrp_script check_nginx {\nscript \"/etc/keepalived/check_port.sh 7443\"\ninterval 2\nweight -20\n}\nvrrp_instance VI_1 {\nstate BACKUP\n    interface enp3s0\n    virtual_router_id 251\npriority 90\nadvert_int 1\nmcast_src_ip 192.168.9.192\n    nopreempt\n\nauthentication {\nauth_type PASS\n        auth_pass 1111\n}\nvirtual_ipaddress {\n192.168.9.190\n    }\n}\n</code></pre> <p>\u542f\u52a8\u670d\u52a1</p> <pre><code># \u91cd\u542f\u670d\u52a1\nsystemctl restart keepalived\n# \u8bbe\u7f6e\u670d\u52a1\u4e3a\u5f00\u673a\u81ea\u542f\nsystemctl enable keepalived\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c<code>interface</code>\u53c2\u6570\u5bf9\u5e94\u7684\u662f\u771f\u5b9e\u7684\u4e3b\u673a\u7f51\u5361\u540d\u79f0\uff0c<code>virtual_router_id</code>\u53c2\u6570\u9700\u8981\u5728\u540c\u4e00\u4e2a\u865a\u62dfIP\u7684\u524d\u63d0\u4e0b\uff0c\u8bbe\u7f6e\u9700\u4e00\u81f4\u3002</p>"},{"location":"03.ultimate/06-install-agent-server/#_1","title":"\u56db\u3001\u9a8c\u8bc1","text":"<p>\u901a\u8fc7<code>ping 192.169.9.190</code>\u7684\u65b9\u5f0f\u8fdb\u884c\u9a8c\u8bc1\uff0c\u5982\u679c\u6709\u6b63\u5e38\u8fd4\u56de\uff0c\u4ee3\u8868keepalived\u8fd0\u884c\u6b63\u5e38\u3002</p>"},{"location":"03.ultimate/07-install-other-component/","title":"\u5b89\u88c5controller-manager\u548cscheduler","text":""},{"location":"03.ultimate/07-install-other-component/#kubectl","title":"\u4e00\u3001\u521b\u5efakubectl\u94fe\u63a5","text":"<p>\u6211\u4eec\u4f7f\u7528<code>kubectl</code>\u4f5c\u4e3ak8s\u7684\u7ba1\u7406\u5de5\u5177\uff0c\u521b\u5efa\u4e00\u4e2a\u8f6f\u94fe\u63a5\uff0c\u5982\u4e0b</p> <pre><code>ln -s /opt/kubernetes/server/bin/kubectl /usr/local/bin/kubectl\n</code></pre>"},{"location":"03.ultimate/07-install-other-component/#controller-manager","title":"\u4e8c\u3001\u5b89\u88c5controller-manager","text":""},{"location":"03.ultimate/07-install-other-component/#21","title":"2.1 \u521b\u5efa\u914d\u7f6e","text":"<p>controller-manager\u548capiserver\u4e4b\u95f4\u7684\u8ba4\u8bc1\u662f\u901a\u8fc7kubeconfig\u7684\u65b9\u5f0f\u6765\u8ba4\u8bc1\u7684\uff0c\u5373controller-manager\u7684\u79c1\u94a5\u3001\u516c\u94a5\u53caCA\u7684\u8bc1\u4e66\u8981\u653e\u5728\u4e00\u4e2akubeconfig\u6587\u4ef6\u91cc\u3002\u4e0b\u9762\u521b\u5efacontroller-manager\u6240\u7528\u7684kubeconfig\u6587\u4ef6kube-controller-manager.kubeconfig\uff0c\u73b0\u5728\u5728<code>/etc/kubernetes/pki</code>\u91cc\u521b\u5efa\uff0c\u7136\u540e\u79fb\u52a8\u5230<code>/etc/kubernetes</code>\u91cc\u3002</p> <pre><code># \u8fdb\u5165\u8bc1\u4e66\u76ee\u5f55\ncd /etc/kubernetes/pki/\n\n# \u8bbe\u7f6e\u96c6\u7fa4\u4fe1\u606f\nkubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://192.168.9.190:7443 --kubeconfig=kube-controller-manager.kubeconfig\n\n# \u8bbe\u7f6e\u7528\u6237\u4fe1\u606f\uff0c\u8fd9\u91cc\u7528\u6237\u540d\u662fsystem:kube-controller-manager \uff0c\u4e5f\u5c31\u662f\u524d\u9762controller-manager-csr.json\u91ccCN\u6307\u5b9a\u7684\u3002\nkubectl config set-credentials system:kube-controller-manager --client-certificate=controller-manager.pem --client-key=controller-manager-key.pem --embed-certs=true --kubeconfig=kube-controller-manager.kubeconfig\n\n# \u8bbe\u7f6e\u4e0a\u4e0b\u6587\u4fe1\u606f\nkubectl config set-context system:kube-controller-manager --cluster=kubernetes --user=system:kube-controller-manager --kubeconfig=kube-controller-manager.kubeconfig\n\n# \u8bbe\u7f6e\u9ed8\u8ba4\u7684\u4e0a\u4e0b\u6587\nkubectl config use-context system:kube-controller-manager --kubeconfig=kube-controller-manager.kubeconfig\n\n# \u5c06\u751f\u6210\u7684\u8bc1\u4e66\u79fb\u5230/etc/kubernetes/\nmv kube-controller-manager.kubeconfig /etc/kubernetes/\n</code></pre> <p><code>/etc/kubernetes/kube-controller-manager.kubeconfig</code>\u914d\u7f6e\u6587\u4ef6\u53ea\u9700\u751f\u6210\u4e00\u6b21\uff0c\u518d\u4f20\u5230\u5176\u4ed6\u4e3b\u673a\u5373\u53ef\u3002</p>"},{"location":"03.ultimate/07-install-other-component/#21_1","title":"2.1 \u521b\u5efa\u542f\u52a8\u811a\u672c","text":"<p>\u521b\u5efa\u6587\u4ef6<code>/opt/kubernetes/server/bin/kube-controller-manager.sh</code>\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>#!/bin/bash\n./kube-controller-manager \\\n--v=2 \\\n--logtostderr=true \\\n--bind-address=127.0.0.1 \\\n--root-ca-file=/etc/kubernetes/pki/ca.pem \\\n--cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem \\\n--cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem \\\n--service-account-private-key-file=/etc/kubernetes/pki/ca-key.pem \\\n--kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \\\n--leader-elect=true \\\n--use-service-account-credentials=true \\\n--node-monitor-grace-period=40s \\\n--node-monitor-period=5s \\\n--pod-eviction-timeout=2m0s \\\n--controllers=*,bootstrapsigner,tokencleaner \\\n--allocate-node-cidrs=true \\\n--cluster-cidr=10.244.0.0/16 \\\n--node-cidr-mask-size=24\n</code></pre> <p>\u6dfb\u52a0\u6267\u884c\u6743\u9650\u4e0e\u521b\u5efa\u65e5\u5fd7\u76ee\u5f55</p> <pre><code># \u6dfb\u52a0\u53ef\u6267\u884c\u6743\u9650\nchmod +x /opt/kubernetes/server/bin/kube-controller-manager.sh\n</code></pre> <p>\u521b\u5efasupervisor\u811a\u672c\u542f\u52a8\u7ba1\u7406\u6587\u4ef6<code>/etc/supervisor/conf.d/kube-controller-manager.conf</code>\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>[program:kube-controller-manager-199]\ndirectory=/opt/kubernetes/server/bin\ncommand=/opt/kubernetes/server/bin/kube-controller-manager.sh\nnumprocs=1\nautostart=true\nautorestart=true\nstartsecs=30\nstartretries=3\nexitcodes=0,2\nstopsignal=QUIT\nstopwaitsecs=10\nuser=root\nredirect_stderr=true\nstdout_logfile=/data/logs/supervisor/controller.stdout.log\nstdout_logfile_maxbytes=64MB\nstdout_logfile_backups=4\nstdout_capture_maxbytes=1MB\nstdout_event_enabled=false\n</code></pre> <p>\u66f4\u65b0supervisor</p> <pre><code>supervisorctl update\n</code></pre>"},{"location":"03.ultimate/07-install-other-component/#scheduler","title":"\u4e09\u3001\u90e8\u7f72scheduler","text":""},{"location":"03.ultimate/07-install-other-component/#31","title":"3.1 \u521b\u5efa\u914d\u7f6e","text":"<p>controller-manager\u548capiserver\u4e4b\u95f4\u7684\u8ba4\u8bc1\u662f\u901a\u8fc7kubeconfig\u7684\u65b9\u5f0f\u6765\u8ba4\u8bc1\u7684\uff0c\u5373controller-manager\u7684\u79c1\u94a5\u3001\u516c\u94a5\u53caCA\u7684\u8bc1\u4e66\u8981\u653e\u5728\u4e00\u4e2akubeconfig\u6587\u4ef6\u91cc\u3002\u4e0b\u9762\u521b\u5efacontroller-manager\u6240\u7528\u7684kubeconfig\u6587\u4ef6kube-controller-manager.kubeconfig\uff0c\u73b0\u5728\u5728/etc/kubernetes/pki\u91cc\u521b\u5efa\uff0c\u7136\u540e\u526a\u5207\u5230/etc/kubernetes\u91cc\u3002</p> <pre><code># \u8bbe\u7f6e\u96c6\u7fa4\u4fe1\u606f\nkubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://192.168.9.190:7443 --kubeconfig=kube-scheduler.kubeconfig\n\n# \u8bbe\u7f6e\u7528\u6237\u4fe1\u606f\nkubectl config set-credentials system:kube-scheduler --client-certificate=scheduler.pem --client-key=scheduler-key.pem --embed-certs=true --kubeconfig=kube-scheduler.kubeconfig\n\n# \u8bbe\u7f6e\u4e0a\u4e0b\u6587\u4fe1\u606f\nkubectl config set-context system:kube-scheduler --cluster=kubernetes --user=system:kube-scheduler --kubeconfig=kube-scheduler.kubeconfig\n\n# \u8bbe\u7f6e\u9ed8\u8ba4\u7684\u4e0a\u4e0b\u6587\nkubectl config use-context system:kube-scheduler --kubeconfig=kube-scheduler.kubeconfig\n\n# \u526a\u5207\u5230/etc/kubernetes\nmv kube-scheduler.kubeconfig /etc/kubernetes/\n</code></pre> <p><code>/etc/kubernetes/kube-scheduler.kubeconfig</code>\u914d\u7f6e\u6587\u4ef6\u4e5f\u53ea\u9700\u751f\u6210\u4e00\u6b21\uff0c\u518d\u4f20\u5230\u5176\u4ed6\u4e3b\u673a\u5373\u53ef\u3002</p>"},{"location":"03.ultimate/07-install-other-component/#32","title":"3.2 \u521b\u5efa\u542f\u52a8\u811a\u672c","text":"<p>\u521b\u5efascheluder\u542f\u52a8\u811a\u672c\u6587\u4ef6<code>/opt/kubernetes/server/bin/kube-scheduler.sh</code>\u6587\u4ef6\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>#!/bin/bash\n./kube-scheduler \\\n--v=2 \\\n--logtostderr=true \\\n--bind-address=127.0.0.1 \\\n--leader-elect=true \\\n--kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig\n</code></pre> <p>\u6dfb\u52a0\u811a\u672c\u6267\u884c\u6743\u9650\u4e0e\u521b\u5efa\u65e5\u5fd7\u76ee\u5f55</p> <pre><code># \u6dfb\u52a0\u811a\u672c\u7684\u53ef\u6267\u884c\u6743\u9650\nchmod +x /opt/kubernetes/server/bin/kube-scheduler.sh\n</code></pre> <p>\u521b\u5efa\u8fdb\u7a0b\u7ba1\u7406\u914d\u7f6e\u6587\u4ef6<code>/etc/supervisor/conf.d/kube-scheduler.conf</code>\u6587\u4ef6\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>[program:kube-scheduler-199]\ndirectory=/opt/kubernetes/server/bin\ncommand=/opt/kubernetes/server/bin/kube-scheduler.sh\nnumprocs=1\nautostart=true\nautorestart=true\nstartsecs=30\nstartretries=3\nexitcodes=0,2\nstopsignal=QUIT\nstopwaitsecs=10\nuser=root\nredirect_stderr=true\nstdout_logfile=/data/logs/supervisor/scheduler.stdout.log\nstdout_logfile_maxbytes=64MB\nstdout_logfile_backups=4\nstdout_capture_maxbytes=1MB\nstdout_event_enabled=false\n</code></pre> <p>\u66f4\u65b0supervisor</p> <pre><code>supervisorctl update\n</code></pre>"},{"location":"03.ultimate/07-install-other-component/#_1","title":"\u56db\u3001\u96c6\u7fa4\u9a8c\u8bc1","text":""},{"location":"03.ultimate/07-install-other-component/#41","title":"4.1 \u521b\u5efa\u7ba1\u7406\u5458\u914d\u7f6e","text":"<p>\u521b\u5efa\u7ba1\u7406\u5458\u7528\u6237\u7528\u7684kubeconfig\uff0c\u6700\u540e\u62f7\u8d1d\u4e3a~/.kube/config\u4f5c\u4e3a\u9ed8\u8ba4\u7684kubeconfig\u6587\u4ef6\u3002</p> <pre><code># \u8bbe\u7f6e\u4e00\u4e2a\u96c6\u7fa4\u4fe1\u606f\nkubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://192.168.9.190:7443 --kubeconfig=admin.conf\n\n# \u8bbe\u7f6e\u7528\u6237\u4fe1\u606f\nkubectl config set-credentials admin --client-certificate=admin.pem --client-key=admin-key.pem --embed-certs=true --kubeconfig=admin.conf\n\n# \u8bbe\u7f6e\u4e0a\u4e0b\u6587\nkubectl config set-context kubernetes --cluster=kubernetes --user=admin --kubeconfig=admin.conf\n\n# \u8bbe\u7f6e\u9ed8\u8ba4\u4e0a\u4e0b\u6587\u5883\nkubectl config use-context kubernetes --kubeconfig=admin.conf\n\n# \u79fb\u52a8\nmv admin.conf /etc/kubernetes/\n</code></pre> <p>\u521b\u5efa\u597d\u4e4b\u540e\u540c\u6b65\u5230\u5176\u4ed6\u8282\u70b9\uff0c\u518d\u62f7\u8d1d\u914d\u7f6e\u6587\u4ef6\u5230\u7528\u6237\u76ee\u5f55\u3002</p>"},{"location":"03.ultimate/07-install-other-component/#42","title":"4.2 \u4f7f\u7528\u7ba1\u7406\u5458\u914d\u7f6e","text":"<pre><code>mkdir -p ~/.kube\ncp /etc/kubernetes/admin.conf ~/.kube/config\n</code></pre> <p>\u4f7f\u7528<code>kubectl get cs</code>\u68c0\u67e5\u96c6\u7fa4\u72b6\u6001\uff0c\u8fd9\u65f6\u5019\u4f60\u4f1a\u53d1\u73b0\u7c7b\u4f3c\u5982\u4e0b\u7684\u9519\u8bef</p> <pre><code>Error from server (Forbidden): Forbidden (user=admin, verb=get, resource=nodes, subresource=proxy)\n</code></pre> <p>\u8fd9\u4ee3\u8868\u6211\u4eec\u521b\u5efa\u7684<code>admin</code>\u7528\u6237\u6ca1\u6709\u96c6\u7fa4\u7ba1\u7406\u6743\u9650\uff0c\u7ed1\u5b9a\u4e00\u4e2a<code>cluster-admin</code>\u89d2\u8272\u5373\u53ef\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>kubectl create clusterrolebinding system:anonymous --clusterrole=cluster-admin --user=admin\n</code></pre> <p>\u6700\u540e\u518d\u4f7f\u7528<code>kubectl get cs</code>\u67e5\u770b\u96c6\u7fa4\uff0c\u5982\u8fd4\u56de\u4ee5\u4e0b\u7c7b\u4f3c\u5185\u5bb9\uff0c\u5219\u4ee3\u8868\u96c6\u7fa4\u63a7\u5236\u8282\u70b9\u7684\u670d\u52a1\u6b63\u5e38</p> <p></p>"},{"location":"03.ultimate/08-install-kubelet/","title":"\u5b89\u88c5kubectl","text":""},{"location":"03.ultimate/08-install-kubelet/#_1","title":"\u4e00\u3001\u7ed9\u6307\u5b9a\u7528\u6237\u6388\u6743","text":""},{"location":"03.ultimate/08-install-kubelet/#11","title":"1.1 \u6388\u6743","text":"<p>\u4e3a\u7528\u6237kubelet-bootstrap\u6388\u6743\uff0c\u5141\u8bb8kubelet tls bootstrap\u521b\u5efaCSR\u8bf7\u6c42\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>kubectl create clusterrolebinding kubelet-bootstrap1 --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap\n</code></pre> <p>\u628asystem:certificates.k8s.io:certificatesigningrequests:nodeclient\u6388\u6743\u7ed9kubelet-bootstrap\uff0c\u76ee\u7684\u662f\u5b9e\u73b0\u5bf9CSR\u7684\u81ea\u52a8\u5ba1\u6279\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>kubectl create clusterrolebinding kubelet-bootstrap2 --clusterrole=system:certificates.k8s.io:certificatesigningrequests:nodeclient --user=kubelet-bootstrap\n</code></pre> <p>\u8fd9\u4e2a\u7528\u6237\u540d\u662f\u5728\u914d\u7f6eapiserver\u65f6\u7528\u5230\u7684token\u6587\u4ef6<code>/etc/kubernetes/bb.csv</code>\u91cc\u6307\u5b9a\u7684\u3002</p>"},{"location":"03.ultimate/08-install-kubelet/#12","title":"1.2 \u521b\u5efa\u6388\u6743\u914d\u7f6e\u6587\u4ef6","text":"<pre><code># \u8fdb\u5165\u8bc1\u4e66\u76ee\u5f55\ncd /etc/kubernetes/pki/\n\n# \u521b\u5efa\u96c6\u7fa4\u4fe1\u606f\nkubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://192.168.9.190:7443 --kubeconfig=kubelet-bootstrap.conf\n\n# \u521b\u5efa\u7528\u6237\u4fe1\u606f\nkubectl config set-credentials kubelet-bootstrap --token=6440328e1b3a1f4873dc  --kubeconfig=kubelet-bootstrap.conf\n\n# \u8bbe\u7f6e\u4e0a\u4e0b\u6587\nkubectl config set-context kubernetes --cluster=kubernetes --user=kubelet-bootstrap --kubeconfig=kubelet-bootstrap.conf\n\n# \u542f\u7528\u4e0a\u4e0b\u6587\nkubectl config use-context kubernetes --kubeconfig=kubelet-bootstrap.conf\n\n# \u526a\u5207\u914d\u7f6e\u6587\u4ef6\u5230/etc/kubernetes\nmv kubelet-bootstrap.conf  /etc/kubernetes/\n</code></pre> <p>\u751f\u6210\u914d\u7f6e\u6587\u4ef6<code>/etc/kubernetes/kubelet-bootstrap.conf</code>\u4e4b\u540e\uff0c\u4f20\u5230\u5de5\u4f5c\u8282\u70b9\u4e2d\uff0c\u5728\u8fd9\u91cc\u662f<code>192-debian</code>\u548c<code>160-debian</code>\u3002</p>"},{"location":"03.ultimate/08-install-kubelet/#kubelet","title":"\u4e8c\u3001\u521b\u5efakubelet\u914d\u7f6e\u6587\u4ef6","text":"<p>\u521b\u5efakubelet\u80fd\u7528\u5230\u7684\u914d\u7f6e\u6587\u4ef6<code>/etc/kubernetes/kubelet-config.yaml</code>\uff0c\u8fd9\u4e2a\u6587\u4ef6\u7684\u8def\u5f84\u8981\u548c\u4e0b\u9762kubelet\u542f\u52a8\u6587\u4ef6\u91cc\u6307\u5b9a\u7684\u4e00\u81f4\uff0c\u5185\u5bb9\u5982\u4e0b</p> <pre><code>apiVersion: kubelet.config.k8s.io/v1beta1\naddress: 0.0.0.0\nport: 10250 readOnlyPort: 10255\nauthentication:\nanonymous:\nenabled: false\nwebhook:\ncacheTTL: 0s\nenabled: true\nx509:\nclientCAFile: /etc/kubernetes/pki/ca.pem\nauthorization:\nmode: Webhook\nwebhook:\ncacheAuthorizedTTL: 0s\ncacheUnauthorizedTTL: 0s\ncgroupDriver: systemd\nclusterDNS:\n- 10.96.0.10\nclusterDomain: cluster.local\ncpuManagerReconcilePeriod: 0s\nevictionPressureTransitionPeriod: 0s\nfileCheckFrequency: 0s\nhealthzBindAddress: 127.0.0.1\nhttpCheckFrequency: 0s\nimageMinimumGCAge: 0s\nkind: KubeletConfiguration\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u6307\u5b9aclusterDNS\u7684IP\u662f10.96.0.10\u3002</p>"},{"location":"03.ultimate/08-install-kubelet/#kubelet_1","title":"\u4e09\u3001\u914d\u7f6ekubelet\u542f\u52a8\u811a\u672c","text":""},{"location":"03.ultimate/08-install-kubelet/#31","title":"3.1 \u914d\u7f6e\u542f\u52a8\u811a\u672c","text":"<p>\u63a5\u4e0b\u6765\u5728<code>192-debian</code>\u548c<code>160-debian</code>\u4e0a\u542f\u52a8kubelet\uff0c\u5728\u8ba9kubelet\u542f\u52a8\u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u6709\u4e00\u4e2a\u57fa\u7840\u7684pause\u955c\u50cf\uff0c\u4ee5\u4e0b\u662f\u62c9\u53d6\u547d\u4ee4\uff0c\u8be5\u955c\u50cf\u8d1f\u8d23\u5176k8s\u96c6\u7fa4\u4e2dpod\u542f\u52a8\u4e4b\u524d\u7684\u521d\u59cb\u5316\u64cd\u4f5c</p> <pre><code>nerdctl pull registry.aliyuncs.com/google_containers/pause:3.6\n</code></pre> <p>\u521b\u5efakubelet\u7684\u542f\u52a8\u811a\u672c\u6587\u4ef6<code>/opt/kubernetes/server/bin/kubelet.sh</code>\u6587\u4ef6\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>#!/bin/bash\n./kubelet \\\n--bootstrap-kubeconfig=/etc/kubernetes/kubelet-bootstrap.conf  \\\n--cert-dir=/var/lib/kubelet/pki \\\n--hostname-override=node-192 \\\n--kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\\n--config=/etc/kubernetes/kubelet-config.yaml \\\n--pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.6 \\\n--container-runtime=remote \\\n--container-runtime-endpoint=unix:///var/run/containerd/containerd.sock \\\n--runtime-request-timeout=15m \\\n--alsologtostderr=true \\\n--logtostderr=false \\\n--log-dir=/var/log/kubernetes \\\n--v=2\n</code></pre> <p>\u6dfb\u52a0\u53ef\u6267\u884c\u6743\u9650</p> <pre><code>chmod +x /opt/kubernetes/server/bin/kubelet.sh\n</code></pre> <p>\u521b\u5efa\u6570\u636e\u76ee\u5f55\u548c\u65e5\u5fd7\u76ee\u5f55</p> <pre><code># \u521b\u5efakubelet\u6240\u9700\u8981\u7684\u65e5\u5fd7\u76ee\u5f55\nmkdir -p /var/log/kubernetes\n</code></pre>"},{"location":"03.ultimate/08-install-kubelet/#32","title":"3.2 \u914d\u7f6e\u7ba1\u7406\u670d\u52a1","text":"<p>\u521b\u5efasupervisor\u8fdb\u7a0b\u914d\u7f6e\u6587\u4ef6<code>/etc/supervisor/conf.d/kube-kubelet.conf</code>\u6587\u4ef6\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>[program:kube-kubelet-192]\ndirectory=/opt/kubernetes/server/bin\ncommand=/opt/kubernetes/server/bin/kubelet.sh\nnumprocs=1\nautostart=true\nautorestart=true\nstartsecs=30\nstartretries=3\nexitcodes=0,2\nstopsignal=QUIT\nstopwaitsecs=10\nuser=root\nredirect_stderr=true\nstdout_logfile=/data/logs/supervisor/kubelet.stdout.log\nstdout_logfile_maxbytes=64MB\nstdout_logfile_backups=4\nstdout_capture_maxbytes=1MB\nstdout_event_enabled=false\n</code></pre> <p>\u66f4\u65b0supervisord\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>supervisorctl update\n</code></pre>"},{"location":"03.ultimate/08-install-kubelet/#33","title":"3.3 \u9a8c\u8bc1\u96c6\u7fa4","text":"<p>\u6b64\u65f6\uff0c\u670d\u52a1\u5df2\u7ecf\u6b63\u5e38\u8fd0\u884c\u4e86\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b<code>kubectl</code>\u547d\u4ee4\u5728\u67e5\u770b\u8282\u70b9\u4fe1\u606f</p> <pre><code>kubectl get nodes\n</code></pre> <p>\u5982\u679c\u770b\u5230\u4ee5\u4e0b\u4fe1\u606f\uff0c\u4ee3\u8868\u5b89\u88c5\u6210\u529f</p> <pre><code>root@199-debian:/etc/kubernetes# kubectl get nodes\nNAME       STATUS   ROLES    AGE   VERSION\nnode-160   Ready    &lt;none&gt;   40s   v1.24.1\nnode-192   Ready    &lt;none&gt;   47s   v1.24.1\n</code></pre> <p>\u6211\u4eec\u8fd8\u53ef\u4ee5\u8bbe\u7f6e\u96c6\u7fa4\u7684\u6807\u7b7e</p> <pre><code># \u8bbe\u7f6e\u96c6\u7fa4\u4e3anode\u6807\u7b7e\nkubectl label node node-160 node-role.kubernetes.io/node=\nkubectl label node node-192 node-role.kubernetes.io/node=\n</code></pre>"},{"location":"03.ultimate/09-install-kubeproxy/","title":"\u5b89\u88c5proxy","text":""},{"location":"03.ultimate/09-install-kubeproxy/#kubeconfig","title":"\u4e00\u3001\u521b\u5efakubeconfig\u914d\u7f6e\u6587\u4ef6","text":"<p>\u5728<code>199-debian</code>\u670d\u52a1\u5668\u4e0a\u6267\u884c\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code># \u8fdb\u5165\u8bc1\u4e66\u76ee\u5f55\ncd /etc/kubernetes/pki/\n# \u521b\u5efa\u96c6\u7fa4\u4fe1\u606f\nkubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://192.168.9.190:7443 --kubeconfig=kube-proxy.kubeconfig\n\n# \u521b\u5efa\u7528\u6237\u4fe1\u606f\nkubectl config set-credentials kube-proxy --client-certificate=proxy.pem --client-key=proxy-key.pem --embed-certs=true --kubeconfig=kube-proxy.kubeconfig\n\n# \u521b\u5efa\u4e0a\u4e0b\u6587\nkubectl config set-context default --cluster=kubernetes --user=kube-proxy --kubeconfig=kube-proxy.kubeconfig\n\n# \u5e94\u7528\u4e0a\u4e0b\u6587\nkubectl config use-context default --kubeconfig=kube-proxy.kubeconfig\n\n# \u526a\u5207\u5230/etc/kubernetes/\nmv kube-proxy.kubeconfig /etc/kubernetes/\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u540c\u6b65\u5230\u5de5\u4f5c\u8282\u70b9<code>192-debian</code>\u548c<code>160-debian</code>\u3002</p>"},{"location":"03.ultimate/09-install-kubeproxy/#kube-proxy","title":"\u4e8c\u3001\u521b\u5efakube-proxy\u914d\u7f6e\u6587\u4ef6","text":"<p>\u5728\u5de5\u4f5c\u8282\u70b9\u521b\u5efa<code>/etc/kubernetes/kube-proxy.yaml</code>\uff0c\u5185\u5bb9\u5982\u4e0b</p> <pre><code>apiVersion: kubeproxy.config.k8s.io/v1alpha1\nbindAddress: 0.0.0.0\nclientConnection:\n  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig\nclusterCIDR: 10.244.0.0/16 kind: KubeProxyConfiguration\nmetricsBindAddress: 0.0.0.0:10249\nmode: \"ipvs\"\n</code></pre>"},{"location":"03.ultimate/09-install-kubeproxy/#_1","title":"\u4e09\u3001\u542f\u52a8\u670d\u52a1","text":""},{"location":"03.ultimate/09-install-kubeproxy/#31","title":"3.1 \u521b\u5efa\u542f\u52a8\u811a\u672c","text":"<p>\u5728\u4e24\u53f0\u4e3b\u673a\u6267\u884c\u4ee5\u4e0a\u811a\u672c\u4e4b\u540e\uff0c\u6211\u4eec\u521b\u5efa<code>kube-proxy</code>\u7684\u542f\u52a8\u811a\u672c\u6587\u4ef6<code>/opt/kubernetes/server/bin/kube-proxy.sh</code></p> <pre><code>#!/bin/bash\n./kube-proxy \\\n--config=/etc/kubernetes/kube-proxy.yaml \\\n--alsologtostderr=true \\\n--logtostderr=false \\\n--log-dir=/var/log/kubernetes \\\n--v=2\n</code></pre> <p>\u6dfb\u52a0\u53ef\u6267\u884c\u6743\u9650</p> <pre><code>chmod +x /opt/kubernetes/server/bin/kube-proxy.sh\n</code></pre>"},{"location":"03.ultimate/09-install-kubeproxy/#32","title":"3.2 \u521b\u5efa\u670d\u52a1\u914d\u7f6e","text":"<p>\u521b\u5efasupervisor\u7684\u914d\u7f6e\u6587\u4ef6<code>/etc/supervisor/conf.d/kube-proxy.conf</code>\u6587\u4ef6\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>[program:kube-proxy-192]\ndirectory=/opt/kubernetes/server/bin\ncommand=/opt/kubernetes/server/bin/kube-proxy.sh\nnumprocs=1\nautostart=true\nautorestart=true\nstartsecs=30\nstartretries=3\nexitcodes=0,2\nstopsignal=QUIT\nstopwaitsecs=10\nuser=root\nredirect_stderr=true\nstdout_logfile=/data/logs/supervisor/kube-proxy.stdout.log\nstdout_logfile_maxbytes=64MB\nstdout_logfile_backups=4\nstdout_capture_maxbytes=1MB\nstdout_event_enabled=false\n</code></pre> <p>\u66f4\u65b0supervisor</p> <pre><code>supervisorctl update\n</code></pre>"},{"location":"03.ultimate/09-install-kubeproxy/#_2","title":"\u56db\u3001\u521b\u5efa\u5fc5\u8981\u7684\u6743\u9650","text":""},{"location":"03.ultimate/09-install-kubeproxy/#41","title":"4.1 \u521b\u5efa\u6743\u9650\u914d\u7f6e\u6587\u4ef6","text":"<p>\u5728<code>199-debian</code>\u4e0a\u521b\u5efa<code>/etc/kubernetes/rbac.yaml</code>\uff0c\u5199\u5165\u5982\u4e0b\u5185\u5bb9</p> <pre><code>apiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  annotations:\n    rbac.authorization.kubernetes.io/autoupdate: \"true\"\n  labels:\n    kubernetes.io/bootstrapping: rbac-defaults\n  name: system:kubernetes-to-kubelet\nrules:\n  - apiGroups:\n      - \"\"\n    resources:\n      - nodes/proxy\n      - nodes/stats\n      - nodes/log\n      - nodes/spec\n      - nodes/metrics\n    verbs:\n      - \"*\"\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: system:kubernetes\n  namespace: \"\"\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: system:kubernetes-to-kubelet\nsubjects:\n  - apiGroup: rbac.authorization.k8s.io\n    kind: User\n    name: kubernetes\n</code></pre>"},{"location":"03.ultimate/09-install-kubeproxy/#42","title":"4.2 \u521b\u5efa\u89d2\u8272\u53ca\u6388\u6743","text":"<pre><code>kubectl apply -f /etc/kubernetes/rbac.yaml\n</code></pre>"},{"location":"03.ultimate/09-install-kubeproxy/#_3","title":"\u4e94\u3001\u96c6\u7fa4\u7684\u9a8c\u8bc1","text":"<p>\u5728\u4e24\u4e2a\u8282\u70b9\u90fd\u542f\u52a8\u597dkube-proxy\u670d\u52a1\u4e4b\u540e\uff0c\u81f3\u6b64\uff0c\u96c6\u7fa4\u7684\u57fa\u672c\u7ec4\u4ef6\u5df2\u7ecf\u5b89\u88c5\u5b8c\u6210\uff0c\u4e0b\u9762\u6211\u4eec\u6765\u9a8c\u8bc1\u96c6\u7fa4\u3002\u5728\u4efb\u610f\u7ba1\u7406\u8282\u70b9\u521b\u5efa\u4e00\u4e2aPod\u7c7b\u578b\u7684\u8d44\u6e90\uff0c\u6dfb\u52a0<code>nginx-pod.yaml</code>\u6587\u4ef6\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: pod1\nspec:\ncontainers:\n- name: nginx-pod\nimage: nginx:latest\nimagePullPolicy: IfNotPresent\nports:\n- name: nginxport\ncontainerPort: 80\n</code></pre> <p>\u6267\u884c\u8d44\u6e90\u521b\u5efa\u547d\u4ee4</p> <pre><code>kubectl create -f nginx-ds.yaml\n</code></pre> <p>\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u9a8c\u8bc1pod\u662f\u5426\u6b63\u5e38\u8fd0\u884c</p> <pre><code>kubectl get pod -o wide\n</code></pre> <p>\u5982\u679c\u8fd4\u56de\u5982\u4e0b\u5185\u5bb9\uff0c\u4ee3\u8868\u96c6\u7fa4\u6b63\u5e38</p> <pre><code>root@199-debian:~# kubectl get pod -o wide\nNAME   READY   STATUS    RESTARTS   AGE     IP          NODE       NOMINATED NODE   READINESS GATES\npod1   1/1     Running   0          2m52s   10.88.0.2   node-192   &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u521b\u5efa\u7684pod\u8fd0\u884c\u5728<code>node-192</code>\u8fd9\u53f0\u4e3b\u673a\u4e0a\uff0c\u5728\u8fd9\u53f0\u673a\u4f7f\u7528<code>curl 10.88.0.2</code>\u547d\u4ee4\u80fd\u6b63\u5e38\u8bbf\u95ee\u5230nginx\u670d\u52a1\u3002\u4f46\u662f\u5982\u679c\u6211\u4eec\u5728\u53e6\u4e00\u4e2a\u8282\u70b9<code>node-160</code>\u4e0a\u6267\u884c<code>curl curl 10.88.0.2</code>\u4f1a\u53d1\u73b0\u8bbf\u95ee\u4e0d\u5230\u3002\u539f\u56e0\u662f\u8fd9\u4e24\u4e2a\u8282\u70b9\u4e0a\u7684\u5bb9\u5668\u5728\u5404\u81ea\u7684\u865a\u62df\u7f51\u7edc\u5185\uff0c\u6211\u4eec\u5c06\u5230\u540e\u7eed\u7684\u7ae0\u8282\u5b89\u88c5\u901a\u8fc7\u5b89\u88c5k8s\u7f51\u7edc\u63d2\u4ef6\u7684\u65b9\u5f0f\uff0c\u7ee7\u7eed\u89e3\u51b3\u4e0d\u540c\u8282\u70b9\u7684\u5bb9\u5668\u7f51\u7edc\u4e92\u76f8\u8bbf\u95ee\u7684\u95ee\u9898\uff01</p>"},{"location":"03.ultimate/10-install-calico-coredns/","title":"\u5b89\u88c5calico\u548ccoreDNS","text":"<p>\u4ee5\u4e0b\u7684\u64cd\u4f5c\uff0c\u6211\u4eec\u5728<code>199-debian</code>\u8282\u70b9\u53bb\u5b8c\u6210\u3002</p>"},{"location":"03.ultimate/10-install-calico-coredns/#calico","title":"\u4e00\u3001\u5b89\u88c5calico","text":"<pre><code>cd /etc/kubernetes\nwget https://docs.projectcalico.org/manifests/calico.yaml\n</code></pre> <p>\u4fee\u6539calico.yaml\u6587\u4ef6\uff0c\u5c06<code>CALICO_IPV4POOL_CIDR</code>\u6539\u4e3a\u548ckube-proxy\u7684\u914d\u7f6e\u4e00\u6837\uff0c\u5982\u4e0b</p> <pre><code>- name: CALICO_IPV4POOL_CIDR\nvalue: \"10.244.0.0/16\"\n</code></pre> <p>\u521b\u5efacalico\u670d\u52a1</p> <pre><code>kubectl apply -fcalico.yaml\n</code></pre> <p>\u6267\u884c\u547d\u4ee4\u4e4b\u540e\uff0ccalico\u4f1a\u62c9\u53bb\u8fdc\u7aef\u7684\u955c\u50cf\u5e76\u8fd0\u884c\uff0c\u7b49\u5230\u6240\u6709pod\u90fd\u5904\u4e8e<code>Running</code>\u72b6\u6001\u4ee3\u8868\u670d\u52a1\u542f\u52a8\u5b8c\u6210\uff0c\u5982\u4e0b</p> <pre><code>root@199-debian:/etc/kubernetes# kubectl get pods -n kube-system\nNAME                                       READY   STATUS    RESTARTS   AGE\ncalico-kube-controllers-6799f5f4b4-xqpf9   1/1     Running   0          3m34s\ncalico-node-9bt29                          1/1     Running   0          3m34s\ncalico-node-djxvc                          1/1     Running   0          3m34s\n</code></pre> <p>\u6b64\u65f6calico\u5df2\u7ecf\u6b63\u5e38\u8fd0\u884c\u4e86\uff0c\u5982\u679c\u4e0a\u8282\u521b\u5efa\u7684nginx\u7684pod\u8fd8\u6ca1\u6709\u5220\u9664\u7684\u8bdd\uff0c\u5148\u5220\u9664\u6389\u518d\u521b\u5efa\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>kubectl delete -f nginx-pod.yaml\nkubectl apply -f nginx-pod.yaml\n</code></pre> <p>\u521b\u5efa\u65b0\u7684pod\u4e4b\u540e\uff0c\u4f7f\u7528<code>kubectl get pod -o wide</code>\u67e5\u770bpod\u6240\u5904\u7684\u8282\u70b9\uff0c\u6b64\u65f6\u6211\u4eec\u5728\u4efb\u610f\u5de5\u4f5c\u8282\u70b9\u8bf7\u6c42\u8be5IP\uff0c\u90fd\u80fd\u6210\u529f\u8bf7\u6c42\u3002</p>"},{"location":"03.ultimate/10-install-calico-coredns/#coredns","title":"\u4e8c\u3001\u5b89\u88c5coredns","text":""},{"location":"03.ultimate/10-install-calico-coredns/#21","title":"2.1 \u4e0b\u8f7d\u57fa\u7840\u8d44\u6e90\u914d\u7f6e\u6587\u4ef6","text":"<p>\u4e0b\u8f7dcorndns\u8d44\u6e90\u914d\u7f6e\u6587\u4ef6</p> <pre><code># \u4e0b\u8f7d\nwget https://raw.githubusercontent.com/coredns/deployment/master/kubernetes/coredns.yaml.sed\n# \u91cd\u547d\u540d\nmv coredns.yaml.sed coredns.yaml\n</code></pre>"},{"location":"03.ultimate/10-install-calico-coredns/#22","title":"2.2 \u4fee\u6539\u914d\u7f6e","text":"<p>\u505a\u51fa\u4ee5\u4e0b\u4fee\u6539\uff1a</p> <p>\u5927\u6982\u7b2c62\u884c\uff0c\u627e\u5230\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684<code>CLUSTER_DOMAIN</code>\u3001<code>REVERSE_CIDRS</code>\u8fd9\u4e24\u4e2a\u53d8\u91cf\u6539\u4e3a\u96c6\u7fa4\u57df\u540d\uff0c\u5982\u4e0b</p> <pre><code>kubernetes cluster.local in-addr.arpa ip6.arpa {\n  fallthrough in-addr.arpa ip6.arpa\n}\n</code></pre> <p>\u5927\u6982\u7b2c66\u884c\uff0c<code>UPSTREAMNAMESERVER</code>\u6539\u4e3a\u5bbf\u4e3b\u673aDNS\u914d\u7f6e<code>/etc/resolve.conf</code>\uff0c\u5982\u4e0b</p> <pre><code>forward . /etc/resolve.conf {\nmax_concurrent 1000\n}\n</code></pre> <p>\u5927\u6982\u5728186\u884c\uff0c\u5c06<code>CLUSTER_DNS_IP</code>\u6539\u4e3akubelet\u914d\u7f6e\u6587\u4ef6\u4e2d\u6307\u5b9a\u7684\u96c6\u7fa4IP\u5730\u5740<code>10.96.0.10</code>\uff0c\u5982\u4e0b</p> <pre><code>spec:\n  selector:\n    k8s-app: kube-dns\n  clusterIP: 10.96.0.10\n</code></pre>"},{"location":"03.ultimate/10-install-calico-coredns/#23","title":"2.3 \u542f\u52a8\u670d\u52a1","text":"<p>\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u542f\u52a8\u670d\u52a1</p> <pre><code>kubectl apply -f coredns.yaml\n</code></pre>"},{"location":"03.ultimate/11-install-traefik/","title":"\u5b89\u88c5traefik-ingress","text":""},{"location":"03.ultimate/11-install-traefik/#_1","title":"\u4e00\u3001\u521b\u5efa\u89d2\u8272\u548c\u8d26\u53f7","text":"<p>\u5728\u8fd0\u884ctraefik\u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u4e3atraefik\u7279\u5b9a\u7684\u89d2\u8272\u548c\u8d26\u53f7\uff0c\u6211\u4eec\u5728<code>199-debian</code>\u64cd\u4f5c\u5373\u53ef\u3002</p>"},{"location":"03.ultimate/11-install-traefik/#11","title":"1.1 \u521b\u5efa\u89d2\u8272","text":"<pre><code>cat &gt; /etc/kubernetes/traefik-role.yml &lt;&lt;EOF\nkind: ClusterRole\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: traefik-role\nrules:\n  - apiGroups:\n      - \"\"\n    resources:\n      - services\n      - endpoints\n      - secrets\n    verbs:\n      - get\n      - list\n      - watch\n  - apiGroups:\n      - extensions\n      - networking.k8s.io\n    resources:\n      - ingresses\n      - ingressclasses\n    verbs:\n      - get\n      - list\n      - watch\n  - apiGroups:\n      - extensions\n      - networking.k8s.io\n    resources:\n      - ingresses/status\n    verbs:\n      - update\nEOF\n</code></pre>"},{"location":"03.ultimate/11-install-traefik/#12","title":"1.2 \u521b\u5efa\u8d26\u53f7","text":"<pre><code>cat &gt; /etc/kubernetes/traefik-account.yml &lt;&lt;EOF\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: traefik-account\nEOF\n</code></pre>"},{"location":"03.ultimate/11-install-traefik/#13","title":"1.3 \u521b\u5efa\u89d2\u8272\u548c\u8d26\u53f7\u7ed1\u5b9a","text":"<pre><code>cat &gt; /etc/kubernetes/traefik-role-binding.yml &lt;&lt;EOF\nkind: ClusterRoleBinding\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: traefik-role-binding\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: traefik-role\nsubjects:\n  - kind: ServiceAccount\n    name: traefik-account\n    namespace: default\nEOF\n</code></pre>"},{"location":"03.ultimate/11-install-traefik/#_2","title":"\u4e8c\u3001\u542f\u52a8\u670d\u52a1","text":""},{"location":"03.ultimate/11-install-traefik/#21-traefik","title":"2.1 \u542f\u52a8traefik","text":"<pre><code>cat &gt; /etc/kubernetes/traefik.yml &lt;&lt;EOF\nkind: Deployment\napiVersion: apps/v1\nmetadata:\n  name: traefik-deployment\n  labels:\n    app: traefik\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: traefik\n  template:\n    metadata:\n      labels:\n        app: traefik\n    spec:\n      serviceAccountName: traefik-account\n      containers:\n        - name: traefik\n          image: traefik:v2.8\n          args:\n            - --api.insecure\n            - --providers.kubernetesingress\n          ports:\n            - name: web\n              containerPort: 80\n            - name: dashboard\n              containerPort: 8080\nEOF\n</code></pre> <p>\u57fa\u4e8etraefik\u955c\u50cf\u542f\u52a8\u7684pod\u5c06\u521b\u5efa\u8fd0\u884c\u4e24\u4e2a\u7aef\u53e3\u670d\u52a1\uff0c<code>80</code>\u5bf9\u5e94ingress\u672c\u8eab\u6838\u5fc3\u670d\u52a1\uff0c\u6211\u4eec\u540e\u7eed\u53ef\u4ee5\u5c06\u6d41\u91cf\u90fd\u8f6c\u53d1\u5230ingress\u7684<code>80</code>\u7aef\u53e3\uff0c\u8ba9ingress\u505a\u6d41\u91cf\u8c03\u5ea6\u3002<code>8080</code>\u662ftraefik\u7684\u63a7\u5236\u9762\u677f\u540e\u53f0\u670d\u52a1\u3002</p>"},{"location":"03.ultimate/11-install-traefik/#22-traefikservice","title":"2.2 \u521b\u5efatraefik\u7684service","text":"<pre><code>cat /etc/kubernetes/traefik-services.yml &lt;&lt;EOF\napiVersion: v1\nkind: Service\nmetadata:\n  name: traefik-dashboard-service\nspec:\n  type: NodePort\n  ports:\n    - port: 8080\n      name: dashboard\n      protocol: TCP\n      nodePort: 34808\n      name: http\n  selector:\n    app: traefik\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: traefik-web-service\nspec:\n  type: NodePort\n  ports:\n    - port: 80\n      name: web\n      protocol: TCP\n      nodePort: 34807\n      name: http\n  selector:\n    app: traefik\nEOF\n</code></pre> <p>\u6211\u4eec\u521b\u5efa\u4e24\u4e2a<code>nodePort</code>\u7c7b\u578b\u7684service\uff0c\u76ee\u7684\u662f\u4e3a\u4e86\u5728\u6bcf\u4e2a\u5de5\u4f5c\u8282\u70b9\u4e0a\u63d0\u4f9b\u4e00\u4e2a\u670d\u52a1\u5165\u53e3\u3002\u540e\u7eed\u518d\u5c06\u8bf7\u6c42\u8d1f\u8f7d\u5230\u5404\u4e2a\u8282\u70b9\u4e0a\u3002</p>"},{"location":"03.ultimate/11-install-traefik/#23-nginx","title":"2.3 \u914d\u7f6enginx","text":"<p>\u5728<code>http</code>\u8282\u70b9\u6dfb\u52a0\u4ee5\u4e0b\u914d\u7f6e</p> <pre><code>upstream traefik_dashboard {\nserver 192.168.9.192:34808    max_fails=3 fail_timeout=10s;\nserver 192.168.9.160:34808    max_fails=3 fail_timeout=10s;\n}\nserver {\nserver_name traefik.k8s.com;\nlocation / {\nproxy_pass http://traefik_dashboard;\nproxy_set_header Host       $http_host;\nproxy_set_header x-forwarded-for $proxy_add_x_forwarded_for;\n}\n}\nupstream default_backend_traefik {\nserver 192.168.9.192:34807    max_fails=3 fail_timeout=10s;\nserver 192.168.9.160:34807    max_fails=3 fail_timeout=10s;\n}\nserver {\nserver_name *.jkdev.cn;\nlocation / {\nproxy_pass http://default_backend_traefik;\nproxy_set_header Host       $http_host;\nproxy_set_header x-forwarded-for $proxy_add_x_forwarded_for;\n}\n}\n</code></pre> <p>\u5728\u4ee5\u4e0a\u914d\u7f6e\u4e2d\uff0c\u6211\u4eec\u628a<code>traefik.k8s.com</code>\u7684\u8bf7\u6c42\u8f6c\u53d1\u5230traefik\u7684\u63a7\u5236\u9762\u677f\u3002\u540c\u65f6\uff0c\u6211\u4eec\u628a<code>*.jkdev.cn</code>\u7684\u6240\u6709\u6d41\u91cf\u8f6c\u53d1\u5230\u96c6\u7fa4\u7684traefik\u670d\u52a1\uff0c\u7531traefik\u6765\u8c03\u5ea6\uff0c\u540e\u7eed\u53d1\u5e03\u5e94\u8be5\u6211\u4eec\u53ea\u9700\u8981\u914d\u7f6e\u597dingress\u8d44\u6e90\u5373\u53ef\u3002</p> <p>\u81f3\u6b64\uff0c\u96c6\u7fa4\u7684\u6838\u5fc3\u7ec4\u4ef6\u548c\u6838\u5fc3\u63d2\u4ef6\u5df2\u7ecf\u5168\u90e8\u5b89\u88c5\u5b8c\u6bd5\uff0c\u96c6\u7fa4\u5df2\u53ef\u4ee5\u6b63\u5e38\u5de5\u4f5c\u3002\u6211\u4eec\u5c06\u5728\u6700\u540e\u4e00\u8282\u53d1\u5e03\u4e00\u4e2ak8\u5e94\u7528\uff0c\u656c\u8bf7\u671f\u5f85\u3002</p>"},{"location":"03.ultimate/12-deploy-app/","title":"\u5728k8s\u73af\u5883\u90e8\u7f72\u5e94\u7528","text":""},{"location":"03.ultimate/12-deploy-app/#_1","title":"\u4e00\u3001\u6982\u8ff0","text":"<p>\u90e8\u7f72k8s\u901a\u5e38\u5305\u542b\u4ee5\u4e0b\u51e0\u4e2a\u6b65\u9aa4</p> <ul> <li>1.\u51c6\u5907\u9879\u76ee\u955c\u50cf\uff0c\u7528\u4e8e\u542f\u52a8\u5e94\u7528\u5bb9\u5668</li> <li>2.\u901a\u5e38\u521b\u5efaDeployment\u8d44\u6e90\u7684\u65b9\u5f0f\u8fd0\u884c\u5e94\u7528</li> <li>3.\u521b\u5efa\u5e94\u7528\u7684Service\u7f51\u7edc\uff0c\u7528\u4e8e\u5173\u8054Deployment</li> <li>4.\u521b\u5efa\u5bf9\u5e94\u7684Ingress\u8d44\u6e90\uff0c\u7528\u4e8e\u8c03\u5ea67\u5c42\u6d41\u91cf</li> </ul> <p>\u5728\u4e0b\u6587\uff0c\u6211\u4eec\u4f7f\u7528\u58f0\u660e\u5f0f\u7684\u7ba1\u7406\u65b9\u5f0f\uff08\u901a\u5e38\u6307\u901a\u8fc7yaml\u914d\u7f6e\u6587\u4ef6\u6765\u7ba1\u7406\u96c6\u7fa4\uff09\u6765\u521b\u5efa\u5404\u4e2a\u96c6\u7fa4\u8d44\u6e90\uff0c\u5b8c\u6210\u5e94\u7528\u90e8\u7f72\u3002</p>"},{"location":"03.ultimate/12-deploy-app/#_2","title":"\u4e8c\u3001\u51c6\u5907\u8d44\u6e90\u914d\u7f6e\u6587\u4ef6","text":"<p>\u6211\u4eec\u901a\u8fc7\u90e8\u7f72tomcat\u6765\u6f14\u793a\u4e00\u4e2a\u5e94\u7528\u5728k8s\u90e8\u7f72\u7684\u6d41\u7a0b</p>"},{"location":"03.ultimate/12-deploy-app/#21-deploymeny","title":"2.1 \u58f0\u660edeploymeny","text":"<p>\u521b\u5efa<code>03-whoami.yml</code>\u6587\u4ef6\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>kind: Deployment\napiVersion: apps/v1\nmetadata:\nname: whoami\nlabels:\napp: whoami\nspec:\nreplicas: 1\nselector:\nmatchLabels:\napp: whoami\ntemplate:\nmetadata:\nlabels:\napp: whoami\nspec:\ncontainers:\n- name: whoami\nimage: tomcat:8.5-jre10-slim\nports:\n- name: web\ncontainerPort: 8080\n</code></pre>"},{"location":"03.ultimate/12-deploy-app/#22-service","title":"2.2 \u58f0\u660eservice","text":"<p>\u521b\u5efa<code>03-whoami-services.yml</code>\u6587\u4ef6\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: whoami\n\nspec:\n  ports:\n    - name: web\n      port: 80\n      targetPort: web\n\n  selector:\n    app: whoami\n</code></pre>"},{"location":"03.ultimate/12-deploy-app/#23-ingress","title":"2.3 \u58f0\u660eingress","text":"<p>\u521b\u5efa<code>04-whoami-ingress.yml</code>\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: whoami-ingress\nspec:\n  rules:\n  - host: tomcat.jkdev.cn\n    http:\n      paths:\n      - path: /\n        pathType: Prefix\n        backend:\n          service:\n            name: whoami\n            port:\n              name: web\n</code></pre>"},{"location":"03.ultimate/12-deploy-app/#_3","title":"\u4e09\u3001\u8d44\u6e90\u521b\u5efa\u4e0e\u9a8c\u8bc1","text":"<p>\u521b\u5efa\u5404\u4e2a\u8d44\u6e90</p> <pre><code>kubectl apply -f 03-whoami-services.yml \\\n-f 03-whoami.yml \\\n-f 04-whoami-ingress.yml\n</code></pre> <p>\u6267\u884c\u4ee5\u4e0a\u547d\u4ee4\u4e4b\u540e\uff0ck8s\u5c06\u4f1a\u62c9\u53d6tomcat\u7684\u955c\u50cf\uff0c\u5e76\u6309\u6211\u4eec\u6307\u5b9a\u7684\u914d\u7f6e\u53bb\u542f\u52a8\u670d\u52a1\u3002</p> <p>\u542f\u52a8\u5b8c\u6210\u4e4b\u540e\uff0c\u6211\u4eec\u5728\u81ea\u5df1\u7684\u684c\u9762\u64cd\u4f5c\u7cfb\u7edf\u7684\u7535\u8111\u4e0a\u5c06<code>tomcat.jkdev.cn</code>\u57df\u540d\u89e3\u6790\u5230\u5728\u524d\u9762\u901a\u8fc7keepalived\u521b\u5efa\u7684\u865a\u62dfIP <code>192.168.9.190</code>\uff0c\u518d\u4f7f\u7528\u6d4f\u89c8\u5668\u8bbf\u95ee\u57df\u540d\uff0c\u5c31\u987a\u5229\u8bbf\u95ee\u5230\u4e86tomcat\u3002</p>"},{"location":"04.extend/01-k8s-resources/","title":"k8s\u8d44\u6e90\u5206\u7c7b","text":""},{"location":"04.extend/01-k8s-resources/#wordflow","title":"\u4e00\u3001wordflow\u7c7b","text":"<ul> <li>pods</li> <li>replicasets/rs</li> <li>daemonsets/ds</li> <li>deployments/deploy</li> <li>statefulsets/sts</li> <li>cronjobs/cj</li> <li>jobs</li> </ul>"},{"location":"04.extend/01-k8s-resources/#_1","title":"\u4e8c\u3001\u7f51\u7edc\u8d1f\u8f7d\u7c7b","text":"<ul> <li>endpoints/ep</li> <li>ingresses/ing</li> <li>ingressclasses</li> <li>services/svc</li> <li>networkpolicies/netpol</li> </ul>"},{"location":"04.extend/01-k8s-resources/#_2","title":"\u4e09\u3001\u5b58\u50a8\u914d\u7f6e\u7c7b","text":"<p>namespace\u7ea7</p> <ul> <li>persistentvolumeclaims/pvc</li> <li>configmaps/cm</li> <li>secrets</li> <li>volumesnapshots</li> </ul> <p>\u96c6\u7fa4\u7ea7</p> <ul> <li>storageclasses/sc</li> <li>persistentvolumes/pv</li> </ul>"},{"location":"04.extend/01-k8s-resources/#_3","title":"\u56db\u3001\u6743\u9650\u7c7b","text":"<p>namespace\u7ea7</p> <ul> <li>bindings</li> <li>serviceaccounts/sa</li> <li>rolebindings</li> <li>roles</li> </ul> <p>\u96c6\u7fa4\u7ea7</p> <ul> <li>role</li> <li>clusterrole</li> <li>roleBinding</li> <li>clusterrolebinding</li> </ul>"},{"location":"04.extend/01-k8s-resources/#_4","title":"\u4e94\u3001\u96c6\u7fa4\u7ba1\u7406\u7c7b","text":"<ul> <li>namespace/ns</li> <li>node/no</li> <li>customresourcedefinitions/crd</li> <li>apiservices</li> <li>hpa</li> <li>events/ev</li> <li>limitranges/limits</li> </ul>"},{"location":"04.extend/02-install-docker/","title":"\u6269\u5c55:\u4f7f\u7528\u4e8c\u8fdb\u5236\u5b89\u88c5\u5305\u5b89\u88c5docker","text":"<p>\u672c\u6587\u53c2\u8003docker\u5b98\u65b9\u6587\u6863\uff0c\u65b0\u7248\u672c\u7684kubernetes\u5e76\u4e0d\u63a8\u8350\u4f7f\u7528docker\u4f5c\u4e3a\u96c6\u7fa4\u7684\u8fd0\u884c\u65f6\u73af\u5883\uff0c\u6211\u4eec\u4e5f\u4e0d\u628adocker\u4f5c\u4e3a\u96c6\u7fa4\u7684\u8fd0\u884c\u65f6\u73af\u5883\u3002\u8fd9\u91cc\u5b89\u88c5docker\u53ea\u662f\u5907\u7528\uff0c\u6216\u8005\u7528\u4e8e\u5176\u4ed6\u7528\u9014\u3002</p>"},{"location":"04.extend/02-install-docker/#docker_1","title":"\u4e00\u3001\u5b89\u88c5docker","text":"<p>\u6211\u4eec\u8981\u5728\u6240\u6709\u51c6\u5907\u7684\u8282\u70b9\u4e0a\u5b89\u88c5docker\uff0c\u4ee5\u4e0b\u662f\u5b89\u88c5\u7684\u8fc7\u7a0b</p> <p>docker\u4e8c\u8fdb\u5236\u5b89\u88c5\u5305\u7684\u4e0b\u8f7d\u5730\u5740\u4e3a\uff1ahttps://download.docker.com/linux/static/stable/</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5982\u679c\u4f7f\u7528docker\u6700\u4e3ak8s\u7684\u8fd0\u884c\u65f6\uff0c\u5b89\u88c5\u7684docker\u7248\u672c\u5fc5\u987b\u5bf9\u5e94\u4e0a\u5b89\u88c5\u7684k8s\u7248\u672c\u3002\u7406\u8bba\u4e0a\u8d8a\u65b0\u7684k8s\u7248\u672c\u652f\u6301\u7684docker\u7248\u672c\u8d8a\u591a\uff0c\u4f46\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5982\u679c\u9009\u62e9\u592a\u65b0\u7684docker\uff0c\u5373\u4f7f\u662f\u6700\u65b0\u7684k8s\u7248\u672c\u4e5f\u53ef\u80fd\u6765\u8fd8\u6765\u4e0d\u6025\u505a\u9002\u914d\u3002\u8fd9\u91cc\u6211\u4eec\u9009\u62e9\u4e00\u4e2a\u76f8\u5bf9\u65b0\u7684\u7248\u672c<code>20.10.14</code>\u3002</p> <pre><code># \u4e0b\u8f7d\u4e8c\u8fdb\u5236\u5b89\u88c5\u5305\nwget https://download.docker.com/linux/static/stable/x86_64/docker-20.10.14.tgz\n# \u89e3\u538b\u5b89\u88c5\u5305\ntar -zxvf docker-20.10.14.tgz\n# \u8d4b\u4e88\u6240\u6709\u4e8c\u8fdb\u5236\u6587\u4ef6\u53ef\u4e4b\u884c\u6743\u9650\nchmod +x docker/*\n# \u5c06\u89e3\u538b\u5305\u91cc\u7684\u5185\u5bb9\u79fb\u52a8\u7cfb\u7edf\u7684\u53ef\u6267\u884c\u6587\u4ef6\u76ee\u5f55\u4e2d\nmv docker/* /usr/bin\n</code></pre>"},{"location":"04.extend/02-install-docker/#docker_2","title":"\u4e8c\u3001\u914d\u7f6edocker","text":"<p>\u521b\u5efa\u914d\u7f6e\u6587\u4ef6 <code>/etc/docker/daemon.json</code>\uff0c\u8bbe\u7f6e\u975ehttps\u7684\u955c\u50cf\u5730\u5740\uff0c\u8bbe\u7f6e\u52a0\u901f\u955c\u50cf\u5730\u5740\u7b49\uff0c\u6839\u636e\u81ea\u5df1\u7684\u60c5\u51b5\u6765\u914d\u7f6e\uff0c\u6211\u914d\u7f6e\u7684\u5185\u5bb9\u5982\u4e0b</p> <pre><code>{\n\"storage-driver\": \"overlay2\",\n\"insecure-registries\": [\"harbor.k8s.com\"],\n\"registry-mirrors\": [\"https://registry.cn-hangzhou.aliyuncs.com\"],\n\"bip\": \"172.7.199.1/24\",\n\"exec-opts\": [\"native.cgroupdriver=systemd\"],\n\"live-restore\": true\n}\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c<code>bip</code>\u7684\u914d\u7f6e\u5728\u4e0d\u540c\u4e3b\u673a\u7684\u914d\u7f6e\u9700\u8981\u4e0d\u4e00\u6837\uff0c\u8fd9\u662f\u751f\u6210\u7684\u5bb9\u5668\u7684IP\u7f51\u6bb5\u3002</p> <p>\u8ddf\u591a\u7684\u914d\u7f6e\u9879\u53ef\u4ee5\u53c2\u8003\u5b98\u65b9\u6587\u6863\uff1ahttps://docs.docker.com/engine/reference/commandline/dockerd/#options</p>"},{"location":"04.extend/02-install-docker/#systemd","title":"\u4e09\u3001\u914d\u7f6esystemd\u670d\u52a1\u7ba1\u7406","text":""},{"location":"04.extend/02-install-docker/#31-cgroup","title":"3.1 \u81ea\u52a8\u6302\u8f7dcgroup","text":"<pre><code># \u5b89\u88c5\napt install -y cgroupfs-mount\n# \u6302\u5728\ncgroupfs-mount\n# \u5f00\u673a\u81ea\u542f\u52a8\nsystemctl enable cgroupfs-mount\n</code></pre>"},{"location":"04.extend/02-install-docker/#32-containerd","title":"3.2 \u5173\u4e8econtainerd","text":"<p>\u5b9e\u9645\u4e0adocker\u8fd0\u884c\u7684\u65f6\u5019\u4f1a\u4f9d\u8d56containerd\uff0c\u4e0d\u8fc7\u6211\u4eec\u5728\u524d\u9762\u5df2\u7ecf\u5b89\u88c5\u4e86containerd\uff08\u8def\u5f84\u5728/usr/local/bin/containerd\uff09\uff0cdocker\u4e8c\u8fdb\u5236\u5b89\u88c5\u5305\u5305\u542b\u7684containerd\uff08\u8def\u5f84\u5728/usr/bin/containerd\uff09\u5c31\u4e0d\u7528\u7ba1\u4e86\u3002</p>"},{"location":"04.extend/02-install-docker/#33-docker","title":"3.3 docker\u670d\u52a1\u914d\u7f6e","text":"<p>\u6dfb\u52a0<code>docker</code>\u7684\u670d\u52a1\u914d\u7f6e\u6587\u4ef6<code>/usr/lib/systemd/system/docker.service</code>\uff0c\u5199\u5165\u5982\u4e0b\u5185\u5bb9</p> <pre><code>[Unit]\nDescription=Docker Application Container Engine\nDocumentation=https://docs.docker.com\nAfter=network-online.target firewalld.service\nWants=network-online.target\n[Service]\nType=notify\nExecStart=/usr/bin/dockerd\nExecReload=/bin/kill -s HUP LimitNOFILE=infinity\nLimitNPROC=infinity\nTimeoutStartSec=0\nDelegate=yes\nKillMode=process\nRestart=on-failure\nStartLimitBurst=3\nStartLimitInterval=60s\n[Install]\nWantedBy=multi-user.target\n</code></pre> <p>\u542f\u52a8\u4e0e<code>docker</code>\u5e76\u8bbe\u7f6e\u4e3a\u5f00\u673a\u81ea\u542f</p> <pre><code>systemctl daemon-reload\nsystemctl start docker.service\nsystemctl enable docker.service\n</code></pre>"},{"location":"04.extend/02-install-docker/#docker_3","title":"\u56db\u3001\u9a8c\u8bc1docker","text":"<p>\u8fd0\u884c\u4e00\u4e2anginx\u5bb9\u5668\uff0c\u5982\u4e0b\u547d\u4ee4</p> <pre><code>docker run --name nginx -p 80:80 -d nginx:alpine\n</code></pre> <p>\u4f7f\u7528<code>curl http://127.0.0.1</code>\u547d\u4ee4\u9a8c\u8bc1nginx\u5bb9\u5668\u662f\u5426\u6b63\u5e38\u8fd0\u884c\uff0c\u5982\u679c\u8f93\u51fa\u4ee5\u4e0b\u5185\u5bb9\uff0c\u4ee3\u8868docker\u5df2\u7ecf\u6b63\u5e38\u5de5\u4f5c</p> <pre><code>&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;style&gt;\nhtml { color-scheme: light dark; }\nbody { width: 35em; margin: 0 auto;\nfont-family: Tahoma, Verdana, Arial, sans-serif; }\n&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;\n&lt;p&gt;If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.&lt;/p&gt;\n&lt;p&gt;For online documentation and support please refer to\n&lt;a href=\"http://nginx.org/\"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;\nCommercial support is available at\n&lt;a href=\"http://nginx.com/\"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre>"},{"location":"04.extend/04-install-harbor/","title":"\u642d\u5efaharbor\u79c1\u6709\u955c\u50cf\u4ed3\u5e93","text":"<p>harbor\u662fdocker\u955c\u50cf\u7ba1\u7406\u8f6f\u4ef6\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528harbor\u642d\u5efa\u81ea\u5df1\u7684\u955c\u50cf\u670d\u52a1\u3002\u5728\u7f16\u5199\u6b64\u6587\u6863\u7684\u65f6\u5019\uff0charbor\u7684\u6700\u65b0\u7248\u672c\u662f<code>2.6.0</code>\u3002\u6211\u4eec\u5c06\u5728<code>199-debian</code>\u8fd9\u53f0\u4e3b\u673a\u4e0a\u642d\u5efaharbor\u670d\u52a1\uff0c\u5728\u672c\u6587\uff0c\u6211\u4eec\u4e00\u8d77\u63a2\u8ba8harbor\u670d\u52a1\u7684\u642d\u5efa\u8fc7\u7a0b\u3002</p>"},{"location":"04.extend/04-install-harbor/#harbor_1","title":"\u4e00\u3001\u4e0b\u8f7dharbor","text":"<p>harbor\u7684\u5b98\u65b9\u4e0b\u8f7d\u5730\u5740\u662f\uff1ahttps://github.com/goharbor/harbor/releases</p> <pre><code># \u4e0b\u8f7dharbor\nwget https://github.com/goharbor/harbor/releases/download/v2.6.0/harbor-offline-installer-v2.6.0.tgz\n# \u89e3\u538bharbor\u5230/opt/\u76ee\u5f55\ntar -xzvf harbor-offline-installer-v2.6.0.tgz -C /opt/\n</code></pre> <p>\u6b64\u65f6\uff0charbor\u89e3\u538b\u6240\u6709\u89e3\u538b\u5185\u5bb9\u5728 <code>/opt/harbor</code>\u76ee\u5f55\u4e2d\uff0c\u9996\u5148\u9700\u8981\u62f7\u8d1d\u4e00\u4efdharbor\u76ee\u5f55\u4e0b\u7684\u914d\u7f6e\u6587\u4ef6<code>cp /opt/harbor/harbor.yml.tmpl /opt/harbor/harbor.yml</code>\uff0c\u4fee\u6539\u5185\u5bb9\u5982\u4e0b</p> <pre><code># \u4fee\u6539\u4e3b\u673a\u540d\nhostname: harbor.host.com\n# \u4fee\u6539http\u670d\u52a1\uff0c\u56e0\u4e3a\u6211\u4eec\u5c06\u6765\u8fd8\u5728\u8fd9\u53f0\u4e3b\u673a\u8fd0\u884cnginx\uff0c\u6240\u4ee5harbor\u5c06harbor\u7aef\u53e3\u6539\u4e3a\u975e80\u7aef\u53e3\nhttp:\nport: 180\n# \u4fee\u6539\u7ba1\u7406\u5458\u7684\u9ed8\u8ba4\u5bc6\u7801\nharbor_admin_password: Harbor123456\n# \u4fee\u6539\u6570\u636e\u7684\u5730\u5740\ndata_volume: /data/harbor\n# \u4fee\u6539\u65e5\u5fd7\u5730\u5740\nlog:\n# \u65e5\u5fd7\u7ea7\u522b\nlevel: info\n# \u6eda\u52a8\u6570\u91cf\nrotate_count: 50\n# \u6eda\u52a8\u5927\u5c0f\nrotate_size: 200M\n# \u65e5\u5fd7\u7684\u4f4d\u7f6e\nlocation: /data/harbor/logs\n# \u6ce8\u91ca\u6389https\u76f8\u5173\u914d\u7f6e\n#https:\n# https port for harbor, default is 443\n#port: 443\n# The path of cert and key files for nginx\n#certificate: /your/certificate/path\n#private_key: /your/private/key/path\n</code></pre> <p>\u521b\u5efa\u65e5\u5fd7\u76ee\u5f55</p> <pre><code>mkdir -p /data/harbor/logs\n</code></pre>"},{"location":"04.extend/04-install-harbor/#docker-compose","title":"\u4e8c\u3001\u5b89\u88c5docker-compose","text":"<p>harbor\u4f9d\u8d56\u4e8edocker-compose\u505a\u5355\u673a\u7f16\u6392\uff0c\u6240\u4ee5\u9700\u8981\u5b89\u88c5docker-compose\uff0cdocker-compose\u7684\u4e8c\u8fdb\u5236\u5b89\u88c5\u5305\u4e0b\u8f7d\u5730\u5740\u662f\uff1ahttps://github.com/docker/compose/releases/</p> <pre><code># \u5c06\u4e8c\u8fdb\u5236\u6587\u4ef6\u4fdd\u5b58\u5230\u672c\u5730\ncurl -L https://github.com/docker/compose/releases/download/v2.11.0/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose\n# \u8d4b\u4e88\u4e8c\u8fdb\u5236\u6587\u4ef6\u6267\u884c\u6743\u9650\nchmod +x /usr/local/bin/docker-compose\n</code></pre>"},{"location":"04.extend/04-install-harbor/#harbor_2","title":"\u4e09\u3001\u5b89\u88c5harbor","text":"<p>\u5b89\u88c5\u597d\u7cfb\u7edf\u91cc\u6709docker\u4e0edocker-compose\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u6267harbor\u7684\u5b89\u88c5\u547d\u4ee4\u4e86\uff0c\u6267\u884c\u5b89\u88c5\u811a\u672c\u5982\u4e0b</p> <pre><code>bash /opt/harbor/install.sh\n</code></pre> <p>\u6267\u884c\u5b8c\u6210\u5b89\u88c5\u811a\u672c\u4e4b\u540e\uff0c\u53ef\u4ee5\u4f7f\u7528<code>docker-compose ps</code>\u67e5\u770b\u5bb9\u5668\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u3002\u5982\u679c\u73b0\u5b9e\u5982\u4e0b\u76f8\u4f3c\u5185\u5bb9\uff0c\u4ee3\u8868harbor\u5df2\u7ecf\u6b63\u5e38\u8fd0\u884c</p> <pre><code>[root@kb200 harbor]# docker-compose ps\nNAME                COMMAND                  SERVICE             STATUS              PORTS\nharbor-core         \"/harbor/harbor_core\"    core                running (healthy)   harbor-db           \"/docker-entrypoint.\u2026\"   postgresql          running (healthy)   5432/tcp\nharbor-jobservice   \"/harbor/harbor_jobs\u2026\"   jobservice          running (healthy)   harbor-log          \"/bin/sh -c /usr/loc\u2026\"   log                 running (healthy)   127.0.0.1:1514-&gt;10514/tcp\nharbor-portal       \"nginx -g 'daemon of\u2026\"   portal              running (healthy)   8080/tcp\nnginx               \"nginx -g 'daemon of\u2026\"   proxy               running (healthy)   0.0.0.0:180-&gt;8080/tcp\nredis               \"redis-server /etc/r\u2026\"   redis               running (healthy)   6379/tcp\nregistry            \"/home/harbor/entryp\u2026\"   registry            running (healthy)   5000/tcp\nregistryctl         \"/home/harbor/start.\u2026\"   registryctl         running (healthy)\n</code></pre>"},{"location":"04.extend/04-install-harbor/#nginx","title":"\u56db\u3001\u5b89\u88c5nginx","text":""},{"location":"04.extend/04-install-harbor/#41","title":"4.1 \u5b89\u88c5\u4e0e\u914d\u7f6e","text":"<p>nginx\u7684\u6e90\u4ee3\u7801\u7684\u4e0b\u8f7d\u5730\u5740\u662f\uff1ahttps://nginx.org/en/download.html</p> <p>\u5728\u7f16\u5199\u6587\u6863\u7684\u65f6\u5019\uff0cnginx\u7684\u6700\u65b0\u7a33\u5b9a\u7248\u672c\u662f<code>1.22.0</code>\uff0c\u4e0b\u8f7dnginx\u6e90\u4ee3\u7801\uff0c\u5e76\u7f16\u8bd1\u5b89\u88c5\uff0c\u547d\u4ee4\u5982\u4e0b\uff1a</p> <pre><code># \u4e0b\u8f7d\u4ee3\u7801\nwget https://nginx.org/download/nginx-1.22.0.tar.gz\n# \u89e3\u538b\u6587\u4ef6\ntar -zxvf nginx-1.22.0.tar.gz\n# \u8fdb\u5165\u6e90\u7801\u76ee\u5f55\ncd nginx-1.22.0\n# \u914d\u7f6e\u7f16\u8bd1\u53c2\u6570\uff0c--prefix\u53c2\u6570\u6307\u5b9a\u5b89\u88c5\u76ee\u5f55\n./configure \\\n--prefix=/usr/local/nginx-1.22.0 \\\n--with-stream \\\n--with-http_stub_status_module \\\n--with-http_ssl_module --with-http_v2_module \\\n--error-log-path=/data/log/nginx/error.log \\\n--http-log-path=/data/log/nginx/access.log\n# \u7f16\u8bd1\u5e76\u5b89\u88c5\nmake &amp;&amp; make install\n</code></pre> <p>\u7f16\u8bd1nginx\u65f6\uff0c\u53ef\u80fd\u4f1a\u63d0\u793a\u4f60\u7f3a\u5c11\u76f8\u5173\u7684\u4f9d\u8d56\u5e93\uff0c\u6839\u636e\u63d0\u793a\u8fdb\u884c\u5b89\u88c5\u5373\u53ef\u3002</p> <p>\u6211\u4eec\u5728nginx\u7684\u914d\u7f6e\u6587\u4ef6<code>/usr/local/nginx-1.22.0/conf/nginx.conf</code>\u4e2d\u6dfb\u52a0\u4ee5\u4e0b<code>server</code>\u8282\u70b9</p> <pre><code>server {\nlisten  80;\nserver_name  harbor.k8s.com;\nclient_max_body_size  1000m;\nlocation / {\nproxy_pass http://127.0.0.1:180;\n}\n}\n</code></pre> <p>\u914d\u7f6e\u597d\u4e4b\u540e\uff0c\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u542f\u52a8nginx</p> <pre><code># \u521b\u5efanginx\u8f6f\u8fde\u63a5\nln -s /usr/local/nginx-1.22.0 /usr/local/nginx\nln -s /usr/local/nginx/sbin/nginx /usr/local/bin/nginx\n# \u68c0\u6d4b\u914d\u7f6e\u6587\u4ef6\u662f\u5426\u6b63\u786e\nnginx -t\n# \u542f\u52a8nginx\u670d\u52a1\nnginx\n</code></pre>"},{"location":"04.extend/04-install-harbor/#42-ip","title":"4.2 \u5f00\u542fIP\u8f6c\u53d1\u529f\u80fd","text":"<p>\u5982\u679c\u6211\u4eec\u7684IP\u6ca1\u6709\u5f00\u542f\u8f6c\u53d1\u529f\u80fd\uff0c\u5b9e\u9645\u4e0aharbor\u5bf9\u4e8e\u5916\u7f51\u7684\u670d\u52a1\u53ef\u80fd\u662f\u4e0d\u6b63\u5e38\u7684\uff0c \u4f7f\u7528 <code>sysctl net.ipv4.ip_forward</code> \u547d\u4ee4\u67e5\u770b IP\u662f\u5426\u5df2\u5f00\u542f\u4e86\u8f6c\u53d1\u529f\u80fd\uff0c\u5982\u679c\u8fd4\u56de\u4ee5\u4e0b\u5185\u5bb9\uff0c\u4ee3\u8868\u6ca1\u6709\u6b63\u5e38\u5f00\u542f</p> <pre><code>net.ipv4.ip_forward = 0\n</code></pre> <p>\u5982\u679c\u6ca1\u6709\u5f00\u542f\uff0c\u4f7f\u7528\u4ee5\u4e0b\u6b65\u9aa4\u8fdb\u884c\u5f00\u542f</p> <p>\u7b2c\u4e00\u6b65\uff0c \u7f16\u8f91<code>/etc/sysctl.conf</code>\u6587\u4ef6\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>net.ipv4.ip_forward = 1 # \u8fd9\u4e2a\u914d\u7f6e\u6539\u62101\uff0c0\u662f\u6ca1\u6253\u5f00\n</code></pre> <p>\u7b2c\u4e8c\u6b65\uff0c\u91cd\u542f\u7f51\u7edc\uff0c\u5982\u679c\u5df2\u6b63\u5e38\u5f00\u542f\u4e86IP\u8f6c\u53d1\u4e86\uff0c\u5219\u4e0d\u9700\u8981\u91cd\u542f\u7f51\u7edc\u4e86</p> <pre><code>/etc/init.d/networking restart\n</code></pre>"},{"location":"04.extend/04-install-harbor/#_1","title":"\u4e94\u3001\u6dfb\u52a0\u57df\u540d\u89e3\u6790","text":"<p>\u5728\u4e0a\u9762\u7684\u6b65\u9aa4\u4e2d\uff0c\u6211\u4eec\u53d1\u73b0\u8bbf\u95ee<code>harbor.k8s.com</code>\u57df\u540d\u7684\u65f6\u5019\u5e76\u4e0d\u4f1a\u89e3\u6790\u5230kb200\u8fd9\u53f0\u4e3b\u673a\uff0c\u6211\u4eec\u9700\u8981\u56de\u5230<code>199-debian</code>\u8fd9\u53f0\u57df\u540d\u89e3\u6790\u670d\u52a1\u5668\u6dfb\u52a0\u4e0a<code>harbor.k8s.com</code>\u8fd9\u4e2a\u57df\u540d\u3002\u5728kb11\u8fd9\u53f0\u8fd9\u51e0\u4e0a\u6253\u5f00<code>/etc/bind/k8s.com.zone</code>\u6587\u4ef6\uff0c\u4fee\u6539\u4e3a\u4ee5\u4e0b\u5185\u5bb9</p> <pre><code>$ORIGIN k8s.com.\n$TTL 600 ; 10 minutes\n@ IN SOA dns.k8s.com. dnsadmin.k8s.com. (\n2022012003 ; serial \u5f80\u540e\u6dfb\u52a0\u4e00\u4e2a\u5e8f\u5217\u53f7\n    10800      ; refresh (3 hours)\n900        ; retry (15 minutes)\n604800     ; expire (1 week)\n86400      ; minium (1 day)\n)\nNS dns.k8s.com.\n\n$TTL 60    ;   1 minute\ndns    A      192.168.9.199\n; \u6dfb\u52a0harbor\u7684\u89e3\u6790\nharbor    A   192.168.9.199\n</code></pre> <p>\u4f7f\u7528<code>systemctl restart named</code>\u91cd\u542f\u57df\u540d\u89e3\u6790\u670d\u52a1\uff0c\u5e76\u4f7f\u7528<code>dig -t A harbor.k8s.com +short</code>\uff0c\u5982\u679c\u6b63\u5e38\u8fd4\u56de<code>192.168.14.200</code>\u5219\u4ee3\u8868\u89e3\u6790\u6210\u529f\u3002\u6b64\u65f6\uff0charbor\u5df2\u7ecf\u5b89\u88c5\u6210\u529f\u4e86\uff0c\u5982\u679c\u6211\u4eec\u7684\u7535\u8111\u672c\u8eab\u89e3\u6790 <code>harbor.k8s.com</code> \u5230kb200\u8fd9\u53f0\u4e3b\u673a\u7684\u8bdd\uff0c\u6b64\u65f6\u6211\u4eec\u80fd\u6b63\u5e38\u8bbf\u95eeharbor\u7684web\u670d\u52a1\u3002</p>"},{"location":"04.extend/04-install-harbor/#_2","title":"\u516d\u3001\u63a8\u9001\u955c\u50cf","text":"<p>harhor\u670d\u52a1\u5b89\u88c5\u6210\u529f\u540e\uff0c\u6211\u4eec\u5c1d\u8bd5\u5c06\u955c\u50cf\u63a8\u9001\u5230harbor\u4e2d\uff0c\u4f7f\u7528<code>docker login harbor.k8s.com</code>\u547d\u4ee4\u767b\u5f55\u5230harbor\u3002\u8d26\u53f7\u662f<code>admin</code>\uff0c\u5bc6\u7801\u662f\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684<code>Harbor123456</code>\u3002</p> <p>\u63a5\u4e0b\u6765\u8fdb\u884c\u955c\u50cf\u63a8\u9001\u64cd\u4f5c</p> <pre><code># \u4ecedocker\u5b98\u65b9\u955c\u50cf\u7ad9\u62c9\u53d6nginx:alpine\u955c\u50cf\ndocker pull nginx:alpine\n# \u5c06nginx:alpine\u955c\u50cf\u6253\u4e3a\u81ea\u5efa\u7684harbor\u670d\u52a1\u7684\u955c\u50cf\ndocker tag nginx:alpine harbor.k8s.com/library/nginx:alpine\n# \u63a8\u9001\u955c\u50cf\ndocker push harbor.k8s.com/library/nginx:alpine\n</code></pre> <p>\u5982\u679c\u6ca1\u6709\u4efb\u4f55\u62a5\u9519\uff0c\u4ee3\u8868harbor\u670d\u52a1\u6b63\u5e38\u8fd0\u884c\u3002</p>"},{"location":"04.extend/05-ip_suggestion/","title":"\u96c6\u7fa4\u642d\u5efaIP\u7f51\u6bb5\u89c4\u5212\u5efa\u8bae","text":""},{"location":"04.extend/05-ip_suggestion/#ipv4","title":"\u4e00\u3001IPv4\u7684\u4e13\u7528\u7f51\u7edc\u5730\u5740","text":"<p>IPv4\u7684\u5730\u5740\u8303\u56f4\u662f<code>1.0.0.1\u2014\u2014255.255.255.254</code>\uff0c\u7edd\u5927\u591a\u6570\u7684IP\u5730\u5740\u90fd\u662f\u516c\u6709\u5730\u5740\uff0c\u9700\u8981\u5411\u56fd\u9645\u4e92\u8054\u7f51\u4fe1\u606f\u4e2d\u5fc3\u7533\u8bf7\u6ce8\u518c\u3002\u4f46\u662f\u5728IPv4\u5730\u5740\u534f\u8bae\u4e2d\u9884\u7559\u4e863\u4e2aIP\u5730\u5740\u6bb5\uff0c\u4f5c\u4e3a\u4e13\u7528\u7f51\u7edc\u5730\u5740\uff0c\u4e13\u95e8\u4f9b\u7ec4\u7ec7\u673a\u6784\u5185\u90e8\u4f7f\u7528\u3002\u8fd9\u4e09\u4e2a\u5730\u5740\u6bb5\u5206\u522b\u4f4d\u4e8eA\u3001B\u3001C\u4e09\u7c7b\u5730\u5740\u5185\uff1a</p> <p>\u8fd9\u4e09\u4e2a\u5730\u5740\u6bb5\u5206\u522b\u4f4d\u4e8eA\u3001B\u3001C\u4e09\u7c7b\u5730\u5740\u5185\uff1a</p> <p>A\u7c7b\u5730\u5740\uff0c\u4fdd\u7559\u7684IP\u8303\u56f4\u662f<code>10.0.0.0 -- 10.255.255.255</code> B\u7c7b\u5730\u5740\uff0c\u4fdd\u7559\u7684IP\u8303\u56f4\u662f<code>172.16.0.0 -- 172.31.255.255</code> C\u7c7b\u5730\u5740\uff0c\u4fdd\u7559\u7684IP\u8303\u56f4\u662f<code>192.168.0.0 -- 192.168.255.255</code></p> <p>\u5f53\u7136\uff0cIPv4\u8fd8\u6709\u5176\u4ed6\u7684\u4fdd\u7559\u5730\u5740\uff0c\u6bd4\u5982 <code>127.0.0.0 \u2013 127.255.255.255</code> \u8fd9\u4e2aIP\u8303\u56f4\u4e5f\u662f\u4fdd\u7559\u5730\u5740\uff0c\u7528\u4e8e\u5230\u672c\u5730\u4e3b\u673a\u7684\u73af\u56de\u5730\u5740\u3002</p>"},{"location":"04.extend/05-ip_suggestion/#ip_1","title":"\u4e8c\u3001\u96c6\u7fa4IP\u7684\u89c4\u5212\u5efa\u8bae","text":"<p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u8fd9\u5f20\u56fe\u4e86\u89e3\u5230k8s\u96c6\u7fa4\u7684\u7f51\u7edc\u7684\u67b6\u6784</p> <p></p> <p>\u89c4\u5212\u96c6\u7fa4\u7684IP\u5730\u5740\uff0c\u5e94\u5f53\u8981\u6ee1\u8db3\u5c3d\u91cf\u6ee1\u8db3\u4e24\u4e2a\u8981\u6c42\uff0c\u4e00\u662f\u5730\u5740\u6709\u610f\u4e49\uff0c\u4e8c\u662f\u8981\u8ba9\u4eba\u5bb9\u6613\u7406\u89e3\u3002\u6839\u636eIPv4\u7684\u76f8\u5173\u89c4\u5219\u4ee5\u53ca\u5b9e\u9645\u7684\u9700\u6c42\uff0c\u6211\u4eec\u642d\u5efak8s\u96c6\u7fa4\u53ef\u4ee5\u9075\u5faa\u4ee5\u4e0b\u7684IP\u5730\u5740\u5206\u914d\u89c4\u5219</p> <ul> <li><code>\u8282\u70b9\u7f51\u7edc</code>: \u8282\u70b9\u7f51\u7edc\u662f\u5bbf\u4e3b\u673a\u7684\u7f51\u7edc\uff0c\u4e5f\u5c31\u662f\u673a\u623f\u91cc\u5355\u4e2a\u4e3b\u673a\u7684\u5185\u7f51\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>10.0.0.0/8 (255.0.0.0)</code>\u7f51\u7edc\u6bb5</li> <li><code>Pod\u7f51\u7edc</code>: \u6bcf\u4e2a\u8282\u70b9\u53ef\u4ee5\u8fd0\u884c\u591a\u4e2aPod\uff0c\u53ef\u4ee5\u4f7f\u7528<code>172.16.0.0/12 (255.240.0.0)</code>\u7f51\u7edc\u6bb5\uff0c<code>172</code>\u4e5f\u662fdocker\u5bb9\u5668\u7684\u9ed8\u8ba4\u7f51\u6bb5</li> <li><code>Service\u7f51\u7edc</code>: Pod\u7f51\u7edc\u548cService\u7f51\u7edc\u901a\u8fc7kube-proxy\u76f8\u8fde\uff0cService\u7f51\u7edc\u662f\u865a\u62df\u7684\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>192.168.0.0/16 (255.255.0.0)</code> \u7f51\u7edc\u6bb5</li> </ul> <p>\u5728\u8282\u70b9\u7f51\u7edc\u4e2d\uff0c\u7b2c\u4e00\u4f4d\u6570\u5b57\uff1a10\uff0c\u901a\u5e38\u6807\u8bc6IDC(Internet Data Center\uff0c\u4e92\u8054\u7f51\u6570\u636e\u4e2d\u5fc3) \u673a\u623f\uff1b\u7b2c\u4e8c\u4f4d\u901a\u5e38\u4ee3\u8868\u673a\u623f\u5e8f\u53f7\uff1b\u7b2c\u4e09\u4f4d\u4ee3\u8868\u4e0d\u540c\u7684\u9879\u76ee\u6216\u8005\u73af\u5883\uff0c\u53ef\u4ee5\u505a\u7269\u7406\u9694\u79bb\uff1b\u7b2c\u56db\u4f4d\u4ee3\u8868\u5177\u4f53\u7684\u9879\u76ee\u3002</p> <p>\u5982\u679c\u6211\u4eec\u4f7f\u7528\u4e86\u4ee5\u4e0a\u9762\u7684\u89c4\u5219\uff0c\u901a\u8fc7IP\u6bb5\u8ba9\u6211\u4eec\u80fd\u5feb\u901f\u5730\u8fa8\u8bc6\u6240\u5c5e\u7f51\u7edc\u7c7b\u578b\uff08\u8282\u70b9\u7f51\u7edc\u3001Pod\u7f51\u7edc\u3001Service\u7f51\u7edc\uff09\uff0c\u540c\u65f6\u4e5f\u4fbf\u4e8e\u7406\u89e3\u3002</p>"},{"location":"04.extend/06-run-centos6/","title":"\u89e3\u51b3centos6\u955c\u50cf\u542f\u52a8\u5bb9\u5668\u5931\u8d25\u7684\u95ee\u9898","text":"<p>bug: https://github.com/docker/for-linux/issues/58</p>"}]}